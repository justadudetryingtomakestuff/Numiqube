<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Numiqube ðŸ§Š â€” Math Study App</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Nunito:wght@400;600;700;900&display=swap" rel="stylesheet">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --bg:#0f0e17;--bg2:#13121f;--card:#1a1830;--card2:#201e38;--card3:#252340;
  --accent:#ff6b35;--a2:#ffd166;--a3:#06d6a0;--a4:#118ab2;--a5:#c77dff;--a6:#f72585;
  --text:#fffffe;--muted:#a7a9be;--border:#ffffff0f;
  --correct:#06d6a0;--wrong:#ef476f;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
}
.light-mode{
  --bg:#f7f3ee;--bg2:#efe9e0;--card:#ffffff;--card2:#f5efe8;--card3:#ece4d9;
  --text:#1a1830;--muted:#7a6e62;--border:#0000000f;
  --shadow:0 8px 32px rgba(0,0,0,0.08);
}
*{box-sizing:border-box;margin:0;padding:0;}
html{scroll-behavior:smooth;}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;transition:background 0.3s,color 0.3s;}

/* â”€â”€â”€ LOADING SCREEN â”€â”€â”€ */
#loader{position:fixed;inset:0;background:var(--bg);z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:28px;transition:opacity 0.6s ease,visibility 0.6s ease;}
#loader.hidden{opacity:0;visibility:hidden;pointer-events:none;}
.loader-title{font-family:'Space Mono',monospace;font-size:1.6rem;font-weight:700;background:linear-gradient(135deg,#4cc9f0,#c77dff,#f72585);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:2px;}
.loader-sub{color:var(--muted);font-size:0.8rem;letter-spacing:1px;}

/* 3D Cube */
.cube-scene{width:100px;height:100px;perspective:350px;}
.cube{width:100%;height:100%;position:relative;transform-style:preserve-3d;animation:spinCube 3s linear infinite;}
@keyframes spinCube{
  0%  {transform:rotateX(-20deg) rotateY(0deg);}
  100%{transform:rotateX(-20deg) rotateY(360deg);}
}
.cube-face{position:absolute;width:100px;height:100px;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:3px;padding:3px;border-radius:4px;}
.cube-face .cell{border-radius:3px;display:flex;align-items:center;justify-content:center;font-size:0;font-weight:900;}
/* Face positions */
.face-front {transform:translateZ(50px);}
.face-back  {transform:rotateY(180deg) translateZ(50px);}
.face-right {transform:rotateY(90deg)  translateZ(50px);}
.face-left  {transform:rotateY(-90deg) translateZ(50px);}
.face-top   {transform:rotateX(90deg)  translateZ(50px);}
.face-bottom{transform:rotateX(-90deg) translateZ(50px);}
/* Rubik colors per face */
.face-front  .cell{background:#ff6b35;}
.face-back   .cell{background:#ffd166;}
.face-right  .cell{background:#06d6a0;}
.face-left   .cell{background:#118ab2;}
.face-top    .cell{background:#c77dff;}
.face-bottom .cell{background:#f72585;}
/* Center cell of front face gets the xÂ³ label */
.face-front .cell.center{background:#fff;color:#ff6b35;font-size:1rem;font-weight:900;font-family:'Space Mono',monospace;}
.face-front .cell.center sup{font-size:0.6rem;vertical-align:super;}

/* Subtle rotating color effect on each cell with staggered delay */
.cube-face .cell{animation:cellPulse 3s ease-in-out infinite;}
.cube-face .cell:nth-child(1){animation-delay:0s}
.cube-face .cell:nth-child(2){animation-delay:.1s}
.cube-face .cell:nth-child(3){animation-delay:.2s}
.cube-face .cell:nth-child(4){animation-delay:.3s}
.cube-face .cell:nth-child(5){animation-delay:.4s}
.cube-face .cell:nth-child(6){animation-delay:.5s}
.cube-face .cell:nth-child(7){animation-delay:.6s}
.cube-face .cell:nth-child(8){animation-delay:.7s}
.cube-face .cell:nth-child(9){animation-delay:.8s}
@keyframes cellPulse{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}

.loader-bar-wrap{width:160px;height:4px;background:var(--card3);border-radius:99px;overflow:hidden;}
.loader-bar{height:100%;width:0%;background:linear-gradient(90deg,#4cc9f0,#c77dff);border-radius:99px;animation:loaderFill 1.8s ease forwards;}
@keyframes loaderFill{0%{width:0%}60%{width:85%}100%{width:100%}}


#stars-bg{position:fixed;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:0;overflow:hidden;}
.star{position:absolute;border-radius:50%;background:white;animation:twinkle var(--d,3s) infinite var(--delay,0s);}
@keyframes twinkle{0%,100%{opacity:var(--lo,.1)}50%{opacity:var(--hi,.8)}}
.light-mode #stars-bg{display:none;}

/* â”€â”€â”€ NAV â”€â”€â”€ */
#nav{position:fixed;top:0;left:0;right:0;z-index:200;
  background:rgba(15,14,23,0.95);backdrop-filter:blur(16px);
  border-bottom:1px solid var(--border);
  display:none;align-items:center;justify-content:space-between;
  padding:0 16px;height:52px;gap:8px;}
.light-mode #nav{background:rgba(240,242,248,0.97);}
.nav-logo{font-family:'Space Mono',monospace;font-size:1rem;font-weight:700;
  background:linear-gradient(135deg,#4cc9f0,#c77dff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.nav-tabs{display:flex;gap:2px;}
.nav-tab{padding:5px 12px;border-radius:8px;font-size:0.75rem;font-weight:700;cursor:pointer;border:none;
  background:none;color:var(--muted);font-family:'Nunito',sans-serif;transition:all 0.2s;}
.nav-tab:hover,.nav-tab.active{background:rgba(255,107,53,0.15);color:var(--accent);}
.nav-right{display:flex;align-items:center;gap:8px;}
#nav-timer{font-family:'Space Mono',monospace;font-size:0.85rem;color:var(--a2);font-weight:700;}
#nav-xp{font-size:0.75rem;color:var(--a3);font-weight:700;}
#nav-streak{font-size:0.8rem;color:var(--accent);font-weight:700;}
#nav-lvl{background:linear-gradient(135deg,#7b2ff7,#f107a3);padding:2px 8px;border-radius:99px;font-size:0.68rem;font-weight:700;color:white;}
.nav-icon-btn{background:none;border:1px solid var(--border);color:var(--muted);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:0.9rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s;}
.nav-icon-btn:hover{background:var(--card2);color:var(--text);}

/* â”€â”€â”€ PAGES â”€â”€â”€ */
.page{display:none;position:relative;z-index:1;padding-top:56px;min-height:100vh;}
.page.active{display:block;}
.container{max-width:820px;margin:0 auto;padding:20px 16px;}

/* â”€â”€â”€ START SCREEN â”€â”€â”€ */
#page-home{display:none;flex-direction:column;align-items:center;justify-content:center;
  min-height:100vh;text-align:center;gap:22px;padding:20px;}
#page-home.show{display:flex;}
.rocket-anim{font-size:5rem;animation:float 3s ease-in-out infinite;display:block;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-16px)}}
.home-title{font-size:clamp(2.2rem,6vw,3.5rem);font-weight:900;letter-spacing:-1.5px;
  background:linear-gradient(135deg,#4cc9f0,#c77dff,#f72585);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.home-motto{font-size:1rem;font-style:italic;color:var(--a2);font-weight:700;margin-bottom:4px;letter-spacing:0.2px;}
.home-sub{color:var(--muted);font-size:1rem;max-width:440px;line-height:1.6;}
.onboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;width:100%;max-width:600px;}
.onboard-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 12px;text-align:center;}
.onboard-card .oc-icon{font-size:1.8rem;display:block;margin-bottom:6px;}
.onboard-card strong{display:block;font-size:0.88rem;color:var(--text);}
.onboard-card span{font-size:0.75rem;color:var(--muted);}
.name-input-wrap{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;}
#username-input{background:var(--card);border:1.5px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:1rem;padding:11px 16px;border-radius:12px;outline:none;
  transition:border-color 0.2s;width:220px;}
#username-input:focus{border-color:var(--accent);}
.btn-primary{background:linear-gradient(135deg,var(--accent),#ff9a3c);border:none;color:white;
  font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:900;padding:12px 36px;
  border-radius:99px;cursor:pointer;box-shadow:0 0 24px rgba(255,107,53,0.35);transition:transform 0.2s,box-shadow 0.2s;}
.btn-primary:hover{transform:scale(1.04);box-shadow:0 0 36px rgba(255,107,53,0.55);}
.btn-secondary{background:var(--card2);border:1px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:700;padding:10px 24px;
  border-radius:99px;cursor:pointer;transition:all 0.2s;}
.btn-secondary:hover{background:var(--card3);}

/* â”€â”€â”€ DASHBOARD â”€â”€â”€ */
.section-title{font-size:0.75rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);margin-bottom:12px;font-weight:700;}
.dash-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:20px;}
.dash-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center;transition:transform 0.2s;}
.dash-card:hover{transform:translateY(-2px);}
.dc-icon{font-size:1.6rem;display:block;margin-bottom:6px;}
.dc-num{font-family:'Space Mono',monospace;font-size:1.5rem;font-weight:700;}
.dc-label{font-size:0.75rem;color:var(--muted);margin-top:2px;text-transform:uppercase;letter-spacing:0.5px;}
.goal-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:12px;}
.goal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.goal-title{font-size:0.85rem;font-weight:700;}
.goal-pct{font-family:'Space Mono',monospace;font-size:0.8rem;color:var(--a3);}
.goal-bar-wrap{height:8px;background:var(--card3);border-radius:99px;overflow:hidden;}
.goal-bar-fill{height:100%;border-radius:99px;transition:width 0.6s;}
.goal-sub{font-size:0.72rem;color:var(--muted);margin-top:6px;}
.activity-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;margin-top:8px;}
.act-cell{aspect-ratio:1;border-radius:3px;background:var(--card3);cursor:default;transition:box-shadow 0.2s,filter 0.2s;display:flex;align-items:center;justify-content:center;font-size:0.5rem;font-weight:700;color:rgba(255,255,255,0.5);}
.act-cell:hover{filter:brightness(1.5);box-shadow:0 0 6px rgba(6,214,160,0.4);}
.act-0{background:var(--card3);}
.act-1{background:rgba(6,214,160,0.3);}
.act-2{background:rgba(6,214,160,0.55);}
.act-3{background:rgba(6,214,160,0.8);}
.act-4{background:var(--a3);}
.streak-calendar{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:12px;}
.week-row{display:flex;gap:4px;flex-wrap:wrap;}
.day-dot{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:var(--muted);}
.day-done{background:var(--a3);color:#000;}
.day-today{background:var(--accent);color:white;}
.day-missed{background:var(--card3);color:var(--muted);}

/* â”€â”€â”€ STUDY PAGE â”€â”€â”€ */
#topic-selector-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;}
.topic-tab{padding:5px 12px;border-radius:99px;font-size:0.74rem;font-weight:700;cursor:pointer;
  border:1.5px solid var(--border);background:none;color:var(--muted);font-family:'Nunito',sans-serif;transition:all 0.15s;}
.topic-tab:hover{border-color:var(--accent);color:var(--text);}
.topic-tab.active{background:var(--accent);border-color:var(--accent);color:white;}
.study-toolbar{display:flex;gap:6px;align-items:center;margin-bottom:12px;}
.tool-btn{background:var(--card2);border:1px solid var(--border);color:var(--muted);font-family:'Nunito',sans-serif;
  font-size:0.74rem;padding:5px 11px;border-radius:99px;cursor:pointer;transition:all 0.2s;}
.tool-btn:hover{background:var(--card3);color:var(--text);}
.tool-btn.active-tool{background:rgba(255,107,53,0.2);border-color:var(--accent);color:var(--accent);}
.tool-btn.music-off{opacity:0.45;}

/* More button */
.more-btn{background:var(--card2);border:1px solid var(--border);color:var(--text);font-family:'Nunito',sans-serif;
  font-size:0.82rem;font-weight:700;padding:6px 14px;border-radius:99px;cursor:pointer;
  display:flex;align-items:center;gap:6px;transition:all 0.2s;}
.more-btn:hover{background:var(--card3);border-color:var(--accent);color:var(--accent);}

/* Side panel */
#more-panel-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,0);pointer-events:none;transition:background 0.3s;}
#more-panel-overlay.open{background:rgba(0,0,0,0.5);pointer-events:all;}
#more-panel{position:fixed;top:0;right:0;bottom:0;width:260px;background:var(--card);
  border-left:1px solid var(--border);z-index:301;padding:20px 16px;
  transform:translateX(100%);transition:transform 0.32s cubic-bezier(0.4,0,0.2,1);
  display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
#more-panel.open{transform:translateX(0);}
.panel-title{font-size:0.7rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--muted);
  font-weight:700;margin:10px 0 4px;padding-top:10px;border-top:1px solid var(--border);}
.panel-title:first-child{margin-top:0;padding-top:0;border-top:none;}
.panel-btn{background:var(--card2);border:1px solid var(--border);color:var(--text);font-family:'Nunito',sans-serif;
  font-size:0.88rem;font-weight:700;padding:10px 14px;border-radius:12px;cursor:pointer;
  text-align:left;transition:all 0.18s;display:flex;align-items:center;gap:10px;}
.panel-btn:hover{background:var(--card3);border-color:var(--accent);color:var(--accent);}
.panel-btn.active-tool{background:rgba(255,107,53,0.12);border-color:var(--accent);color:var(--accent);}
.panel-close{background:none;border:1px solid var(--border);color:var(--muted);width:30px;height:30px;
  border-radius:8px;cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;
  transition:all 0.2s;align-self:flex-end;margin-bottom:6px;}
.panel-close:hover{background:var(--card2);color:var(--text);}

/* Compact daily challenge */
#daily-compact{display:flex;align-items:center;gap:10px;padding:7px 12px;
  background:rgba(199,125,255,0.08);border:1px solid rgba(199,125,255,0.2);
  border-radius:10px;margin-bottom:10px;}
#daily-compact-label{font-size:0.76rem;font-weight:700;color:var(--a5);white-space:nowrap;}
#daily-compact-bar-wrap{flex:1;height:4px;background:var(--card3);border-radius:99px;overflow:hidden;}
#daily-compact-bar{height:100%;background:var(--a5);border-radius:99px;width:0%;transition:width 0.4s;}
#daily-compact-count{font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--muted);white-space:nowrap;}
#session-prog-wrap{margin-bottom:12px;}
#session-prog-label{display:flex;justify-content:space-between;font-size:0.7rem;color:var(--muted);margin-bottom:4px;}
.thin-bar{height:5px;background:var(--card3);border-radius:99px;overflow:hidden;}
.thin-bar-fill{height:100%;background:linear-gradient(90deg,var(--a4),var(--a5));border-radius:99px;transition:width 0.5s;}
.question-meta{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:6px;}
#topic-badge{background:linear-gradient(135deg,var(--a4),var(--a3));padding:4px 12px;border-radius:99px;font-size:0.74rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;}
#q-counter{color:var(--muted);font-size:0.78rem;font-family:'Space Mono',monospace;}
#score-display{color:var(--a2);font-size:0.84rem;font-weight:700;}

/* â”€â”€â”€ QUESTION CARD â”€â”€â”€ */
#question-card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:24px;margin-bottom:14px;
  position:relative;animation:slideIn 0.3s ease;box-shadow:var(--shadow);}
@keyframes slideIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
#question-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;
  background:linear-gradient(90deg,var(--accent),var(--a2),var(--a3),var(--a5));}
#diff-tag{font-size:0.72rem;font-weight:700;padding:3px 9px;border-radius:99px;display:inline-block;margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;}
.d-easy{background:rgba(6,214,160,0.18);color:var(--a3);}
.d-medium{background:rgba(255,209,102,0.18);color:var(--a2);}
.d-hard{background:rgba(239,71,111,0.18);color:var(--wrong);}
.d-competition{background:rgba(17,138,178,0.18);color:var(--a4);}
#question-text{font-size:1.05rem;line-height:1.78;margin-bottom:18px;color:var(--text);min-height:3em;word-wrap:break-word;overflow-wrap:break-word;}

/* Speed timer ring */
#speed-ring-wrap{display:none;float:right;margin:-4px 0 8px 12px;}
#speed-ring{width:48px;height:48px;}
#speed-num{font-family:'Space Mono',monospace;font-size:0.75rem;color:var(--a2);text-anchor:middle;dominant-baseline:middle;}

#options-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px;}
.opt-btn{background:rgba(255,255,255,0.035);border:1.5px solid var(--border);border-radius:11px;
  color:var(--text);font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:600;
  padding:11px 12px;text-align:left;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;gap:8px;}
.opt-btn:hover:not(:disabled){background:rgba(255,107,53,0.1);border-color:var(--accent);transform:translateX(2px);}
.opt-lbl{background:rgba(255,255,255,0.08);width:24px;height:24px;border-radius:5px;display:flex;align-items:center;justify-content:center;font-family:'Space Mono',monospace;font-size:0.68rem;flex-shrink:0;}
.opt-btn.correct{background:rgba(6,214,160,0.13);border-color:var(--correct);}
.opt-btn.correct .opt-lbl{background:var(--correct);color:#000;}
.opt-btn.wrong{background:rgba(239,71,111,0.13);border-color:var(--wrong);}
.opt-btn.wrong .opt-lbl{background:var(--wrong);color:#fff;}
.opt-btn:disabled{cursor:default;}
#free-wrap{display:none;margin-bottom:12px;}
#free-input{width:100%;background:var(--card2);border:1.5px solid var(--border);border-radius:11px;color:var(--text);
  font-family:'Nunito',sans-serif;font-size:0.98rem;padding:11px 14px;outline:none;transition:border-color 0.2s;}
#free-input:focus{border-color:var(--accent);}
#submit-free{margin-top:8px;background:var(--accent);border:none;color:white;font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;padding:9px 22px;border-radius:99px;cursor:pointer;}

/* hint */
#hint-section{margin-bottom:10px;display:flex;align-items:flex-start;gap:8px;flex-wrap:wrap;}
#hint-btn{background:none;border:1px solid var(--border);color:var(--muted);font-family:'Nunito',sans-serif;font-size:0.76rem;padding:4px 12px;border-radius:99px;cursor:pointer;transition:all 0.2s;flex-shrink:0;}
#hint-btn:hover{border-color:var(--a2);color:var(--a2);}
#hint-text{display:none;flex:1;padding:9px 12px;background:rgba(255,209,102,0.07);border-left:3px solid var(--a2);
  border-radius:0 8px 8px 0;font-size:0.83rem;color:var(--a2);line-height:1.55;}

/* feedback */
#feedback-box{display:none;border-radius:12px;padding:12px 15px;margin-bottom:12px;font-size:0.87rem;line-height:1.65;animation:fadeIn 0.25s;}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
#feedback-box.fb-correct{background:rgba(6,214,160,0.09);border:1px solid var(--correct);}
#feedback-box.fb-wrong{background:rgba(239,71,111,0.09);border:1px solid var(--wrong);}
.fb-step{margin-top:8px;padding:8px 10px;background:rgba(255,255,255,0.04);border-radius:8px;font-size:0.82rem;color:var(--muted);}
.fb-step strong{color:var(--a2);display:block;font-size:0.72rem;text-transform:uppercase;margin-bottom:2px;}

#next-btn{display:none;width:100%;background:linear-gradient(135deg,var(--accent),#ff9a3c);border:none;color:white;
  font-family:'Nunito',sans-serif;font-size:0.92rem;font-weight:800;padding:12px;border-radius:11px;cursor:pointer;transition:opacity 0.2s,transform 0.1s;}
#next-btn:hover{opacity:0.9;transform:translateY(-1px);}

/* stats mini row */
#stats-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
.stat-mini{flex:1;min-width:72px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 10px;text-align:center;}
.snum{font-family:'Space Mono',monospace;font-size:1.2rem;font-weight:700;}
.slabel{color:var(--muted);font-size:0.72rem;margin-top:2px;text-transform:uppercase;letter-spacing:0.4px;}

/* â”€â”€â”€ PROGRESS PAGE â”€â”€â”€ */
.topic-bar-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.tb-label{width:110px;font-size:0.78rem;color:var(--muted);flex-shrink:0;}
.tb-bar-wrap{flex:1;height:9px;background:var(--card3);border-radius:99px;overflow:hidden;}
.tb-bar-fill{height:100%;border-radius:99px;transition:width 0.7s;}
.tb-pct{width:30px;text-align:right;font-size:0.72rem;font-family:'Space Mono',monospace;}
.ach-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(115px,1fr));gap:8px;margin-top:8px;}
.ach-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;text-align:center;transition:transform 0.2s;}
.ach-card.earned{border-color:var(--a5);background:rgba(199,125,255,0.07);}
.ach-card:hover{transform:translateY(-2px);}
.ach-icon{font-size:1.65rem;}
.ach-name{font-size:0.78rem;font-weight:700;margin-top:4px;}
.ach-desc{font-size:0.68rem;color:var(--muted);margin-top:2px;}
.history-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:300px;overflow-y:auto;}
.hist-item{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:8px;font-size:0.8rem;}
.hist-correct{color:var(--correct);font-family:'Space Mono',monospace;font-size:0.75rem;}
.hist-wrong{color:var(--wrong);font-family:'Space Mono',monospace;font-size:0.75rem;}
.wrong-list{display:flex;flex-direction:column;gap:8px;margin-top:8px;}
.wrong-item{background:rgba(239,71,111,0.07);border:1px solid rgba(239,71,111,0.25);border-radius:11px;padding:12px 14px;font-size:0.82rem;cursor:pointer;transition:background 0.2s;}
.wrong-item:hover{background:rgba(239,71,111,0.12);}
.wrong-q{font-weight:600;margin-bottom:4px;}
.wrong-a{color:var(--muted);font-size:0.75rem;}
.wrong-correct{color:var(--correct);}

/* â”€â”€â”€ GOALS PAGE â”€â”€â”€ */
.goal-form{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px;}
.goal-form label{font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;}
.goal-input{background:var(--card2);border:1.5px solid var(--border);color:var(--text);font-family:'Nunito',sans-serif;
  font-size:0.92rem;padding:9px 13px;border-radius:10px;outline:none;width:100%;transition:border-color 0.2s;margin-bottom:10px;}
.goal-input:focus{border-color:var(--accent);}
.goal-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:10px;position:relative;}
.goal-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.goal-item-title{font-size:0.9rem;font-weight:700;}
.goal-badge{font-size:0.7rem;padding:2px 8px;border-radius:99px;font-weight:700;}
.gb-active{background:rgba(6,214,160,0.2);color:var(--a3);}
.gb-done{background:rgba(255,209,102,0.2);color:var(--a2);}
.goal-del{position:absolute;top:10px;right:10px;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;}
.goal-del:hover{color:var(--wrong);}
.tab-row{display:flex;gap:6px;margin-bottom:16px;border-bottom:1px solid var(--border);padding-bottom:10px;}
.tab-pill{padding:6px 14px;border-radius:8px;font-size:0.78rem;font-weight:700;cursor:pointer;border:none;background:none;color:var(--muted);font-family:'Nunito',sans-serif;transition:all 0.2s;}
.tab-pill.active{background:rgba(255,107,53,0.15);color:var(--accent);}

/* â”€â”€â”€ LEADERBOARD â”€â”€â”€ */
.lb-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px 16px;
  display:flex;align-items:center;gap:12px;margin-bottom:8px;transition:background 0.2s,border-color 0.2s;}
.lb-row:hover{background:var(--card2);}
.lb-rank{font-family:'Space Mono',monospace;font-size:0.9rem;width:24px;text-align:center;color:var(--muted);}
.lb-rank.gold{color:#ffd700;font-weight:700;}
.lb-rank.silver{color:#c0c0c0;font-weight:700;}
.lb-rank.bronze{color:#cd7f32;font-weight:700;}
.lb-avatar{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;}
.lb-name{font-weight:700;font-size:0.88rem;flex:1;}
.lb-xp{font-family:'Space Mono',monospace;font-size:0.8rem;color:var(--a3);}
.lb-me{border-color:var(--accent)!important;background:rgba(255,107,53,0.07)!important;}

/* â”€â”€â”€ FORMULA MODAL â”€â”€â”€ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:400;overflow-y:auto;padding:16px;}
.modal-box{background:var(--card);border-radius:20px;max-width:700px;margin:auto;padding:24px;border:1px solid var(--a5);position:relative;box-shadow:var(--shadow);}
.modal-close{position:absolute;top:12px;right:12px;background:none;border:1px solid var(--border);color:var(--muted);font-size:1rem;width:30px;height:30px;border-radius:8px;cursor:pointer;transition:all 0.2s;}
.modal-close:hover{color:var(--text);background:var(--card2);}
.formula-section h3{font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--a5);margin:14px 0 7px;}
.formula-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.formula-card{background:var(--card2);border-radius:9px;padding:9px 11px;font-size:0.78rem;}
.formula-card strong{display:block;color:var(--a2);font-size:0.68rem;margin-bottom:2px;}
.fn{font-family:'Space Mono',monospace;font-size:0.75rem;color:var(--a3);}

/* â”€â”€â”€ FRIENDS & LEADERBOARD â”€â”€â”€ */
.friend-code-box{background:var(--card2);border:1.5px solid var(--border);border-radius:14px;
  padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:16px;}
.friend-code-label{font-size:0.72rem;color:var(--muted);margin-bottom:3px;}
.friend-code-value{font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--accent);letter-spacing:2px;}
.friend-code-copy{background:var(--card3);border:1px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:0.78rem;font-weight:700;padding:6px 12px;
  border-radius:8px;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.friend-code-copy:hover{border-color:var(--accent);color:var(--accent);}
.friend-search-row{display:flex;gap:8px;margin-bottom:16px;}
.friend-search-input{flex:1;background:var(--card2);border:1.5px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:0.88rem;padding:9px 13px;border-radius:10px;outline:none;transition:border-color 0.2s;}
.friend-search-input:focus{border-color:var(--accent);}
.friend-search-btn{background:var(--accent);border:none;color:white;font-family:'Nunito',sans-serif;
  font-size:0.88rem;font-weight:800;padding:9px 16px;border-radius:10px;cursor:pointer;transition:opacity 0.2s;white-space:nowrap;}
.friend-search-btn:hover{opacity:0.88;}
.friend-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:var(--card2);
  border:1px solid var(--border);border-radius:12px;margin-bottom:8px;}
.friend-avatar{width:38px;height:38px;border-radius:50%;display:flex;align-items:center;
  justify-content:center;font-size:1.3rem;background:var(--card3);flex-shrink:0;}
.friend-avatar img{width:38px;height:38px;border-radius:50%;object-fit:cover;}
.friend-name{font-size:0.88rem;font-weight:700;flex:1;}
.friend-sub{font-size:0.72rem;color:var(--muted);margin-top:1px;}
.friend-action-btn{background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'Nunito',sans-serif;font-size:0.74rem;padding:5px 10px;border-radius:8px;cursor:pointer;transition:all 0.2s;}
.friend-action-btn.accept{border-color:var(--a3);color:var(--a3);}
.friend-action-btn.accept:hover{background:rgba(6,214,160,0.1);}
.friend-action-btn.decline{border-color:var(--wrong);color:var(--wrong);}
.friend-action-btn.decline:hover{background:rgba(239,71,111,0.1);}
.friend-action-btn.remove:hover{border-color:var(--wrong);color:var(--wrong);}
/* â”€â”€â”€ DUEL SYSTEM â”€â”€â”€ */
.duel-btn{background:linear-gradient(135deg,#f72585,#c77dff);border:none;color:white;
  font-family:'Nunito',sans-serif;font-size:0.72rem;font-weight:800;padding:5px 10px;
  border-radius:99px;cursor:pointer;transition:opacity 0.2s;white-space:nowrap;}
.duel-btn:hover{opacity:0.85;}
.duel-btn.challenge{background:linear-gradient(135deg,#ff6b35,#ffd166);}
.online-dot{width:8px;height:8px;border-radius:50%;background:#ccc;flex-shrink:0;margin-left:2px;}
.online-dot.online{background:var(--a3);box-shadow:0 0 6px var(--a3);}

/* Incoming duel notification */
#duel-incoming{position:fixed;top:60px;left:50%;transform:translateX(-50%) translateY(-120px);pointer-events:none;visibility:hidden;opacity:0;
  background:linear-gradient(135deg,#1a1830,#201e38);border:2px solid var(--a6);
  border-radius:18px;padding:18px 22px;z-index:800;min-width:290px;max-width:340px;
  box-shadow:0 16px 48px rgba(247,37,133,0.35);transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);}
#duel-incoming.show{transform:translateX(-50%) translateY(0);pointer-events:all;visibility:visible;opacity:1;}
.di-title{font-size:0.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--a6);font-weight:700;margin-bottom:6px;}
.di-challenger{font-size:1.05rem;font-weight:900;margin-bottom:2px;}
.di-sub{font-size:0.78rem;color:var(--muted);margin-bottom:14px;}
.di-btns{display:flex;gap:8px;}
.di-accept{flex:1;background:linear-gradient(135deg,var(--a3),#0ea5e9);border:none;color:#000;
  font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;padding:10px;border-radius:10px;cursor:pointer;}
.di-decline{flex:1;background:var(--card3);border:1px solid var(--border);color:var(--muted);
  font-family:'Nunito',sans-serif;font-weight:700;font-size:0.88rem;padding:10px;border-radius:10px;cursor:pointer;}
.di-accept:hover{opacity:0.9;} .di-decline:hover{background:var(--card2);}
.di-timer{font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--muted);text-align:center;margin-top:8px;}

/* Duel arena overlay */
#duel-arena{position:fixed;inset:0;background:var(--bg);z-index:700;display:none;flex-direction:column;}
#duel-arena.show{display:flex;}
.da-header{background:linear-gradient(135deg,rgba(247,37,133,0.15),rgba(199,125,255,0.1));
  border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px;}
.da-title{font-family:'Space Mono',monospace;font-size:0.9rem;font-weight:700;
  background:linear-gradient(135deg,var(--a6),var(--a5));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;flex:1;text-align:center;}
.da-quit{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 10px;
  border-radius:8px;font-family:'Nunito',sans-serif;font-size:0.75rem;cursor:pointer;}
.da-scoreboard{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;
  padding:10px 16px;background:var(--card);}
.da-player{text-align:center;}
.da-player-name{font-size:0.78rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.da-player-score{font-family:'Space Mono',monospace;font-size:2rem;font-weight:700;line-height:1;}
.da-player-score.me{color:var(--a3);}
.da-player-score.them{color:var(--a6);}
.da-vs{font-family:'Space Mono',monospace;font-size:0.9rem;color:var(--muted);font-weight:700;}
.da-progress{height:4px;background:var(--card3);position:relative;}
.da-progress-me{position:absolute;left:0;top:0;height:100%;background:var(--a3);transition:width 0.4s;}
.da-progress-them{position:absolute;right:0;top:0;height:100%;background:var(--a6);transition:width 0.4s;}
.da-progress-mid{position:absolute;left:50%;top:-4px;width:2px;height:12px;background:var(--muted);}
.da-question-area{flex:1;overflow-y:auto;padding:12px 16px;}
.da-topic-badge{font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;
  color:var(--a5);font-weight:700;margin-bottom:8px;}
.da-finish-15{font-size:0.72rem;color:var(--muted);text-align:center;margin-top:6px;}

/* Countdown overlay */
#duel-countdown{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:750;
  display:none;align-items:center;justify-content:center;flex-direction:column;gap:8px;}
#duel-countdown.show{display:flex;}
.dc-num{font-family:'Space Mono',monospace;font-size:6rem;font-weight:700;
  background:linear-gradient(135deg,var(--a6),var(--a5));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;animation:dcPop 0.4s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes dcPop{from{transform:scale(0.5);opacity:0}to{transform:scale(1);opacity:1}}
.dc-sub{color:var(--muted);font-size:0.88rem;letter-spacing:1px;}

/* Duel result screen */
#duel-result{position:fixed;inset:0;background:var(--bg);z-index:760;
  display:none;align-items:center;justify-content:center;padding:20px;}
#duel-result.show{display:flex;}
.dr-card{background:var(--card);border:1px solid var(--border);border-radius:24px;
  padding:32px 28px;width:100%;max-width:360px;text-align:center;}
.dr-crown{font-size:4rem;display:block;margin-bottom:8px;animation:float 2s ease-in-out infinite;}
.dr-outcome{font-size:1.8rem;font-weight:900;margin-bottom:4px;}
.dr-sub{color:var(--muted);font-size:0.85rem;margin-bottom:20px;}
.dr-scores{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
.dr-score-box{border-radius:14px;padding:14px 10px;}
.dr-score-box.winner{background:rgba(6,214,160,0.12);border:1px solid rgba(6,214,160,0.3);}
.dr-score-box.loser{background:rgba(239,71,111,0.08);border:1px solid rgba(239,71,111,0.2);}
.dr-score-num{font-family:'Space Mono',monospace;font-size:2rem;font-weight:700;}
.dr-score-name{font-size:0.72rem;color:var(--muted);margin-top:3px;}
.dr-xp-reward{background:rgba(255,209,102,0.1);border:1px solid rgba(255,209,102,0.3);
  border-radius:10px;padding:10px 14px;margin-bottom:16px;font-size:0.88rem;color:var(--a2);font-weight:700;}

.lb-tabs{display:flex;gap:6px;margin-bottom:16px;}
.lb-tab{flex:1;background:var(--card2);border:1px solid var(--border);color:var(--muted);
  font-family:'Nunito',sans-serif;font-size:0.78rem;font-weight:700;padding:7px;
  border-radius:10px;cursor:pointer;transition:all 0.2s;text-align:center;}
.lb-tab.active{background:rgba(255,107,53,0.15);border-color:var(--accent);color:var(--accent);}
.lb-row{display:flex;align-items:center;gap:12px;padding:10px 12px;
  border-radius:12px;margin-bottom:6px;transition:background 0.2s;}
.lb-row:hover{background:var(--card2);}
.lb-row.me{background:rgba(255,107,53,0.08);border:1px solid rgba(255,107,53,0.2);}
.lb-rank{font-family:'Space Mono',monospace;font-size:0.9rem;font-weight:700;
  width:28px;text-align:center;flex-shrink:0;}
.lb-rank.gold{color:#ffd166;}
.lb-rank.silver{color:#a7a9be;}
.lb-rank.bronze{color:#cd7f32;}
.lb-info{flex:1;}
.lb-name{font-size:0.88rem;font-weight:700;}
.lb-detail{font-size:0.72rem;color:var(--muted);margin-top:1px;}
.lb-value{font-family:'Space Mono',monospace;font-size:0.95rem;font-weight:700;color:var(--a2);}
.lb-empty{text-align:center;padding:32px 16px;color:var(--muted);font-size:0.85rem;line-height:1.7;}
.req-badge{background:var(--accent);color:white;font-size:0.65rem;font-weight:900;
  padding:2px 6px;border-radius:99px;margin-left:6px;display:none;}


#results-card-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:500;
  display:none;align-items:center;justify-content:center;padding:20px;}
#results-card-overlay.show{display:flex;}
#results-card{background:linear-gradient(145deg,#1a1830,#201e38);border:1px solid rgba(255,255,255,0.1);
  border-radius:24px;padding:28px 24px;width:100%;max-width:360px;position:relative;
  box-shadow:0 24px 64px rgba(0,0,0,0.6);}
.rc-close{position:absolute;top:14px;right:14px;background:none;border:1px solid var(--border);
  color:var(--muted);width:28px;height:28px;border-radius:8px;cursor:pointer;font-size:0.9rem;
  display:flex;align-items:center;justify-content:center;transition:all 0.2s;}
.rc-close:hover{background:var(--card2);color:var(--text);}
.rc-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.rc-avatar{width:44px;height:44px;border-radius:50%;border:2px solid var(--accent);
  display:flex;align-items:center;justify-content:center;font-size:1.4rem;
  background:linear-gradient(135deg,rgba(255,107,53,0.2),rgba(199,125,255,0.2));}
.rc-avatar img{width:44px;height:44px;border-radius:50%;object-fit:cover;}
.rc-username{font-size:0.95rem;font-weight:900;}
.rc-topic{font-size:0.72rem;color:var(--muted);}
.rc-score-big{text-align:center;margin:16px 0;}
.rc-pct{font-family:'Space Mono',monospace;font-size:3.5rem;font-weight:700;
  background:linear-gradient(135deg,#06d6a0,#4cc9f0);-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.rc-pct-label{font-size:0.78rem;color:var(--muted);margin-top:4px;}
.rc-grade{display:inline-block;font-family:'Space Mono',monospace;font-size:1rem;
  font-weight:700;padding:4px 14px;border-radius:99px;margin-top:8px;}
.rc-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:16px 0;}
.rc-stat{background:rgba(255,255,255,0.05);border-radius:12px;padding:10px 8px;text-align:center;}
.rc-stat-num{font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;}
.rc-stat-label{font-size:0.65rem;color:var(--muted);margin-top:2px;}
.rc-branding{text-align:center;font-size:0.68rem;color:var(--muted);margin:12px 0 16px;
  letter-spacing:0.5px;}
.rc-branding strong{color:var(--accent);}
.rc-share-btn{width:100%;background:linear-gradient(135deg,var(--accent),#ff9a3c);border:none;
  color:white;font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:900;padding:12px;
  border-radius:12px;cursor:pointer;transition:opacity 0.2s;}
.rc-share-btn:hover{opacity:0.88;}
.rc-share-hint{font-size:0.72rem;color:var(--muted);text-align:center;margin-top:8px;}


#page-onboarding{display:none;position:relative;z-index:1;min-height:100vh;
  display:none;flex-direction:column;align-items:center;justify-content:center;
  padding:24px 16px;gap:0;}
#page-onboarding.active{display:flex;}
.onb-card{background:var(--card);border:1px solid var(--border);border-radius:24px;
  padding:28px 24px;width:100%;max-width:500px;box-shadow:var(--shadow);}
.onb-steps{display:flex;gap:6px;justify-content:center;margin-bottom:24px;}
.onb-step-dot{width:8px;height:8px;border-radius:50%;background:var(--card3);transition:all 0.3s;}
.onb-step-dot.active{background:var(--accent);width:24px;border-radius:99px;}
.onb-step-dot.done{background:var(--a3);}
.onb-step{display:none;}
.onb-step.active{display:block;animation:pageFadeIn 0.3s ease both;}
.onb-google-avatar{width:72px;height:72px;border-radius:50%;border:3px solid var(--accent);
  display:block;margin:0 auto 12px;}
.onb-google-avatar-placeholder{width:72px;height:72px;border-radius:50%;border:3px solid var(--accent);
  background:linear-gradient(135deg,var(--accent),var(--a5));display:flex;align-items:center;
  justify-content:center;font-size:2rem;margin:0 auto 12px;}
.onb-title{font-size:1.4rem;font-weight:900;text-align:center;margin-bottom:6px;}
.onb-sub{font-size:0.85rem;color:var(--muted);text-align:center;margin-bottom:20px;line-height:1.6;}
.onb-label{font-size:0.78rem;color:var(--muted);display:block;margin-bottom:5px;font-weight:700;}
.onb-input{width:100%;background:var(--card2);border:1.5px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:1rem;padding:10px 14px;border-radius:11px;
  outline:none;transition:border-color 0.2s;margin-bottom:14px;}
.onb-input:focus{border-color:var(--accent);}
.onb-next-btn{width:100%;background:linear-gradient(135deg,var(--accent),#ff9a3c);border:none;
  color:white;font-family:'Nunito',sans-serif;font-size:1rem;font-weight:900;padding:13px;
  border-radius:12px;cursor:pointer;transition:opacity 0.2s,transform 0.1s;margin-top:4px;}
.onb-next-btn:hover{opacity:0.9;transform:translateY(-1px);}
.onb-skip{background:none;border:none;color:var(--muted);font-family:'Nunito',sans-serif;
  font-size:0.78rem;cursor:pointer;margin-top:10px;display:block;width:100%;text-align:center;
  text-decoration:underline;transition:color 0.2s;}
.onb-skip:hover{color:var(--text);}
.avatar-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px;}
.avatar-opt{font-size:1.6rem;width:100%;aspect-ratio:1;border-radius:10px;border:2px solid var(--border);
  background:var(--card2);cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all 0.15s;}
.avatar-opt:hover{border-color:var(--accent);transform:scale(1.08);}
.avatar-opt.selected{border-color:var(--accent);background:rgba(255,107,53,0.12);}
.topic-onb-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px;}
.topic-onb-btn{background:var(--card2);border:2px solid var(--border);border-radius:12px;
  padding:10px 12px;cursor:pointer;text-align:left;transition:all 0.15s;display:flex;align-items:center;gap:8px;}
.topic-onb-btn:hover{border-color:var(--accent);}
.topic-onb-btn.selected{border-color:var(--accent);background:rgba(255,107,53,0.1);}
.topic-onb-btn .t-icon{font-size:1.2rem;}
.topic-onb-btn .t-name{font-size:0.8rem;font-weight:700;color:var(--muted);}
.onb-feature-list{display:flex;flex-direction:column;gap:10px;margin-bottom:20px;}
.onb-feature{display:flex;align-items:flex-start;gap:12px;padding:10px 12px;
  background:var(--card2);border-radius:10px;}
.onb-feature-icon{font-size:1.4rem;flex-shrink:0;}
.onb-feature-text strong{display:block;font-size:0.88rem;margin-bottom:2px;}
.onb-feature-text span{font-size:0.76rem;color:var(--muted);}


.google-btn{display:flex;align-items:center;justify-content:center;gap:10px;
  background:white;border:1.5px solid #ddd;border-radius:99px;color:#333;
  font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:700;
  padding:11px 28px;cursor:pointer;transition:all 0.2s;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
.google-btn:hover{box-shadow:0 4px 16px rgba(0,0,0,0.15);transform:translateY(-1px);}
.google-btn img{width:20px;height:20px;}
.auth-divider{display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--muted);font-size:0.78rem;}
.auth-divider::before,.auth-divider::after{content:'';flex:1;height:1px;background:var(--border);}
.auth-user-bar{display:none;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);
  border-radius:12px;padding:10px 14px;margin-bottom:12px;}
.auth-user-bar.show{display:flex;}
.auth-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;}
.auth-name{font-size:0.88rem;font-weight:700;flex:1;}
.auth-signout{background:none;border:1px solid var(--border);color:var(--muted);font-family:'Nunito',sans-serif;
  font-size:0.74rem;padding:4px 10px;border-radius:99px;cursor:pointer;transition:all 0.2s;}
.auth-signout:hover{border-color:var(--wrong);color:var(--wrong);}
.auth-status{font-size:0.72rem;color:var(--a3);margin-top:2px;}
.email-signup-box{background:linear-gradient(135deg,rgba(76,201,240,0.1),rgba(199,125,255,0.08));
  border:1px solid rgba(76,201,240,0.25);border-radius:16px;padding:18px 20px;margin-top:12px;}
.email-signup-box h4{font-size:0.95rem;font-weight:900;margin-bottom:4px;}
.email-signup-box p{font-size:0.8rem;color:var(--muted);margin-bottom:12px;line-height:1.5;}
.email-row{display:flex;gap:8px;flex-wrap:wrap;}
.email-input{flex:1;min-width:180px;background:var(--card2);border:1.5px solid var(--border);
  color:var(--text);font-family:'Nunito',sans-serif;font-size:0.9rem;padding:9px 13px;
  border-radius:10px;outline:none;transition:border-color 0.2s;}
.email-input:focus{border-color:#4cc9f0;}
.email-btn{background:linear-gradient(135deg,#4cc9f0,#c77dff);border:none;color:white;
  font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:800;padding:9px 20px;
  border-radius:10px;cursor:pointer;white-space:nowrap;transition:opacity 0.2s;}
.email-btn:hover{opacity:0.88;}
.email-success{font-size:0.82rem;color:var(--a3);font-weight:700;margin-top:8px;display:none;}

/* Name step that appears after email submit */
.name-step{display:none;animation:pageFadeIn 0.3s ease both;}
.name-step h4{font-size:0.95rem;font-weight:900;margin-bottom:3px;}
.name-step p{font-size:0.8rem;color:var(--muted);margin-bottom:12px;line-height:1.5;}
.name-fields{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
.name-fields .email-input{flex:1;min-width:120px;}
.name-submit-btn{background:linear-gradient(135deg,#4cc9f0,#c77dff);border:none;color:white;
  font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:800;padding:9px 20px;
  border-radius:10px;cursor:pointer;width:100%;transition:opacity 0.2s;}
.name-submit-btn:hover{opacity:0.88;}
.name-skip{background:none;border:none;color:var(--muted);font-family:'Nunito',sans-serif;
  font-size:0.75rem;cursor:pointer;margin-top:6px;text-decoration:underline;display:block;
  text-align:center;transition:color 0.2s;}
.name-skip:hover{color:var(--text);}


#q-streak-banner{display:none;align-items:center;gap:8px;padding:8px 14px;
  background:linear-gradient(135deg,rgba(255,107,53,0.15),rgba(255,154,60,0.1));
  border:1px solid rgba(255,107,53,0.3);border-radius:10px;margin-bottom:10px;
  animation:streakPop 0.4s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes streakPop{from{opacity:0;transform:scale(0.88)}to{opacity:1;transform:scale(1)}}
#q-streak-banner.show{display:flex;}
.qs-fire{font-size:1.2rem;}
.qs-label{font-size:0.8rem;font-weight:700;color:var(--accent);}
.qs-num{font-family:'Space Mono',monospace;font-size:1.1rem;font-weight:700;color:var(--a2);}
.qs-sub{font-size:0.72rem;color:var(--muted);margin-left:auto;}

/* Nav question streak pill */
#nav-qstreak{font-size:0.75rem;color:var(--a2);font-weight:700;display:none;}


#ach-toast{position:fixed;bottom:16px;right:16px;background:var(--card2);border:1px solid var(--a5);
  border-radius:14px;padding:12px 15px;z-index:500;transform:translateX(160%);
  transition:transform 0.45s cubic-bezier(0.34,1.56,0.64,1);max-width:240px;box-shadow:var(--shadow);}
#ach-toast.show{transform:translateX(0);}
.toast-badge{font-size:0.62rem;color:var(--a5);text-transform:uppercase;letter-spacing:1px;font-weight:700;}
.toast-title2{font-size:0.92rem;font-weight:800;margin-top:2px;}
.toast-desc2{font-size:0.73rem;color:var(--muted);margin-top:2px;}

/* â”€â”€â”€ XP POP â”€â”€â”€ */
.xp-pop{position:fixed;font-family:'Space Mono',monospace;font-size:1rem;font-weight:700;
  pointer-events:none;z-index:600;animation:xpFloat 1.3s ease forwards;}
@keyframes xpFloat{0%{opacity:1;transform:translateY(0) scale(1)}70%{opacity:1}100%{opacity:0;transform:translateY(-60px) scale(1.15)}}

/* â”€â”€â”€ SETTINGS â”€â”€â”€ */
.setting-row{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px 16px;
  display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.setting-label{font-size:0.88rem;font-weight:700;}
.setting-sub{font-size:0.72rem;color:var(--muted);margin-top:2px;}
.toggle{width:44px;height:24px;border-radius:99px;background:var(--card3);border:none;cursor:pointer;position:relative;transition:background 0.2s;flex-shrink:0;}
.toggle::after{content:'';position:absolute;width:18px;height:18px;border-radius:50%;background:white;top:3px;left:3px;transition:left 0.2s;}
.toggle.on{background:var(--a3);}
.toggle.on::after{left:23px;}
.select-input{background:var(--card2);border:1px solid var(--border);color:var(--text);font-family:'Nunito',sans-serif;font-size:0.82rem;padding:5px 10px;border-radius:8px;outline:none;cursor:pointer;}
.danger-btn{background:rgba(239,71,111,0.15);border:1px solid rgba(239,71,111,0.3);color:var(--wrong);font-family:'Nunito',sans-serif;font-size:0.85rem;font-weight:700;padding:9px 20px;border-radius:10px;cursor:pointer;transition:all 0.2s;}
.danger-btn:hover{background:rgba(239,71,111,0.25);}

/* â”€â”€â”€ MISC â”€â”€â”€ */
.card-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:14px;}
.card-section h3{font-size:0.92rem;font-weight:700;margin-bottom:12px;}
.chip{padding:3px 10px;border-radius:99px;font-size:0.7rem;font-weight:700;}
.chip-blue{background:rgba(17,138,178,0.2);color:var(--a4);}
.chip-green{background:rgba(6,214,160,0.2);color:var(--a3);}
.chip-purple{background:rgba(199,125,255,0.2);color:var(--a5);}
.chip-red{background:rgba(239,71,111,0.2);color:var(--wrong);}
.tag-wrap{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}

/* â”€â”€â”€ ROADMAP PAGE â”€â”€â”€ */
.roadmap-item{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 18px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start;}
.rm-num{width:32px;height:32px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900;font-size:0.9rem;flex-shrink:0;}
.rm-title{font-size:0.9rem;font-weight:700;margin-bottom:3px;}
.rm-desc{font-size:0.78rem;color:var(--muted);line-height:1.5;}
.phase-label{font-size:0.68rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--a5);font-weight:700;margin:18px 0 8px;}
.effort-chip{display:inline-block;font-size:0.65rem;padding:2px 8px;border-radius:99px;margin-left:6px;font-weight:700;}
.e-low{background:rgba(6,214,160,0.2);color:var(--a3);}
.e-med{background:rgba(255,209,102,0.2);color:var(--a2);}
.e-high{background:rgba(239,71,111,0.2);color:var(--wrong);}
.tech-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:8px;margin-top:8px;}
.tech-card{background:var(--card2);border-radius:10px;padding:10px 12px;font-size:0.78rem;}
.tech-card strong{display:block;color:var(--text);margin-bottom:2px;}
.tech-card span{color:var(--muted);font-size:0.7rem;}

/* â”€â”€â”€ SMOOTHER GLOBAL ANIMATIONS â”€â”€â”€ */
*{transition-timing-function:cubic-bezier(0.4,0,0.2,1);}
.page{animation:pageFadeIn 0.28s ease both;}
@keyframes pageFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.opt-btn{transition:background 0.18s,border-color 0.18s,transform 0.15s,box-shadow 0.18s;}
.opt-btn:hover:not(:disabled){transform:translateX(3px) scale(1.01);box-shadow:0 4px 16px rgba(255,107,53,0.15);}
.dash-card{transition:transform 0.2s,box-shadow 0.2s;}
.dash-card:hover{transform:translateY(-3px);box-shadow:0 8px 24px rgba(0,0,0,0.3);}
.ach-card{transition:transform 0.2s,box-shadow 0.2s,border-color 0.2s;}
.ach-card:hover{transform:translateY(-3px);box-shadow:0 8px 20px rgba(199,125,255,0.15);}
.modal-box{animation:modalPop 0.3s cubic-bezier(0.34,1.56,0.64,1) both;}
@keyframes modalPop{from{opacity:0;transform:scale(0.92) translateY(10px)}to{opacity:1;transform:scale(1) translateY(0)}}
#question-card{transition:box-shadow 0.3s;}
.numpad-btn{transition:background 0.1s,transform 0.1s,border-color 0.15s;}
.tool-btn{transition:background 0.18s,color 0.18s,border-color 0.18s,transform 0.1s;}
.tool-btn:hover{transform:translateY(-1px);}
.topic-card-item{transition:transform 0.2s,border-color 0.2s,box-shadow 0.2s,background 0.2s;}
.topic-card-item:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,0.3);}
.shop-item{transition:transform 0.2s,border-color 0.2s,box-shadow 0.2s;}
.shop-item:hover{transform:translateY(-2px);}

/* â”€â”€â”€ TOPIC PICKER BUTTON â”€â”€â”€ */
.btn-topic-pick{background:var(--card);border:1.5px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;padding:8px 14px;
  border-radius:12px;cursor:pointer;display:flex;align-items:center;gap:8px;
  transition:border-color 0.2s,background 0.2s,transform 0.15s;}
.btn-topic-pick:hover{border-color:var(--accent);background:var(--card2);transform:translateY(-1px);}

/* â”€â”€â”€ TOPIC MODAL CARDS â”€â”€â”€ */
.topic-card-item{background:var(--card2);border:1.5px solid var(--border);border-radius:14px;
  padding:14px 12px;cursor:pointer;text-align:center;position:relative;}
.topic-card-item.selected{border-color:var(--accent);background:rgba(255,107,53,0.08);}
.topic-card-item.active-topic{border-color:var(--a3);}
.tci-check{position:absolute;top:8px;right:8px;width:18px;height:18px;border-radius:5px;border:2px solid var(--border);background:var(--card3);display:flex;align-items:center;justify-content:center;font-size:0.65rem;transition:all 0.15s;}
.topic-card-item.selected .tci-check{background:var(--accent);border-color:var(--accent);color:white;}
.tci-icon{font-size:1.6rem;display:block;margin-bottom:5px;}
.tci-name{font-size:0.78rem;font-weight:700;display:block;margin-bottom:3px;}
.tci-acc{font-size:0.65rem;color:var(--muted);}
.tci-bar{height:3px;background:var(--card3);border-radius:99px;overflow:hidden;margin-top:5px;}
.tci-bar-fill{height:100%;border-radius:99px;transition:width 0.6s;}

/* â”€â”€â”€ SHOP â”€â”€â”€ */
.shop-item{background:var(--card2);border:1.5px solid var(--border);border-radius:14px;padding:14px 12px;text-align:center;cursor:pointer;}
.shop-item.owned{border-color:var(--a3);background:rgba(6,214,160,0.06);cursor:default;}
.shop-item.equipped{border-color:var(--a5);background:rgba(199,125,255,0.08);}
.shop-item.locked{opacity:0.6;}
.shop-icon{font-size:1.8rem;display:block;margin-bottom:5px;}
.shop-name{font-size:0.74rem;font-weight:700;display:block;margin-bottom:3px;}
.shop-cost{font-size:0.7rem;color:var(--a2);font-family:'Space Mono',monospace;font-weight:700;}
.shop-status{font-size:0.65rem;margin-top:4px;font-weight:700;}

/* â”€â”€â”€ STUDY / TEST MODE BANNER â”€â”€â”€ */
#mode-banner{display:none;background:rgba(17,138,178,0.12);border:1px solid rgba(17,138,178,0.3);border-radius:10px;padding:8px 14px;margin-bottom:10px;font-size:0.78rem;color:var(--a4);}
#mode-banner.visible{display:flex;align-items:center;justify-content:space-between;}
#concepts-content p{font-size:0.88rem;line-height:1.7;color:var(--text);}

.numpad-btn{background:var(--card2);border:1.5px solid var(--border);border-radius:12px;color:var(--text);
  font-family:'Space Mono',monospace;font-size:1.2rem;font-weight:700;padding:14px 8px;cursor:pointer;
  transition:all 0.12s;user-select:none;-webkit-user-select:none;}
.numpad-btn:active{transform:scale(0.93);background:var(--card3);}
.numpad-btn:hover{background:var(--card3);border-color:var(--accent);}
.numpad-clear{background:rgba(239,71,111,0.1);border-color:rgba(239,71,111,0.3);color:var(--wrong);}
.numpad-submit{background:linear-gradient(135deg,var(--a3),#05b889);border-color:var(--a3);color:#000;}
.numpad-submit:hover{opacity:0.9;}

/* â”€â”€â”€ SELECT INPUT â”€â”€â”€ */
.select-input{background:var(--card2);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Nunito',sans-serif;cursor:pointer;appearance:none;-webkit-appearance:none;}
.select-input:focus{outline:none;border-color:var(--accent);}


.sort-item{background:var(--card2);border:1.5px solid var(--border);border-radius:10px;padding:11px 14px;
  font-size:1rem;font-weight:700;cursor:grab;display:flex;align-items:center;gap:10px;
  transition:transform 0.15s,border-color 0.15s;user-select:none;}
.sort-item:active{cursor:grabbing;transform:scale(1.02);border-color:var(--accent);}
.sort-item.drag-over{border-color:var(--a3);background:rgba(6,214,160,0.08);}
.sort-item.selected{border-color:var(--accent);background:rgba(255,107,53,0.08);}


.inline-frac{display:inline-flex;flex-direction:column;align-items:center;vertical-align:middle;font-size:0.85em;line-height:1.1;margin:0 2px;}
.inline-frac sup,.inline-frac sub{font-size:1em;line-height:1;}
sup{font-size:0.7em;vertical-align:super;line-height:0;}
sub{font-size:0.7em;vertical-align:sub;line-height:0;}
.sqrt-wrap{display:inline-flex;align-items:center;gap:0;}
.sqrt-inner{border-top:1.5px solid currentColor;padding:0 2px;display:inline-block;}
.opt-btn sup,.opt-btn sub{font-size:0.72em;}
#question-text sup,#question-text sub{font-size:0.72em;}


.pro-badge{background:linear-gradient(135deg,#ffd166,#ff9a3c);color:#000;font-size:0.65rem;font-weight:900;padding:2px 7px;border-radius:99px;letter-spacing:0.5px;text-transform:uppercase;vertical-align:middle;}
.upgrade-btn{background:linear-gradient(135deg,#ffd166,#ff9a3c);border:none;color:#000;font-family:'Nunito',sans-serif;font-size:0.72rem;font-weight:900;padding:4px 12px;border-radius:99px;cursor:pointer;transition:all 0.2s;white-space:nowrap;}
.upgrade-btn:hover{transform:scale(1.05);box-shadow:0 0 16px rgba(255,209,102,0.5);}
.pro-modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:500;overflow-y:auto;padding:16px;align-items:center;justify-content:center;}
.pro-modal-overlay.show{display:flex;}
.pro-modal{background:var(--card);border-radius:24px;max-width:500px;width:100%;padding:28px 24px;border:1.5px solid rgba(255,209,102,0.4);box-shadow:0 0 60px rgba(255,209,102,0.15);position:relative;margin:auto;}
.pro-modal-close{position:absolute;top:14px;right:14px;background:none;border:1px solid var(--border);color:var(--muted);width:30px;height:30px;border-radius:8px;cursor:pointer;font-size:1rem;}
.pro-title{font-size:1.6rem;font-weight:900;text-align:center;margin-bottom:4px;background:linear-gradient(135deg,#ffd166,#ff9a3c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.pro-sub{text-align:center;color:var(--muted);font-size:0.85rem;margin-bottom:20px;}
.pro-tier-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
.pro-tier{border-radius:16px;padding:18px 16px;border:1.5px solid var(--border);background:var(--card2);}
.pro-tier.highlight{border-color:rgba(255,209,102,0.5);background:rgba(255,209,102,0.05);}
.pt-label{font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;}
.pt-name{font-size:1.1rem;font-weight:900;margin:4px 0;}
.pt-price{font-family:'Space Mono',monospace;font-size:1.3rem;font-weight:700;color:var(--a2);}
.pt-period{font-size:0.72rem;color:var(--muted);}
.pt-features{margin-top:12px;font-size:0.78rem;color:var(--muted);line-height:1.8;}
.pt-features li{list-style:none;padding-left:0;}
.pt-features li::before{content:'âœ“ ';color:var(--a3);font-weight:700;}
.pt-cta{width:100%;margin-top:14px;padding:10px;border-radius:10px;font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer;border:none;transition:all 0.2s;}
.pt-cta-free{background:var(--card3);color:var(--muted);}
.pt-cta-pro{background:linear-gradient(135deg,#ffd166,#ff9a3c);color:#000;}
.pt-cta-pro:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(255,209,102,0.4);}
.lifetime-row{background:linear-gradient(135deg,rgba(199,125,255,0.1),rgba(17,138,178,0.1));border:1px solid rgba(199,125,255,0.3);border-radius:14px;padding:16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.lt-info strong{font-size:1rem;}
.lt-info p{font-size:0.75rem;color:var(--muted);margin-top:2px;}
.lt-price{font-family:'Space Mono',monospace;font-size:1.4rem;font-weight:700;color:var(--a5);}

@media(max-width:520px){
  #options-grid{grid-template-columns:1fr;}
  .formula-grid{grid-template-columns:1fr;}
  .nav-tabs{display:none;}
  .onboard-grid{grid-template-columns:1fr 1fr;}
}

/* â”€â”€â”€ RANK SYSTEM â”€â”€â”€ */
:root {
  --rank-apprentice:#a0a0b0;
  --rank-scholar:#4cc9f0;
  --rank-thinker:#06d6a0;
  --rank-analyst:#c77dff;
  --rank-sage:#ffd166;
  --rank-genius:#118ab2;
  --rank-mastermind:#f72585;
}
.rank-badge {
  display:inline-flex;align-items:center;gap:6px;padding:4px 14px;
  border-radius:99px;font-size:0.8rem;font-weight:900;letter-spacing:0.5px;
  border:1.5px solid;
}
.rank-apprentice { background:rgba(160,160,176,0.15);border-color:var(--rank-apprentice);color:var(--rank-apprentice); }
.rank-scholar    { background:rgba(76,201,240,0.15);border-color:var(--rank-scholar);color:var(--rank-scholar); }
.rank-thinker    { background:rgba(6,214,160,0.15);border-color:var(--rank-thinker);color:var(--rank-thinker); }
.rank-analyst    { background:rgba(199,125,255,0.15);border-color:var(--rank-analyst);color:var(--rank-analyst); }
.rank-sage       { background:rgba(255,209,102,0.15);border-color:var(--rank-sage);color:var(--rank-sage); }
.rank-genius     { background:rgba(17,138,178,0.15);border-color:var(--rank-genius);color:var(--rank-genius); }
.rank-mastermind { background:rgba(247,37,133,0.2);border-color:var(--rank-mastermind);color:var(--rank-mastermind);animation:mastermindGlow 2s ease-in-out infinite alternate; }
@keyframes mastermindGlow{from{box-shadow:0 0 8px rgba(247,37,133,0.3)}to{box-shadow:0 0 18px rgba(247,37,133,0.7)}}

/* â”€â”€â”€ RANKED LANDING PAGE â”€â”€â”€ */
.mode-landing {
  background:var(--card);border:1px solid var(--border);border-radius:20px;
  padding:28px 24px;margin-bottom:20px;
}
.mode-landing-header {
  display:flex;align-items:center;gap:14px;margin-bottom:16px;
}
.mode-landing-icon {
  width:60px;height:60px;border-radius:16px;display:flex;align-items:center;
  justify-content:center;font-size:2rem;flex-shrink:0;
}
.mode-landing-icon.ranked { background:rgba(255,209,102,0.15);border:1.5px solid rgba(255,209,102,0.4); }
.mode-landing-icon.casual { background:rgba(76,201,240,0.12);border:1.5px solid rgba(76,201,240,0.3); }
.mode-landing-title { font-size:1.4rem;font-weight:900; }
.mode-landing-sub { font-size:0.82rem;color:var(--muted);margin-top:2px; }
.mode-info-grid { display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px 0; }
.mode-info-card { background:var(--card2);border:1px solid var(--border);border-radius:12px;padding:12px 14px; }
.mode-info-label { font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;margin-bottom:4px; }
.mode-info-val { font-size:0.9rem;font-weight:700; }
.queue-btn {
  width:100%;padding:14px;border-radius:14px;font-family:'Nunito',sans-serif;
  font-size:1.05rem;font-weight:900;border:none;cursor:pointer;transition:all 0.2s;
  display:flex;align-items:center;justify-content:center;gap:10px;
}
.queue-btn.ranked { background:linear-gradient(135deg,#ffd166,#ff9a3c);color:#000; }
.queue-btn.ranked:hover { transform:translateY(-2px);box-shadow:0 8px 24px rgba(255,209,102,0.4); }
.queue-btn.casual { background:linear-gradient(135deg,#4cc9f0,#118ab2);color:#fff; }
.queue-btn.casual:hover { transform:translateY(-2px);box-shadow:0 8px 24px rgba(76,201,240,0.4); }

/* â”€â”€â”€ RANK TIERS DISPLAY â”€â”€â”€ */
.rank-tiers-grid {
  display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin:12px 0;
}
.rank-tier-card {
  background:var(--card2);border:1.5px solid var(--border);border-radius:14px;
  padding:14px 10px;text-align:center;transition:transform 0.2s,border-color 0.2s;
}
.rank-tier-card:hover { transform:translateY(-2px); }
.rank-tier-card.current { border-color:var(--accent);background:rgba(255,107,53,0.08); }
.rank-tier-icon { font-size:1.8rem;display:block;margin-bottom:6px; }
.rank-tier-name { font-size:0.8rem;font-weight:900;display:block;margin-bottom:2px; }
.rank-tier-sub { font-size:0.65rem;color:var(--muted); }
.rank-lp-bar-wrap { height:6px;background:var(--card3);border-radius:99px;overflow:hidden;margin-top:8px; }
.rank-lp-bar { height:100%;border-radius:99px;transition:width 0.6s; }

/* â”€â”€â”€ RANKED LEADERBOARD â”€â”€â”€ */
.ranked-lb-row {
  display:flex;align-items:center;gap:12px;padding:10px 14px;
  background:var(--card2);border:1px solid var(--border);border-radius:12px;
  margin-bottom:6px;transition:background 0.2s;
}
.ranked-lb-row.me { background:rgba(255,107,53,0.1);border-color:var(--accent); }
.ranked-lb-pos { font-family:'Space Mono',monospace;font-size:0.8rem;font-weight:700;width:28px;text-align:center;flex-shrink:0; }
.ranked-lb-avatar { font-size:1.3rem;flex-shrink:0; }
.ranked-lb-info { flex:1;min-width:0; }
.ranked-lb-name { font-size:0.85rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; }
.ranked-lb-rank { font-size:0.68rem;color:var(--muted); }
.ranked-lb-lp { font-family:'Space Mono',monospace;font-size:0.82rem;font-weight:700;color:var(--a2);flex-shrink:0; }

/* â”€â”€â”€ DUELS PAGE â”€â”€â”€ */
.duels-hero {
  background:linear-gradient(135deg,rgba(247,37,133,0.12),rgba(199,125,255,0.1));
  border:1px solid rgba(247,37,133,0.25);border-radius:20px;
  padding:24px;margin-bottom:20px;text-align:center;
}
.duels-hero-title { font-size:1.5rem;font-weight:900;margin-bottom:4px; }
.duels-hero-sub { color:var(--muted);font-size:0.85rem;margin-bottom:16px; }
.duel-record-row { display:flex;gap:12px;justify-content:center;margin-bottom:16px;flex-wrap:wrap; }
.duel-record-card { background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px 20px;text-align:center; }
.duel-record-num { font-family:'Space Mono',monospace;font-size:1.4rem;font-weight:700; }
.duel-record-lbl { font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px; }
.friends-duel-list .friend-item { cursor:default; }




/* â”€â”€â”€ CUSTOM DIALOG (replaces alert/confirm/prompt) â”€â”€â”€ */
#custom-dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:2000;
  display:none;align-items:center;justify-content:center;padding:20px;}
#custom-dialog-overlay.show{display:flex;}
#custom-dialog{background:var(--card);border:1px solid var(--border);border-radius:20px;
  padding:28px 24px;width:100%;max-width:360px;text-align:center;
  box-shadow:0 24px 64px rgba(0,0,0,0.6);animation:cdPop 0.3s cubic-bezier(0.34,1.56,0.64,1);}
@keyframes cdPop{from{transform:scale(0.85);opacity:0}to{transform:scale(1);opacity:1}}
.cd-icon{font-size:2.5rem;display:block;margin-bottom:12px;}
.cd-title{font-size:1.1rem;font-weight:900;margin-bottom:8px;}
.cd-msg{font-size:0.85rem;color:var(--muted);line-height:1.6;margin-bottom:20px;}
.cd-input{width:100%;background:var(--card2);border:1.5px solid var(--border);color:var(--text);
  font-family:'Nunito',sans-serif;font-size:0.95rem;padding:10px 14px;border-radius:12px;
  outline:none;margin-bottom:16px;transition:border-color 0.2s;text-align:center;}
.cd-input:focus{border-color:var(--accent);}
.cd-btns{display:flex;gap:10px;}
.cd-btn-primary{flex:1;background:linear-gradient(135deg,var(--accent),#ff9a3c);border:none;
  color:white;font-family:'Nunito',sans-serif;font-size:0.92rem;font-weight:900;
  padding:11px;border-radius:12px;cursor:pointer;transition:opacity 0.2s;}
.cd-btn-primary:hover{opacity:0.88;}
.cd-btn-secondary{flex:1;background:var(--card2);border:1px solid var(--border);color:var(--muted);
  font-family:'Nunito',sans-serif;font-size:0.92rem;font-weight:700;
  padding:11px;border-radius:12px;cursor:pointer;transition:all 0.2s;}
.cd-btn-secondary:hover{background:var(--card3);color:var(--text);}
.cd-btn-danger{flex:1;background:rgba(239,71,111,0.15);border:1px solid rgba(239,71,111,0.4);
  color:var(--wrong);font-family:'Nunito',sans-serif;font-size:0.92rem;font-weight:900;
  padding:11px;border-radius:12px;cursor:pointer;transition:all 0.2s;}
.cd-btn-danger:hover{background:rgba(239,71,111,0.25);}

/* â”€â”€â”€ PRE-DUEL INTRO SCREEN â”€â”€â”€ */
#preduel-intro{position:fixed;inset:0;background:var(--bg);z-index:900;
  display:none;align-items:center;justify-content:center;flex-direction:column;
  gap:0;overflow:hidden;}
#preduel-intro.show{display:flex;}
.pdi-bg{position:absolute;inset:0;background:radial-gradient(ellipse at 30% 50%,rgba(6,214,160,0.12) 0%,transparent 60%),
  radial-gradient(ellipse at 70% 50%,rgba(247,37,133,0.12) 0%,transparent 60%);pointer-events:none;}
.pdi-inner{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;
  gap:24px;width:100%;max-width:560px;padding:24px;}
.pdi-title{font-family:'Space Mono',monospace;font-size:0.72rem;letter-spacing:3px;
  text-transform:uppercase;color:var(--muted);text-align:center;}
.pdi-ranked-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 14px;
  border-radius:99px;font-size:0.72rem;font-weight:700;letter-spacing:0.5px;}
.pdi-ranked-badge.ranked{background:rgba(255,209,102,0.15);border:1px solid rgba(255,209,102,0.4);color:var(--a2);}
.pdi-ranked-badge.unranked{background:rgba(76,201,240,0.12);border:1px solid rgba(76,201,240,0.3);color:#4cc9f0;}
.pdi-players{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px;width:100%;}
.pdi-player{display:flex;flex-direction:column;align-items:center;gap:10px;animation:pdiSlideIn 0.6s cubic-bezier(0.34,1.2,0.64,1);}
.pdi-player.them{animation:pdiSlideInRight 0.6s cubic-bezier(0.34,1.2,0.64,1);}
@keyframes pdiSlideIn{from{transform:translateX(-60px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes pdiSlideInRight{from{transform:translateX(60px);opacity:0}to{transform:translateX(0);opacity:1}}
.pdi-avatar{width:96px;height:96px;border-radius:24px;display:flex;align-items:center;
  justify-content:center;font-size:3rem;position:relative;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);}
.pdi-avatar.me{background:linear-gradient(135deg,rgba(6,214,160,0.25),rgba(76,201,240,0.15));
  border:2px solid rgba(6,214,160,0.4);}
.pdi-avatar.them{background:linear-gradient(135deg,rgba(247,37,133,0.25),rgba(199,125,255,0.15));
  border:2px solid rgba(247,37,133,0.4);}
.pdi-player-name{font-size:0.92rem;font-weight:900;text-align:center;max-width:120px;
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pdi-player-title{font-size:0.68rem;color:var(--muted);font-weight:700;text-align:center;
  background:var(--card);border:1px solid var(--border);border-radius:99px;padding:2px 10px;}
.pdi-player-record{font-family:'Space Mono',monospace;font-size:0.7rem;color:var(--muted);}
.pdi-vs{text-align:center;}
.pdi-vs-text{font-family:'Space Mono',monospace;font-size:2.2rem;font-weight:700;
  background:linear-gradient(135deg,var(--a6),var(--a5));-webkit-background-clip:text;
  -webkit-text-fill-color:transparent;background-clip:text;
  animation:vsPulse 0.8s ease-in-out infinite alternate;}
@keyframes vsPulse{from{filter:brightness(1)}to{filter:brightness(1.4)}}
.pdi-topic-info{background:var(--card);border:1px solid var(--border);border-radius:14px;
  padding:12px 20px;text-align:center;width:100%;}
.pdi-topic-label{font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.pdi-topic-name{font-size:1rem;font-weight:900;color:var(--a5);}
.pdi-topic-rounds{font-size:0.75rem;color:var(--muted);margin-top:2px;}

/* â”€â”€â”€ RANKED MATCHMAKING QUEUE â”€â”€â”€ */
#matchmaking-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.85);z-index:850;
  display:none;align-items:center;justify-content:center;padding:20px;}
#matchmaking-overlay.show{display:flex;}
#matchmaking-card{background:var(--card);border:1px solid var(--border);border-radius:24px;
  padding:32px 24px;width:100%;max-width:380px;text-align:center;
  box-shadow:0 24px 64px rgba(0,0,0,0.7);}
.mm-radar{width:80px;height:80px;border-radius:50%;background:rgba(6,214,160,0.08);
  border:2px solid rgba(6,214,160,0.3);margin:0 auto 20px;position:relative;
  display:flex;align-items:center;justify-content:center;font-size:2rem;}
.mm-radar::before{content:'';position:absolute;inset:-8px;border-radius:50%;
  border:2px solid rgba(6,214,160,0.15);animation:radarPing 1.5s ease-out infinite;}
.mm-radar::after{content:'';position:absolute;inset:-18px;border-radius:50%;
  border:2px solid rgba(6,214,160,0.08);animation:radarPing 1.5s ease-out infinite 0.5s;}
@keyframes radarPing{0%{transform:scale(0.8);opacity:0.8}100%{transform:scale(1.3);opacity:0}}
.mm-title{font-size:1.1rem;font-weight:900;margin-bottom:6px;}
.mm-status{font-size:0.82rem;color:var(--muted);margin-bottom:16px;line-height:1.5;}
.mm-timer{font-family:'Space Mono',monospace;font-size:2rem;font-weight:700;
  color:var(--a3);margin-bottom:8px;}
.mm-expand-msg{background:rgba(255,209,102,0.1);border:1px solid rgba(255,209,102,0.3);
  border-radius:10px;padding:10px 14px;font-size:0.8rem;color:var(--a2);
  margin-bottom:14px;display:none;animation:fadeIn 0.3s;}
.mm-type-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 14px;
  border-radius:99px;font-size:0.78rem;font-weight:700;margin-bottom:16px;}
.mm-type-badge.ranked{background:rgba(255,209,102,0.12);border:1px solid rgba(255,209,102,0.35);color:var(--a2);}
.mm-type-badge.unranked{background:rgba(76,201,240,0.1);border:1px solid rgba(76,201,240,0.25);color:#4cc9f0;}
.mm-cancel-btn{background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'Nunito',sans-serif;font-size:0.85rem;font-weight:700;padding:9px 22px;
  border-radius:10px;cursor:pointer;transition:all 0.2s;margin-top:4px;}
.mm-cancel-btn:hover{border-color:var(--wrong);color:var(--wrong);}
.mm-topic-row{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-bottom:16px;}
.mm-topic-chip{background:var(--card2);border:1.5px solid var(--border);border-radius:99px;
  font-size:0.72rem;font-weight:700;padding:4px 10px;cursor:pointer;transition:all 0.2s;}
.mm-topic-chip.selected{background:rgba(199,125,255,0.15);border-color:var(--a5);color:var(--a5);}

/* â”€â”€â”€ AVATAR IDENTITY CARD (in nav) â”€â”€â”€ */
#nav-avatar-display{display:flex;align-items:center;gap:7px;cursor:pointer;
  padding:4px 10px;border-radius:12px;border:1px solid var(--border);
  transition:all 0.2s;background:var(--card);}
#nav-avatar-display:hover{border-color:var(--accent);background:var(--card2);}
#nav-avatar-emoji{font-size:1.3rem;line-height:1;}
#nav-avatar-info{display:flex;flex-direction:column;line-height:1.2;}
#nav-avatar-name{font-size:0.72rem;font-weight:700;max-width:80px;overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap;}
#nav-avatar-title{font-size:0.58rem;color:var(--a5);font-weight:700;}

/* â”€â”€â”€ AVATAR RARITY â”€â”€â”€ */
.rarity-common .shop-icon::after{display:none;}
.rarity-rare .shop-icon::after{content:'â˜…';position:absolute;top:-2px;right:-2px;font-size:0.55rem;color:#4cc9f0;}
.rarity-epic .shop-icon::after{content:'â—†';position:absolute;top:-2px;right:-2px;font-size:0.55rem;color:#a855f7;}
.rarity-legendary .shop-icon::after{content:'ðŸ‘‘';position:absolute;top:-4px;right:-4px;font-size:0.65rem;}
.rarity-badge{display:inline-block;font-size:0.6rem;font-weight:700;padding:1px 7px;
  border-radius:99px;margin-top:3px;letter-spacing:0.5px;}
.rarity-badge.common{background:rgba(167,169,190,0.2);color:var(--muted);}
.rarity-badge.rare{background:rgba(76,201,240,0.15);color:#4cc9f0;}
.rarity-badge.epic{background:rgba(168,85,247,0.15);color:#a855f7;}
.rarity-badge.legendary{background:rgba(255,209,102,0.15);color:var(--a2);}

/* â”€â”€â”€ RANKED MATCHMAKING BUTTON on friends page â”€â”€â”€ */
.ranked-duel-section{background:linear-gradient(135deg,rgba(255,107,53,0.08),rgba(199,125,255,0.05));
  border:1px solid rgba(255,107,53,0.2);border-radius:16px;padding:16px;margin-bottom:20px;}
.ranked-duel-title{font-size:0.92rem;font-weight:900;margin-bottom:4px;}
.ranked-duel-sub{font-size:0.78rem;color:var(--muted);margin-bottom:14px;line-height:1.5;}
.ranked-mode-btns{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.ranked-mode-btn{padding:12px 14px;border-radius:12px;border:none;cursor:pointer;
  font-family:'Nunito',sans-serif;font-weight:900;font-size:0.88rem;
  display:flex;flex-direction:column;align-items:center;gap:3px;transition:all 0.2s;}
.ranked-mode-btn .rmb-icon{font-size:1.4rem;}
.ranked-mode-btn .rmb-name{font-size:0.82rem;font-weight:900;}
.ranked-mode-btn .rmb-sub{font-size:0.65rem;opacity:0.8;}
.ranked-mode-btn.ranked-btn{background:linear-gradient(135deg,rgba(255,209,102,0.2),rgba(255,107,53,0.15));
  border:1.5px solid rgba(255,209,102,0.4);color:var(--a2);}
.ranked-mode-btn.ranked-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(255,209,102,0.2);}
.ranked-mode-btn.casual-btn{background:linear-gradient(135deg,rgba(76,201,240,0.15),rgba(6,214,160,0.1));
  border:1.5px solid rgba(76,201,240,0.3);color:#4cc9f0;}
.ranked-mode-btn.casual-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(76,201,240,0.15);}

/* â”€â”€â”€ SOUND TOGGLE IN PANEL â”€â”€â”€ */
.sound-wave{display:inline-flex;align-items:flex-end;gap:2px;height:14px;margin-right:4px;}
.sw-bar{width:3px;border-radius:99px;background:var(--a3);animation:swAnim 0.6s ease-in-out infinite alternate;}
.sw-bar:nth-child(1){height:4px;animation-delay:0s;}
.sw-bar:nth-child(2){height:8px;animation-delay:0.1s;}
.sw-bar:nth-child(3){height:12px;animation-delay:0.2s;}
.sw-bar:nth-child(4){height:8px;animation-delay:0.3s;}
.sw-bar:nth-child(5){height:4px;animation-delay:0.4s;}
@keyframes swAnim{from{transform:scaleY(0.5)}to{transform:scaleY(1)}}

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOADING SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loader">
  <div class="cube-scene">
    <div class="cube">
      <!-- Front face: has xÂ³ in center -->
      <div class="cube-face face-front">
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell center">x<sup>3</sup></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      </div>
      <!-- Back -->
      <div class="cube-face face-back">
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      </div>
      <!-- Right -->
      <div class="cube-face face-right">
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      </div>
      <!-- Left -->
      <div class="cube-face face-left">
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      </div>
      <!-- Top -->
      <div class="cube-face face-top">
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      </div>
      <!-- Bottom -->
      <div class="cube-face face-bottom">
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
        <div class="cell"></div><div class="cell"></div><div class="cell"></div>
      </div>
    </div>
  </div>
  <div class="loader-title">NUMIQUBE</div>
  <div class="loader-bar-wrap"><div class="loader-bar"></div></div>
  <div class="loader-sub">Loading your math world...</div>
</div>

<!-- Stars -->
<div id="stars-bg"></div>

<!-- Achievement Toast -->
<div id="ach-toast">
  <div class="toast-badge">ðŸ… Achievement Unlocked!</div>
  <div class="toast-title2" id="toast-name2">â€“</div>
  <div class="toast-desc2" id="toast-desc2">â€“</div>
</div>

<!-- Formula Modal -->
<div class="modal-overlay" id="formula-modal">
  <div class="modal-box">
    <button class="modal-close" onclick="closeModal('formula-modal')">âœ•</button>
    <h2 style="font-size:1.2rem;margin-bottom:2px;">ðŸ“‹ Formula Sheet</h2>
    <p style="font-size:0.75rem;color:var(--muted);margin-bottom:4px;">Everything you need â€” bookmark this!</p>
    <div class="formula-section"><h3>Quadratics</h3><div class="formula-grid">
      <div class="formula-card"><strong>Quadratic Formula</strong><span class="fn">x=(âˆ’bÂ±âˆš(bÂ²âˆ’4ac))/2a</span></div>
      <div class="formula-card"><strong>Discriminant Rules</strong><span class="fn">&gt;0: 2 roots Â· =0: 1 root Â· &lt;0: none</span></div>
      <div class="formula-card"><strong>Vertex Form</strong><span class="fn">y=a(xâˆ’h)Â²+k, vertex=(h,k)</span></div>
      <div class="formula-card"><strong>Vieta's</strong><span class="fn">sum=âˆ’b/a Â· product=c/a</span></div>
    </div></div>
    <div class="formula-section"><h3>Algebra & Sequences</h3><div class="formula-grid">
      <div class="formula-card"><strong>Slope</strong><span class="fn">m=(yâ‚‚âˆ’yâ‚)/(xâ‚‚âˆ’xâ‚)</span></div>
      <div class="formula-card"><strong>Slope-Intercept</strong><span class="fn">y=mx+b</span></div>
      <div class="formula-card"><strong>Arithmetic Seq</strong><span class="fn">aâ‚™=aâ‚+(nâˆ’1)d</span></div>
      <div class="formula-card"><strong>Geometric Seq</strong><span class="fn">aâ‚™=aâ‚Â·râ¿â»Â¹</span></div>
      <div class="formula-card"><strong>Sum 1 to n</strong><span class="fn">n(n+1)/2</span></div>
      <div class="formula-card"><strong>Arith. Series</strong><span class="fn">n(aâ‚+aâ‚™)/2</span></div>
      <div class="formula-card"><strong>Geo. Series</strong><span class="fn">aâ‚(râ¿âˆ’1)/(râˆ’1)</span></div>
      <div class="formula-card"><strong>Absolute Value</strong><span class="fn">|x|=a â†’ x=Â±a</span></div>
    </div></div>
    <div class="formula-section"><h3>Geometry</h3><div class="formula-grid">
      <div class="formula-card"><strong>Pythagorean</strong><span class="fn">aÂ²+bÂ²=cÂ²</span></div>
      <div class="formula-card"><strong>Circle</strong><span class="fn">A=Ï€rÂ² Â· C=2Ï€r</span></div>
      <div class="formula-card"><strong>Triangle Area</strong><span class="fn">A=Â½bh</span></div>
      <div class="formula-card"><strong>Trapezoid</strong><span class="fn">A=Â½(bâ‚+bâ‚‚)h</span></div>
      <div class="formula-card"><strong>Equilateral â–³</strong><span class="fn">A=(âˆš3/4)sÂ²</span></div>
      <div class="formula-card"><strong>30-60-90</strong><span class="fn">x Â· xâˆš3 Â· 2x</span></div>
      <div class="formula-card"><strong>45-45-90</strong><span class="fn">x Â· x Â· xâˆš2</span></div>
      <div class="formula-card"><strong>Cylinder</strong><span class="fn">V=Ï€rÂ²h</span></div>
      <div class="formula-card"><strong>Sphere</strong><span class="fn">V=(4/3)Ï€rÂ³</span></div>
      <div class="formula-card"><strong>Interior âˆ  sum</strong><span class="fn">(nâˆ’2)Ã—180Â°</span></div>
      <div class="formula-card"><strong>Diagonals</strong><span class="fn">n(nâˆ’3)/2</span></div>
      <div class="formula-card"><strong>Arc Length</strong><span class="fn">(Î¸/360)Â·2Ï€r</span></div>
    </div></div>
    <div class="formula-section"><h3>Number Theory & Combinatorics</h3><div class="formula-grid">
      <div class="formula-card"><strong>Permutations</strong><span class="fn">P(n,r)=n!/(nâˆ’r)!</span></div>
      <div class="formula-card"><strong>Combinations</strong><span class="fn">C(n,r)=n!/[r!(nâˆ’r)!]</span></div>
      <div class="formula-card"><strong>LCMÃ—GCD</strong><span class="fn">LCMÂ·GCD=aÂ·b</span></div>
      <div class="formula-card"><strong>Trailing zeros n!</strong><span class="fn">âŒŠn/5âŒ‹+âŒŠn/25âŒ‹+â€¦</span></div>
      <div class="formula-card"><strong>Inclusion-Exclusion</strong><span class="fn">|AâˆªB|=|A|+|B|âˆ’|Aâˆ©B|</span></div>
      <div class="formula-card"><strong>Circular Perms</strong><span class="fn">(nâˆ’1)!</span></div>
    </div></div>
    <div class="formula-section"><h3>Probability & Stats</h3><div class="formula-grid">
      <div class="formula-card"><strong>Probability</strong><span class="fn">P=favorable/total</span></div>
      <div class="formula-card"><strong>Complement</strong><span class="fn">P(not A)=1âˆ’P(A)</span></div>
      <div class="formula-card"><strong>Independent</strong><span class="fn">P(Aâˆ©B)=P(A)Â·P(B)</span></div>
      <div class="formula-card"><strong>Mean</strong><span class="fn">xÌ„=Î£x/n</span></div>
    </div></div>
    <p style="color:var(--muted);font-size:0.7rem;margin-top:12px;">Press Esc or click outside to close.</p>
  </div>
</div>

<!-- SHAREABLE RESULTS CARD -->
<div id="results-card-overlay">
  <div id="results-card">
    <button class="rc-close" onclick="closeResultsCard()">âœ•</button>
    <div class="rc-header">
      <div class="rc-avatar" id="rc-avatar">â­</div>
      <div>
        <div class="rc-username" id="rc-username">Student</div>
        <div class="rc-topic" id="rc-topic">Quadratics</div>
      </div>
    </div>
    <div class="rc-score-big">
      <div class="rc-pct" id="rc-pct">95%</div>
      <div class="rc-pct-label">Accuracy</div>
      <div class="rc-grade" id="rc-grade">A+</div>
    </div>
    <div class="rc-stats">
      <div class="rc-stat">
        <div class="rc-stat-num" id="rc-xp" style="color:var(--a2);">0</div>
        <div class="rc-stat-label">XP Earned</div>
      </div>
      <div class="rc-stat">
        <div class="rc-stat-num" id="rc-correct" style="color:var(--a3);">0</div>
        <div class="rc-stat-label">Correct</div>
      </div>
      <div class="rc-stat">
        <div class="rc-stat-num" id="rc-streak" style="color:var(--accent);">0</div>
        <div class="rc-stat-label">Best Streak</div>
      </div>
    </div>
    <div class="rc-branding">ðŸ§Š <strong>Numiqube</strong> Â· Free math for everyone</div>
    <button class="rc-share-btn" onclick="shareResultsCard()">ðŸ“¸ Save as image</button>
    <div class="rc-share-hint">Screenshot this card and share it with friends!</div>
  </div>
</div>

<!-- PRO UPGRADE MODAL -->
<div class="pro-modal-overlay" id="pro-modal">
  <div class="pro-modal">
    <button class="pro-modal-close" onclick="closeProModal()">âœ•</button>
    <div class="pro-title">Numiqube Pro â­</div>
    <p class="pro-sub">Unlock everything and blast through your goals faster.</p>

    <div class="pro-tier-grid">
      <div class="pro-tier">
        <div class="pt-label">Current Plan</div>
        <div class="pt-name">Free</div>
        <div class="pt-price">$0</div>
        <div class="pt-period">forever</div>
        <ul class="pt-features">
          <li>9 topics</li>
          <li>Progress tracking</li>
          <li>Achievements</li>
          <li>Leaderboard</li>
        </ul>
        <button class="pt-cta pt-cta-free" disabled>Current Plan</button>
      </div>
      <div class="pro-tier highlight">
        <div class="pt-label">ðŸ”¥ Most Popular</div>
        <div class="pt-name">Pro Monthly</div>
        <div class="pt-price">$2.99</div>
        <div class="pt-period">per month</div>
        <ul class="pt-features">
          <li>All 12 topics</li>
          <li>Hard + Extreme modes</li>
          <li>Unlimited goals</li>
          <li>Speed Mode unlocked</li>
          <li>No ads (ever)</li>
          <li>Priority new content</li>
        </ul>
        <button class="pt-cta pt-cta-pro" onclick="showComingSoon()">Get Pro Monthly</button>
      </div>
    </div>

    <div class="lifetime-row">
      <div class="lt-info">
        <strong>Lifetime Access ðŸš€</strong>
        <p>One-time payment, own it forever. Best deal.</p>
      </div>
      <div>
        <div class="lt-price">$14.99</div>
        <button class="pt-cta pt-cta-pro" style="width:auto;padding:8px 20px;font-size:0.8rem;margin-top:6px;" onclick="showComingSoon()">Get Lifetime</button>
      </div>
    </div>

    <p style="text-align:center;font-size:0.72rem;color:var(--muted);">Payments coming soon via Stripe Â· Cancel anytime Â· No hidden fees</p>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONCEPTS MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="concepts-modal" style="align-items:flex-start;padding-top:70px;">
  <div class="modal-box" style="max-width:580px;">
    <button class="modal-close" onclick="closeModal('concepts-modal')">âœ•</button>
    <div id="concepts-content"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     REPORT QUESTION MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="report-modal">
  <div class="modal-box" style="max-width:420px;">
    <button class="modal-close" onclick="closeModal('report-modal')">âœ•</button>
    <h2 style="font-size:1.1rem;font-weight:900;margin-bottom:4px;">ðŸš© Report This Question</h2>
    <p style="font-size:0.78rem;color:var(--muted);margin-bottom:14px;">Something wrong with this question? Let me know.</p>
    <div id="report-q-preview" style="background:var(--card2);border-radius:10px;padding:10px 12px;font-size:0.8rem;margin-bottom:12px;color:var(--muted);border-left:3px solid var(--wrong);"></div>
    <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">What's the issue?</label>
    <select id="report-type" class="select-input" style="width:100%;padding:9px 12px;font-size:0.85rem;margin-bottom:10px;">
      <option value="wrong_answer">Wrong answer / incorrect solution</option>
      <option value="confusing">Question is confusing or unclear</option>
      <option value="too_easy">Too easy for this difficulty</option>
      <option value="too_hard">Too hard for this difficulty</option>
      <option value="typo">Typo or formatting issue</option>
      <option value="other">Other</option>
    </select>
    <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Extra details (optional)</label>
    <textarea id="report-details" style="width:100%;background:var(--card2);border:1.5px solid var(--border);border-radius:10px;color:var(--text);font-family:'Nunito',sans-serif;font-size:0.85rem;padding:9px 12px;resize:vertical;min-height:70px;outline:none;margin-bottom:14px;" placeholder="Anything else you want to add..."></textarea>
    <button class="btn-primary" style="width:100%;font-size:0.9rem;padding:10px;" onclick="submitReport()">Send Report â†’</button>
  </div>
</div>


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="topic-modal" style="align-items:flex-start;padding-top:70px;">
  <div class="modal-box" style="max-width:600px;">
    <button class="modal-close" onclick="closeModal('topic-modal')">âœ•</button>
    <h2 style="font-size:1.1rem;font-weight:900;margin-bottom:2px;">ðŸ“š Choose Topics</h2>
    <p style="font-size:0.75rem;color:var(--muted);margin-bottom:12px;">Select one or more â€” questions will be mixed from everything you pick.</p>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;background:var(--card2);border-radius:10px;padding:10px 14px;">
      <span style="font-size:0.82rem;font-weight:700;" id="selected-count-label">All 12 selected</span>
      <button id="toggle-all-btn" onclick="toggleAllTopics()" style="background:var(--accent);border:none;color:white;font-family:'Nunito',sans-serif;font-size:0.75rem;font-weight:700;padding:5px 14px;border-radius:99px;cursor:pointer;">Deselect All</button>
    </div>
    <div id="topic-card-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:14px;"></div>
    <button class="btn-primary" style="width:100%;font-size:0.9rem;" onclick="confirmTopicSelection()">Study Selected Topics â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PRINT WORKSHEET MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="print-modal">
  <div class="modal-box" style="max-width:480px;">
    <button class="modal-close" onclick="closeModal('print-modal')">âœ•</button>
    <h2 style="font-size:1.1rem;font-weight:900;margin-bottom:4px;">ðŸ–¨ï¸ Print a Worksheet</h2>
    <p style="font-size:0.78rem;color:var(--muted);margin-bottom:16px;">Generates a clean, ink-friendly sheet you can print and take anywhere.</p>
    <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Topic</label>
    <select id="print-topic-sel" class="select-input" style="width:100%;margin-bottom:10px;padding:9px 12px;font-size:0.88rem;">
    </select>
    <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Number of Questions</label>
    <select id="print-count-sel" class="select-input" style="width:100%;margin-bottom:10px;padding:9px 12px;font-size:0.88rem;">
      <option value="10">10 questions</option>
      <option value="15" selected>15 questions</option>
      <option value="20">20 questions</option>
    </select>
    <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Difficulty</label>
    <select id="print-diff-sel" class="select-input" style="width:100%;margin-bottom:16px;padding:9px 12px;font-size:0.88rem;">
      <option value="all">All difficulties</option>
      <option value="easy">Easy only</option>
      <option value="medium">Medium only</option>
      <option value="hard">Hard only</option>
    </select>
    <button class="btn-primary" style="width:100%;" onclick="generateWorksheet()">ðŸ–¨ï¸ Generate & Print</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     XP REWARDS SHOP MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="shop-modal">
  <div class="modal-box" style="max-width:540px;">
    <button class="modal-close" onclick="closeModal('shop-modal')">âœ•</button>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;">
      <h2 style="font-size:1.1rem;font-weight:900;">ðŸ›ï¸ XP Rewards Shop</h2>
      <span style="font-family:'Space Mono',monospace;font-size:0.9rem;color:var(--a2);font-weight:700;" id="shop-xp-display">0 XP</span>
    </div>
    <p style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;">Spend your XP on cosmetic rewards. Can't be bought, only earned.</p>
    <div id="shop-items-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px;"></div>
  </div>
</div>

<!-- NAV -->
<nav id="nav">
  <div class="nav-logo" onclick="goHome()" style="cursor:pointer;" title="Back to Home">ðŸ§Š Numiqube</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showPage('study')">ðŸ“š Study</button>
    <button class="nav-tab" onclick="showPage('dashboard')">ðŸ  Dashboard</button>
    <button class="nav-tab" onclick="showPage('progress')">ðŸ“Š Progress</button>
    <button class="nav-tab" onclick="showPage('goals')">ðŸŽ¯ Goals</button>
    <button class="nav-tab" onclick="showPage('friends')">ðŸ‘¥ Friends<span class="req-badge" id="req-badge">0</span></button>
    <button class="nav-tab" onclick="showPage('duels')">âš”ï¸ Duels</button>
    <button class="nav-tab" onclick="showPage('settings')">âš™ï¸ Settings</button>
  </div>
  <div class="nav-right">
    <button class="upgrade-btn" onclick="openProModal()">â­ Upgrade</button>
    <span id="nav-streak">ðŸ”¥0</span>
    <span id="nav-qstreak">âš¡0</span>
    <div id="nav-avatar-display" onclick="openShop()" title="Your Avatar & Title">
      <span id="nav-avatar-emoji">â­</span>
      <div id="nav-avatar-info">
        <span id="nav-avatar-name">Player</span>
        <span id="nav-avatar-title">Student</span>
      </div>
    </div>
    <div id="nav-auth-bar" class="auth-user-bar" style="margin-bottom:0;padding:5px 10px;display:none;">
      <img id="nav-auth-avatar" class="auth-avatar" src="" alt="" style="width:24px;height:24px;"/>
      <span id="nav-auth-name" style="font-size:0.78rem;"></span>
      <button class="auth-signout" onclick="signOut()">Sign out</button>
    </div>
    <span id="nav-lvl">LVL 1</span>
    <span id="nav-xp">0 XP</span>
    <span id="nav-timer">00:00</span>
    <button class="nav-icon-btn" onclick="openShop()" title="XP Shop" style="font-size:0.75rem;font-weight:700;width:auto;padding:0 8px;">ðŸ›ï¸ Shop</button>
    <button class="nav-icon-btn" onclick="openModal('formula-modal')" title="Formula Sheet">ðŸ“‹</button>
    <button class="nav-icon-btn" onclick="toggleLight()" title="Theme" id="theme-btn">â˜€ï¸</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     WHY US MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-overlay" id="whyus-modal">
  <div class="modal-box" style="max-width:560px;border-color:rgba(76,201,240,0.3);">
    <button class="modal-close" onclick="closeModal('whyus-modal')">âœ•</button>
    <h2 style="font-size:1.3rem;font-weight:900;margin-bottom:4px;background:linear-gradient(135deg,#4cc9f0,#c77dff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">Why Numiqube?</h2>
    <p style="color:var(--muted);font-size:0.78rem;margin-bottom:18px;">Straight from the person who built it.</p>

    <div style="font-size:0.9rem;line-height:1.85;color:var(--text);">
      <p style="margin-bottom:14px;">I'm the solo creator of this website. The main reason I started it is because I needed somewhere I could study everything I had to practice â€” all in one place, quick and easy, without having to give all my information to big companies. Before this, I just printed out worksheets. It was boring, and it wasted a lot of ink. Ink costs money, so I thought: <em style="color:var(--a2);">"Why not make something that's digital, doesn't use ink, and actually helps?"</em> That's the reason Numiqube exists, and I really think you â€” whoever is reading this â€” will like it.</p>

      <p style="margin-bottom:14px;">There are a lot of math websites out there. Most of them are great at one thing, but stop being useful after a certain level. I wanted something that goes <strong style="color:var(--a2);">all the way</strong> â€” from literally counting apples, to competition-level hard problems â€” in one place.</p>

      <p style="margin-bottom:14px;">Here's what I think makes this different:</p>

      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px;">
        <div style="background:var(--card2);border-radius:10px;padding:12px 14px;border-left:3px solid var(--a3);">
          <strong style="font-size:0.85rem;">Every wrong answer teaches you something.</strong>
          <p style="color:var(--muted);font-size:0.78rem;margin-top:3px;">Every single question has a step-by-step breakdown. Not just "wrong, try again." You actually learn why you got it wrong.</p>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px 14px;border-left:3px solid var(--a5);">
          <strong style="font-size:0.85rem;">Your XP actually means something.</strong>
          <p style="color:var(--muted);font-size:0.78rem;margin-top:3px;">Earn XP and spend it on real rewards â€” unlock new themes, profile titles, and avatar icons. Not just a number that sits there doing nothing.</p>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px 14px;border-left:3px solid var(--a4);">
          <strong style="font-size:0.85rem;">Study anywhere â€” even offline, on paper.</strong>
          <p style="color:var(--muted);font-size:0.78rem;margin-top:3px;">Print a custom worksheet from any topic, any difficulty. Real questions, clean format, no ink wasted on ads or logos.</p>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px 14px;border-left:3px solid var(--a2);">
          <strong style="font-size:0.85rem;">No ads. No "sign up to see the answer." No nonsense.</strong>
          <p style="color:var(--muted);font-size:0.78rem;margin-top:3px;">The free version is genuinely free. I hate when websites hide the useful stuff behind a paywall, so I didn't do that.</p>
        </div>
        <div style="background:var(--card2);border-radius:10px;padding:12px 14px;border-left:3px solid var(--accent);">
          <strong style="font-size:0.85rem;">Built by a student, not a corporation.</strong>
          <p style="color:var(--muted);font-size:0.78rem;margin-top:3px;">I'm not a company. I'm someone who needed a better tool and decided to build it. Every update comes from real feedback from real people using it.</p>
        </div>
      </div>

      <p style="color:var(--muted);font-size:0.8rem;">If you like it â€” share it with a friend. That's genuinely the biggest thing you can do. ðŸ™</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HOME / ONBOARDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-home">
  <!-- ? button top right -->
  <button onclick="openModal('whyus-modal')" style="position:fixed;top:16px;right:16px;width:36px;height:36px;border-radius:50%;background:var(--card);border:1.5px solid var(--border);color:var(--muted);font-size:1rem;font-weight:700;cursor:pointer;z-index:10;transition:all 0.2s;" onmouseover="this.style.borderColor='#4cc9f0';this.style.color='#4cc9f0'" onmouseout="this.style.borderColor='';this.style.color=''">?</button>

  <span class="rocket-anim">ðŸ§Š</span>
  <h1 class="home-title">Numiqube</h1>
  <p class="home-motto">"We have a lot. From counting, to calculus."</p>
  <p class="home-sub">The math study app that actually makes sense â€” for everyone.</p>

  <div class="onboard-grid">
    <div class="onboard-card"><span class="oc-icon">ðŸ“</span><strong>12 Topics</strong><span>Counting â†’ Calculus</span></div>
    <div class="onboard-card"><span class="oc-icon">ðŸ†</span><strong>Achievements</strong><span>20+ to unlock</span></div>
    <div class="onboard-card"><span class="oc-icon">ðŸ›ï¸</span><strong>XP Shop</strong><span>Spend XP on rewards</span></div>
    <div class="onboard-card"><span class="oc-icon">ðŸ”¥</span><strong>Streaks</strong><span>Study every day</span></div>
  </div>

  <!-- Google sign in -->
  <button class="google-btn" onclick="signInWithGoogle()">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google"/>
    Continue with Google
  </button>

  <div class="auth-divider">or</div>

  <!-- Guest / name entry -->
  <div class="name-input-wrap">
    <input id="username-input" placeholder="Your name (e.g. Alex)" maxlength="20"/>
    <button class="btn-primary" onclick="beginApp()">Let's go â†’</button>
  </div>
  <p style="color:var(--muted);font-size:0.75rem;margin-top:8px;">Guest progress saves in this browser only. Sign in with Google to sync everywhere.</p>

  <!-- Email signup -->
  <div class="email-signup-box" style="max-width:460px;width:100%;margin-top:8px;">
    <div id="home-step-email">
      <h4>ðŸ“¬ Stay in the loop</h4>
      <p>Get notified when new topics, features, and improvements drop. No spam, ever.</p>
      <div class="email-row">
        <input class="email-input" id="home-email-input" type="email" placeholder="your@email.com"/>
        <button class="email-btn" onclick="submitEmail('home')">Notify me â†’</button>
      </div>
    </div>
    <div class="name-step" id="home-step-name">
      <h4>ðŸ‘‹ Nice! One more thingâ€¦</h4>
      <p>What should we call you? (Last name is optional)</p>
      <div class="name-fields">
        <input class="email-input" id="home-first-name" placeholder="First name" maxlength="20"/>
        <input class="email-input" id="home-last-name" placeholder="Last name (optional)" maxlength="30"/>
      </div>
      <button class="name-submit-btn" onclick="submitName('home')">Let's go ðŸš€</button>
      <button class="name-skip" onclick="skipName('home')">Skip for now</button>
    </div>
    <div class="email-success" id="home-email-success">âœ… You're all set! Welcome to Numiqube.</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GOOGLE ONBOARDING PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-onboarding">
  <div class="onb-card">
    <!-- Step dots -->
    <div class="onb-steps">
      <div class="onb-step-dot active" id="onb-dot-0"></div>
      <div class="onb-step-dot" id="onb-dot-1"></div>
      <div class="onb-step-dot" id="onb-dot-2"></div>
      <div class="onb-step-dot" id="onb-dot-3"></div>
    </div>

    <!-- Step 0: Welcome + what is Numiqube -->
    <div class="onb-step active" id="onb-step-0">
      <div id="onb-avatar-wrap" class="onb-google-avatar-placeholder">ðŸ§Š</div>
      <h2 class="onb-title" id="onb-welcome-title">Welcome to Numiqube! ðŸ‘‹</h2>
      <p class="onb-sub">The math app that goes from counting to calculus â€” all in one place.</p>
      <div class="onb-feature-list">
        <div class="onb-feature">
          <span class="onb-feature-icon">ðŸŽ¯</span>
          <div class="onb-feature-text"><strong>Questions with real explanations</strong><span>Every wrong answer teaches you exactly what went wrong, step by step.</span></div>
        </div>
        <div class="onb-feature">
          <span class="onb-feature-icon">â­</span>
          <div class="onb-feature-text"><strong>Earn XP & unlock rewards</strong><span>Spend XP in the shop on themes, titles, and avatars.</span></div>
        </div>
        <div class="onb-feature">
          <span class="onb-feature-icon">ðŸ”¥</span>
          <div class="onb-feature-text"><strong>Daily streaks & challenges</strong><span>Build a habit. Come back every day and watch your streak grow.</span></div>
        </div>
        <div class="onb-feature">
          <span class="onb-feature-icon">â˜ï¸</span>
          <div class="onb-feature-text"><strong>Your progress syncs everywhere</strong><span>Signed in with Google â€” your XP, streak and achievements follow you.</span></div>
        </div>
      </div>
      <button class="onb-next-btn" onclick="onbNext(1)">Let's set up your profile â†’</button>
    </div>

    <!-- Step 1: Name confirmation -->
    <div class="onb-step" id="onb-step-1">
      <h2 class="onb-title">What's your name?</h2>
      <p class="onb-sub">This is how you'll appear in Numiqube. You can change it anytime in Settings.</p>
      <label class="onb-label">Display name</label>
      <input class="onb-input" id="onb-name-input" placeholder="e.g. Alex" maxlength="20"/>
      <button class="onb-next-btn" onclick="onbSaveName()">Continue â†’</button>
    </div>

    <!-- Step 2: Avatar picker -->
    <div class="onb-step" id="onb-step-2">
      <h2 class="onb-title">Pick your avatar</h2>
      <p class="onb-sub">Choose an icon that represents you!</p>
      <div class="avatar-grid" id="onb-avatar-grid"></div>
      <button class="onb-next-btn" onclick="onbNext(3)">Continue â†’</button>
      <button class="onb-skip" onclick="onbNext(3)">Skip for now</button>
    </div>

    <!-- Step 3: Pick starting topic -->
    <div class="onb-step" id="onb-step-3">
      <h2 class="onb-title">What do you want to study?</h2>
      <p class="onb-sub">Pick a topic to start with. You can always switch later.</p>
      <div class="topic-onb-grid" id="onb-topic-grid"></div>
      <button class="onb-next-btn" onclick="onbFinish()">Start learning ðŸš€</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MORE SIDE PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="more-panel-overlay" onclick="closeMorePanel()"></div>
<div id="more-panel">
  <button class="panel-close" onclick="closeMorePanel()">âœ•</button>

  <div class="panel-title">Study Tools</div>
  <button class="panel-btn" onclick="openModal('formula-modal');closeMorePanel()">ðŸ“‹ Formula Sheet</button>
  <button class="panel-btn" onclick="openModal('concepts-modal');loadConcept();closeMorePanel()">ðŸ“– Learn First</button>
  <button class="panel-btn" onclick="shuffleTopic();closeMorePanel()">ðŸŽ² Random Topic</button>
  <button class="panel-btn" onclick="skipQ();closeMorePanel()">â­ Skip Question</button>

  <div class="panel-title">Mode</div>
  <button class="panel-btn" id="panel-studymode-btn" onclick="toggleStudyMode()">ðŸ“š Study Mode: Off</button>
  <button class="panel-btn" id="panel-mode-btn" onclick="toggleMode()">ðŸŽ¯ Normal Mode</button>
  <button class="panel-btn" id="panel-sr-btn" onclick="toggleSR()">ðŸ§  Spaced Rep: Off</button>
  <button class="panel-btn" id="panel-pause-btn" onclick="togglePause()">â¸ Pause</button>

  <div class="panel-title">Other</div>
  <button class="panel-btn" id="panel-music-btn" onclick="toggleMusic();closeMorePanel()">ðŸŽµ Music: ON</button>
  <button class="panel-btn" onclick="openPrintModal();closeMorePanel()">ðŸ–¨ï¸ Print Worksheet</button>
  <button class="panel-btn" onclick="showPage('progress');closeMorePanel()">ðŸ“Š My Progress</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STUDY PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-study" class="page">
<div class="container">

  <!-- Compact daily challenge -->
  <div id="daily-compact">
    <span id="daily-compact-label">âš¡ Daily</span>
    <div id="daily-compact-bar-wrap"><div id="daily-compact-bar"></div></div>
    <span id="daily-compact-count">0/10</span>
  </div>

  <!-- Topic selector -->
  <div id="topic-selector-row" style="margin-bottom:10px;">
    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:6px;">
      <button class="btn-topic-pick" id="topic-pick-btn" onclick="openTopicModal()">
        <span id="topic-pick-icon">ðŸ“</span>
        <span id="topic-pick-name">Quadratics</span>
        <span style="color:var(--muted);font-size:0.8rem;">â–¾</span>
      </button>
      <span id="topic-pick-acc" style="font-size:0.72rem;color:var(--muted);"></span>
    </div>
  </div>

  <!-- Study mode banner -->
  <div id="mode-banner">
    <span>ðŸ“ <strong>Test Mode</strong> â€” hints hidden, explanations shown at end</span>
    <span id="test-score-live" style="font-family:'Space Mono',monospace;font-size:0.72rem;"></span>
  </div>

  <!-- Slim toolbar: just More button + a couple quick actions -->
  <div class="study-toolbar">
    <button class="more-btn" onclick="openMorePanel()">â˜° More</button>
    <button class="tool-btn" id="pause-btn" onclick="togglePause()">â¸ Pause</button>
    <button class="tool-btn" onclick="skipQ()">â­ Skip</button>
    <button class="tool-btn" id="music-toolbar-btn" onclick="toggleMusic()" title="Toggle background music">ðŸŽµ</button>
    <!-- Hidden elements still needed for JS references -->
    <button style="display:none" id="studymode-btn"></button>
    <button style="display:none" id="mode-btn"></button>
    <button style="display:none" id="sr-btn"></button>
  </div>

  <div id="session-prog-wrap">
    <div id="session-prog-label"><span id="session-prog-text">Session Goal: 0 / 20</span><span id="session-goal-badge" style="color:var(--a3);font-size:0.7rem;">ðŸŽ¯ Keep going!</span></div>
    <div class="thin-bar"><div class="thin-bar-fill" id="session-prog-fill" style="width:0%"></div></div>
  </div>

  <div class="question-meta">
    <div id="topic-badge">Quadratics</div>
    <div id="q-counter">Q 1</div>
    <div id="score-display">0 / 0</div>
  </div>

  <!-- Question streak banner -->
  <div id="q-streak-banner">
    <span class="qs-fire">ðŸ”¥</span>
    <span class="qs-label">Answer Streak</span>
    <span class="qs-num" id="q-streak-num">0</span>
    <span class="qs-sub" id="q-streak-sub">in a row!</span>
  </div>

  <div id="question-card">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;margin-bottom:8px;">
      <div id="diff-tag" class="d-easy">Easy</div>
      <div id="speed-ring-wrap">
        <svg id="speed-ring" viewBox="0 0 48 48">
          <circle cx="24" cy="24" r="20" fill="none" stroke="#ffffff15" stroke-width="4"/>
          <circle id="speed-arc" cx="24" cy="24" r="20" fill="none" stroke="var(--a2)" stroke-width="4"
            stroke-dasharray="125.6" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-90 24 24)"/>
          <text id="speed-num" x="24" y="25" text-anchor="middle" dominant-baseline="middle" font-family="Space Mono" font-size="11" fill="var(--a2)">15</text>
        </svg>
      </div>
    </div>
    <div id="question-text">Loading...</div>
    <div id="hint-section">
      <button id="hint-btn" onclick="showHint()">ðŸ’¡ Hint</button>
      <div id="hint-text"></div>
    </div>
    <div id="options-grid"></div>
    <div id="free-wrap">
      <input type="text" id="free-input" placeholder="Type your answerâ€¦" onkeydown="if(event.key==='Enter')submitFree()"/>
      <br><button id="submit-free" onclick="submitFree()">Submit â†’</button>
    </div>
    <!-- Number Pad Input -->
    <div id="numpad-wrap" style="display:none;">
      <div id="numpad-display" style="background:var(--card2);border:2px solid var(--border);border-radius:12px;padding:14px 18px;font-family:'Space Mono',monospace;font-size:1.8rem;font-weight:700;text-align:right;margin-bottom:10px;min-height:56px;color:var(--text);letter-spacing:2px;">_</div>
      <div id="numpad-keys" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
        <button class="numpad-btn" onclick="numpadPress('1')">1</button>
        <button class="numpad-btn" onclick="numpadPress('2')">2</button>
        <button class="numpad-btn" onclick="numpadPress('3')">3</button>
        <button class="numpad-btn" onclick="numpadPress('4')">4</button>
        <button class="numpad-btn" onclick="numpadPress('5')">5</button>
        <button class="numpad-btn" onclick="numpadPress('6')">6</button>
        <button class="numpad-btn" onclick="numpadPress('7')">7</button>
        <button class="numpad-btn" onclick="numpadPress('8')">8</button>
        <button class="numpad-btn" onclick="numpadPress('9')">9</button>
        <button class="numpad-btn" onclick="numpadNegate()">+/âˆ’</button>
        <button class="numpad-btn" onclick="numpadPress('0')">0</button>
        <button class="numpad-btn" onclick="numpadPress('.')">.</button>
        <button class="numpad-btn numpad-clear" onclick="numpadClear()" style="grid-column:span 2;">âŒ« Delete</button>
        <button class="numpad-btn numpad-submit" onclick="submitNumpad()">âœ“</button>
      </div>
    </div>
    <!-- Multi-variable Input (e.g. x= and y=) -->
    <div id="multivar-wrap" style="display:none;">
      <p id="multivar-hint" style="font-size:0.75rem;color:var(--muted);margin-bottom:10px;">Enter each value separately. Use numbers only â€” no letters or symbols.</p>
      <div id="multivar-fields" style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px;"></div>
      <button id="submit-multivar" onclick="submitMultiVar()" style="background:var(--accent);border:none;color:white;font-family:'Nunito',sans-serif;font-size:0.9rem;font-weight:800;padding:10px 24px;border-radius:10px;cursor:pointer;width:100%;">Submit â†’</button>
    </div>
    <div id="sort-wrap" style="display:none;">
      <p style="font-size:0.78rem;color:var(--muted);margin-bottom:8px;">Drag to reorder, or tap to move:</p>
      <div id="sort-list" style="display:flex;flex-direction:column;gap:6px;"></div>
      <button class="numpad-btn numpad-submit" style="width:100%;margin-top:10px;border-radius:10px;" onclick="submitSort()">âœ“ Submit Order</button>
    </div>
    <div id="feedback-box"></div>
    <button id="next-btn" onclick="nextQ()">Next â†’</button>
    <div style="text-align:right;margin-top:8px;">
      <button onclick="openReportModal()" style="background:none;border:none;color:var(--muted);font-size:0.7rem;cursor:pointer;padding:2px 6px;border-radius:6px;transition:color 0.2s;" onmouseover="this.style.color='var(--wrong)'" onmouseout="this.style.color='var(--muted)'">ðŸš© Report question</button>
    </div>
  </div>

  <div id="stats-row">
    <div class="stat-mini"><div class="snum" id="st-correct" style="color:var(--correct)">0</div><div class="slabel">Correct</div></div>
    <div class="stat-mini"><div class="snum" id="st-wrong" style="color:var(--wrong)">0</div><div class="slabel">Wrong</div></div>
    <div class="stat-mini"><div class="snum" id="st-streak" style="color:var(--accent)">0</div><div class="slabel">Best Streak</div></div>
    <div class="stat-mini"><div class="snum" id="st-acc" style="color:var(--a2)">--%</div><div class="slabel">Accuracy</div></div>
    <div class="stat-mini"><div class="snum" id="st-time" style="color:var(--a4)">--s</div><div class="slabel">Avg Time</div></div>
    <div class="stat-mini"><div class="snum" id="st-xp" style="color:var(--a5)">0</div><div class="slabel">Session XP</div></div>
  </div>

  <!-- Wrong answers review -->
  <div class="card-section" id="review-section" style="display:none;">
    <h3>ðŸ“Œ Questions You Got Wrong â€” Review These!</h3>
    <div class="wrong-list" id="wrong-list"></div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-dashboard" class="page">
<div class="container">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:8px;">
    <div>
      <h2 style="font-size:1.4rem;font-weight:900;">Welcome back, <span id="dash-name" style="color:var(--accent);">Student</span>! ðŸ‘‹</h2>
      <p style="color:var(--muted);font-size:0.82rem;" id="dash-subtitle">What are we learning today?</p>
    </div>
    <div id="dash-level-badge" style="background:linear-gradient(135deg,#7b2ff7,#f107a3);padding:8px 16px;border-radius:99px;font-weight:900;font-size:1rem;">LVL 1</div>
  </div>

  <p class="section-title">Overall Stats</p>
  <div class="dash-grid" id="dash-stats-grid"></div>

  <div class="card-section">
    <h3>ðŸ—“ï¸ Study Activity (Last 28 Days)</h3>
    <div class="activity-grid" id="activity-grid"></div>
    <div style="display:flex;align-items:center;gap:6px;margin-top:8px;">
      <div style="width:10px;height:10px;border-radius:2px;background:var(--card3);"></div><span style="font-size:0.68rem;color:var(--muted);">None</span>
      <div style="width:10px;height:10px;border-radius:2px;background:rgba(6,214,160,0.35);"></div><span style="font-size:0.68rem;color:var(--muted);">Low</span>
      <div style="width:10px;height:10px;border-radius:2px;background:var(--a3);"></div><span style="font-size:0.68rem;color:var(--muted);">High</span>
    </div>
  </div>

  <div class="card-section">
    <h3>ðŸ”¥ Current Streak</h3>
    <div class="week-row" id="week-row"></div>
    <p style="color:var(--muted);font-size:0.78rem;margin-top:8px;" id="streak-msg">Study today to keep your streak alive!</p>
  </div>

  <p class="section-title" style="margin-top:4px;">Active Goals</p>
  <div id="dash-goals"></div>

  <div class="card-section">
    <h3>ðŸ’¡ Daily Tip</h3>
    <p id="daily-tip" style="font-size:0.85rem;color:var(--muted);line-height:1.6;"></p>
  </div>

  <button class="btn-primary" onclick="showPage('study')" style="width:100%;margin-top:4px;">ðŸ“š Start Studying Now</button>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PROGRESS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-progress" class="page">
<div class="container">
  <h2 style="font-size:1.3rem;font-weight:900;margin-bottom:14px;">ðŸ“Š My Progress</h2>

  <div class="tab-row">
    <button class="tab-pill active" onclick="progressTab(this,'prog-accuracy')">ðŸŽ¯ Accuracy</button>
    <button class="tab-pill" onclick="progressTab(this,'prog-history')">ðŸ“œ History</button>
    <button class="tab-pill" onclick="progressTab(this,'prog-review')">âŒ Review Wrongs</button>
    <button class="tab-pill" onclick="progressTab(this,'prog-ach')">ðŸ… Achievements</button>
  </div>

  <div id="prog-accuracy">
    <div class="card-section">
      <h3>Topic Accuracy</h3>
      <div id="topic-acc-bars"></div>
    </div>
    <div class="card-section">
      <h3>ðŸ“ˆ Speed Analysis</h3>
      <div id="speed-analysis"></div>
    </div>
  </div>
  <div id="prog-history" style="display:none;">
    <div class="card-section">
      <h3>Session History</h3>
      <div class="history-list" id="history-list"></div>
    </div>
  </div>
  <div id="prog-review" style="display:none;">
    <div class="card-section">
      <h3>âŒ Questions You Got Wrong â€” Study These!</h3>
      <p style="font-size:0.78rem;color:var(--muted);margin-bottom:12px;">Tap any card to see the full explanation.</p>
      <div id="prog-wrong-list" class="wrong-list"></div>
    </div>
  </div>
  <div id="prog-ach" style="display:none;">
    <div class="card-section">
      <h3>ðŸ… Achievements (<span id="ach-count">0</span> / <span id="ach-total">0</span>)</h3>
      <div class="ach-grid" id="ach-grid"></div>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GOALS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-goals" class="page">
<div class="container">
  <h2 style="font-size:1.3rem;font-weight:900;margin-bottom:14px;">ðŸŽ¯ My Goals</h2>

  <div class="card-section">
    <h3>âž• Add New Goal</h3>
    <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Goal Title</label>
    <input class="goal-input" id="goal-title-in" placeholder="e.g. Answer 50 quadratic questions this week"/>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:120px;">
        <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Type</label>
        <select class="goal-input" id="goal-type-in">
          <option value="questions">Total Questions</option>
          <option value="correct">Correct Answers</option>
          <option value="xp">XP Earned</option>
          <option value="streak">Day Streak</option>
          <option value="topic">Topic Mastery (80%+ acc)</option>
        </select>
      </div>
      <div style="flex:1;min-width:100px;">
        <label style="font-size:0.78rem;color:var(--muted);display:block;margin-bottom:4px;">Target</label>
        <input class="goal-input" id="goal-target-in" type="number" placeholder="50" min="1"/>
      </div>
    </div>
    <button class="btn-primary" style="margin-top:10px;padding:10px 24px;font-size:0.9rem;" onclick="addGoal()">Add Goal</button>
  </div>

  <p class="section-title">Active Goals</p>
  <div id="goals-list"></div>

  <p class="section-title" style="margin-top:18px;">Completed Goals ðŸŽ‰</p>
  <div id="goals-done"></div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEADERBOARD PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ROADMAP / GO BIG PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-roadmap" class="page">
<div class="container">
  <h2 style="font-size:1.3rem;font-weight:900;margin-bottom:4px;">ðŸ—ºï¸ How to Go BIG</h2>
  <p style="color:var(--muted);font-size:0.82rem;margin-bottom:18px;">Your step-by-step guide to turning Numiqube into a real, published app.</p>

  <div class="card-section">
    <h3>ðŸ› ï¸ Tech Stack We'd Use</h3>
    <div class="tech-grid">
      <div class="tech-card"><strong>React Native</strong><span>iOS + Android from one codebase</span></div>
      <div class="tech-card"><strong>Expo</strong><span>Fast development & publishing</span></div>
      <div class="tech-card"><strong>Firebase</strong><span>Auth, database, leaderboard</span></div>
      <div class="tech-card"><strong>Supabase</strong><span>Alt: Postgres + auth + real-time</span></div>
      <div class="tech-card"><strong>Next.js</strong><span>Web version + landing page</span></div>
      <div class="tech-card"><strong>Vercel</strong><span>Free hosting for the web app</span></div>
      <div class="tech-card"><strong>GitHub</strong><span>Version control + open source</span></div>
      <div class="tech-card"><strong>RevenueCat</strong><span>Subscriptions & in-app purchases</span></div>
    </div>
  </div>

  <div class="phase-label">Phase 1 â€” Get It on GitHub (Free, This Weekend)</div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(6,214,160,0.2);color:var(--a3);">1</div>
    <div><div class="rm-title">Create a GitHub account <span class="effort-chip e-low">15 min</span></div>
    <div class="rm-desc">Go to github.com â†’ Sign up â†’ Create a new repository called "numiqube". This is where all your code lives.</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(6,214,160,0.2);color:var(--a3);">2</div>
    <div><div class="rm-title">Upload this HTML file <span class="effort-chip e-low">10 min</span></div>
    <div class="rm-desc">Go to your repo â†’ "Add file" â†’ "Upload files" â†’ drag this .html file in. Commit it. Your app is now version-controlled.</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(6,214,160,0.2);color:var(--a3);">3</div>
    <div><div class="rm-title">Deploy with GitHub Pages (free website!) <span class="effort-chip e-low">5 min</span></div>
    <div class="rm-desc">Settings â†’ Pages â†’ Source: main branch â†’ index.html. Your app will be live at username.github.io/numiqube â€” share this link with friends!</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(6,214,160,0.2);color:var(--a3);">4</div>
    <div><div class="rm-title">Add a README.md <span class="effort-chip e-low">20 min</span></div>
    <div class="rm-desc">Write what Numiqube is, who it's for, screenshots. A good README makes people take your project seriously. Use Claude to help write it!</div></div></div>

  <div class="phase-label">Phase 2 â€” Make It a Real Web App (1-2 Months)</div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(255,209,102,0.2);color:var(--a2);">5</div>
    <div><div class="rm-title">Learn React.js basics <span class="effort-chip e-med">2â€“3 weeks</span></div>
    <div class="rm-desc">React is the #1 framework for building web apps. Free resources: react.dev official tutorial, freeCodeCamp, or just ask Claude to teach you step by step.</div>
    <div class="tag-wrap"><span class="chip chip-blue">react.dev</span><span class="chip chip-blue">freeCodeCamp</span><span class="chip chip-green">Claude tutoring</span></div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(255,209,102,0.2);color:var(--a2);">6</div>
    <div><div class="rm-title">Set up Firebase (real data storage) <span class="effort-chip e-med">1 week</span></div>
    <div class="rm-desc">Firebase is free for small apps. Add: Google authentication (sign in with Google), Firestore (cloud database to save progress), and Firebase Hosting.</div>
    <div class="tag-wrap"><span class="chip chip-blue">firebase.google.com</span><span class="chip chip-green">Free tier generous</span></div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(255,209,102,0.2);color:var(--a2);">7</div>
    <div><div class="rm-title">Add a real leaderboard <span class="effort-chip e-med">3 days</span></div>
    <div class="rm-desc">With Firebase, you can show real XP from real users worldwide. Add school-based leaderboards â€” students compete with their classmates!</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(255,209,102,0.2);color:var(--a2);">8</div>
    <div><div class="rm-title">Expand the question bank with AI <span class="effort-chip e-low">Ongoing</span></div>
    <div class="rm-desc">Use Claude's API to generate new questions dynamically. Never run out of problems. Each question auto-tagged with topic, difficulty, and step-by-step solution.</div>
    <div class="tag-wrap"><span class="chip chip-purple">Anthropic API</span><span class="chip chip-green">Infinite questions</span></div></div></div>

  <div class="phase-label">Phase 3 â€” iOS & Android App (2â€“4 Months)</div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(239,71,111,0.2);color:var(--wrong);">9</div>
    <div><div class="rm-title">Convert to React Native + Expo <span class="effort-chip e-high">3â€“4 weeks</span></div>
    <div class="rm-desc">React Native lets you write once and ship to iPhone AND Android. Expo makes it much easier. Your React skills carry over directly.</div>
    <div class="tag-wrap"><span class="chip chip-blue">expo.dev</span><span class="chip chip-blue">reactnative.dev</span></div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(239,71,111,0.2);color:var(--wrong);">10</div>
    <div><div class="rm-title">Submit to Apple App Store <span class="effort-chip e-high">$99/year + 1 week</span></div>
    <div class="rm-desc">You need an Apple Developer Account ($99/year). The review process takes 1â€“3 days. You'll need a Mac or use a cloud Mac service like MacStadium. Be 17+ or have parent help.</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(239,71,111,0.2);color:var(--wrong);">11</div>
    <div><div class="rm-title">Submit to Google Play Store <span class="effort-chip e-med">$25 one-time + 3 days</span></div>
    <div class="rm-desc">Google Play is cheaper ($25 one-time fee) and easier to get approved. Great place to launch first.</div></div></div>

  <div class="phase-label">Phase 4 â€” Make Money & Grow (6+ Months)</div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(199,125,255,0.2);color:var(--a5);">12</div>
    <div><div class="rm-title">Add a "Pro" subscription <span class="effort-chip e-med">1 week</span></div>
    <div class="rm-desc">Free tier: 9 topics, progress tracking. Pro ($2.99/month): AI-generated problems, no ads, study schedule, parent dashboard. Use RevenueCat to handle payments.</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(199,125,255,0.2);color:var(--a5);">13</div>
    <div><div class="rm-title">Partner with schools & MATHCOUNTS teams <span class="effort-chip e-high">Ongoing</span></div>
    <div class="rm-desc">Contact your school's math teacher. Offer free teacher accounts. Schools can assign Numiqube as homework. This is how you get hundreds of users fast. Make a short demo video and email it.</div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(199,125,255,0.2);color:var(--a5);">14</div>
    <div><div class="rm-title">Post on social media <span class="effort-chip e-low">1 hour</span></div>
    <div class="rm-desc">Post on Reddit (r/learnmath, r/mathcounts, r/teenagers), TikTok (show your streak, achievements), Instagram. "Built my own math app at 13" is a compelling story!</div>
    <div class="tag-wrap"><span class="chip chip-blue">r/learnmath</span><span class="chip chip-blue">r/mathcounts</span><span class="chip chip-green">TikTok / IG</span></div></div></div>
  <div class="roadmap-item"><div class="rm-num" style="background:rgba(199,125,255,0.2);color:var(--a5);">15</div>
    <div><div class="rm-title">Apply to hackathons & competitions <span class="effort-chip e-med">Several weekends</span></div>
    <div class="rm-desc">Competitions like Congressional App Challenge, FBLA, DECA, Regeneron STS all love apps that solve real problems. Numiqube is exactly that. Winning or placing can get you college attention and sometimes prize money.</div>
    <div class="tag-wrap"><span class="chip chip-purple">Congressional App Challenge</span><span class="chip chip-purple">FBLA</span><span class="chip chip-purple">Regeneron</span></div></div></div>

  <div class="card-section" style="margin-top:18px;">
    <h3>ðŸ’° Realistic Revenue Projection</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:8px;">
      <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center;">
        <div style="font-family:'Space Mono',monospace;font-size:1.2rem;color:var(--a3);font-weight:700;">$0</div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Month 1 (GitHub Pages free)</div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center;">
        <div style="font-family:'Space Mono',monospace;font-size:1.2rem;color:var(--a2);font-weight:700;">$50â€“200</div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Month 6 (Pro subscriptions)</div>
      </div>
      <div style="background:var(--card2);border-radius:10px;padding:12px;text-align:center;">
        <div style="font-family:'Space Mono',monospace;font-size:1.2rem;color:var(--accent);font-weight:700;">$500+</div>
        <div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Month 12 (School partnerships)</div>
      </div>
    </div>
  </div>

  <div class="card-section">
    <h3>ðŸš€ Your First Step (Do This Today!)</h3>
    <p style="font-size:0.85rem;color:var(--muted);line-height:1.7;">1. Make a GitHub account at <strong style="color:var(--accent);">github.com</strong><br>2. Create a repo called <strong style="color:var(--a2);">numiqube</strong><br>3. Upload this HTML file and enable GitHub Pages<br>4. Share the link with 5 friends and your math teacher<br>5. Watch people actually use something <em>you</em> built ðŸ”¥</p>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FRIENDS & LEADERBOARD PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-friends" class="page">
<div class="container">
  <h2 style="font-size:1.3rem;font-weight:900;margin-bottom:4px;">ðŸ‘¥ Friends</h2>
  <p style="color:var(--muted);font-size:0.8rem;margin-bottom:16px;">Add friends, track their progress, and challenge them to duels.</p>

  <!-- Guest warning -->
  <div id="friends-guest-msg" style="display:none;background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.3);border-radius:12px;padding:14px 16px;margin-bottom:16px;">
    <strong style="font-size:0.88rem;">Sign in with Google to use Friends</strong>
    <p style="font-size:0.78rem;color:var(--muted);margin-top:4px;">Friends and leaderboards require a Google account so your progress syncs across devices.</p>
  </div>

  <div id="friends-content">
    <!-- Your friend code -->
    <p class="section-title">Your Friend Code</p>
    <div class="friend-code-box">
      <div>
        <div class="friend-code-label">Share this code with friends</div>
        <div class="friend-code-value" id="my-friend-code">â€“â€“â€“â€“â€“</div>
      </div>
      <button class="friend-code-copy" onclick="copyFriendCode()">ðŸ“‹ Copy</button>
    </div>

    <!-- Add friend -->
    <p class="section-title">Add a Friend</p>
    <div class="friend-search-row">
      <input class="friend-search-input" id="friend-search-input" placeholder="Friend code (e.g. MATH-4821) or username"/>
      <button class="friend-search-btn" onclick="sendFriendRequest()">Add â†’</button>
    </div>
    <div id="friend-search-result" style="margin-bottom:12px;font-size:0.82rem;color:var(--muted);"></div>

    <!-- Pending requests -->
    <p class="section-title" id="requests-title" style="display:none;">Friend Requests <span class="req-badge" id="req-badge-inline" style="display:inline;">0</span></p>
    <div id="friend-requests-list"></div>

    <!-- Friends list -->
    <p class="section-title" style="margin-top:16px;">My Friends</p>
    <div id="friends-list"><p style="color:var(--muted);font-size:0.82rem;">No friends yet. Add some!</p></div>

    <!-- Leaderboard -->
    <p class="section-title" style="margin-top:20px;">ðŸ† Friends Leaderboard</p>
    <div class="lb-tabs">
      <button class="lb-tab active" id="lb-tab-xp" onclick="switchLbTab('xp')">Total XP</button>
      <button class="lb-tab" id="lb-tab-weekly" onclick="switchLbTab('weekly')">Weekly XP</button>
      <button class="lb-tab" id="lb-tab-streak" onclick="switchLbTab('streak')">Streak</button>
    </div>
    <div id="leaderboard-list"></div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DUELS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-duels" class="page">
<div class="container">

  <div class="duels-hero">
    <div class="duels-hero-title">âš”ï¸ Duels</div>
    <div class="duels-hero-sub">Challenge a friend or get matched with a random opponent. First to 15 correct wins.</div>
    <div class="duel-record-row">
      <div class="duel-record-card">
        <div class="duel-record-num" id="duels-wins" style="color:var(--a3);">0</div>
        <div class="duel-record-lbl">Wins</div>
      </div>
      <div class="duel-record-card">
        <div class="duel-record-num" id="duels-losses" style="color:var(--wrong);">0</div>
        <div class="duel-record-lbl">Losses</div>
      </div>
      <div class="duel-record-card">
        <div class="duel-record-num" id="duels-winrate" style="color:var(--a2);">--%</div>
        <div class="duel-record-lbl">Win Rate</div>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:center;">
      <button class="queue-btn ranked" style="width:auto;padding:12px 28px;font-size:0.95rem;" onclick="showPage('ranked')">ðŸ† Ranked Queue</button>
      <button class="queue-btn casual" style="width:auto;padding:12px 28px;font-size:0.95rem;" onclick="showPage('casual')">ðŸŽ® Casual Queue</button>
    </div>
  </div>

  <!-- Challenge a friend -->
  <p class="section-title">Challenge a Friend</p>
  <div id="duels-guest-msg" style="display:none;background:rgba(255,107,53,0.1);border:1px solid rgba(255,107,53,0.3);border-radius:12px;padding:14px 16px;margin-bottom:12px;">
    <strong style="font-size:0.88rem;">Sign in with Google to challenge friends</strong>
  </div>
  <div id="duels-friends-list" class="friends-duel-list">
    <p style="color:var(--muted);font-size:0.82rem;">Loading friends...</p>
  </div>

  <p class="section-title" style="margin-top:20px;">How It Works</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">
    <div class="mode-info-card">
      <div class="mode-info-label">ðŸŽ¯ Objective</div>
      <div class="mode-info-val" style="font-size:0.82rem;margin-top:4px;color:var(--muted);font-weight:400;">First to answer 15 questions correctly wins the duel</div>
    </div>
    <div class="mode-info-card">
      <div class="mode-info-label">ðŸ§  Questions</div>
      <div class="mode-info-val" style="font-size:0.82rem;margin-top:4px;color:var(--muted);font-weight:400;">Mental math â€” no paper needed. Fast, head-to-head</div>
    </div>
    <div class="mode-info-card">
      <div class="mode-info-label">â­ XP Rewards</div>
      <div class="mode-info-val" style="font-size:0.82rem;margin-top:4px;color:var(--muted);font-weight:400;">Win: +150 XP &nbsp;|&nbsp; Lose: +50 XP â€” you always earn</div>
    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RANKED MODE LANDING PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-ranked" class="page">
<div class="container">
  <button onclick="showPage('duels')" style="background:none;border:none;color:var(--muted);font-size:0.82rem;cursor:pointer;padding:0;margin-bottom:16px;font-family:'Nunito',sans-serif;">â† Back to Duels</button>

  <div class="mode-landing">
    <div class="mode-landing-header">
      <div class="mode-landing-icon ranked">ðŸ†</div>
      <div>
        <div class="mode-landing-title">Ranked Mode</div>
        <div class="mode-landing-sub">Compete for rank. Every match counts.</div>
      </div>
    </div>

    <!-- Your rank display -->
    <div style="background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;">
      <div>
        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);font-weight:700;margin-bottom:4px;">Your Rank</div>
        <div id="my-rank-badge" class="rank-badge rank-apprentice" style="font-size:0.95rem;">ðŸ“– Apprentice IV</div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:0.68rem;color:var(--muted);font-weight:700;margin-bottom:4px;">LP (League Points)</div>
        <div style="font-family:'Space Mono',monospace;font-size:1.2rem;font-weight:700;color:var(--a2);" id="my-lp">0 LP</div>
        <div style="font-size:0.65rem;color:var(--muted);" id="my-lp-next">100 LP to next division</div>
      </div>
    </div>

    <!-- LP bar -->
    <div class="rank-lp-bar-wrap" style="height:8px;margin-bottom:16px;">
      <div class="rank-lp-bar" id="lp-progress-bar" style="width:0%;background:var(--rank-apprentice);"></div>
    </div>

    <div class="mode-info-grid">
      <div class="mode-info-card">
        <div class="mode-info-label">Win</div>
        <div class="mode-info-val" style="color:var(--a3);">+20â€“30 LP</div>
      </div>
      <div class="mode-info-card">
        <div class="mode-info-label">Loss</div>
        <div class="mode-info-val" style="color:var(--wrong);">âˆ’15 LP</div>
      </div>
      <div class="mode-info-card">
        <div class="mode-info-label">First Win</div>
        <div class="mode-info-val" style="color:var(--a5);">+35 LP bonus</div>
      </div>
      <div class="mode-info-card">
        <div class="mode-info-label">Win Streak</div>
        <div class="mode-info-val" style="color:var(--a2);">Bonus LP Ã—1.2</div>
      </div>
    </div>

    <button class="queue-btn ranked" onclick="startMatchmaking('ranked')">ðŸ† Enter Ranked Queue</button>
  </div>

  <!-- All Ranks -->
  <p class="section-title">All Ranks</p>
  <div class="rank-tiers-grid" id="rank-tiers-display"></div>

  <!-- Ranked Leaderboard Top 35 -->
  <p class="section-title" style="margin-top:20px;">ðŸŒ Global Ranked Leaderboard â€” Top 35</p>
  <div id="ranked-leaderboard-list">
    <div style="text-align:center;padding:20px;color:var(--muted);font-size:0.82rem;">Loading leaderboard...</div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CASUAL MODE LANDING PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-casual" class="page">
<div class="container">
  <button onclick="showPage('duels')" style="background:none;border:none;color:var(--muted);font-size:0.82rem;cursor:pointer;padding:0;margin-bottom:16px;font-family:'Nunito',sans-serif;">â† Back to Duels</button>

  <div class="mode-landing">
    <div class="mode-landing-header">
      <div class="mode-landing-icon casual">ðŸŽ®</div>
      <div>
        <div class="mode-landing-title">Casual Mode</div>
        <div class="mode-landing-sub">Play for fun. No rank on the line.</div>
      </div>
    </div>

    <div class="mode-info-grid">
      <div class="mode-info-card">
        <div class="mode-info-label">XP Reward</div>
        <div class="mode-info-val" style="color:var(--a3);">Win: +150 XP</div>
      </div>
      <div class="mode-info-card">
        <div class="mode-info-label">Participation</div>
        <div class="mode-info-val" style="color:var(--a5);">+50 XP always</div>
      </div>
      <div class="mode-info-card">
        <div class="mode-info-label">Rank Impact</div>
        <div class="mode-info-val" style="color:var(--muted);">None â€” relax!</div>
      </div>
      <div class="mode-info-card">
        <div class="mode-info-label">Wait Time</div>
        <div class="mode-info-val" style="color:var(--a2);">~30 seconds avg</div>
      </div>
    </div>

    <button class="queue-btn casual" onclick="startMatchmaking('casual')">ðŸŽ® Find Casual Match</button>
  </div>

  <p class="section-title">How Casual Works</p>
  <div style="background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;">
    <p style="font-size:0.85rem;line-height:1.8;color:var(--muted);">
      Casual matches you with any available player â€” no rank restrictions. 
      You'll answer mental math questions head-to-head. First to 15 correct wins. 
      There's no penalty for losing, so it's perfect for warming up, practicing, or just having fun with a random opponent.
    </p>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SETTINGS PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-settings" class="page">
<div class="container">
  <h2 style="font-size:1.3rem;font-weight:900;margin-bottom:16px;">âš™ï¸ Settings</h2>

  <p class="section-title">Appearance</p>
  <div class="setting-row">
    <div><div class="setting-label">Light Mode</div><div class="setting-sub">Switch between dark and light theme</div></div>
    <button class="toggle" id="light-toggle" onclick="toggleLight()"></button>
  </div>

  <p class="section-title" style="margin-top:14px;">Study Preferences</p>
  <div class="setting-row">
    <div><div class="setting-label">Session Goal</div><div class="setting-sub">Questions per session</div></div>
    <select class="select-input" id="goal-select" onchange="updateSessionGoal()">
      <option value="10">10 questions</option>
      <option value="20" selected>20 questions</option>
      <option value="30">30 questions</option>
      <option value="50">50 questions</option>
    </select>
  </div>
  <div class="setting-row">
    <div><div class="setting-label">Speed Mode Timer</div><div class="setting-sub">Seconds per question in speed mode</div></div>
    <select class="select-input" id="speed-timer-select" onchange="saveSettings()">
      <option value="10">10 seconds</option>
      <option value="15" selected>15 seconds</option>
      <option value="20">20 seconds</option>
      <option value="30">30 seconds</option>
    </select>
  </div>
  <div class="setting-row">
    <div><div class="setting-label">Sound Effects</div><div class="setting-sub">Play sounds on correct/wrong answers</div></div>
    <button class="toggle on" id="sound-toggle" onclick="toggleSetting('sound')"></button>
  </div>
  <div class="setting-row">
    <div><div class="setting-label">Confetti on Achievements</div><div class="setting-sub">Celebrate big wins!</div></div>
    <button class="toggle on" id="confetti-toggle" onclick="toggleSetting('confetti')"></button>
  </div>

  <p class="section-title" style="margin-top:14px;">Profile</p>
  <div class="setting-row">
    <div><div class="setting-label">Display Name</div><div class="setting-sub" id="current-name-display">â€“</div></div>
    <button class="btn-secondary" style="font-size:0.78rem;padding:7px 14px;" onclick="changeName()">Change</button>
  </div>

  <p class="section-title" style="margin-top:14px;">Data</p>
  <div class="setting-row">
    <div><div class="setting-label">Export Progress</div><div class="setting-sub">Download your stats as JSON</div></div>
    <button class="btn-secondary" style="font-size:0.78rem;padding:7px 14px;" onclick="exportData()">Export</button>
  </div>
  <div class="setting-row">
    <div><div class="setting-label" style="color:var(--wrong);">Reset All Data</div><div class="setting-sub">Delete all progress permanently</div></div>
    <button class="danger-btn" onclick="resetData()">Reset</button>
  </div>

  <p class="section-title" style="margin-top:14px;">Newsletter</p>
  <div class="email-signup-box">
    <div id="settings-step-email">
      <h4>ðŸ“¬ Stay updated</h4>
      <p>Get notified when new topics, features, and improvements drop. No spam, ever.</p>
      <div class="email-row">
        <input class="email-input" id="settings-email-input" type="email" placeholder="your@email.com"/>
        <button class="email-btn" onclick="submitEmail('settings')">Notify me â†’</button>
      </div>
    </div>
    <div class="name-step" id="settings-step-name">
      <h4>ðŸ‘‹ Nice! One more thingâ€¦</h4>
      <p>What should we call you? (Last name is optional)</p>
      <div class="name-fields">
        <input class="email-input" id="settings-first-name" placeholder="First name" maxlength="20"/>
        <input class="email-input" id="settings-last-name" placeholder="Last name (optional)" maxlength="30"/>
      </div>
      <button class="name-submit-btn" onclick="submitName('settings')">Save ðŸš€</button>
      <button class="name-skip" onclick="skipName('settings')">Skip for now</button>
    </div>
    <div class="email-success" id="settings-email-success">âœ… You're all set! Welcome to Numiqube.</div>
  </div>

  <div class="card-section" style="margin-top:16px;">
    <h3>âŒ¨ï¸ Keyboard Shortcuts</h3>
    <div style="background:rgba(76,201,240,0.08);border:1px solid rgba(76,201,240,0.2);border-radius:10px;padding:10px 12px;margin-bottom:12px;font-size:0.78rem;color:var(--muted);">
      ðŸ’¡ <strong style="color:#4cc9f0;">iPad or tablet?</strong> Connect a Bluetooth keyboard to use all shortcuts below. Go to Settings â†’ Bluetooth on your device.
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;font-size:0.78rem;">
      <div style="background:var(--card2);border-radius:8px;padding:8px 10px;"><strong style="font-family:'Space Mono',monospace;">1/2/3/4</strong> â€” Select answer</div>
      <div style="background:var(--card2);border-radius:8px;padding:8px 10px;"><strong style="font-family:'Space Mono',monospace;">A/B/C/D</strong> â€” Select answer</div>
      <div style="background:var(--card2);border-radius:8px;padding:8px 10px;"><strong style="font-family:'Space Mono',monospace;">Enter</strong> â€” Next question</div>
      <div style="background:var(--card2);border-radius:8px;padding:8px 10px;"><strong style="font-family:'Space Mono',monospace;">H</strong> â€” Show/hide hint</div>
      <div style="background:var(--card2);border-radius:8px;padding:8px 10px;"><strong style="font-family:'Space Mono',monospace;">R</strong> â€” Random topic</div>
      <div style="background:var(--card2);border-radius:8px;padding:8px 10px;"><strong style="font-family:'Space Mono',monospace;">Esc</strong> â€” Close modals</div>
    </div>
  </div>

  <div style="text-align:center;margin-top:20px;color:var(--muted);font-size:0.72rem;">
    Numiqube v1.0 Â· Built with â¤ï¸ Â· Your data is stored locally in this browser
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyDyjLVPEGhEeWxwqodCXaGGhcKhEh7GcG4",
  authDomain: "numiqube-a67f9.firebaseapp.com",
  projectId: "numiqube-a67f9",
  storageBucket: "numiqube-a67f9.firebasestorage.app",
  messagingSenderId: "91585910537",
  appId: "1:91585910537:web:1d1661c19c004570eea5d8"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const googleProvider = new firebase.auth.GoogleAuthProvider();

let currentUser = null;

function signInWithGoogle() {
  auth.signInWithPopup(googleProvider).catch(err => {
    console.error('Sign in error:', err);
    uiAlert('Sign in failed. Make sure popups are allowed and try again.', 'ðŸ”', 'Sign In Failed');
  });
}

function signOut() {
  auth.signOut().then(() => {
    currentUser = null;
    updateAuthUI(null);
  });
}

function updateAuthUI(user) {
  // Always prioritize in-app avatar over Google photo
  updateNavAvatar();
  const bar = document.getElementById('nav-auth-bar');
  if (user) {
    bar.classList.add('show');
    document.getElementById('nav-auth-name').textContent = user.displayName || user.email;
    if (user.photoURL) {
      document.getElementById('nav-auth-avatar').src = user.photoURL;
      document.getElementById('nav-auth-avatar').style.display = 'block';
    } else {
      document.getElementById('nav-auth-avatar').style.display = 'none';
    }
  } else {
    bar.classList.remove('show');
  }
}

async function saveStateToFirebase() {
  if (!currentUser) return;
  try {
    const toSave = Object.assign({}, S);
    toSave.earned = [...S.earned];
    delete toSave.q; delete toSave.speedInterval; delete toSave.srQueue;

    // Anti-cheat: XP sanity check before saving to Firebase
    // Max possible XP per question: base(30) + streakBonus(30) + speed(8) + noHint(3) = 71
    // Max realistic XP = total questions answered * 71. Allow 20% buffer.
    const maxPossibleXP = Math.max(100, (S.total || 0) * 71 * 1.2);
    if (toSave.xp > maxPossibleXP) {
      console.warn('XP value rejected - exceeds maximum possible. Resetting to safe value.');
      toSave.xp = Math.min(toSave.xp, maxPossibleXP);
      S.xp = toSave.xp; // also correct local state
    }

    toSave.lastSeen = Date.now();
    await db.collection('users').doc(currentUser.uid).set(toSave, { merge: true });
  } catch(e) { console.error('Firebase save error:', e); }
}

async function loadStateFromFirebase() {
  if (!currentUser) return false;
  try {
    const doc = await db.collection('users').doc(currentUser.uid).get();
    if (doc.exists) {
      const d = doc.data();
      Object.assign(S, d);
      S.earned = new Set(S.earned || []);
      S.q = null; S.answered = false;
      S.streak = S.streak || 0; S.lastTime = 999; S.lastCorrect = false; S.qStart = 0;
      S.hintUsed = false; S.speedInterval = null; S.paused = false;
      S.mode = 'normal'; S.srMode = false; S.srQueue = [];
      S.sessionCorrect = 0; S.sessionXP = 0;
      // Apply this account's settings to the UI immediately
      applySettings();
      return true;
    }
  } catch(e) { console.error('Firebase load error:', e); }
  return false;
}

function applySettings() {
  const lightMode = S.settings && S.settings.lightMode;
  document.body.classList.toggle('light-mode', !!lightMode);
  const themeBtn = document.getElementById('theme-btn');
  if (themeBtn) themeBtn.textContent = lightMode ? 'ðŸŒ™' : 'â˜€ï¸';
}

// Listen for auth state changes
auth.onAuthStateChanged(async user => {
  currentUser = user;
  if (user) {
    updateAuthUI(user);
    const loaded = await loadStateFromFirebase();
    const isNewUser = !loaded || !S.onboardingDone;
    if (!loaded) {
      S.username = user.displayName || user.email.split('@')[0];
    }
    if (isNewUser) {
      showOnboarding(user);
    } else {
      showHomePage();
    }
    // Start listening for incoming duel challenges + matchmaking
    listenForIncomingDuels();
    listenForMatchmaking();
  } else {
    updateAuthUI(null);
    showHomePage();
  }
});

const ONB_AVATARS = ['ðŸ¦','ðŸ¦Š','ðŸ¯','ðŸ¬','ðŸ¦„','ðŸ‰','ðŸ¦‹','ðŸ¦…','ðŸ§','ðŸ¦ˆ','ðŸ¦“','ðŸ¸','ðŸ¼','ðŸ¦‰','ðŸ¦š','ðŸº','ðŸ¦','ðŸ™'];
let _onbSelectedAvatar = 'â­';
let _onbSelectedTopic = 'counting';

function showOnboarding(user) {
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('page-home').classList.remove('show');
  document.getElementById('page-onboarding').classList.add('active');
  document.getElementById('nav').style.display = 'none';

  // Set avatar/name from Google
  if (user.photoURL) {
    const wrap = document.getElementById('onb-avatar-wrap');
    wrap.outerHTML = `<img id="onb-avatar-wrap" class="onb-google-avatar" src="${user.photoURL}" alt=""/>`;
  }
  const firstName = (user.displayName || S.username || '').split(' ')[0];
  document.getElementById('onb-welcome-title').textContent = `Welcome, ${firstName}! ðŸ‘‹`;
  document.getElementById('onb-name-input').value = user.displayName || S.username || '';

  // Build avatar grid
  const grid = document.getElementById('onb-avatar-grid');
  grid.innerHTML = ONB_AVATARS.map(a =>
    `<button class="avatar-opt${a===_onbSelectedAvatar?' selected':''}" onclick="selectOnbAvatar('${a}')">${a}</button>`
  ).join('');

  // Build topic grid
  const tgrid = document.getElementById('onb-topic-grid');
  tgrid.innerHTML = Object.entries(TL).map(([k,v]) =>
    `<button class="topic-onb-btn${k===_onbSelectedTopic?' selected':''}" onclick="selectOnbTopic('${k}',this)">
      <span class="t-icon">${TOPIC_ICONS[k]||'ðŸ“š'}</span>
      <span class="t-name">${v.replace(/[ðŸŽðŸ”¢ðŸ“ðŸ”—ðŸ“ðŸŽ²ðŸ“ˆðŸ§©ðŸ“ŠðŸ†ðŸ”¥âš–ï¸ðŸ”£]/g,'').trim()}</span>
    </button>`
  ).join('');
}

function onbNext(step) {
  document.querySelectorAll('.onb-step').forEach(s => s.classList.remove('active'));
  document.getElementById('onb-step-' + step).classList.add('active');
  // Update dots
  document.querySelectorAll('.onb-step-dot').forEach((d, i) => {
    d.classList.remove('active','done');
    if (i < step) d.classList.add('done');
    else if (i === step) d.classList.add('active');
  });
}

function onbSaveName() {
  const name = document.getElementById('onb-name-input').value.trim();
  if (!name) {
    const inp = document.getElementById('onb-name-input');
    inp.style.borderColor = 'var(--wrong)';
    inp.placeholder = 'Please enter your name!';
    setTimeout(() => { inp.style.borderColor=''; inp.placeholder='e.g. Alex'; }, 1800);
    return;
  }
  S.username = name.slice(0, 20);
  onbNext(2);
}

function selectOnbAvatar(a) {
  _onbSelectedAvatar = a;
  document.querySelectorAll('.avatar-opt').forEach(b => b.classList.remove('selected'));
  event.target.closest('.avatar-opt').classList.add('selected');
}

function selectOnbTopic(key, el) {
  _onbSelectedTopic = key;
  document.querySelectorAll('.topic-onb-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function onbFinish() {
  // Save choices
  S.onboardingDone = true;
  S.currentTopic = _onbSelectedTopic;
  if (!S.shopEquipped) S.shopEquipped = {};
  if (!S.shopOwned) S.shopOwned = [];
  // Map onboarding emoji to a shop avatar id
  const onbAvatarMap = {'ðŸ¦':'avatar_lion','ðŸ¦Š':'avatar_fox','ðŸ¯':'avatar_tiger','ðŸ¬':'avatar_dolphin',
    'ðŸ¦„':'avatar_unicorn','ðŸ‰':'avatar_dragon','ðŸ¦‹':'avatar_butterfly','ðŸ¦…':'avatar_eagle',
    'ðŸ§':'avatar_penguin','ðŸ¦ˆ':'avatar_shark','ðŸ¦“':'avatar_zebra','ðŸ¸':'avatar_frog',
    'ðŸ¼':'avatar_panda','ðŸ¦‰':'avatar_owl','ðŸ¦š':'avatar_peacock','ðŸº':'avatar_wolf',
    'ðŸ¦':'avatar_raccoon','ðŸ™':'avatar_octopus'};
  const avatarId = onbAvatarMap[_onbSelectedAvatar] || 'avatar_star';
  // Use icon directly if no mapping found â€” store as custom
  S.shopEquipped.avatar = avatarId;
  // Give them the free title
  if (!S.shopEquipped.title) S.shopEquipped.title = 'title_student';
  if (!S.shopOwned.includes(avatarId)) S.shopOwned.push(avatarId);
  if (!S.shopOwned.includes('title_student')) S.shopOwned.push('title_student');

  // Hide onboarding
  document.getElementById('page-onboarding').classList.remove('active');

  // Launch app to dashboard
  document.getElementById('nav').style.display = 'flex';
  updateDayStreak();
  restoreEquipped();
  isStudyPageActive = false;
  buildTopicTabs();
  startTimer();
  loadQ();
  showPage('dashboard');
  refreshDashboard();
  saveState();

  // Welcome XP
  S.xp += 25;
  updateLevel();
  saveState();
  listenForIncomingDuels();
  setTimeout(() => spawnXP('+25 XP ðŸŽ‰ Welcome to Numiqube!', '#4cc9f0'), 600);
}



function showHomePage() {
  document.getElementById('loader').classList.add('hidden');
  document.getElementById('page-home').classList.add('show');
  document.getElementById('nav').style.display = 'none';

  if (currentUser && S.onboardingDone) {
    // Returning Google user â€” show a "Continue" button that launches app directly
    const firstName = (currentUser.displayName || S.username || '').split(' ')[0];
    document.querySelector('.home-motto').textContent = `Welcome back, ${firstName}! ðŸ‘‹`;
    document.getElementById('username-input').value = S.username || '';
    // Swap button to say "Continue"
    const btn = document.querySelector('.name-input-wrap .btn-primary');
    if (btn) { btn.textContent = 'Continue â†’'; btn.onclick = launchAppDirectly; }
    // Hide guest note
    const guestNote = document.querySelector('#page-home p[style*="0.75rem"]');
    if (guestNote) guestNote.style.display = 'none';
  } else if (S.username) {
    document.getElementById('username-input').value = S.username;
  }
}

function launchAppDirectly() {
  document.getElementById('page-home').classList.remove('show');
  document.getElementById('nav').style.display = 'flex';
  updateDayStreak();
  restoreEquipped();
  isStudyPageActive = true;
  buildTopicTabs();
  startTimer();
  loadQ();
  showPage('study');
  refreshDashboard();
  saveState();
}


const QB = {
  counting:[
    {text:"There are 3 apples and 2 oranges. How many fruits in total?",opts:["5","4","6","3"],ans:0,diff:"easy",type:"numpad",accepted:["5"],
      hint:"Count the apples, then count the oranges, then add them together.",
      steps:["Apples: 3","Oranges: 2","Total: 3 + 2 = 5"],exp:"3 + 2 = 5 fruits total."},
    {text:"You have 7 stickers and give away 3. How many do you have left?",opts:["4","3","5","10"],ans:0,diff:"easy",type:"numpad",accepted:["4"],
      hint:"Start with 7, then take away 3.",
      steps:["Start: 7","Take away: 3","7 âˆ’ 3 = 4"],exp:"7 âˆ’ 3 = 4 stickers left."},
    {text:"What number comes after 15?",opts:["16","14","17","15"],ans:0,diff:"easy",type:"numpad",accepted:["16"],
      hint:"Count up by 1 from 15.",
      steps:["...14, 15, 16, 17...","The next number is 16"],exp:"16 comes right after 15."},
    {text:"Double the number 6.",opts:["12","10","8","6"],ans:0,diff:"easy",type:"numpad",accepted:["12"],
      hint:"Doubling means adding the number to itself: 6 + 6.",
      steps:["Double 6 = 6 + 6","= 12"],exp:"6 + 6 = 12."},
    {text:"Count by 2s: 2, 4, 6, 8, __",opts:["10","9","12","11"],ans:0,diff:"easy",type:"numpad",accepted:["10"],
      hint:"Each number is 2 more than the last.",
      steps:["8 + 2 = 10"],exp:"The pattern adds 2 each time: next is 10."},
    {text:"There are 5 birds on a fence. 2 fly away. How many remain?",opts:["3","2","4","7"],ans:0,diff:"easy",type:"numpad",accepted:["3"],
      hint:"Start with 5, subtract 2.",
      steps:["5 âˆ’ 2 = 3"],exp:"5 âˆ’ 2 = 3 birds remain."},
    {text:"Which is bigger: 9 or 6?",opts:["9","6","They are equal","Can't tell"],ans:0,diff:"easy",
      hint:"Think of the number line â€” which is further right?",
      steps:["On a number line: ...6...7...8...9...","9 is further right â†’ 9 is bigger"],exp:"9 > 6."},
    {text:"What is half of 10?",opts:["5","4","6","2"],ans:0,diff:"easy",type:"numpad",accepted:["5"],
      hint:"Half means splitting into 2 equal groups: 10 Ã· 2.",
      steps:["10 Ã· 2 = 5"],exp:"Half of 10 = 5."},
    {text:"A dozen eggs is how many?",opts:["12","10","6","24"],ans:0,diff:"easy",type:"numpad",accepted:["12"],
      hint:"A 'dozen' is a special word meaning a specific number.",
      steps:["A dozen = 12","This is a word to memorize!"],exp:"A dozen = 12."},
    {text:"3 Ã— 4 = ?",opts:["12","7","10","9"],ans:0,diff:"easy",type:"numpad",accepted:["12"],
      hint:"3 groups of 4: 4 + 4 + 4.",
      steps:["3 Ã— 4 = 4 + 4 + 4","= 8 + 4 = 12"],exp:"3 Ã— 4 = 12."},
  
    {text:"How many sides does a triangle have?",opts:["3","4","5","6"],ans:0,diff:"easy",type:"numpad",accepted:["3"],hint:"Think about what 'tri' means.",steps:["Triangle has 3 sides"],exp:"3 sides."},
    {text:"What is 4 + 4?",opts:["8","6","9","7"],ans:0,diff:"easy",type:"numpad",accepted:["8"],hint:"Count 4 then 4 more.",steps:["4+4=8"],exp:"8."},
    {text:"What is 10 âˆ’ 6?",opts:["4","5","3","6"],ans:0,diff:"easy",type:"numpad",accepted:["4"],hint:"Start at 10, count back 6.",steps:["10âˆ’6=4"],exp:"4."},
    {text:"Count by 5s: 5, 10, 15, __",opts:["20","25","18","22"],ans:0,diff:"easy",type:"numpad",accepted:["20"],hint:"Add 5 to 15.",steps:["15+5=20"],exp:"20."},
    {text:"A box has 4 rows of 3 crayons. Total?",opts:["12","7","8","16"],ans:0,diff:"easy",type:"numpad",accepted:["12"],hint:"4Ã—3.",steps:["4Ã—3=12"],exp:"12."},
    {text:"What number is between 7 and 9?",opts:["8","6","10","7"],ans:0,diff:"easy",type:"numpad",accepted:["8"],hint:"7, __, 9.",steps:["8"],exp:"8."},
    {text:"What is 5 Ã— 5?",opts:["25","20","30","10"],ans:0,diff:"easy",type:"numpad",accepted:["25"],hint:"5+5+5+5+5.",steps:["25"],exp:"25."},
    {text:"12 cookies shared equally among 4. How many each?",opts:["3","4","6","2"],ans:0,diff:"easy",type:"numpad",accepted:["3"],hint:"12Ã·4.",steps:["12Ã·4=3"],exp:"3."},
    {text:"What is one hundred minus one?",opts:["99","100","98","101"],ans:0,diff:"easy",type:"numpad",accepted:["99"],hint:"100âˆ’1.",steps:["99"],exp:"99."},
    {text:"Smallest of: 42, 18, 35, 27?",opts:["18","27","35","42"],ans:0,diff:"easy",hint:"Look at tens digits.",steps:["Tens: 4,1,3,2 â†’ smallest is 1 â†’ 18"],exp:"18."},
    {text:"What is 9 + 7?",opts:["16","15","17","14"],ans:0,diff:"easy",type:"numpad",accepted:["16"],hint:"Make 10: 9+1+6=16.",steps:["16"],exp:"16."},
    {text:"Clock shows 3:00. Hours until 7:00?",opts:["4","3","5","6"],ans:0,diff:"easy",type:"numpad",accepted:["4"],hint:"Count from 3 to 7.",steps:["4 hours"],exp:"4."},
    {text:"What is 2 Ã— 9?",opts:["18","16","20","19"],ans:0,diff:"easy",type:"numpad",accepted:["18"],hint:"9+9.",steps:["18"],exp:"18."},
    {text:"24 marbles, take out 8. How many left?",opts:["16","14","18","15"],ans:0,diff:"easy",type:"numpad",accepted:["16"],hint:"24âˆ’8.",steps:["16"],exp:"16."},
    {text:"Even numbers between 1 and 10 (not including 1 and 10)?",opts:["4","3","5","6"],ans:0,diff:"easy",type:"numpad",accepted:["4"],hint:"2, 4, 6, 8.",steps:["2,4,6,8 â†’ 4 numbers"],exp:"4."},
],
  earlyMath:[
    {text:"What is 23 + 48?",opts:["71","61","81","70"],ans:0,diff:"easy",type:"numpad",accepted:["71"],
      hint:"Add the ones column first (3+8=11, carry the 1), then the tens.",
      steps:["Ones: 3 + 8 = 11, write 1 carry 1","Tens: 2 + 4 + 1(carry) = 7","Answer: 71"],exp:"23 + 48 = 71."},
    {text:"What is 100 âˆ’ 37?",opts:["63","73","67","53"],ans:0,diff:"easy",type:"numpad",accepted:["63"],
      hint:"Think of it as: how many do you add to 37 to reach 100?",
      steps:["37 + 3 = 40","40 + 60 = 100","Total added: 3 + 60 = 63"],exp:"100 âˆ’ 37 = 63."},
    {text:"A pencil costs $0.75. You pay $1.00. Change?",opts:["$0.25","$0.15","$0.35","$0.20"],ans:0,diff:"easy",
      hint:"Subtract: $1.00 âˆ’ $0.75.",
      steps:["$1.00 âˆ’ $0.75","= $0.25"],exp:"You get $0.25 back."},
    {text:"8 Ã— 7 = ?",opts:["56","54","48","63"],ans:0,diff:"easy",type:"numpad",accepted:["56"],
      hint:"A multiplication table fact to memorize: 8 Ã— 7.",
      steps:["8 Ã— 7 = 56","Tip: 8Ã—7 = 56 (5,6 â€” consecutive digits!)"],exp:"8 Ã— 7 = 56."},
    {text:"Order from least to greatest: 45, 12, 78, 33",opts:["12, 33, 45, 78","12, 45, 33, 78","33, 12, 45, 78","78, 45, 33, 12"],ans:0,diff:"easy",type:"sort",sortItems:["45","12","78","33"],sortAnswer:["12","33","45","78"],
      hint:"Compare the tens digits first.",
      steps:["Tens: 1(2), 3(3), 4(5), 7(8)","Smallest first: 12, 33, 45, 78"],exp:"12 < 33 < 45 < 78."},
    {text:"What is 6Â²?",opts:["36","12","30","64"],ans:0,diff:"easy",type:"numpad",accepted:["36"],
      hint:"6Â² means 6 Ã— 6.",
      steps:["6Â² = 6 Ã— 6 = 36"],exp:"6 Ã— 6 = 36."},
    {text:"A rectangle has sides 4 and 7. What is the perimeter?",opts:["22","28","11","18"],ans:0,diff:"easy",type:"numpad",accepted:["22"],
      hint:"Perimeter = add all four sides. A rectangle has two pairs of equal sides.",
      steps:["Sides: 4, 7, 4, 7","Perimeter: 4+7+4+7=22"],exp:"2(4+7) = 22."},
    {text:"What is 15% of 60?",opts:["9","6","12","15"],ans:0,diff:"medium",type:"numpad",accepted:["9"],
      hint:"10% of 60 = 6. Then 5% = half of that = 3. Add them.",
      steps:["10% of 60 = 6","5% of 60 = 3","15% = 6 + 3 = 9"],exp:"15% Ã— 60 = 9."},
    {text:"Simplify the fraction: 12/16",opts:["3/4","2/3","4/5","6/8"],ans:0,diff:"medium",
      hint:"Divide top and bottom by their GCD (which is 4).",
      steps:["GCD(12,16)=4","12Ã·4=3 Â· 16Ã·4=4","Answer: 3/4"],exp:"12/16 = 3/4."},
    {text:"A store sells 3 shirts for $24. Cost per shirt?",opts:["$8","$6","$9","$12"],ans:0,diff:"easy",type:"numpad",accepted:["8"],
      hint:"Divide total cost by number of shirts.",
      steps:["$24 Ã· 3 = $8 per shirt"],exp:"$24 Ã· 3 = $8."},
  
    {text:"144 Ã· 12?",opts:["12","11","13","14"],ans:0,diff:"easy",type:"numpad",accepted:["12"],hint:"12Ã—12=144.",steps:["12"],exp:"12."},
    {text:"25% of 200?",opts:["50","25","75","100"],ans:0,diff:"easy",type:"numpad",accepted:["50"],hint:"25%=1/4. 200Ã·4.",steps:["50"],exp:"50."},
    {text:"Round 3,847 to nearest hundred.",opts:["3800","3900","4000","3000"],ans:0,diff:"easy",hint:"Tens digit is 4 < 5 â†’ round down.",steps:["3800"],exp:"3800."},
    {text:"Perimeter of square with side 9?",opts:["36","18","27","81"],ans:0,diff:"easy",type:"numpad",accepted:["36"],hint:"4Ã—9.",steps:["36"],exp:"36."},
    {text:"13 Ã— 11?",opts:["143","131","133","144"],ans:0,diff:"easy",type:"numpad",accepted:["143"],hint:"13Ã—10+13.",steps:["130+13=143"],exp:"143."},
    {text:"Pizza cut in 8 slices, eat 3. Fraction remaining?",opts:["5/8","3/8","1/2","3/5"],ans:0,diff:"easy",hint:"8âˆ’3=5.",steps:["5/8"],exp:"5/8."},
    {text:"7Â² âˆ’ 4Â²?",opts:["33","45","24","15"],ans:0,diff:"medium",type:"numpad",accepted:["33"],hint:"49âˆ’16.",steps:["33"],exp:"33."},
    {text:"0.75 as a fraction in lowest terms?",opts:["3/4","7/10","3/5","75/10"],ans:0,diff:"medium",hint:"75/100 Ã· 25.",steps:["3/4"],exp:"3/4."},
    {text:"Train at 60 mph for 2.5 hours. Distance?",opts:["150 miles","120 miles","125 miles","180 miles"],ans:0,diff:"medium",hint:"d=60Ã—2.5.",steps:["150"],exp:"150 miles."},
    {text:"Area of triangle, base 10 height 6?",opts:["30","60","20","36"],ans:0,diff:"medium",type:"numpad",accepted:["30"],hint:"Â½Ã—10Ã—6.",steps:["30"],exp:"30."},
    {text:"Which is larger: 7/8 or 5/6?",opts:["7/8","5/6","Equal","Can't compare"],ans:0,diff:"medium",hint:"7/8=21/24, 5/6=20/24.",steps:["21>20 â†’ 7/8"],exp:"7/8."},
    {text:"30% off $50 item. What do you pay?",opts:["$35","$20","$30","$15"],ans:0,diff:"medium",hint:"70% of $50.",steps:["$35"],exp:"$35."},
    {text:"Simplify 18/24.",opts:["3/4","2/3","4/6","9/12"],ans:0,diff:"easy",hint:"GCD=6.",steps:["3/4"],exp:"3/4."},
    {text:"1,000 Ã— 0.001?",opts:["1","10","0.1","100"],ans:0,diff:"medium",type:"numpad",accepted:["1"],hint:"Move decimal 3 places.",steps:["1"],exp:"1."},
    {text:"2.5 cups per batch Ã— 3 batches?",opts:["7.5 cups","5.5 cups","6 cups","8 cups"],ans:0,diff:"medium",hint:"2.5Ã—3.",steps:["7.5"],exp:"7.5 cups."},
    {text:"5! (five factorial)?",opts:["120","60","24","100"],ans:0,diff:"medium",type:"numpad",accepted:["120"],hint:"5Ã—4Ã—3Ã—2Ã—1.",steps:["120"],exp:"120."},
    {text:"3/5 as a percentage?",opts:["60%","35%","53%","75%"],ans:0,diff:"easy",hint:"3Ã·5Ã—100.",steps:["60%"],exp:"60%."},
    {text:"240 miles on 8 gallons. MPG?",opts:["30 mpg","28 mpg","32 mpg","25 mpg"],ans:0,diff:"medium",type:"numpad",accepted:["30"],hint:"240Ã·8.",steps:["30"],exp:"30 mpg."},
    {text:"LCM of 4 and 6?",opts:["12","24","8","6"],ans:0,diff:"medium",type:"numpad",accepted:["12"],hint:"Multiples of 4: 4,8,12... and 6: 6,12...",steps:["12"],exp:"12."},
    {text:"If x=3, what is 4x+7?",opts:["19","16","22","13"],ans:0,diff:"medium",type:"numpad",accepted:["19"],hint:"4(3)+7.",steps:["12+7=19"],exp:"19."},
],
  quadratics:[
    {text:"Factor completely: xÂ² + 5x + 6",opts:["(x+2)(x+3)","(x+1)(x+6)","(xâˆ’2)(xâˆ’3)","(x+6)(xâˆ’1)"],ans:0,diff:"easy",
      hint:"Look for two numbers that MULTIPLY to 6 and ADD to 5.",
      steps:["Find two numbers: multiply to 6 and add to 5.","Try 2 and 3: 2Ã—3=6 âœ“ and 2+3=5 âœ“","So xÂ²+5x+6 = (x+2)(x+3) âœ“"],
      exp:"(x+2)(x+3): 2Ã—3=6 and 2+3=5."},
    {text:"Solve: xÂ² âˆ’ 7x + 12 = 0",opts:["x=3 or x=4","x=âˆ’3 or x=âˆ’4","x=2 or x=6","x=1 or x=12"],ans:0,diff:"easy",
      hint:"Factor by finding two numbers that multiply to 12 and add to âˆ’7.",
      steps:["We need two numbers: multiply to 12, add to âˆ’7.","âˆ’3 Ã— âˆ’4 = 12 âœ“ and âˆ’3 + (âˆ’4) = âˆ’7 âœ“","So (xâˆ’3)(xâˆ’4)=0","Set each factor to 0: x=3 or x=4"],
      exp:"(xâˆ’3)(xâˆ’4)=0 â†’ x=3 or x=4."},
    {text:"Solve: xÂ² âˆ’ 4 = 0",opts:["x=2 or x=âˆ’2","x=4 or x=âˆ’4","x=2 only","No real solutions"],ans:0,diff:"easy",
      hint:"This is a difference of squares! aÂ²âˆ’bÂ² = (a+b)(aâˆ’b).",
      steps:["Recognize xÂ²âˆ’4 = xÂ²âˆ’2Â²","Factor: (x+2)(xâˆ’2)=0","x+2=0 â†’ x=âˆ’2 Â· xâˆ’2=0 â†’ x=2","Answer: x=Â±2"],
      exp:"Difference of squares: (x+2)(xâˆ’2)=0 â†’ x=Â±2."},
    {text:"Quadratic formula for 2xÂ² + 5x âˆ’ 3 = 0:",opts:["x=Â½ or x=âˆ’3","x=1 or x=âˆ’3","x=âˆ’Â½ or x=3","x=2 or x=âˆ’3"],ans:0,diff:"medium",
      hint:"Identify a=2, b=5, c=âˆ’3. Discriminant = bÂ²âˆ’4ac = 25+24 = 49.",
      steps:["a=2, b=5, c=âˆ’3","Discriminant: 25âˆ’4(2)(âˆ’3)=25+24=49","âˆš49=7","x=(âˆ’5Â±7)/4","x=(âˆ’5+7)/4=2/4=Â½ OR x=(âˆ’5âˆ’7)/4=âˆ’3"],
      exp:"Disc=49. x=(âˆ’5Â±7)/4 â†’ x=Â½ or x=âˆ’3."},
    {text:"The discriminant bÂ²âˆ’4ac = âˆ’9. This means:",opts:["No real solutions","One repeated real root","Two distinct real roots","Two integer roots"],ans:0,diff:"medium",
      hint:"Negative discriminant â†’ square root of negative number â†’ no real solutions.",
      steps:["Discriminant < 0 â†’ âˆš(negative) is not real","Therefore: no real solutions","The equation has complex/imaginary roots"],
      exp:"bÂ²âˆ’4ac<0 means no real roots exist."},
    {text:"A parabola has vertex (2,âˆ’1) and passes through (0,3). Its equation:",opts:["y=(xâˆ’2)Â²âˆ’1","y=âˆ’(xâˆ’2)Â²âˆ’1","y=2(xâˆ’2)Â²âˆ’1","y=(x+2)Â²+1"],ans:0,diff:"hard",
      hint:"Start with vertex form: y=a(xâˆ’h)Â²+k where (h,k) is the vertex. Then find 'a'.",
      steps:["Vertex (2,âˆ’1): y=a(xâˆ’2)Â²âˆ’1","Plug in (0,3): 3=a(0âˆ’2)Â²âˆ’1","3=4aâˆ’1 â†’ 4a=4 â†’ a=1","Answer: y=(xâˆ’2)Â²âˆ’1 = xÂ²âˆ’4x+3"],
      exp:"Vertex form: y=a(xâˆ’2)Â²âˆ’1. Plug (0,3): a=1."},
    {text:"For what k does xÂ² + kx + 9 = 0 have exactly one solution?",opts:["k=6 or k=âˆ’6","k=3 or k=âˆ’3","k=9 only","k=0"],ans:0,diff:"hard",
      hint:"Exactly one solution â†” discriminant = 0. Set bÂ²âˆ’4ac=0.",
      steps:["Discriminant = kÂ²âˆ’4(1)(9)=kÂ²âˆ’36","For one solution: kÂ²âˆ’36=0","kÂ²=36 â†’ k=Â±6"],
      exp:"kÂ²âˆ’4(9)=0 â†’ kÂ²=36 â†’ k=Â±6."},
    {text:"Sum of roots of 3xÂ² âˆ’ 12x + 7 = 0?",opts:["4","âˆ’4","7/3","12"],ans:0,diff:"medium",
      hint:"Vieta's Formula: sum of roots = âˆ’b/a. No need to solve!",
      steps:["Vieta's Formula: sum = âˆ’b/a","Here b=âˆ’12, a=3","Sum = âˆ’(âˆ’12)/3 = 12/3 = 4"],
      exp:"Vieta's: sum = âˆ’b/a = 12/3 = 4."},
    {text:"Product of roots of 2xÂ² + 6x âˆ’ 10 = 0?",opts:["âˆ’5","5","âˆ’3","3"],ans:0,diff:"medium",
      hint:"Vieta's Formula: product of roots = c/a.",
      steps:["Vieta's Formula: product = c/a","Here c=âˆ’10, a=2","Product = âˆ’10/2 = âˆ’5"],
      exp:"Vieta's: product = c/a = âˆ’10/2 = âˆ’5."},
    {text:"Solve: xÂ² + 6x + 9 = 0",opts:["x=âˆ’3 (double)","x=3","x=3 or x=âˆ’3","x=âˆ’9"],ans:0,diff:"easy",
      hint:"This is a PERFECT SQUARE TRINOMIAL. (x + ?)Â² = xÂ² + 2?x + ?Â²",
      steps:["Recognize: 6=2Ã—3 and 9=3Â²","So xÂ²+6x+9 = (x+3)Â²","(x+3)Â²=0 â†’ x+3=0 â†’ x=âˆ’3","This is a repeated (double) root"],
      exp:"(x+3)Â²=0 â†’ x=âˆ’3 (double root)."},
    {text:"If one root of xÂ² âˆ’ 5x + k = 0 is x=2, find k.",opts:["6","âˆ’6","10","3"],ans:0,diff:"medium",
      hint:"If 2 is a root, substituting x=2 must make the equation true.",
      steps:["Substitute x=2: (2)Â²âˆ’5(2)+k=0","4âˆ’10+k=0","âˆ’6+k=0 â†’ k=6"],
      exp:"4âˆ’10+k=0 â†’ k=6."},
    {text:"For which x is xÂ² âˆ’ 3x âˆ’ 10 < 0?",opts:["âˆ’2 < x < 5","x<âˆ’2 or x>5","âˆ’5<x<2","x>âˆ’2 and x<5"],ans:0,diff:"hard",
      hint:"Factor first. Parabola opens UP (a>0), so it's negative BETWEEN the roots.",
      steps:["Factor: (xâˆ’5)(x+2)=0 â†’ roots x=5 and x=âˆ’2","Parabola opens up (a=1>0)","It's negative (below x-axis) BETWEEN the roots","Answer: âˆ’2 < x < 5"],
      exp:"(xâˆ’5)(x+2)<0. Parabola up â†’ negative between roots: âˆ’2<x<5."},
  
    {text:"Discriminant of xÂ²âˆ’4x+4=0?",opts:["0","16","8","âˆ’4"],ans:0,diff:"easy",type:"numpad",accepted:["0"],hint:"bÂ²âˆ’4ac=(âˆ’4)Â²âˆ’4(1)(4).",steps:["16âˆ’16=0"],exp:"0 â†’ one repeated root."},
    {text:"Solve (xâˆ’5)(x+3)=0.",opts:["x=5 or x=âˆ’3","x=âˆ’5 or x=3","x=5 and x=3","x=âˆ’5"],ans:0,diff:"easy",hint:"Zero product property.",steps:["x=5 or x=âˆ’3"],exp:"x=5 or x=âˆ’3."},
    {text:"Roots of xÂ²âˆ’9=0?",opts:["x=Â±3","x=Â±9","x=3","x=9"],ans:0,diff:"easy",hint:"xÂ²=9.",steps:["x=Â±3"],exp:"Â±3."},
    {text:"Vertex of y=xÂ²âˆ’6x+5?",opts:["(3,âˆ’4)","(âˆ’3,4)","(6,5)","(3,5)"],ans:0,diff:"medium",hint:"x=âˆ’b/2a=3, then y.",steps:["x=3, y=âˆ’4"],exp:"(3,âˆ’4)."},
    {text:"Roots of 2xÂ²+5xâˆ’3=0?",opts:["x=1/2 or x=âˆ’3","x=3 or x=âˆ’1/2","x=1 or x=âˆ’3","x=2 or x=âˆ’3"],ans:0,diff:"medium",hint:"a=2,b=5,c=âˆ’3. Discriminant=49.",steps:["x=(âˆ’5Â±7)/4 â†’ 1/2 or âˆ’3"],exp:"x=1/2 or x=âˆ’3."},
    {text:"Sum of roots of xÂ²âˆ’7x+10=0?",opts:["7","10","âˆ’7","17"],ans:0,diff:"easy",type:"numpad",accepted:["7"],hint:"âˆ’b/a.",steps:["7"],exp:"7."},
    {text:"Product of roots of xÂ²âˆ’7x+10=0?",opts:["10","7","âˆ’7","âˆ’10"],ans:0,diff:"easy",type:"numpad",accepted:["10"],hint:"c/a.",steps:["10"],exp:"10."},
    {text:"Factor 2xÂ²+7x+3.",opts:["(2x+1)(x+3)","(2x+3)(x+1)","(x+3)(2xâˆ’1)","(2x+6)(x+1)"],ans:0,diff:"medium",hint:"AC=6, split middle: 1 and 6.",steps:["(2x+1)(x+3)"],exp:"(2x+1)(x+3)."},
    {text:"Solve xÂ²+10x+25=0.",opts:["x=âˆ’5","x=5","x=Â±5","x=5 or x=âˆ’5"],ans:0,diff:"easy",hint:"Perfect square: (x+5)Â².",steps:["x=âˆ’5"],exp:"x=âˆ’5 (double root)."},
    {text:"Maximum of y=âˆ’xÂ²+4?",opts:["4","âˆ’4","0","2"],ans:0,diff:"medium",type:"numpad",accepted:["4"],hint:"Opens down, vertex at (0,4).",steps:["4"],exp:"4."},
    {text:"Which values satisfy xÂ²<9?",opts:["âˆ’3<x<3","x>3 or x<âˆ’3","x>3","x=Â±3"],ans:0,diff:"medium",hint:"|x|<3.",steps:["âˆ’3<x<3"],exp:"âˆ’3<x<3."},
    {text:"Complete the square: xÂ²+8x=?",opts:["(x+4)Â²âˆ’16","(x+4)Â²","(x+8)Â²âˆ’64","(x+4)Â²+16"],ans:0,diff:"medium",hint:"Add (8/2)Â²=16.",steps:["(x+4)Â²âˆ’16"],exp:"(x+4)Â²âˆ’16."},
    {text:"Ball height h=âˆ’16tÂ²+64t. When hits ground?",opts:["t=4 sec","t=2 sec","t=8 sec","t=64 sec"],ans:0,diff:"hard",hint:"Set h=0. âˆ’16t(tâˆ’4)=0.",steps:["t=0 or t=4"],exp:"t=4 seconds."},
    {text:"Expand (x+3)Â².",opts:["xÂ²+6x+9","xÂ²+9","xÂ²+3x+9","xÂ²+6x+6"],ans:0,diff:"easy",hint:"(a+b)Â²=aÂ²+2ab+bÂ².",steps:["xÂ²+6x+9"],exp:"xÂ²+6x+9."},
    {text:"Axis of symmetry of y=3xÂ²âˆ’12x+7?",opts:["x=2","x=âˆ’2","x=4","x=7"],ans:0,diff:"medium",hint:"x=âˆ’b/2a.",steps:["12/6=2"],exp:"x=2."},
    {text:"How many real roots does xÂ²+4=0 have?",opts:["0","1","2","4"],ans:0,diff:"easy",type:"numpad",accepted:["0"],hint:"Discriminant=âˆ’16<0.",steps:["0"],exp:"0."},
    {text:"Solve 3xÂ²âˆ’27=0.",opts:["x=Â±3","x=3","x=9","x=Â±9"],ans:0,diff:"easy",hint:"xÂ²=9.",steps:["x=Â±3"],exp:"x=Â±3."},
    {text:"f(0) where f(x)=xÂ²âˆ’4x+3?",opts:["3","âˆ’3","0","4"],ans:0,diff:"easy",type:"numpad",accepted:["3"],hint:"Substitute x=0.",steps:["3"],exp:"3."},
    {text:"Factor xÂ²âˆ’2xâˆ’15.",opts:["(xâˆ’5)(x+3)","(x+5)(xâˆ’3)","(xâˆ’5)(xâˆ’3)","(x+5)(x+3)"],ans:0,diff:"easy",hint:"Need: Ã—=âˆ’15, +=âˆ’2.",steps:["(xâˆ’5)(x+3)"],exp:"(xâˆ’5)(x+3)."},
    {text:"Range of y=xÂ²+1?",opts:["yâ‰¥1","all real","yâ‰¤1","y>0"],ans:0,diff:"medium",hint:"xÂ²â‰¥0 always, so xÂ²+1â‰¥1.",steps:["yâ‰¥1"],exp:"yâ‰¥1."},
],
  systems:[
    {text:"Solve:\ny = 2x + 1\ny = âˆ’x + 7",opts:["(2,5)","(3,7)","(1,3)","(0,1)"],ans:0,diff:"easy",
      hint:"Set the right sides equal (both = y), then solve for x.",
      steps:["Set equal: 2x+1=âˆ’x+7","3x=6 â†’ x=2","y=2(2)+1=5","Solution: (2, 5)"],
      exp:"2x+1=âˆ’x+7 â†’ 3x=6 â†’ x=2, y=5."},
    {text:"Solve by elimination:\n2x + y = 10\n3x âˆ’ y = 5",opts:["(3,4)","(2,6)","(4,2)","(5,0)"],ans:0,diff:"easy",
      hint:"Add the two equations. The y terms (+y and âˆ’y) cancel out!",
      steps:["Add equations: (2x+y)+(3xâˆ’y)=10+5","5x=15 â†’ x=3","Sub back: 2(3)+y=10 â†’ y=4","Solution: (3, 4)"],
      exp:"Adding eliminates y: 5x=15 â†’ x=3, y=4."},
    {text:"How many solutions?\n2x âˆ’ 4y = 8\nx âˆ’ 2y = 4",opts:["Infinitely many","Exactly one","No solution","Two solutions"],ans:0,diff:"medium",
      hint:"Divide equation 1 by 2. What do you notice about both equations?",
      steps:["Divide eq1 by 2: xâˆ’2y=4","This is IDENTICAL to eq2!","Both equations describe the SAME line","Same line â†’ infinitely many solutions"],
      exp:"Equations are identical â†’ same line â†’ infinitely many solutions."},
    {text:"Two numbers sum to 30 and differ by 8. Larger number:",type:"free",ans:"19",accepted:["19"],diff:"easy",
      hint:"Call the numbers x and y. Write: x+y=30 and xâˆ’y=8. Then add both equations.",
      steps:["x+y=30 and xâˆ’y=8","Add: 2x=38 â†’ x=19","Sub: y=30âˆ’19=11","Check: 19+11=30 âœ“ and 19âˆ’11=8 âœ“"],
      exp:"x+y=30, xâˆ’y=8. Add â†’ 2x=38 â†’ x=19, y=11."},
    {text:"Solve by substitution:\ny = 3x âˆ’ 1\n2x + y = 9",opts:["(2,5)","(1,2)","(3,8)","(4,11)"],ans:0,diff:"easy",
      hint:"Substitute the first equation into the second wherever you see y.",
      steps:["Replace y with (3xâˆ’1): 2x+(3xâˆ’1)=9","5xâˆ’1=9 â†’ 5x=10 â†’ x=2","y=3(2)âˆ’1=5","Solution: (2, 5)"],
      exp:"2x+(3xâˆ’1)=9 â†’ 5x=10 â†’ x=2, y=5."},
    {text:"System: no solution. Lines must be:",opts:["Parallel","Identical","Perpendicular","Intersecting"],ans:0,diff:"medium",
      hint:"When does a system have no solution? When lines never cross.",
      steps:["Two lines in a plane either: intersect (1 solution), are identical (infinite solutions), or never meet","Lines that never meet are PARALLEL","Parallel lines = same slope, different y-intercept"],
      exp:"Parallel lines never intersect â†’ no solution."},
    {text:"Solve the nonlinear system:\ny = xÂ²\ny = x + 2",opts:["(2,4) and (âˆ’1,1)","(1,1) and (2,4)","(0,0) only","No solution"],ans:0,diff:"hard",
      hint:"Substitute y=xÂ² into y=x+2 to create a quadratic equation.",
      steps:["xÂ²=x+2","xÂ²âˆ’xâˆ’2=0","(xâˆ’2)(x+1)=0 â†’ x=2 or x=âˆ’1","At x=2: y=4. At x=âˆ’1: y=1"],
      exp:"xÂ²=x+2 â†’ (xâˆ’2)(x+1)=0 â†’ (2,4) and (âˆ’1,1)."},
    {text:"Tickets: $3 children, $7 adults. 50 tickets sold, $230 total. Adults:",opts:["20","30","25","15"],ans:0,diff:"medium",
      hint:"Write two equations: total tickets and total money.",
      steps:["c+a=50 and 3c+7a=230","From 1st: c=50âˆ’a","Sub: 3(50âˆ’a)+7a=230","150+4a=230 â†’ 4a=80 â†’ a=20"],
      exp:"c+a=50 and 3c+7a=230. â†’ 4a=80 â†’ a=20."},
    {text:"Car travels 300 miles: first 150 mi at 60 mph, last 150 mi at 40 mph. Total time?",opts:["6.25 hrs","7.5 hrs","5 hrs","6 hrs"],ans:0,diff:"medium",
      hint:"Time = distance Ã· speed. Calculate each leg separately, then add.",
      steps:["First half: 150Ã·60=2.5 hrs","Second half: 150Ã·40=3.75 hrs","Total: 2.5+3.75=6.25 hrs"],
      exp:"150/60 + 150/40 = 2.5+3.75 = 6.25 hrs."},
  
    {text:"Solve x+y=10, xâˆ’y=4.",opts:["x=7,y=3","x=3,y=7","x=6,y=4","x=5,y=5"],ans:0,diff:"easy",hint:"Add equations.",steps:["2x=14â†’x=7,y=3"],exp:"x=7,y=3."},
    {text:"2x+y=11 and y=3. Find x.",opts:["4","5","3","8"],ans:0,diff:"easy",type:"numpad",accepted:["4"],hint:"Substitute y=3.",steps:["2x=8â†’x=4"],exp:"4."},
    {text:"Solve 3xâˆ’y=7, x+y=5.",opts:["x=3,y=2","x=2,y=3","x=4,y=1","x=1,y=4"],ans:0,diff:"easy",hint:"Add to eliminate y.",steps:["4x=12â†’x=3,y=2"],exp:"x=3,y=2."},
    {text:"Two numbers add to 50, one is 4Ã— the other. Larger?",opts:["40","10","30","20"],ans:0,diff:"medium",type:"numpad",accepted:["40"],hint:"x+4x=50.",steps:["5x=50â†’x=10, 4x=40"],exp:"40."},
    {text:"Solve y=2x, x+y=9.",opts:["x=3,y=6","x=4,y=5","x=2,y=7","x=6,y=3"],ans:0,diff:"easy",hint:"Substitute y=2x.",steps:["3x=9â†’x=3,y=6"],exp:"x=3,y=6."},
    {text:"Solve 4x+2y=20, 2x+2y=12.",opts:["x=4,y=2","x=2,y=4","x=4,y=4","x=3,y=3"],ans:0,diff:"medium",hint:"Subtract 2nd from 1st.",steps:["2x=8â†’x=4,y=2"],exp:"x=4,y=2."},
    {text:"No solution means lines are:",opts:["Parallel","Perpendicular","Identical","Intersecting"],ans:0,diff:"easy",hint:"Parallel lines never meet.",steps:["Parallel"],exp:"Parallel."},
    {text:"If x+y=12 and xy=35, find xÂ²+yÂ².",opts:["74","144","70","34"],ans:0,diff:"hard",hint:"(x+y)Â²=xÂ²+2xy+yÂ².",steps:["144âˆ’70=74"],exp:"74."},
    {text:"3 shirts+2 pants=$85. 1 shirt+4 pants=$95. Shirt cost?",opts:["$15","$20","$25","$10"],ans:0,diff:"hard",hint:"Substitute s=95âˆ’4p.",steps:["s=$15"],exp:"$15."},
    {text:"Solve 2x+5=x+11.",opts:["x=6","x=8","x=3","x=16"],ans:0,diff:"easy",type:"numpad",accepted:["6"],hint:"x=11âˆ’5.",steps:["x=6"],exp:"6."},
    {text:"Two angles of triangle sum to 110Â°. Third?",opts:["70Â°","90Â°","80Â°","110Â°"],ans:0,diff:"easy",type:"numpad",accepted:["70"],hint:"180Â°âˆ’110Â°.",steps:["70Â°"],exp:"70Â°."},
    {text:"Boat: 24mi downstream in 2h, 24mi upstream in 3h. Current speed?",opts:["2 mph","4 mph","6 mph","3 mph"],ans:0,diff:"hard",hint:"b+c=12, bâˆ’c=8.",steps:["2b=20â†’b=10,c=2"],exp:"2 mph."},
],
  numberTheory:[
    {text:"LCM of 12 and 18?",opts:["36","6","216","72"],ans:0,diff:"easy",
      hint:"LCM = (aÃ—b)/GCD(a,b). First find GCD using Euclidean algorithm.",
      steps:["GCD(12,18): 18=12Ã—1+6 â†’ GCD(12,6) â†’ 12=6Ã—2+0 â†’ GCD=6","LCM=12Ã—18/6=216/6=36"],
      exp:"GCD(12,18)=6. LCM=12Ã—18/6=36."},
    {text:"Prime numbers between 1 and 30:",opts:["10","8","11","9"],ans:0,diff:"easy",
      hint:"List them systematically. Remember: 1 is NOT prime.",
      steps:["2,3,5,7 (under 10) = 4 primes","11,13,17,19 (10s) = 4 primes","23,29 (20s) = 2 primes","Total: 4+4+2=10 primes"],
      exp:"2,3,5,7,11,13,17,19,23,29 â†’ 10 primes."},
    {text:"3âµ Ã— 3â»Â² = ?",opts:["27","81","9","243"],ans:0,diff:"easy",
      hint:"When multiplying same base: ADD the exponents. aáµ Ã— aâ¿ = aáµâºâ¿",
      steps:["Same base (3): add exponents","3âµ Ã— 3â»Â² = 3^(5+(âˆ’2)) = 3^3","3Â³=3Ã—3Ã—3=27"],
      exp:"3^(5âˆ’2)=3Â³=27."},
    {text:"GCD(48, 60)?",opts:["12","6","24","4"],ans:0,diff:"medium",
      hint:"Euclidean algorithm: GCD(a,b) = GCD(b, a mod b).",
      steps:["GCD(60,48): 60=48Ã—1+12","GCD(48,12): 48=12Ã—4+0","Remainder 0 â†’ GCD=12"],
      exp:"Euclidean algorithm: GCD(48,60)=12."},
    {text:"2^100 mod 3?",opts:["1","0","2","Cannot determine"],ans:0,diff:"hard",
      hint:"Find the pattern: 2^1 mod 3, 2^2 mod 3, 2^3 mod 3... It cycles with period 2!",
      steps:["2^1 mod 3 = 2","2^2 mod 3 = 4 mod 3 = 1","2^3 mod 3 = 8 mod 3 = 2 (pattern repeats!)","Period = 2. 100 is even â†’ same as 2^2 mod 3 = 1"],
      exp:"Pattern: 2,1,2,1... Period 2. 100 is even â†’ 1."},
    {text:"Smallest positive integer divisible by 2, 3, 5, and 7?",opts:["210","105","420","70"],ans:0,diff:"medium",
      hint:"Since 2, 3, 5, 7 are all prime, LCM = just multiply them all.",
      steps:["2,3,5,7 are all prime â†’ no common factors","LCM = 2Ã—3Ã—5Ã—7","= 6Ã—5Ã—7 = 30Ã—7 = 210"],
      exp:"LCM of primes = product = 210."},
    {text:"Trailing zeros in 25!?",opts:["6","5","7","4"],ans:0,diff:"hard",
      hint:"Trailing zeros come from factors of 10 = 2Ã—5. Since 2s outnumber 5s, count factors of 5.",
      steps:["Count multiples of 5: âŒŠ25/5âŒ‹=5","Count multiples of 25: âŒŠ25/25âŒ‹=1","Total = 5+1 = 6 trailing zeros"],
      exp:"âŒŠ25/5âŒ‹+âŒŠ25/25âŒ‹=5+1=6."},
    {text:"Units digit of 7âµÂ³?",opts:["7","1","3","9"],ans:0,diff:"hard",
      hint:"Powers of 7 have a repeating units digit pattern with period 4: 7,9,3,1,7,9,3,1...",
      steps:["7Â¹â†’7, 7Â²â†’9, 7Â³â†’3, 7â´â†’1, 7âµâ†’7 (repeats!)","Pattern period = 4","53 mod 4 = 1 (since 53=13Ã—4+1)","Position 1 in cycle â†’ units digit = 7"],
      exp:"Cycle period 4. 53 mod 4=1 â†’ units digit=7."},
    {text:"How many factors does 360 have?",opts:["24","18","12","36"],ans:0,diff:"hard",
      hint:"Prime factorize first! If n=p^a Ã— q^b Ã— r^c, then # of factors = (a+1)(b+1)(c+1).",
      steps:["360=8Ã—45=8Ã—9Ã—5=2Â³Ã—3Â²Ã—5Â¹","# factors=(3+1)(2+1)(1+1)","=4Ã—3Ã—2=24"],
      exp:"360=2Â³Ã—3Â²Ã—5. Factors=(3+1)(2+1)(1+1)=24."},
    {text:"If aâ‰¡2 (mod 5) and bâ‰¡4 (mod 5), find (a+b) mod 5.",opts:["1","6","0","3"],ans:0,diff:"hard",
      hint:"Just add the residues and reduce mod 5.",
      steps:["(a+b) mod 5 = (a mod 5 + b mod 5) mod 5","=(2+4) mod 5","=6 mod 5 = 1"],
      exp:"(2+4) mod 5 = 6 mod 5 = 1."},
  
    {text:"GCD(48,36)?",opts:["12","6","24","18"],ans:0,diff:"easy",type:"numpad",accepted:["12"],hint:"Largest shared factor.",steps:["12"],exp:"12."},
    {text:"Is 91 prime?",opts:["No","Yes","Maybe","Depends"],ans:0,diff:"medium",hint:"91=7Ã—13.",steps:["Not prime"],exp:"No, 91=7Ã—13."},
    {text:"Prime factorization of 60?",opts:["2Â²Ã—3Ã—5","2Ã—3Ã—5Ã—2","4Ã—15","2Â³Ã—3Ã—5"],ans:0,diff:"medium",hint:"60Ã·2=30, 30Ã·2=15, 15Ã·3=5.",steps:["2Â²Ã—3Ã—5"],exp:"2Â²Ã—3Ã—5."},
    {text:"Number of factors of 36?",opts:["9","6","8","12"],ans:0,diff:"medium",type:"numpad",accepted:["9"],hint:"36=2Â²Ã—3Â². (2+1)(2+1).",steps:["9"],exp:"9."},
    {text:"17 mod 5?",opts:["2","3","1","4"],ans:0,diff:"easy",type:"numpad",accepted:["2"],hint:"17=5Ã—3+2.",steps:["2"],exp:"2."},
    {text:"Smallest prime > 20?",opts:["23","21","22","25"],ans:0,diff:"easy",type:"numpad",accepted:["23"],hint:"21=3Ã—7, 22=2Ã—11, 23 is prime.",steps:["23"],exp:"23."},
    {text:"LCM(8,12)?",opts:["24","96","48","12"],ans:0,diff:"easy",type:"numpad",accepted:["24"],hint:"LCM=8Ã—12/GCD=96/4.",steps:["24"],exp:"24."},
    {text:"2^10?",opts:["1024","512","2048","256"],ans:0,diff:"medium",type:"numpad",accepted:["1024"],hint:"2^10 is a famous CS number.",steps:["1024"],exp:"1024."},
    {text:"nâ‰¡3 (mod 7). Which could be n?",opts:["24","21","20","28"],ans:0,diff:"medium",hint:"n=7k+3.",steps:["24=7Ã—3+3"],exp:"24."},
    {text:"How many primes between 10 and 30?",opts:["6","5","4","7"],ans:0,diff:"medium",type:"numpad",accepted:["6"],hint:"11,13,17,19,23,29.",steps:["6"],exp:"6."},
    {text:"Units digit of 7^4?",opts:["1","7","9","3"],ans:0,diff:"medium",type:"numpad",accepted:["1"],hint:"Cycle: 7,9,3,1.",steps:["7^4 ends in 1"],exp:"1."},
    {text:"n even, m odd. n+m is always:",opts:["Odd","Even","Both","Neither"],ans:0,diff:"medium",hint:"even+odd=odd.",steps:["Odd"],exp:"Odd."},
    {text:"Remainder when 100Ã·7?",opts:["2","1","3","6"],ans:0,diff:"easy",type:"numpad",accepted:["2"],hint:"7Ã—14=98.",steps:["2"],exp:"2."},
    {text:"Divisible by both 3 and 4?",opts:["24","18","16","21"],ans:0,diff:"easy",hint:"LCM(3,4)=12.",steps:["24Ã·12=2"],exp:"24."},
    {text:"72 as prime factors?",opts:["2Â³Ã—3Â²","2Ã—36","8Ã—9","2Â³Ã—9"],ans:0,diff:"medium",hint:"72=8Ã—9.",steps:["2Â³Ã—3Â²"],exp:"2Â³Ã—3Â²."},
    {text:"(âˆ’3)^4?",opts:["81","âˆ’81","12","âˆ’12"],ans:0,diff:"easy",type:"numpad",accepted:["81"],hint:"Even exponent â†’ positive.",steps:["81"],exp:"81."},
    {text:"Remainder: 100Ã·7?",opts:["2","1","3","0"],ans:0,diff:"easy",type:"numpad",accepted:["2"],hint:"Same as above.",steps:["2"],exp:"2."},
    {text:"5^3 mod 4?",opts:["1","0","3","2"],ans:0,diff:"medium",type:"numpad",accepted:["1"],hint:"5â‰¡1 mod 4.",steps:["1^3=1"],exp:"1."},
    {text:"Sum of 3 consecutive integers is 63. Middle one?",opts:["21","20","22","19"],ans:0,diff:"medium",type:"numpad",accepted:["21"],hint:"3n=63.",steps:["n=21"],exp:"21."},
    {text:"How many zeros does 20! end with?",opts:["4","5","3","20"],ans:0,diff:"hard",type:"numpad",accepted:["4"],hint:"âŒŠ20/5âŒ‹+âŒŠ20/25âŒ‹.",steps:["4+0=4"],exp:"4."},
],
  geometry:[
    {text:"Rectangle: length 12, width 5. Diagonal?",opts:["13","17","âˆš119","7"],ans:0,diff:"easy",
      hint:"The diagonal is the hypotenuse! Use Pythagorean theorem.",
      steps:["dÂ²=lengthÂ²+widthÂ²=12Â²+5Â²","=144+25=169","d=âˆš169=13"],
      exp:"dÂ²=144+25=169 â†’ d=13."},
    {text:"Circle with circumference 10Ï€. Area?",opts:["25Ï€","10Ï€","100Ï€","5Ï€"],ans:0,diff:"medium",
      hint:"First find r from C=2Ï€r, then use A=Ï€rÂ².",
      steps:["C=2Ï€r=10Ï€ â†’ r=5","A=Ï€rÂ²=Ï€(5)Â²=25Ï€"],
      exp:"r=5, Area=25Ï€."},
    {text:"Triangle angles 45Â° and 75Â°. Third angle?",opts:["60Â°","80Â°","90Â°","70Â°"],ans:0,diff:"easy",
      hint:"Sum of angles in ANY triangle = 180Â°.",
      steps:["Sum = 180Â°","Third = 180âˆ’45âˆ’75=60Â°"],
      exp:"180âˆ’45âˆ’75=60Â°."},
    {text:"Right triangle legs 5 and 12. Hypotenuse?",opts:["13","15","âˆš119","17"],ans:0,diff:"easy",
      hint:"aÂ²+bÂ²=cÂ². Recognize the 5-12-13 Pythagorean triple!",
      steps:["5Â²+12Â²=cÂ²","25+144=169","c=âˆš169=13","Pythagorean triple: 5-12-13"],
      exp:"5Â²+12Â²=169 â†’ c=13. (5-12-13 triple)"},
    {text:"Equilateral triangle with side 4. Area?",opts:["4âˆš3","8âˆš3","2âˆš3","16âˆš3"],ans:0,diff:"medium",
      hint:"Formula: A=(âˆš3/4)sÂ². Equilateral means all sides equal.",
      steps:["A=(âˆš3/4)sÂ²=(âˆš3/4)(4)Â²","=(âˆš3/4)(16)=4âˆš3"],
      exp:"A=(âˆš3/4)(16)=4âˆš3."},
    {text:"Similar triangles: areas 9 and 36. Perimeter ratio?",opts:["1:2","1:4","2:1","3:6"],ans:0,diff:"hard",
      hint:"Area scales as (side ratio)Â². So find the side ratio first, then perimeter ratio = side ratio.",
      steps:["Area ratio = 9:36 = 1:4","Area ratio = (side ratio)Â²","So side ratio = âˆš(1/4)=1/2","Perimeters scale the same as sides â†’ 1:2"],
      exp:"Area ratio 1:4 â†’ side ratio 1:2 â†’ perimeter ratio 1:2."},
    {text:"Circle inscribed in square with side 6. Circle area?",opts:["9Ï€","6Ï€","36Ï€","3Ï€"],ans:0,diff:"medium",
      hint:"The circle just touches all four sides. So diameter = side of square.",
      steps:["Diameter = side = 6 â†’ radius = 3","A=Ï€rÂ²=Ï€(3)Â²=9Ï€"],
      exp:"r=3 (diameter=side), A=9Ï€."},
    {text:"Cylinder: radius 3, height 5. Volume?",opts:["45Ï€","15Ï€","9Ï€","30Ï€"],ans:0,diff:"medium",
      hint:"V=Ï€rÂ²h (pi times radius squared times height).",
      steps:["V=Ï€rÂ²h=Ï€(3Â²)(5)","=Ï€(9)(5)=45Ï€"],
      exp:"V=Ï€(9)(5)=45Ï€."},
    {text:"30-60-90 triangle with hypotenuse 10. Shorter leg?",opts:["5","5âˆš3","10/âˆš3","10âˆš3"],ans:0,diff:"medium",
      hint:"30-60-90 sides ratio: x : xâˆš3 : 2x. Hypotenuse = 2x.",
      steps:["Hypotenuse = 2x = 10 â†’ x=5","Shorter leg (opposite 30Â°) = x = 5","Longer leg (opposite 60Â°) = 5âˆš3"],
      exp:"2x=10 â†’ x=5. Shorter leg=5."},
    {text:"Interior angle sum of a regular octagon?",opts:["1080Â°","720Â°","1440Â°","900Â°"],ans:0,diff:"medium",
      hint:"Formula: (nâˆ’2)Ã—180Â° where n = number of sides.",
      steps:["n=8 sides","Sum=(8âˆ’2)Ã—180=6Ã—180=1080Â°"],
      exp:"(8âˆ’2)Ã—180=1080Â°."},
    {text:"Sector of circle (radius 6, central angle 60Â°). Arc length?",opts:["2Ï€","Ï€","6Ï€","3Ï€"],ans:0,diff:"hard",
      hint:"Arc length = (central angle / 360Â°) Ã— circumference.",
      steps:["Full circumference = 2Ï€(6) = 12Ï€","Fraction of circle = 60/360 = 1/6","Arc length = (1/6)(12Ï€) = 2Ï€"],
      exp:"(60/360)Ã—2Ï€(6) = 2Ï€."},
  
    {text:"Area of circle radius 5? (Ï€â‰ˆ3.14)",opts:["78.5","31.4","25","15.7"],ans:0,diff:"easy",hint:"Ï€rÂ².",steps:["3.14Ã—25=78.5"],exp:"78.5."},
    {text:"Circumference of circle diameter 10? (Ï€â‰ˆ3.14)",opts:["31.4","62.8","15.7","78.5"],ans:0,diff:"easy",hint:"Ï€d.",steps:["31.4"],exp:"31.4."},
    {text:"Right triangle legs 5 and 12. Hypotenuse?",opts:["13","17","7","15"],ans:0,diff:"easy",type:"numpad",accepted:["13"],hint:"5-12-13 triple.",steps:["13"],exp:"13."},
    {text:"Volume of cube side 4?",opts:["64","48","16","96"],ans:0,diff:"easy",type:"numpad",accepted:["64"],hint:"sÂ³.",steps:["64"],exp:"64."},
    {text:"Triangle angles 45Â° and 65Â°. Third?",opts:["70Â°","80Â°","90Â°","75Â°"],ans:0,diff:"easy",type:"numpad",accepted:["70"],hint:"180âˆ’45âˆ’65.",steps:["70Â°"],exp:"70Â°."},
    {text:"Area of trapezoid, parallel sides 6 and 10, height 4?",opts:["32","24","40","16"],ans:0,diff:"medium",type:"numpad",accepted:["32"],hint:"Â½(bâ‚+bâ‚‚)h.",steps:["Â½Ã—16Ã—4=32"],exp:"32."},
    {text:"Supplement of 130Â°?",opts:["50Â°","40Â°","60Â°","130Â°"],ans:0,diff:"easy",type:"numpad",accepted:["50"],hint:"180âˆ’130.",steps:["50Â°"],exp:"50Â°."},
    {text:"Sum of interior angles of hexagon?",opts:["720Â°","540Â°","900Â°","360Â°"],ans:0,diff:"medium",type:"numpad",accepted:["720"],hint:"(nâˆ’2)Ã—180, n=6.",steps:["720Â°"],exp:"720Â°."},
    {text:"Volume of cylinder radius 3, height 10? (Ï€â‰ˆ3.14)",opts:["282.6","94.2","188.4","30Ï€"],ans:0,diff:"medium",hint:"Ï€rÂ²h.",steps:["3.14Ã—9Ã—10=282.6"],exp:"282.6."},
    {text:"Alternate interior angles are:",opts:["Equal","Supplementary","Complementary","Perpendicular"],ans:0,diff:"medium",hint:"Parallel lines cut by transversal.",steps:["Equal"],exp:"Equal."},
    {text:"Diagonal of rectangle 3 by 4?",opts:["5","7","âˆš7","25"],ans:0,diff:"easy",type:"numpad",accepted:["5"],hint:"3-4-5 triangle.",steps:["5"],exp:"5."},
    {text:"Triangle angles in ratio 1:2:3. Largest?",opts:["90Â°","60Â°","120Â°","45Â°"],ans:0,diff:"medium",type:"numpad",accepted:["90"],hint:"6x=180.",steps:["3x=90Â°"],exp:"90Â°."},
    {text:"Exterior angle of regular pentagon?",opts:["72Â°","108Â°","60Â°","90Â°"],ans:0,diff:"medium",type:"numpad",accepted:["72"],hint:"360Ã·5.",steps:["72Â°"],exp:"72Â°."},
    {text:"Surface area of cube side 3?",opts:["54","27","36","18"],ans:0,diff:"easy",type:"numpad",accepted:["54"],hint:"6sÂ².",steps:["54"],exp:"54."},
    {text:"In right triangle, sin A=3/5. cos A?",opts:["4/5","3/4","5/3","1/5"],ans:0,diff:"hard",hint:"3-4-5 triangle.",steps:["4/5"],exp:"4/5."},
    {text:"Each interior angle of regular octagon?",opts:["135Â°","120Â°","150Â°","90Â°"],ans:0,diff:"medium",type:"numpad",accepted:["135"],hint:"(8âˆ’2)Ã—180Ã·8.",steps:["135Â°"],exp:"135Â°."},
    {text:"Similar triangles scale 3:1. Smaller area 4. Larger?",opts:["36","12","9","16"],ans:0,diff:"hard",type:"numpad",accepted:["36"],hint:"Area scales as square.",steps:["4Ã—9=36"],exp:"36."},
    {text:"Slant height of cone, radius 3, height 4?",opts:["5","7","âˆš7","4"],ans:0,diff:"medium",type:"numpad",accepted:["5"],hint:"lÂ²=rÂ²+hÂ².",steps:["âˆš25=5"],exp:"5."},
    {text:"Complement of 35Â°?",opts:["55Â°","45Â°","65Â°","145Â°"],ans:0,diff:"easy",type:"numpad",accepted:["55"],hint:"90âˆ’35.",steps:["55Â°"],exp:"55Â°."},
    {text:"Arc length, 60Â° central angle, radius 6? (Ï€â‰ˆ3.14)",opts:["6.28","18.84","3.14","12.56"],ans:0,diff:"hard",hint:"(60/360)Ã—2Ï€r.",steps:["(1/6)Ã—37.68=6.28"],exp:"6.28."},
],
  probability:[
    {text:"Probability of rolling sum 7 with two dice?",opts:["1/6","7/36","1/7","6/25"],ans:0,diff:"easy",
      hint:"List all pairs that sum to 7. Total outcomes = 6Ã—6=36.",
      steps:["Pairs summing to 7: (1,6),(2,5),(3,4),(4,3),(5,2),(6,1) = 6 pairs","Total outcomes: 6Ã—6=36","P=6/36=1/6"],
      exp:"6 favorable / 36 total = 1/6."},
    {text:"Arrangements of letters in MATH?",opts:["24","16","12","48"],ans:0,diff:"easy",
      hint:"All 4 letters are distinct. Use 4! (4 factorial).",
      steps:["4 distinct letters: 4 choices for 1st, 3 for 2nd, 2 for 3rd, 1 for 4th","4!=4Ã—3Ã—2Ã—1=24"],
      exp:"4!=24."},
    {text:"Bag: 3 red, 4 blue, 5 green. P(blue)?",opts:["1/3","4/12","1/4","5/12"],ans:0,diff:"easy",
      hint:"P = (favorable outcomes) / (total outcomes). Total = 3+4+5.",
      steps:["Total marbles = 3+4+5=12","Favorable (blue) = 4","P = 4/12 = 1/3"],
      exp:"4/12=1/3."},
    {text:"Choose 3 from 7 people (order doesn't matter)?",opts:["35","210","21","42"],ans:0,diff:"medium",
      hint:"Use combinations: C(n,r) = n!/[r!(nâˆ’r)!]. Order doesn't matter = combination.",
      steps:["C(7,3) = 7!/(3!Ã—4!)","= (7Ã—6Ã—5)/(3Ã—2Ã—1)","= 210/6 = 35"],
      exp:"C(7,3)=35."},
    {text:"Two cards drawn without replacement. P(both aces)?",opts:["1/221","1/169","4/663","1/52"],ans:0,diff:"hard",
      hint:"P(1st ace) Ã— P(2nd ace | 1st was ace). Multiply conditional probabilities.",
      steps:["P(1st ace) = 4/52 = 1/13","P(2nd ace | 1st ace removed) = 3/51","P(both) = (4/52)Ã—(3/51) = 12/2652 = 1/221"],
      exp:"(4/52)Ã—(3/51)=1/221."},
    {text:"Flip coin 3 times. P(exactly 2 heads)?",opts:["3/8","1/2","1/4","3/4"],ans:0,diff:"medium",
      hint:"Use binomial probability: C(3,2)Ã—(Â½)Â²Ã—(Â½)Â¹.",
      steps:["Need exactly 2 heads out of 3 flips","C(3,2)=3 ways to choose which 2 are heads","Each outcome has prob (Â½)Â³=1/8","P=3Ã—(1/8)=3/8"],
      exp:"C(3,2)Ã—(Â½)Â³=3/8."},
    {text:"3-digit numbers from {1,2,3,4,5} with no repetition?",opts:["60","120","24","100"],ans:0,diff:"medium",
      hint:"This is a permutation. How many choices for each digit position?",
      steps:["1st digit: 5 choices","2nd digit: 4 remaining choices","3rd digit: 3 remaining choices","Total: 5Ã—4Ã—3=60"],
      exp:"P(5,3)=5Ã—4Ã—3=60."},
    {text:"P(A)=0.3, P(B)=0.5, A and B independent. P(A and B)?",opts:["0.15","0.8","0.35","0.2"],ans:0,diff:"medium",
      hint:"For INDEPENDENT events: P(Aâˆ©B) = P(A)Ã—P(B).",
      steps:["Independent means one doesn't affect the other","P(A and B) = P(A)Ã—P(B)","=0.3Ã—0.5=0.15"],
      exp:"Independent: P(Aâˆ©B)=0.3Ã—0.5=0.15."},
    {text:"Seat 5 people in a circle (rotations same). How many ways?",opts:["24","120","12","60"],ans:0,diff:"hard",
      hint:"Circular permutations: fix one person, arrange the rest. Formula: (nâˆ’1)!",
      steps:["Fix 1 person to eliminate equivalent rotations","Arrange remaining 4: 4!=24","Circular permutations = (5âˆ’1)!=4!=24"],
      exp:"(nâˆ’1)!=(5âˆ’1)!=24."},
  
    {text:"Bag: 5 red, 3 blue, 2 green. P(not red)?",opts:["1/2","1/10","2/5","3/5"],ans:0,diff:"easy",hint:"1âˆ’P(red)=1âˆ’1/2.",steps:["1/2"],exp:"1/2."},
    {text:"Roll die twice. P(both even)?",opts:["1/4","1/2","1/3","1/6"],ans:0,diff:"medium",hint:"(1/2)Ã—(1/2).",steps:["1/4"],exp:"1/4."},
    {text:"4 books arranged on shelf. How many ways?",opts:["24","16","12","4"],ans:0,diff:"easy",type:"numpad",accepted:["24"],hint:"4!",steps:["24"],exp:"24."},
    {text:"Choose 2 from 7 students?",opts:["21","42","14","35"],ans:0,diff:"medium",type:"numpad",accepted:["21"],hint:"C(7,2).",steps:["21"],exp:"21."},
    {text:"Flip coin 3 times. P(exactly 2 heads)?",opts:["3/8","1/2","1/4","1/8"],ans:0,diff:"medium",hint:"HHT,HTH,THH â†’ 3 of 8.",steps:["3/8"],exp:"3/8."},
    {text:"P(A)=0.4, P(B)=0.5, independent. P(A and B)?",opts:["0.2","0.9","0.1","0.45"],ans:0,diff:"medium",hint:"Multiply.",steps:["0.2"],exp:"0.2."},
    {text:"P(drawing a king from deck)?",opts:["1/13","4/52","1/52","4/13"],ans:0,diff:"easy",hint:"4/52.",steps:["1/13"],exp:"1/13."},
    {text:"P(A)=0.6, P(B)=0.5, P(Aâˆ©B)=0.3. P(A or B)?",opts:["0.8","1.1","0.3","0.9"],ans:0,diff:"medium",hint:"Addition rule.",steps:["0.6+0.5âˆ’0.3=0.8"],exp:"0.8."},
    {text:"3-digit password, digits 0-9. How many unique?",opts:["1000","999","900","729"],ans:0,diff:"medium",type:"numpad",accepted:["1000"],hint:"10Â³.",steps:["1000"],exp:"1000."},
    {text:"15 boys, 10 girls. P(boy selected)?",opts:["3/5","2/3","1/2","3/4"],ans:0,diff:"easy",hint:"15/25.",steps:["3/5"],exp:"3/5."},
    {text:"President and VP from 10 people. How many ways?",opts:["90","100","10","45"],ans:0,diff:"medium",type:"numpad",accepted:["90"],hint:"10Ã—9.",steps:["90"],exp:"90."},
    {text:"Expected value: win $10 P=0.3, lose $5 P=0.7.",opts:["âˆ’$0.50","$3","$10","âˆ’$2"],ans:0,diff:"hard",hint:"10(0.3)+(âˆ’5)(0.7).",steps:["3âˆ’3.5=âˆ’0.5"],exp:"âˆ’$0.50."},
    {text:"P(A|B) means:",opts:["P(A given B)","P(A and B)","P(A)Ã—P(B)","P(B given A)"],ans:0,diff:"medium",hint:"Conditional probability.",steps:["P(A given B)"],exp:"P(A given B)."},
    {text:"P(rolling >4 on die)?",opts:["1/3","1/2","2/3","1/6"],ans:0,diff:"easy",hint:"5 and 6 â†’ 2/6.",steps:["1/3"],exp:"1/3."},
    {text:"4-letter arrangements of ABCD?",opts:["24","16","12","4"],ans:0,diff:"easy",type:"numpad",accepted:["24"],hint:"4!",steps:["24"],exp:"24."},
],
  algebra:[
    {text:"f(x)=3xâˆ’2. What is f(f(4))?",opts:["28","10","30","34"],ans:0,diff:"easy",
      hint:"Compute from inside out: first f(4), then apply f to that result.",
      steps:["f(4) = 3(4)âˆ’2 = 12âˆ’2 = 10","f(f(4)) = f(10) = 3(10)âˆ’2 = 28"],
      exp:"f(4)=10, f(10)=28."},
    {text:"Slope through (1,2) and (4,8)?",opts:["2","3","6","1/2"],ans:0,diff:"easy",
      hint:"Slope = rise/run = (yâ‚‚âˆ’yâ‚)/(xâ‚‚âˆ’xâ‚).",
      steps:["m = (8âˆ’2)/(4âˆ’1)","= 6/3 = 2"],
      exp:"m=(8âˆ’2)/(4âˆ’1)=6/3=2."},
    {text:"Slope-intercept form of 2y âˆ’ 4x = 10?",opts:["y=2x+5","y=4x+10","y=2x+10","y=âˆ’2x+5"],ans:0,diff:"easy",
      hint:"Solve for y: isolate y on the left side.",
      steps:["2y=4x+10","Divide both sides by 2: y=2x+5"],
      exp:"2y=4x+10 â†’ y=2x+5."},
    {text:"10th term of 3, 7, 11, 15, ...?",opts:["39","37","43","40"],ans:0,diff:"medium",
      hint:"Arithmetic sequence: aâ‚™=aâ‚+(nâˆ’1)d. Find d (common difference).",
      steps:["d=7âˆ’3=4 (common difference)","aâ‚™=aâ‚+(nâˆ’1)d","aâ‚â‚€=3+(10âˆ’1)(4)=3+36=39"],
      exp:"aâ‚â‚€=3+9Ã—4=39."},
    {text:"Sum of first 8 terms of 2, 6, 18, 54, ...?",opts:["6560","3280","6558","13120"],ans:0,diff:"hard",
      hint:"Geometric series (r=3). Sum = aâ‚(râ¿âˆ’1)/(râˆ’1).",
      steps:["r=6/2=3 (geometric with ratio 3)","Sâ‚™=aâ‚(râ¿âˆ’1)/(râˆ’1)","Sâ‚ˆ=2(3â¸âˆ’1)/(3âˆ’1)","3â¸=6561","Sâ‚ˆ=2(6560)/2=6560"],
      exp:"Sâ‚ˆ=2(3â¸âˆ’1)/2=6560."},
    {text:"g(x)=xÂ²âˆ’4, h(x)=2x+1. Find g(h(1)).",opts:["5","âˆ’1","8","3"],ans:0,diff:"medium",
      hint:"Compute h(1) first, then substitute that value into g(x).",
      steps:["h(1)=2(1)+1=3","g(h(1))=g(3)=3Â²âˆ’4=9âˆ’4=5"],
      exp:"h(1)=3, g(3)=5."},
    {text:"Solve: |2x âˆ’ 3| = 7",opts:["x=5 or x=âˆ’2","x=5 or x=2","x=âˆ’5 or x=2","x=5 only"],ans:0,diff:"medium",
      hint:"|expression|=k means: expression=k OR expression=âˆ’k. Two cases!",
      steps:["Case 1: 2xâˆ’3=7 â†’ 2x=10 â†’ x=5","Case 2: 2xâˆ’3=âˆ’7 â†’ 2x=âˆ’4 â†’ x=âˆ’2","Answer: x=5 or x=âˆ’2"],
      exp:"Two cases: 2xâˆ’3=Â±7 â†’ x=5 or x=âˆ’2."},
    {text:"Inverse of f(x)=2x+6?",opts:["fâ»Â¹(x)=(xâˆ’6)/2","fâ»Â¹(x)=2xâˆ’6","fâ»Â¹(x)=(x+6)/2","fâ»Â¹(x)=x/2+6"],ans:0,diff:"medium",
      hint:"To find inverse: replace f(x) with y, SWAP x and y, then solve for y.",
      steps:["y=2x+6","Swap x and y: x=2y+6","Solve for y: xâˆ’6=2y â†’ y=(xâˆ’6)/2","fâ»Â¹(x)=(xâˆ’6)/2"],
      exp:"Swap x,y: x=2y+6 â†’ y=(xâˆ’6)/2."},
    {text:"If 2^x = 32, find x.",opts:["5","4","6","16"],ans:0,diff:"easy",
      hint:"Express 32 as a power of 2. What power of 2 equals 32?",
      steps:["2Â¹=2, 2Â²=4, 2Â³=8, 2â´=16, 2âµ=32","So 2^x=2âµ â†’ x=5"],
      exp:"32=2âµ â†’ x=5."},
    {text:"Simplify: (xÂ²âˆ’9)/(x+3) for xâ‰ âˆ’3",opts:["xâˆ’3","x+3","xÂ²âˆ’3","x+3 again"],ans:0,diff:"medium",
      hint:"Factor the numerator first: xÂ²âˆ’9 is a DIFFERENCE OF SQUARES.",
      steps:["xÂ²âˆ’9=(x+3)(xâˆ’3)","(x+3)(xâˆ’3)/(x+3)","Cancel (x+3): result is xâˆ’3"],
      exp:"xÂ²âˆ’9=(x+3)(xâˆ’3). Cancel (x+3) â†’ xâˆ’3."},
  
    {text:"Simplify 3(x+4)âˆ’2x.",opts:["x+12","x+7","5x+12","3x+12"],ans:0,diff:"easy",hint:"Distribute then combine.",steps:["3x+12âˆ’2x=x+12"],exp:"x+12."},
    {text:"Solve 2(3xâˆ’1)=4x+6.",opts:["x=4","x=2","x=3","x=8"],ans:0,diff:"easy",type:"numpad",accepted:["4"],hint:"Distribute left side.",steps:["6xâˆ’2=4x+6â†’x=4"],exp:"4."},
    {text:"Slope of y=âˆ’3x+7?",opts:["âˆ’3","7","3","âˆ’7"],ans:0,diff:"easy",hint:"y=mx+b, m is slope.",steps:["âˆ’3"],exp:"âˆ’3."},
    {text:"y-intercept of 2x+3y=12?",opts:["4","6","3","12"],ans:0,diff:"easy",type:"numpad",accepted:["4"],hint:"Set x=0.",steps:["y=4"],exp:"4."},
    {text:"Simplify (2xÂ³)(3xÂ²).",opts:["6xâµ","5xâµ","6xâ¶","6x^5"],ans:0,diff:"easy",hint:"Multiply coefficients, add exponents.",steps:["6xâµ"],exp:"6xâµ."},
    {text:"Solve |xâˆ’3|=5.",opts:["x=8 or x=âˆ’2","x=8 or x=2","x=8","x=âˆ’2"],ans:0,diff:"medium",hint:"Two cases: xâˆ’3=5 or xâˆ’3=âˆ’5.",steps:["x=8 or x=âˆ’2"],exp:"x=8 or x=âˆ’2."},
    {text:"Perpendicular slope to y=2x+1?",opts:["âˆ’1/2","2","âˆ’2","1/2"],ans:0,diff:"medium",hint:"Negative reciprocal.",steps:["âˆ’1/2"],exp:"âˆ’1/2."},
    {text:"Factor 3xÂ²âˆ’12.",opts:["3(x+2)(xâˆ’2)","3(xÂ²âˆ’4)","3(x+4)(xâˆ’1)","(3x+6)(xâˆ’2)"],ans:0,diff:"medium",hint:"Factor 3, then diff of squares.",steps:["3(x+2)(xâˆ’2)"],exp:"3(x+2)(xâˆ’2)."},
    {text:"f(g(x)) where f(x)=x+2, g(x)=3x, at x=4?",opts:["14","18","10","24"],ans:0,diff:"medium",type:"numpad",accepted:["14"],hint:"g(4)=12, f(12)=14.",steps:["14"],exp:"14."},
    {text:"NOT a function: which one?",opts:["x=yÂ²","y=xÂ²","y=2x","y=|x|"],ans:0,diff:"medium",hint:"Fails vertical line test.",steps:["x=yÂ²: two y-values for x=4"],exp:"x=yÂ²."},
    {text:"Simplify (x+3)/(xÂ²âˆ’9).",opts:["1/(xâˆ’3)","1/(x+3)","x+3","(x+3)Â²"],ans:0,diff:"medium",hint:"xÂ²âˆ’9=(x+3)(xâˆ’3).",steps:["1/(xâˆ’3)"],exp:"1/(xâˆ’3)."},
    {text:"Solve 3x/4=9.",opts:["x=12","x=9","x=4","x=3"],ans:0,diff:"easy",type:"numpad",accepted:["12"],hint:"Multiply by 4/3.",steps:["x=12"],exp:"12."},
    {text:"Domain of f(x)=1/(xâˆ’2)?",opts:["All x except x=2","All x","x>2","xâ‰¥2"],ans:0,diff:"medium",hint:"Denominator â‰  0.",steps:["xâ‰ 2"],exp:"All x except 2."},
    {text:"Solve 2xâˆ’3>7.",opts:["x>5","x<5","x>2","x<2"],ans:0,diff:"easy",hint:"2x>10.",steps:["x>5"],exp:"x>5."},
    {text:"Inverse of f(x)=2x+6?",opts:["(xâˆ’6)/2","2xâˆ’6","(x+6)/2","x/2+3"],ans:0,diff:"medium",hint:"Swap x and y, solve for y.",steps:["(xâˆ’6)/2"],exp:"fâ»Â¹(x)=(xâˆ’6)/2."},
    {text:"Simplify 2^(âˆ’3).",opts:["1/8","âˆ’8","8","âˆ’1/8"],ans:0,diff:"easy",hint:"Negative exponent = reciprocal.",steps:["1/8"],exp:"1/8."},
    {text:"g(f(3)) where f(x)=xÂ², g(x)=x+1?",opts:["10","9","16","7"],ans:0,diff:"medium",type:"numpad",accepted:["10"],hint:"f(3)=9, g(9)=10.",steps:["10"],exp:"10."},
    {text:"logâ‚â‚€(x)=3. x=?",opts:["1000","30","10","300"],ans:0,diff:"hard",type:"numpad",accepted:["1000"],hint:"10Â³=x.",steps:["1000"],exp:"1000."},
    {text:"Distance between (1,2) and (4,6)?",opts:["5","7","âˆš7","25"],ans:0,diff:"medium",type:"numpad",accepted:["5"],hint:"âˆš((3Â²+4Â²)).",steps:["5"],exp:"5."},
    {text:"Midpoint of (2,4) and (8,10)?",opts:["(5,7)","(6,8)","(3,4)","(10,14)"],ans:0,diff:"easy",hint:"Average each coordinate.",steps:["(5,7)"],exp:"(5,7)."},
    {text:"Simplify âˆš50.",opts:["5âˆš2","10âˆš5","25âˆš2","âˆš50"],ans:0,diff:"medium",hint:"50=25Ã—2.",steps:["5âˆš2"],exp:"5âˆš2."},
    {text:"Slope-intercept form of 3xâˆ’2y=8?",opts:["y=3x/2âˆ’4","y=3xâˆ’8","y=âˆ’3x/2+4","y=2x/3âˆ’4"],ans:0,diff:"medium",hint:"Solve for y.",steps:["y=3x/2âˆ’4"],exp:"y=(3/2)xâˆ’4."},
    {text:"Smallest root of xÂ²âˆ’4x+3=0?",opts:["1","3","âˆ’1","2"],ans:0,diff:"medium",type:"numpad",accepted:["1"],hint:"Factor: (xâˆ’1)(xâˆ’3).",steps:["x=1"],exp:"1."},
    {text:"Solve (x+1)/(xâˆ’1)=3.",opts:["x=2","x=4","x=âˆ’1","x=1/2"],ans:0,diff:"medium",type:"numpad",accepted:["2"],hint:"Cross multiply.",steps:["x+1=3xâˆ’3â†’x=2"],exp:"2."},
    {text:"0! (zero factorial)?",opts:["1","0","undefined","âˆ’1"],ans:0,diff:"easy",type:"numpad",accepted:["1"],hint:"By convention, 0!=1.",steps:["1"],exp:"1."},
],
  logic:[
    {text:"Double a number, subtract 5, get 19. The number?",opts:["12","7","19","14"],ans:0,diff:"easy",
      hint:"Translate to an equation: 2Ã—nâˆ’5=19. Solve for n.",
      steps:["2nâˆ’5=19","2n=24","n=12","Check: 2(12)âˆ’5=24âˆ’5=19 âœ“"],
      exp:"2nâˆ’5=19 â†’ n=12."},
    {text:"Bat + ball = $1.10. Bat is $1 more than ball. Ball costs:",opts:["$0.05","$0.10","$0.15","$0.20"],ans:0,diff:"medium",
      hint:"This is a classic trick! Don't say $0.10. Let b=ball, (b+1)=bat. Set up equation.",
      steps:["ball=b, bat=b+1","b+(b+1)=1.10","2b+1=1.10","2b=0.10 â†’ b=$0.05 (not $0.10!)"],
      exp:"2b+$1=$1.10 â†’ b=$0.05. Common wrong answer: $0.10."},
    {text:"Next: 2, 6, 18, 54, ___",opts:["162","108","96","180"],ans:0,diff:"easy",
      hint:"What are you doing to get from one term to the next?",
      steps:["6/2=3, 18/6=3, 54/18=3","Multiply by 3 each time (geometric)","54Ã—3=162"],
      exp:"Multiply by 3: 54Ã—3=162."},
    {text:"Next prime after 23?",opts:["29","25","27","31"],ans:0,diff:"easy",
      hint:"Check each number after 23: is it divisible by any prime up to its square root?",
      steps:["24=2Ã—12 (not prime)","25=5Ã—5 (not prime)","26=2Ã—13 (not prime)","27=3Ã—9 (not prime)","28=4Ã—7 (not prime)","29: not divisible by 2,3,5 â†’ PRIME!"],
      exp:"29 is the next prime after 23."},
    {text:"20 heads, 56 legs (chickens + cows). Cows?",opts:["8","12","10","6"],ans:0,diff:"medium",
      hint:"Chickens have 2 legs, cows have 4 legs. Write two equations.",
      steps:["c+k=20 (heads) and 4c+2k=56 (legs)","Multiply 1st by 2: 2c+2k=40","Subtract: 2c=16 â†’ c=8 cows","k=20âˆ’8=12 chickens"],
      exp:"Elimination: 2c=16 â†’ c=8 cows."},
    {text:"1, 1, 2, 3, 5, 8, 13, ___",opts:["21","20","24","18"],ans:0,diff:"easy",
      hint:"This is the famous Fibonacci sequence. Each term = sum of previous two.",
      steps:["Rule: aâ‚™=aâ‚™â‚‹â‚+aâ‚™â‚‹â‚‚","8+13=21"],
      exp:"Fibonacci: 8+13=21."},
    {text:"If today is Wednesday, what day is 100 days from now?",opts:["Friday","Saturday","Thursday","Sunday"],ans:0,diff:"medium",
      hint:"Days of week cycle with period 7. Find 100 mod 7.",
      steps:["100 Ã· 7 = 14 remainder 2","So 100 days = 14 full weeks + 2 extra days","Wednesday + 2 days = Friday"],
      exp:"100 mod 7 = 2. Wednesday + 2 = Friday."},
    {text:"Clock shows 3:00. Angle between hands?",opts:["90Â°","60Â°","120Â°","45Â°"],ans:0,diff:"easy",
      hint:"Clock has 12 hours around 360Â°. Each hour = 30Â°. At 3:00, how many hours apart?",
      steps:["360Â° Ã· 12 hours = 30Â° per hour","At 3:00, hands are 3 hours apart","3 Ã— 30Â° = 90Â°"],
      exp:"3 hours Ã— 30Â°/hour = 90Â°."},
    {text:"Pattern: 1, 4, 9, 16, 25, ___",opts:["36","30","35","49"],ans:0,diff:"easy",
      hint:"Look at each number: 1=1Â², 4=2Â², 9=3Â²... What's the pattern?",
      steps:["1Â²=1, 2Â²=4, 3Â²=9, 4Â²=16, 5Â²=25","Next: 6Â²=36"],
      exp:"Perfect squares: 6Â²=36."},
    {text:"How many 3-letter 'words' using A,B,C,D (letters can repeat)?",opts:["64","24","12","48"],ans:0,diff:"medium",
      hint:"If repetition IS allowed, each position has the same number of choices.",
      steps:["4 choices for 1st letter","4 choices for 2nd letter","4 choices for 3rd letter","Total=4Ã—4Ã—4=64"],
      exp:"With repetition: 4Â³=64."},
  
    {text:"Next in Fibonacci: 1,1,2,3,5,8,__?",opts:["13","11","10","16"],ans:0,diff:"easy",type:"numpad",accepted:["13"],hint:"Sum of two previous.",steps:["5+8=13"],exp:"13."},
    {text:"All Bloops are Razzles, all Razzles are Lazzles. All Bloops are:",opts:["Lazzles","Razzles only","Neither","Sometimes Lazzles"],ans:0,diff:"easy",hint:"Transitive: Aâ†’Bâ†’C means Aâ†’C.",steps:["Lazzles"],exp:"Lazzles."},
    {text:"Next in geometric: 2,6,18,54,__?",opts:["162","108","81","216"],ans:0,diff:"easy",type:"numpad",accepted:["162"],hint:"Ã—3 each time.",steps:["54Ã—3=162"],exp:"162."},
    {text:"30 people: pizza or tacos. 20 pizza, 18 tacos. Both?",opts:["8","10","12","6"],ans:0,diff:"medium",type:"numpad",accepted:["8"],hint:"Inclusion-exclusion.",steps:["20+18âˆ’30=8"],exp:"8."},
    {text:"Sequence 3,7,11,15,... 10th term?",opts:["39","43","35","41"],ans:0,diff:"medium",type:"numpad",accepted:["39"],hint:"aâ‚â‚€=3+9Ã—4.",steps:["39"],exp:"39."},
    {text:"Today is Wednesday. Day in 100 days?",opts:["Friday","Thursday","Saturday","Wednesday"],ans:0,diff:"medium",hint:"100 mod 7=2.",steps:["Wed+2=Friday"],exp:"Friday."},
    {text:"Circle:Sphere as Square:?",opts:["Cube","Rectangle","Pentagon","Triangle"],ans:0,diff:"easy",hint:"2Dâ†’3D.",steps:["Cube"],exp:"Cube."},
    {text:"3Ã—3Ã—3 cube painted and cut into 1Ã—1Ã—1. How many have exactly 1 face painted?",opts:["6","8","12","0"],ans:0,diff:"hard",type:"numpad",accepted:["6"],hint:"Face centers: 1 per face Ã— 6 faces.",steps:["6"],exp:"6."},
    {text:"Pattern: 1,4,9,16,25,__?",opts:["36","30","35","49"],ans:0,diff:"easy",type:"numpad",accepted:["36"],hint:"Perfect squares: 6Â².",steps:["36"],exp:"36."},
    {text:"Aâ†”B means:",opts:["Logically equivalent","Contradiction","Unrelated","A implies B only"],ans:0,diff:"medium",hint:"Both Aâ†’B and Bâ†’A.",steps:["Logically equivalent"],exp:"Logically equivalent."},
    {text:"Missing: 2,4,8,__,32,64?",opts:["16","12","10","24"],ans:0,diff:"easy",type:"numpad",accepted:["16"],hint:"Powers of 2.",steps:["16"],exp:"16."},
    {text:"5 people, each shakes hands with every other. Total?",opts:["10","20","5","25"],ans:0,diff:"medium",type:"numpad",accepted:["10"],hint:"C(5,2).",steps:["10"],exp:"10."},
    {text:"NOT(NOT P) equals?",opts:["P","NOT P","True","False"],ans:0,diff:"easy",hint:"Double negative cancels.",steps:["P"],exp:"P."},
    {text:"50th odd number?",opts:["99","101","100","98"],ans:0,diff:"medium",type:"numpad",accepted:["99"],hint:"nth odd=2nâˆ’1.",steps:["2(50)âˆ’1=99"],exp:"99."},
    {text:"Alice before Bob, Bob before Carol, Carol before Dave. Who finishes last?",opts:["Dave","Carol","Bob","Alice"],ans:0,diff:"easy",hint:"Follow the chain.",steps:["Dave"],exp:"Dave."},
],
  statistics:[
    {text:"Mean of 4, 8, 6, 10, 7?",opts:["7","7.5","6.5","8"],ans:0,diff:"easy",
      hint:"Mean = sum of all values Ã· count of values.",
      steps:["Sum=4+8+6+10+7=35","Count=5","Mean=35/5=7"],
      exp:"35/5=7."},
    {text:"Median of 3,1,4,1,5,9,2,6?",opts:["3.5","4","3","4.5"],ans:0,diff:"easy",
      hint:"SORT the numbers first, then find the middle. With even count: average the two middle values.",
      steps:["Sorted: 1,1,2,3,4,5,6,9 (8 values)","Middle two: 3rd=2... wait, 4th=3 and 5th=4","Median=(3+4)/2=3.5"],
      exp:"Sorted: 1,1,2,3,4,5,6,9. Median=(3+4)/2=3.5."},
    {text:"Mean of 5 numbers is 12. Add 18. New mean?",opts:["13","12","14","15"],ans:0,diff:"medium",
      hint:"Find the original sum first (mean Ã— count), then add 18 and recalculate.",
      steps:["Original sum = 5Ã—12 = 60","New sum = 60+18 = 78","New count = 6","New mean = 78/6 = 13"],
      exp:"(5Ã—12+18)/6=78/6=13."},
    {text:"Mode of 2,5,3,2,7,5,2,8?",opts:["2","5","3","7"],ans:0,diff:"easy",
      hint:"Mode = most frequently occurring value. Count each value.",
      steps:["2 appears: 3 times","5 appears: 2 times","3,7,8 appear: 1 time each","Mode = 2"],
      exp:"2 appears 3 times â€” most frequent."},
    {text:"Which is most affected by outlier 200 in {10,20,30,40,200}?",opts:["Mean","Median","Mode","Range"],ans:0,diff:"medium",
      hint:"Which statistic pulls ALL values into its calculation directly?",
      steps:["Mean=(10+20+30+40+200)/5=300/5=60 (dragged up by 200!)","Median of sorted list: 10,20,30,40,200 â†’ middle=30 (barely affected)","Mode: none","Range=200âˆ’10=190 (also affected, but mean is more commonly cited)"],
      exp:"Mean = 60 vs expected ~25. The outlier 200 pulls the mean up dramatically."},
    {text:"Range of 4, 8, 2, 15, 6?",opts:["13","11","15","9"],ans:0,diff:"easy",
      hint:"Range = maximum value âˆ’ minimum value.",
      steps:["Max=15, Min=2","Range=15âˆ’2=13"],
      exp:"Range=maxâˆ’min=15âˆ’2=13."},
    {text:"Dataset {5,5,5,5,5}. Standard deviation?",opts:["0","5","1","25"],ans:0,diff:"medium",
      hint:"Standard deviation measures spread. If all values are identical, how much do they spread?",
      steps:["Mean=5","Every value = mean â†’ deviation = 0 for all","Standard deviation = âˆš(average of squared deviations) = âˆš0 = 0"],
      exp:"All values equal the mean â†’ zero deviation â†’ SD=0."},
    {text:"Mean=50, Median=45. Distribution is likely:",opts:["Right-skewed","Left-skewed","Symmetric","Uniform"],ans:0,diff:"hard",
      hint:"If mean > median, extreme high values pull the mean right. Which direction is the tail?",
      steps:["Mean=50 > Median=45","High outliers pull mean UP (right)","So the tail is on the right","= right-skewed (positive skew)"],
      exp:"Mean > Median â†’ extreme high values â†’ right-skewed."},
  
    {text:"Mean of 4,7,13,2,9?",opts:["7","6","8","5"],ans:0,diff:"easy",type:"numpad",accepted:["7"],hint:"SumÃ·count.",steps:["35Ã·5=7"],exp:"7."},
    {text:"Median of 3,7,1,9,5?",opts:["5","7","3","9"],ans:0,diff:"easy",type:"numpad",accepted:["5"],hint:"Sort: 1,3,5,7,9.",steps:["Middle=5"],exp:"5."},
    {text:"Mode of 2,5,3,5,7,2,5?",opts:["5","2","7","3"],ans:0,diff:"easy",type:"numpad",accepted:["5"],hint:"Most frequent.",steps:["5 appears 3 times"],exp:"5."},
    {text:"Range of 15,3,28,7,42,19?",opts:["39","27","42","15"],ans:0,diff:"easy",type:"numpad",accepted:["39"],hint:"Maxâˆ’min.",steps:["42âˆ’3=39"],exp:"39."},
    {text:"Mean=50, n=5. Sum?",opts:["250","50","100","55"],ans:0,diff:"easy",type:"numpad",accepted:["250"],hint:"Sum=meanÃ—n.",steps:["250"],exp:"250."},
    {text:"Most affected by outliers?",opts:["Mean","Median","Mode","Range"],ans:0,diff:"medium",hint:"Outliers pull the average.",steps:["Mean"],exp:"Mean."},
    {text:"Mean of 1,2,3,4,5?",opts:["3","2.5","4","5"],ans:0,diff:"easy",type:"numpad",accepted:["3"],hint:"15Ã·5.",steps:["3"],exp:"3."},
    {text:"Scores 80,90,70,100. Need mean 85 on 5th test?",opts:["85","80","90","75"],ans:0,diff:"medium",type:"numpad",accepted:["85"],hint:"Target total=425.",steps:["425âˆ’340=85"],exp:"85."},
    {text:"Right-skewed distribution: mean vs median?",opts:["Mean>Median","Mean<Median","Equal","Varies"],ans:0,diff:"hard",hint:"Long right tail pulls mean up.",steps:["Mean>Median"],exp:"Mean is greater."},
    {text:"Normal dist: data within 1 SD of mean?",opts:["68%","95%","99.7%","50%"],ans:0,diff:"hard",hint:"68-95-99.7 rule.",steps:["68%"],exp:"â‰ˆ68%."},
    {text:"Median of 10,20,30,40?",opts:["25","20","30","15"],ans:0,diff:"easy",hint:"Average of two middle values.",steps:["(20+30)/2=25"],exp:"25."},
    {text:"IQR if Q1=10 and Q3=25?",opts:["15","20","35","10"],ans:0,diff:"medium",type:"numpad",accepted:["15"],hint:"Q3âˆ’Q1.",steps:["15"],exp:"15."},
    {text:"Mode of 6,7,7,8,8,8,9,9,10,10?",opts:["8","9","7","10"],ans:0,diff:"easy",type:"numpad",accepted:["8"],hint:"Most frequent.",steps:["8 appears 3 times"],exp:"8."},
    {text:"Values 1,2,3 with frequencies 4,6,2. Mean?",opts:["1.83","2","2.5","1.5"],ans:0,diff:"hard",hint:"Î£(vÃ—f)/Î£f.",steps:["22/12â‰ˆ1.83"],exp:"â‰ˆ1.83."},
    {text:"Remove a value equal to the mean. Mean changes?",opts:["Same","Increases","Decreases","Can't tell"],ans:0,diff:"medium",hint:"Removing the mean doesn't shift it.",steps:["Same"],exp:"Stays the same."},
],
  challenge:[
    {text:"Average of 5 numbers is 12. Remove one â†’ average becomes 10. Number removed?",opts:["20","18","22","16"],ans:0,diff:"competition",
      hint:"Sum of 5 = mean Ã— count = 5Ã—12. Sum of remaining 4 = 4Ã—10. Difference = removed number.",
      steps:["Sum of 5: 5Ã—12=60","Sum of remaining 4: 4Ã—10=40","Removed: 60âˆ’40=20"],
      exp:"60âˆ’40=20."},
    {text:"Positive integers < 100 divisible by 3 or 5?",opts:["46","47","48","45"],ans:0,diff:"competition",
      hint:"Use Inclusion-Exclusion: |AâˆªB|=|A|+|B|âˆ’|Aâˆ©B|. Aâˆ©B = divisible by both = by 15.",
      steps:["Divisible by 3: âŒŠ99/3âŒ‹=33","Divisible by 5: âŒŠ95/5âŒ‹=19","Divisible by 15: âŒŠ90/15âŒ‹=6","Total: 33+19âˆ’6=46"],
      exp:"Inclusion-Exclusion: 33+19âˆ’6=46."},
    {text:"Train: 120 mi @60 mph then 120 mi @40 mph. Average speed?",opts:["48 mph","50 mph","45 mph","52 mph"],ans:0,diff:"competition",
      hint:"Average speed â‰  average of speeds! Use total distance Ã· total time.",
      steps:["Time 1: 120/60=2 hours","Time 2: 120/40=3 hours","Total: 240 miles in 5 hours","Average: 240/5=48 mph"],
      exp:"Total distance/total time = 240/5 = 48 mph."},
    {text:"Sum of all integers 1 to 100?",opts:["5050","5000","5100","4950"],ans:0,diff:"competition",
      hint:"Gauss's trick: pair first and last (1+100=101, 2+99=101...). 50 pairs!",
      steps:["Gauss formula: n(n+1)/2","=100Ã—101/2","=10100/2=5050","Or: 50 pairs of 101 = 5050"],
      exp:"n(n+1)/2=100Ã—101/2=5050."},
    {text:"3Ã—3Ã—3 cube painted, cut into 27 unit cubes. Cubes with exactly 2 painted faces?",opts:["12","8","6","24"],ans:0,diff:"competition",
      hint:"Think about where unit cubes are located: corners? edges? face-centers? center?",
      steps:["Corners: 3 faces painted (8 cubes)","Edge non-corners: 2 faces painted","Face centers: 1 face painted","Complete center: 0 faces","A 3Ã—3 cube has 12 edges, each with 1 middle unit","So 12 cubes have exactly 2 painted faces"],
      exp:"12 edge (non-corner) unit cubes have exactly 2 painted faces."},
    {text:"Boys:girls = 3:4. There are 28 girls. Total students?",opts:["49","28","21","42"],ans:0,diff:"competition",
      hint:"If ratio is 3:4, the girls represent 4 parts of the whole.",
      steps:["4 parts = 28 girls â†’ 1 part = 7","Boys = 3 parts = 21","Total = 7 parts = 49"],
      exp:"1 part=7. Boys=21. Total=49."},
    {text:"Apples $0.40, oranges $0.55. Maria: 15 fruits, $7.20. Oranges?",opts:["8","7","9","6"],ans:0,diff:"competition",
      hint:"Two equations: a+o=15 and 0.40a+0.55o=7.20. Use substitution.",
      steps:["a=15âˆ’o","0.40(15âˆ’o)+0.55o=7.20","6âˆ’0.40o+0.55o=7.20","0.15o=1.20 â†’ o=8"],
      exp:"0.15o=1.20 â†’ o=8."},
    {text:"Smallest number leaving remainder 1 when divided by 2,3,4,5,6?",opts:["61","31","121","41"],ans:0,diff:"competition",
      hint:"Find LCM(2,3,4,5,6) first. Then what number satisfies all conditions?",
      steps:["LCM(2,3,4,5,6)=60","We need Nâ‰¡1 (mod 2), mod 3, mod 4, mod 5, mod 6","N=LCM+1=60+1=61","Check: 61Ã·2=30 R1 âœ“, 61Ã·3=20 R1 âœ“..."],
      exp:"LCM(2,3,4,5,6)=60. Answer=61."},
    {text:"Diagonals in a regular hexagon?",opts:["9","6","12","15"],ans:0,diff:"competition",
      hint:"Formula: n(nâˆ’3)/2 for an n-sided polygon.",
      steps:["n=6 sides","Diagonals = 6(6âˆ’3)/2","=6(3)/2=18/2=9"],
      exp:"n(nâˆ’3)/2=6Ã—3/2=9."},
    {text:"Product=48, sum=14 for two positive integers. What are they?",type:"free",ans:"6 and 8",accepted:["6 and 8","8 and 6","6,8","8,6"],diff:"competition",
      hint:"x+y=14 and xy=48. Form quadratic: substitute y=14âˆ’x into xy=48.",
      steps:["x(14âˆ’x)=48","14xâˆ’xÂ²=48","xÂ²âˆ’14x+48=0","(xâˆ’6)(xâˆ’8)=0 â†’ x=6 or 8","The two numbers are 6 and 8"],
      exp:"xÂ²âˆ’14x+48=0 â†’ 6 and 8."},
    {text:"Perfect squares strictly between 100 and 500?",opts:["12","11","13","10"],ans:0,diff:"competition",
      hint:"List the perfect squares. âˆš100=10, âˆš500â‰ˆ22.4. Count 11Â² through 22Â².",
      steps:["âˆš100=10 (excluded), âˆš500â‰ˆ22.4","Perfect squares: 11Â²=121 through 22Â²=484","Count: 11,12,13,...,22 = 12 numbers"],
      exp:"11Â² through 22Â² â†’ 22âˆ’11+1=12."},
    {text:"12 play chess, 8 play checkers, 5 play both. At least one?",opts:["15","20","25","10"],ans:0,diff:"competition",
      hint:"Inclusion-Exclusion: |chess âˆª checkers| = |chess| + |checkers| âˆ’ |both|.",
      steps:["|ChessâˆªCheckers|=|Chess|+|Checkers|âˆ’|Both|","=12+8âˆ’5=15"],
      exp:"12+8âˆ’5=15."},
    {text:"50th term of 7, 11, 15, 19, ...?",opts:["203","199","207","211"],ans:0,diff:"competition",
      hint:"Arithmetic sequence: aâ‚™=aâ‚+(nâˆ’1)d. What is d?",
      steps:["d=11âˆ’7=4","aâ‚…â‚€=7+(50âˆ’1)Ã—4","=7+49Ã—4=7+196=203"],
      exp:"aâ‚+(nâˆ’1)d=7+49Ã—4=203."},
    {text:"Rectangle: perimeter 28, area 45. Dimensions?",opts:["5 and 9","4 and 10","6 and 8","3 and 11"],ans:0,diff:"competition",
      hint:"2(l+w)=28 â†’ l+w=14. Also lw=45. These give a system â†’ quadratic.",
      steps:["l+w=14 and lw=45","Quadratic: lÂ²âˆ’14l+45=0","(lâˆ’5)(lâˆ’9)=0 â†’ l=5 or 9","Dimensions: 5 and 9"],
      exp:"l+w=14, lw=45 â†’ (lâˆ’5)(lâˆ’9)=0 â†’ 5 and 9."},
  
    {text:"Units digit of 3^100?",opts:["1","3","9","7"],ans:0,diff:"competition",type:"numpad",accepted:["1"],hint:"Cycle: 3,9,7,1 length 4. 100 mod 4=0.",steps:["1"],exp:"1."},
    {text:"Diagonals in 12-sided polygon?",opts:["54","66","78","48"],ans:0,diff:"competition",type:"numpad",accepted:["54"],hint:"n(nâˆ’3)/2.",steps:["12Ã—9/2=54"],exp:"54."},
    {text:"Product of consecutive even integers is 168. Smaller?",opts:["12","14","10","8"],ans:0,diff:"competition",type:"numpad",accepted:["12"],hint:"n(n+2)=168.",steps:["12Ã—14=168"],exp:"12."},
    {text:"Sum of 1+2+...+100?",opts:["5050","5000","10000","4950"],ans:0,diff:"competition",type:"numpad",accepted:["5050"],hint:"n(n+1)/2.",steps:["100Ã—101/2=5050"],exp:"5050."},
    {text:"Ways to sit 3 people in 5 chairs?",opts:["60","10","20","120"],ans:0,diff:"competition",type:"numpad",accepted:["60"],hint:"P(5,3)=5Ã—4Ã—3.",steps:["60"],exp:"60."},
    {text:"Solve âˆš(2x+1)=3.",opts:["x=4","x=5","x=3","x=8"],ans:0,diff:"competition",type:"numpad",accepted:["4"],hint:"Square both sides.",steps:["2x+1=9â†’x=4"],exp:"4."},
    {text:"Integers 1-100 divisible by 3 or 5?",opts:["47","33","40","50"],ans:0,diff:"competition",type:"numpad",accepted:["47"],hint:"Inclusion-exclusion: 33+20âˆ’6.",steps:["47"],exp:"47."},
    {text:"Largest prime factor of 360?",opts:["5","3","2","6"],ans:0,diff:"competition",type:"numpad",accepted:["5"],hint:"360=2Â³Ã—3Â²Ã—5.",steps:["5"],exp:"5."},
    {text:"Sum 1Â²+2Â²+...+10Â²?",opts:["385","285","450","330"],ans:0,diff:"competition",type:"numpad",accepted:["385"],hint:"n(n+1)(2n+1)/6.",steps:["385"],exp:"385."},
    {text:"P(two aces in a row, no replacement)?",opts:["1/221","1/169","4/663","1/52"],ans:0,diff:"competition",hint:"(4/52)Ã—(3/51).",steps:["1/221"],exp:"1/221."},
    {text:"Number of divisors of 2â´Ã—3Â²Ã—5?",opts:["30","15","20","24"],ans:0,diff:"competition",type:"numpad",accepted:["30"],hint:"(4+1)(2+1)(1+1).",steps:["5Ã—3Ã—2=30"],exp:"30."},
    {text:"If logâ‚‚(3)=a, find logâ‚„(9).",opts:["a","2a","a/2","aÂ²"],ans:0,diff:"competition",hint:"logâ‚„(9)=logâ‚‚(9)/logâ‚‚(4).",steps:["2a/2=a"],exp:"a."},
    {text:"Sum of infinite geometric: 1/2+1/4+1/8+...?",opts:["1","2","1/2","âˆž"],ans:0,diff:"competition",type:"numpad",accepted:["1"],hint:"S=a/(1âˆ’r)=(1/2)/(1/2).",steps:["1"],exp:"1."},
    {text:"Squares of any size in 10Ã—10 grid?",opts:["385","100","200","400"],ans:0,diff:"competition",type:"numpad",accepted:["385"],hint:"Î£kÂ² from k=1 to 10.",steps:["n(n+1)(2n+1)/6=385"],exp:"385."},
],
  hardProblems:[
    {text:"If f(x) = 2xÂ² âˆ’ 3x + 1, find f(âˆ’2).",opts:["15","11","7","âˆ’1"],ans:0,diff:"hard",
      hint:"Substitute x=âˆ’2. Remember (âˆ’2)Â²=4.",
      steps:["f(âˆ’2)=2(4)+6+1=15"],exp:"f(âˆ’2)=15."},
    {text:"Find remainder when 2âµâ° is divided by 7.",opts:["4","1","2","6"],ans:0,diff:"hard",
      hint:"2 mod 7 cycle: 2,4,1 (length 3). 50 mod 3=2.",
      steps:["2Â¹=2,2Â²=4,2Â³=1 mod 7","50 mod 3=2 â†’ 2Â²=4"],exp:"4."},
    {text:"How many ways to arrange LEVEL?",opts:["30","120","60","20"],ans:0,diff:"hard",
      hint:"5!/(2!Ã—2!) â€” two L's, two E's.",
      steps:["5!/(2!Ã—2!)=120/4=30"],exp:"30."},
    {text:"The sum of first n odd numbers equals?",opts:["nÂ²","n(n+1)/2","2n","nÂ²+1"],ans:0,diff:"hard",
      hint:"1=1Â², 1+3=4=2Â², 1+3+5=9=3Â²",
      steps:["Pattern: sum = nÂ²"],exp:"nÂ²."},
    {text:"Geometric sequence 3,6,12,... 8th term?",opts:["384","192","768","256"],ans:0,diff:"hard",
      hint:"r=2, aâ‚™=3Ã—2^(nâˆ’1).",
      steps:["aâ‚ˆ=3Ã—2â·=384"],exp:"384."},
    {text:"If logâ‚‚(x)=5, find x.",opts:["32","25","10","16"],ans:0,diff:"hard",
      hint:"2âµ=x.",
      steps:["2âµ=32"],exp:"32."},
    {text:"Circle xÂ²+yÂ²âˆ’6x+4y=12. What is its radius?",opts:["5","25","âˆš12","7"],ans:0,diff:"hard",
      hint:"Complete the square.",
      steps:["(xâˆ’3)Â²+(y+2)Â²=25, r=5"],exp:"5."},
    {text:"How many diagonals in a 10-gon?",opts:["35","45","54","40"],ans:0,diff:"hard",
      hint:"n(nâˆ’3)/2.",
      steps:["10Ã—7/2=35"],exp:"35."},
    {text:"Value of âˆš(6+âˆš(6+âˆš(6+...)))?",opts:["3","âˆš6","4","2+âˆš6"],ans:0,diff:"hard",
      hint:"Let x=âˆš(6+x). Solve xÂ²=6+x.",
      steps:["xÂ²âˆ’xâˆ’6=0","(xâˆ’3)(x+2)=0","x=3"],exp:"3."},
    {text:"Coefficient of xÂ³ in (1+x)â¶?",opts:["20","15","6","10"],ans:0,diff:"hard",
      hint:"C(6,3).",
      steps:["C(6,3)=20"],exp:"20."},
    {text:"Solve 2^(x+1)=32.",opts:["x=4","x=5","x=3","x=16"],ans:0,diff:"hard",type:"numpad",accepted:["4"],
      hint:"32=2âµ â†’ x+1=5.",
      steps:["x=4"],exp:"4."},
    {text:"Product of roots of 2xÂ²âˆ’8x+6=0?",opts:["3","4","âˆ’3","6"],ans:0,diff:"hard",type:"numpad",accepted:["3"],
      hint:"c/a=6/2.",
      steps:["c/a=3"],exp:"3."},
    {text:"How many trailing zeros does 30! have?",opts:["7","6","5","8"],ans:0,diff:"hard",type:"numpad",accepted:["7"],
      hint:"âŒŠ30/5âŒ‹+âŒŠ30/25âŒ‹.",
      steps:["6+1=7"],exp:"7."},
    {text:"Find all x: |2xâˆ’1|<5.",opts:["âˆ’2<x<3","x<3","x>âˆ’2","âˆ’5<x<5"],ans:0,diff:"hard",
      hint:"âˆ’5<2xâˆ’1<5.",
      steps:["âˆ’4<2x<6","âˆ’2<x<3"],exp:"âˆ’2<x<3."},
    {text:"If a+b=5 and aÂ²+bÂ²=17, find ab.",opts:["4","8","3","6"],ans:0,diff:"hard",type:"numpad",accepted:["4"],
      hint:"(a+b)Â²=aÂ²+2ab+bÂ².",
      steps:["25=17+2ab","ab=4"],exp:"4."},
    {text:"Sum of integers from âˆ’50 to 50?",opts:["0","50","2550","âˆ’50"],ans:0,diff:"hard",type:"numpad",accepted:["0"],
      hint:"Symmetric: every positive cancels its negative.",
      steps:["Sum=0"],exp:"0."},
    {text:"Expand (x+y)â´ â€” coefficient of xÂ²yÂ²?",opts:["6","4","12","3"],ans:0,diff:"hard",type:"numpad",accepted:["6"],
      hint:"C(4,2).",
      steps:["C(4,2)=6"],exp:"6."},
    {text:"Derivative of xÂ³ at x=2?",opts:["12","6","8","3"],ans:0,diff:"hard",type:"numpad",accepted:["12"],
      hint:"f'(x)=3xÂ². At x=2: 3Ã—4.",
      steps:["3(4)=12"],exp:"12."},
    {text:"Solve 4^x=8.",opts:["x=3/2","x=2","x=3","x=1"],ans:0,diff:"hard",
      hint:"4=2Â², 8=2Â³. So 2^(2x)=2Â³.",
      steps:["2x=3","x=3/2"],exp:"x=3/2."},
    {text:"Sum of infinite series: 4+2+1+1/2+...?",opts:["8","6","16","4"],ans:0,diff:"hard",type:"numpad",accepted:["8"],
      hint:"S=a/(1âˆ’r), a=4, r=1/2.",
      steps:["4/(1âˆ’1/2)=8"],exp:"8."},
  ],
};

// â”€â”€ POST-PROCESS QB: tag all suitable questions as mental â”€â”€
// mental = no pencil/paper needed, multiple choice, quick to solve in head
(function tagMentalQuestions() {
  const nonMentalKeywords = ['step','derivative','integral','completing the square','long division',
    'prime factori','synthetic','matrix','system of','row echelon','gaussian','taylor','series sum',
    'infinite series','binomial theorem','parametric'];
  for (const topic of Object.keys(QB)) {
    QB[topic].forEach(q => {
      if (q.type === 'sort' || q.type === 'multivar' || q.type === 'free') return;
      if (!q.opts || q.opts.length < 4) return;
      const textLower = (q.text || '').toLowerCase();
      const isTooComplex = nonMentalKeywords.some(kw => textLower.includes(kw));
      if (!isTooComplex && q.diff !== 'hard' && q.diff !== 'competition') {
        q.mental = true;
      }
    });
  }
})();

// â”€â”€ EXTRA MENTAL MATH QUESTION BANK (for duels) â”€â”€
// These are tagged mental:true by default. Added to existing QB arrays.
(function addMentalQuestions() {

const extra = {
  counting: [
    {text:"5 + 8 = ?",opts:["13","12","14","11"],ans:0,diff:"easy",mental:true,hint:"Count up 8 from 5.",steps:["13"],exp:"13.",hint:"Count on from 5."},
    {text:"19 âˆ’ 7 = ?",opts:["12","11","13","14"],ans:0,diff:"easy",mental:true,hint:"Take 7 away from 19.",steps:["12"],exp:"12."},
    {text:"6 Ã— 7 = ?",opts:["42","36","48","35"],ans:0,diff:"easy",mental:true,hint:"6Ã—7=42.",steps:["42"],exp:"42."},
    {text:"What is 20% of 50?",opts:["10","5","15","25"],ans:0,diff:"easy",mental:true,hint:"20% = 1/5.",steps:["50Ã·5=10"],exp:"10."},
    {text:"Next prime after 7?",opts:["11","9","10","13"],ans:0,diff:"easy",mental:true,hint:"8,9,10 not prime, 11 is.",steps:["11"],exp:"11."},
    {text:"Half of 48?",opts:["24","22","26","20"],ans:0,diff:"easy",mental:true,hint:"48Ã·2.",steps:["24"],exp:"24."},
    {text:"7 Ã— 8 = ?",opts:["56","54","64","48"],ans:0,diff:"easy",mental:true,hint:"7Ã—8=56.",steps:["56"],exp:"56."},
    {text:"25% of 80?",opts:["20","25","15","40"],ans:0,diff:"easy",mental:true,hint:"25%=1/4.",steps:["80Ã·4=20"],exp:"20."},
    {text:"100 âˆ’ 37 = ?",opts:["63","73","53","67"],ans:0,diff:"easy",mental:true,hint:"37+63=100.",steps:["63"],exp:"63."},
    {text:"3Â² + 4Â² = ?",opts:["25","7","13","49"],ans:0,diff:"easy",mental:true,hint:"9+16.",steps:["25"],exp:"25."},
    {text:"LCM of 4 and 6?",opts:["12","24","6","8"],ans:0,diff:"easy",mental:true,hint:"List multiples.",steps:["12"],exp:"12."},
    {text:"GCF of 12 and 18?",opts:["6","3","9","12"],ans:0,diff:"easy",mental:true,hint:"Factors of 12: 1,2,3,4,6,12.",steps:["6"],exp:"6."},
    {text:"What is 10% of 350?",opts:["35","3.5","70","17.5"],ans:0,diff:"easy",mental:true,hint:"Move decimal one place left.",steps:["35"],exp:"35."},
    {text:"9 Ã— 9 = ?",opts:["81","72","64","90"],ans:0,diff:"easy",mental:true,hint:"9Ã—9=81.",steps:["81"],exp:"81."},
    {text:"Square root of 144?",opts:["12","11","13","14"],ans:0,diff:"easy",mental:true,hint:"12Ã—12=144.",steps:["12"],exp:"12."},
  ],
  earlyMath: [
    {text:"15% of 200?",opts:["30","20","25","35"],ans:0,diff:"easy",mental:true,hint:"10%=20, 5%=10.",steps:["30"],exp:"30."},
    {text:"4Â³ = ?",opts:["64","48","16","256"],ans:0,diff:"easy",mental:true,hint:"4Ã—4Ã—4.",steps:["64"],exp:"64."},
    {text:"What is 2/5 as a decimal?",opts:["0.4","0.2","0.5","0.25"],ans:0,diff:"easy",mental:true,hint:"2Ã·5.",steps:["0.4"],exp:"0.4."},
    {text:"âˆ’5 Ã— âˆ’3 = ?",opts:["15","âˆ’15","âˆ’8","8"],ans:0,diff:"easy",mental:true,hint:"Negative Ã— negative = positive.",steps:["15"],exp:"15."},
    {text:"What is 3/4 + 1/4?",opts:["1","3/8","1/2","4/8"],ans:0,diff:"easy",mental:true,hint:"Same denominatorâ€”add numerators.",steps:["4/4=1"],exp:"1."},
    {text:"What is 7Â² âˆ’ 5Â²?",opts:["24","4","12","49"],ans:0,diff:"easy",mental:true,hint:"49âˆ’25.",steps:["24"],exp:"24."},
    {text:"Which is larger: 5/8 or 3/5?",opts:["5/8","3/5","Equal","Can't compare"],ans:0,diff:"medium",mental:true,hint:"Cross multiply: 5Ã—5=25, 8Ã—3=24.",steps:["5/8"],exp:"5/8 > 3/5."},
    {text:"Round 3.485 to nearest hundredth?",opts:["3.49","3.48","3.5","3.4"],ans:0,diff:"easy",mental:true,hint:"Look at the thousandths digit.",steps:["3.49"],exp:"3.49."},
    {text:"What is 0.3 Ã— 0.4?",opts:["0.12","0.7","1.2","0.07"],ans:0,diff:"easy",mental:true,hint:"3Ã—4=12, two decimal places.",steps:["0.12"],exp:"0.12."},
    {text:"Simplify 24/36?",opts:["2/3","3/4","4/6","1/2"],ans:0,diff:"easy",mental:true,hint:"GCF(24,36)=12.",steps:["2/3"],exp:"2/3."},
    {text:"A shirt costs $18, now 50% off. Price?",opts:["$9","$8","$10","$12"],ans:0,diff:"easy",mental:true,hint:"Half of 18.",steps:["$9"],exp:"$9."},
    {text:"What is âˆ’8 + 3?",opts:["âˆ’5","5","âˆ’11","11"],ans:0,diff:"easy",mental:true,hint:"Move 3 right on number line.",steps:["âˆ’5"],exp:"âˆ’5."},
    {text:"Order: 0.5, 1/3, 0.4, 2/5. Largest?",opts:["0.5","2/5","1/3","0.4"],ans:0,diff:"medium",mental:true,hint:"Convert to decimals.",steps:["0.5"],exp:"0.5 is largest."},
    {text:"What is 5% of 60?",opts:["3","6","5","4"],ans:0,diff:"easy",mental:true,hint:"10%=6, 5%=3.",steps:["3"],exp:"3."},
    {text:"12Â² = ?",opts:["144","124","132","148"],ans:0,diff:"easy",mental:true,hint:"12Ã—12.",steps:["144"],exp:"144."},
  ],
  fractions: [
    {text:"1/2 + 1/3 = ?",opts:["5/6","2/5","1/6","3/5"],ans:0,diff:"easy",mental:true,hint:"LCD is 6.",steps:["3/6+2/6=5/6"],exp:"5/6."},
    {text:"3/4 Ã— 2/3 = ?",opts:["1/2","6/12","1/4","3/8"],ans:0,diff:"easy",mental:true,hint:"Multiply numerators and denominators.",steps:["6/12=1/2"],exp:"1/2."},
    {text:"2 Ã· 1/4 = ?",opts:["8","4","1/2","1/8"],ans:0,diff:"easy",mental:true,hint:"Dividing by a fraction: multiply by its reciprocal.",steps:["2Ã—4=8"],exp:"8."},
    {text:"What is 3/5 as a percent?",opts:["60%","50%","30%","55%"],ans:0,diff:"easy",mental:true,hint:"3Ã·5=0.6.",steps:["60%"],exp:"60%."},
    {text:"Which is bigger: 7/10 or 2/3?",opts:["7/10","2/3","Equal","Can't tell"],ans:0,diff:"medium",mental:true,hint:"7/10=0.7, 2/3â‰ˆ0.667.",steps:["7/10"],exp:"7/10 > 2/3."},
    {text:"5/6 âˆ’ 1/3 = ?",opts:["1/2","4/3","2/3","4/6"],ans:0,diff:"easy",mental:true,hint:"1/3=2/6.",steps:["5/6âˆ’2/6=3/6=1/2"],exp:"1/2."},
    {text:"What is 7/8 of 24?",opts:["21","14","18","20"],ans:0,diff:"easy",mental:true,hint:"24Ã·8=3, 3Ã—7=21.",steps:["21"],exp:"21."},
    {text:"Mixed number: 2 + 3/4 as improper fraction?",opts:["11/4","7/4","8/4","5/4"],ans:0,diff:"easy",mental:true,hint:"2Ã—4+3=11.",steps:["11/4"],exp:"11/4."},
    {text:"1/2 Ã· 3 = ?",opts:["1/6","3/2","2/3","1/3"],ans:0,diff:"easy",mental:true,hint:"Same as 1/2 Ã— 1/3.",steps:["1/6"],exp:"1/6."},
    {text:"What fraction of 20 is 15?",opts:["3/4","4/5","2/3","5/6"],ans:0,diff:"easy",mental:true,hint:"15/20, simplify.",steps:["3/4"],exp:"3/4."},
    {text:"4/5 + 3/10 = ?",opts:["11/10","7/10","1","7/15"],ans:0,diff:"easy",mental:true,hint:"LCD=10.",steps:["8/10+3/10=11/10"],exp:"11/10."},
    {text:"2/3 of 45?",opts:["30","25","35","40"],ans:0,diff:"easy",mental:true,hint:"45Ã·3=15, 15Ã—2=30.",steps:["30"],exp:"30."},
    {text:"What is 3/8 as a decimal?",opts:["0.375","0.38","0.3","0.4"],ans:0,diff:"easy",mental:true,hint:"3Ã·8.",steps:["0.375"],exp:"0.375."},
    {text:"Which is smallest: 1/2, 1/3, 1/4?",opts:["1/4","1/2","1/3","All equal"],ans:0,diff:"easy",mental:true,hint:"Bigger denominator = smaller fraction.",steps:["1/4"],exp:"1/4."},
    {text:"Simplify 18/24?",opts:["3/4","2/3","9/12","6/8"],ans:0,diff:"easy",mental:true,hint:"GCF(18,24)=6.",steps:["3/4"],exp:"3/4."},
  ],
  numberTheory: [
    {text:"Is 97 prime?",opts:["Yes","No","Not sure","Only in base 10"],ans:0,diff:"medium",mental:true,hint:"Check divisibility by 2,3,5,7.",steps:["97 is prime"],exp:"Yes, 97 is prime."},
    {text:"What is 2âµ?",opts:["32","16","64","25"],ans:0,diff:"easy",mental:true,hint:"2Ã—2Ã—2Ã—2Ã—2.",steps:["32"],exp:"32."},
    {text:"Sum of digits of 12345?",opts:["15","12","18","20"],ans:0,diff:"easy",mental:true,hint:"1+2+3+4+5.",steps:["15"],exp:"15."},
    {text:"LCM of 6 and 8?",opts:["24","48","12","16"],ans:0,diff:"easy",mental:true,hint:"Multiples of 8: 8,16,24.",steps:["24"],exp:"24."},
    {text:"GCF of 36 and 48?",opts:["12","6","24","9"],ans:0,diff:"easy",mental:true,hint:"Factors of 36: ...,12. Factors of 48: ...,12.",steps:["12"],exp:"12."},
    {text:"Which of these is divisible by 9?",opts:["81","83","79","85"],ans:0,diff:"easy",mental:true,hint:"Sum of digits divisible by 9.",steps:["81: 8+1=9"],exp:"81."},
    {text:"3â´ = ?",opts:["81","27","64","36"],ans:0,diff:"easy",mental:true,hint:"3Ã—3Ã—3Ã—3.",steps:["81"],exp:"81."},
    {text:"Units digit of 3^100?",opts:["1","3","9","7"],ans:0,diff:"medium",mental:true,hint:"Cycle: 3,9,7,1 (length 4). 100Ã·4=25 remainder 0.",steps:["1"],exp:"1."},
    {text:"Remainder of 17 Ã· 5?",opts:["2","3","1","4"],ans:0,diff:"easy",mental:true,hint:"5Ã—3=15, 17-15=2.",steps:["2"],exp:"2."},
    {text:"How many factors does 12 have?",opts:["6","4","5","8"],ans:0,diff:"easy",mental:true,hint:"1,2,3,4,6,12.",steps:["6"],exp:"6."},
    {text:"Is 1 a prime number?",opts:["No","Yes","Sometimes","It depends"],ans:0,diff:"easy",mental:true,hint:"Primes have exactly 2 factors. 1 has only one.",steps:["No"],exp:"No. Primes have exactly 2 factors."},
    {text:"Next term: 1, 1, 2, 3, 5, __ (Fibonacci)",opts:["8","7","9","6"],ans:0,diff:"easy",mental:true,hint:"Add last two terms.",steps:["3+5=8"],exp:"8."},
    {text:"2^10 = ?",opts:["1024","512","2048","1000"],ans:0,diff:"medium",mental:true,hint:"Double from 2^9=512.",steps:["1024"],exp:"1024."},
    {text:"What is 5! (5 factorial)?",opts:["120","60","24","100"],ans:0,diff:"easy",mental:true,hint:"5Ã—4Ã—3Ã—2Ã—1.",steps:["120"],exp:"120."},
    {text:"Perfect square between 50 and 70?",opts:["64","49","81","60"],ans:0,diff:"easy",mental:true,hint:"8Â²=64.",steps:["64"],exp:"64."},
  ],
  geometry: [
    {text:"Area of square with side 7?",opts:["49","28","14","42"],ans:0,diff:"easy",mental:true,hint:"sideÂ².",steps:["49"],exp:"49."},
    {text:"Perimeter of rectangle 6Ã—9?",opts:["30","54","15","24"],ans:0,diff:"easy",mental:true,hint:"2(l+w).",steps:["2Ã—15=30"],exp:"30."},
    {text:"Angles in a triangle sum to?",opts:["180Â°","360Â°","90Â°","270Â°"],ans:0,diff:"easy",mental:true,hint:"Always 180Â° in any triangle.",steps:["180Â°"],exp:"180Â°."},
    {text:"Right angle = how many degrees?",opts:["90Â°","180Â°","45Â°","60Â°"],ans:0,diff:"easy",mental:true,hint:"A corner of a square.",steps:["90Â°"],exp:"90Â°."},
    {text:"How many degrees in a straight line?",opts:["180Â°","360Â°","90Â°","270Â°"],ans:0,diff:"easy",mental:true,hint:"Half a full rotation.",steps:["180Â°"],exp:"180Â°."},
    {text:"Area of right triangle with legs 6 and 8?",opts:["24","48","28","12"],ans:0,diff:"easy",mental:true,hint:"Â½ Ã— base Ã— height.",steps:["Â½Ã—6Ã—8=24"],exp:"24."},
    {text:"3-4-5 right triangle. Hypotenuse = 5, leg = 3. Other leg?",opts:["4","3","2","5"],ans:0,diff:"easy",mental:true,hint:"Famous Pythagorean triple.",steps:["4"],exp:"4."},
    {text:"Number of sides of a pentagon?",opts:["5","6","4","8"],ans:0,diff:"easy",mental:true,hint:"Penta = five.",steps:["5"],exp:"5."},
    {text:"A square has 4 right angles. True or False?",opts:["True","False"],ans:0,diff:"easy",mental:true,hint:"All angles of a square are 90Â°.",steps:["True"],exp:"True."},
    {text:"Circumference of circle with radius 5? (use Ï€â‰ˆ3)",opts:["30","15","25","60"],ans:0,diff:"easy",mental:true,hint:"2Ï€râ‰ˆ2Ã—3Ã—5.",steps:["30"],exp:"â‰ˆ30."},
    {text:"Supplement of 40Â°?",opts:["140Â°","50Â°","130Â°","60Â°"],ans:0,diff:"easy",mental:true,hint:"Supplementary angles sum to 180Â°.",steps:["180âˆ’40=140Â°"],exp:"140Â°."},
    {text:"Complement of 25Â°?",opts:["65Â°","75Â°","55Â°","155Â°"],ans:0,diff:"easy",mental:true,hint:"Complementary angles sum to 90Â°.",steps:["90âˆ’25=65Â°"],exp:"65Â°."},
    {text:"Diagonal of a square with side 1 is?",opts:["âˆš2","2","1","âˆš3"],ans:0,diff:"medium",mental:true,hint:"1Â²+1Â²=cÂ².",steps:["âˆš2"],exp:"âˆš2."},
    {text:"A hexagon has how many sides?",opts:["6","5","7","8"],ans:0,diff:"easy",mental:true,hint:"Hex = six.",steps:["6"],exp:"6."},
    {text:"Which triangle has all sides equal?",opts:["Equilateral","Isosceles","Scalene","Right"],ans:0,diff:"easy",mental:true,hint:"Equi = equal.",steps:["Equilateral"],exp:"Equilateral."},
  ],
  algebra: [
    {text:"If x + 5 = 12, then x = ?",opts:["7","8","17","6"],ans:0,diff:"easy",mental:true,hint:"Subtract 5 from both sides.",steps:["7"],exp:"7."},
    {text:"If 3x = 21, then x = ?",opts:["7","6","8","3"],ans:0,diff:"easy",mental:true,hint:"Divide both sides by 3.",steps:["7"],exp:"7."},
    {text:"Evaluate 2x + 1 when x = 4?",opts:["9","7","8","10"],ans:0,diff:"easy",mental:true,hint:"2Ã—4+1.",steps:["9"],exp:"9."},
    {text:"Simplify 5x âˆ’ 2x?",opts:["3x","7x","10x","x"],ans:0,diff:"easy",mental:true,hint:"Combine like terms.",steps:["3x"],exp:"3x."},
    {text:"What is the slope of y = 4x âˆ’ 3?",opts:["4","âˆ’3","3","âˆ’4"],ans:0,diff:"easy",mental:true,hint:"y=mx+b, m is slope.",steps:["4"],exp:"4."},
    {text:"Solve 2x âˆ’ 6 = 0?",opts:["3","6","2","âˆ’3"],ans:0,diff:"easy",mental:true,hint:"2x=6.",steps:["3"],exp:"3."},
    {text:"If y = xÂ² and x = 3, y = ?",opts:["9","6","8","27"],ans:0,diff:"easy",mental:true,hint:"3Â².",steps:["9"],exp:"9."},
    {text:"Expand (x + 3)(x âˆ’ 3)?",opts:["xÂ²âˆ’9","xÂ²+9","xÂ²âˆ’3","xÂ²+6xâˆ’9"],ans:0,diff:"medium",mental:true,hint:"Difference of squares.",steps:["xÂ²âˆ’9"],exp:"xÂ²âˆ’9."},
    {text:"Which is a perfect square: 49, 50, 51, 52?",opts:["49","50","51","52"],ans:0,diff:"easy",mental:true,hint:"7Ã—7=49.",steps:["49"],exp:"49=7Â²."},
    {text:"f(x) = 2x + 1. Find f(3)?",opts:["7","5","8","6"],ans:0,diff:"easy",mental:true,hint:"2(3)+1.",steps:["7"],exp:"7."},
    {text:"What is the y-intercept of y = 3x + 5?",opts:["5","3","âˆ’5","0"],ans:0,diff:"easy",mental:true,hint:"Set x=0.",steps:["5"],exp:"5."},
    {text:"Simplify xÂ² Ã— xÂ³?",opts:["xâµ","xâ¶","2xâµ","x"],ans:0,diff:"easy",mental:true,hint:"Add exponents.",steps:["xâµ"],exp:"xâµ."},
    {text:"If 5 âˆ’ x = 2, then x = ?",opts:["3","7","2","5"],ans:0,diff:"easy",mental:true,hint:"x = 5âˆ’2.",steps:["3"],exp:"3."},
    {text:"xÂ² = 36. x = ?",opts:["6 or âˆ’6","6","âˆ’6","18"],ans:0,diff:"easy",mental:true,hint:"Both positive and negative roots.",steps:["Â±6"],exp:"6 or âˆ’6."},
    {text:"Simplify (xâ´)/(xÂ²)?",opts:["xÂ²","xâ¶","xÂ³","x"],ans:0,diff:"easy",mental:true,hint:"Subtract exponents.",steps:["xÂ²"],exp:"xÂ²."},
  ],
  quadratics: [
    {text:"Roots of xÂ² âˆ’ 5x + 6 = 0?",opts:["2 and 3","1 and 6","âˆ’2 and âˆ’3","âˆ’1 and 6"],ans:0,diff:"medium",mental:true,hint:"Find two numbers that multiply to 6 and add to âˆ’5.",steps:["(xâˆ’2)(xâˆ’3)=0"],exp:"x=2 or x=3."},
    {text:"Vertex of y = xÂ² âˆ’ 4x + 4?",opts:["(2,0)","(0,4)","(4,0)","(âˆ’2,0)"],ans:0,diff:"medium",mental:true,hint:"x = âˆ’b/(2a). Or notice it's (xâˆ’2)Â².",steps:["(2,0)"],exp:"(2,0)."},
    {text:"Discriminant of xÂ² âˆ’ 4x + 4 = 0?",opts:["0","16","âˆ’4","8"],ans:0,diff:"medium",mental:true,hint:"bÂ²âˆ’4ac = 16âˆ’16.",steps:["0"],exp:"0 â†’ one repeated root."},
    {text:"Sum of roots of xÂ² âˆ’ 7x + 10 = 0?",opts:["7","âˆ’7","10","âˆ’10"],ans:0,diff:"easy",mental:true,hint:"Sum of roots = âˆ’b/a.",steps:["7"],exp:"7."},
    {text:"Product of roots of xÂ² âˆ’ 7x + 10 = 0?",opts:["10","âˆ’10","7","âˆ’7"],ans:0,diff:"easy",mental:true,hint:"Product of roots = c/a.",steps:["10"],exp:"10."},
    {text:"xÂ² âˆ’ 9 = 0. Solutions?",opts:["3 and âˆ’3","3 only","9 and âˆ’9","Â±3âˆš3"],ans:0,diff:"easy",mental:true,hint:"Difference of squares.",steps:["Â±3"],exp:"x=3 or x=âˆ’3."},
    {text:"y = xÂ². Opens which direction?",opts:["Up","Down","Left","Right"],ans:0,diff:"easy",mental:true,hint:"Positive leading coefficient.",steps:["Up"],exp:"Up."},
    {text:"y = âˆ’xÂ². Opens which direction?",opts:["Down","Up","Left","Right"],ans:0,diff:"easy",mental:true,hint:"Negative leading coefficient.",steps:["Down"],exp:"Down."},
    {text:"Axis of symmetry of y = xÂ² âˆ’ 6x + 9?",opts:["x=3","x=âˆ’3","x=6","x=0"],ans:0,diff:"medium",mental:true,hint:"x = âˆ’b/(2a) = 6/2.",steps:["x=3"],exp:"x=3."},
    {text:"How many real roots if discriminant < 0?",opts:["0","1","2","Infinite"],ans:0,diff:"easy",mental:true,hint:"Negative discriminant = no real solutions.",steps:["0"],exp:"0 real roots."},
    {text:"Simplify (x+2)Â²?",opts:["xÂ²+4x+4","xÂ²+4","xÂ²+2x+4","xÂ²+2"],ans:0,diff:"medium",mental:true,hint:"(a+b)Â²=aÂ²+2ab+bÂ².",steps:["xÂ²+4x+4"],exp:"xÂ²+4x+4."},
    {text:"Root of xÂ² = 25?",opts:["Â±5","5","25","Â±25"],ans:0,diff:"easy",mental:true,hint:"Square root both sides.",steps:["Â±5"],exp:"Â±5."},
    {text:"y = 2xÂ². Does it have a minimum or maximum?",opts:["Minimum","Maximum","Neither","Both"],ans:0,diff:"easy",mental:true,hint:"Opens up = minimum.",steps:["Minimum"],exp:"Minimum at vertex."},
    {text:"Factor xÂ² + 5x + 6?",opts:["(x+2)(x+3)","(x+1)(x+6)","(x+2)(xâˆ’3)","(xâˆ’2)(x+3)"],ans:0,diff:"medium",mental:true,hint:"Find two numbers that multiply to 6 and add to 5.",steps:["(x+2)(x+3)"],exp:"(x+2)(x+3)."},
    {text:"Vertex x-coordinate of y = xÂ² + 2x âˆ’ 1?",opts:["âˆ’1","1","âˆ’2","2"],ans:0,diff:"medium",mental:true,hint:"x = âˆ’b/(2a) = âˆ’2/2.",steps:["âˆ’1"],exp:"x=âˆ’1."},
  ],
  probability: [
    {text:"P(rolling a 4 on a fair die)?",opts:["1/6","1/4","4/6","1/3"],ans:0,diff:"easy",mental:true,hint:"One favorable outcome out of 6.",steps:["1/6"],exp:"1/6."},
    {text:"P(heads on a fair coin)?",opts:["1/2","1/4","1","2/3"],ans:0,diff:"easy",mental:true,hint:"Two equally likely outcomes.",steps:["1/2"],exp:"1/2."},
    {text:"P(not rolling a 6 on a die)?",opts:["5/6","1/6","1/2","4/6"],ans:0,diff:"easy",mental:true,hint:"1 âˆ’ P(rolling 6).",steps:["5/6"],exp:"5/6."},
    {text:"Flip 2 coins. How many outcomes?",opts:["4","2","6","8"],ans:0,diff:"easy",mental:true,hint:"HH, HT, TH, TT.",steps:["4"],exp:"4."},
    {text:"P(drawing an ace from a deck)?",opts:["1/13","1/52","4/13","1/4"],ans:0,diff:"easy",mental:true,hint:"4 aces in 52 cards.",steps:["4/52=1/13"],exp:"1/13."},
    {text:"Roll two dice. P(same number)?",opts:["1/6","1/36","6/36","1/12"],ans:0,diff:"medium",mental:true,hint:"6 ways to match out of 36 total.",steps:["6/36=1/6"],exp:"1/6."},
    {text:"P(red card from a deck)?",opts:["1/2","1/4","1/3","2/3"],ans:0,diff:"easy",mental:true,hint:"26 red out of 52.",steps:["1/2"],exp:"1/2."},
    {text:"P(sum of 2 when rolling two dice)?",opts:["1/36","2/36","1/12","1/6"],ans:0,diff:"easy",mental:true,hint:"Only (1,1) gives sum 2.",steps:["1/36"],exp:"1/36."},
    {text:"P(A or B) if P(A)=0.3, P(B)=0.4, mutually exclusive?",opts:["0.7","0.12","0.3","0.4"],ans:0,diff:"easy",mental:true,hint:"Mutually exclusive: just add.",steps:["0.7"],exp:"0.7."},
    {text:"P(rolling even on a die)?",opts:["1/2","1/3","2/3","1/6"],ans:0,diff:"easy",mental:true,hint:"Even: 2,4,6 â†’ 3 outcomes.",steps:["3/6=1/2"],exp:"1/2."},
    {text:"Bag: 3 red, 2 blue. P(blue)?",opts:["2/5","3/5","1/2","2/3"],ans:0,diff:"easy",mental:true,hint:"2 blue out of 5 total.",steps:["2/5"],exp:"2/5."},
    {text:"P(rolling < 3 on a die)?",opts:["1/3","2/6","1/2","1/6"],ans:0,diff:"easy",mental:true,hint:"1 and 2 are < 3.",steps:["2/6=1/3"],exp:"1/3."},
    {text:"Certainty has probability?",opts:["1","0","0.5","100"],ans:0,diff:"easy",mental:true,hint:"Something that always happens.",steps:["1"],exp:"1."},
    {text:"Impossible event has probability?",opts:["0","1","0.5","âˆ’1"],ans:0,diff:"easy",mental:true,hint:"Something that never happens.",steps:["0"],exp:"0."},
    {text:"P(A and B) if independent and P(A)=0.5, P(B)=0.4?",opts:["0.2","0.9","0.1","0.45"],ans:0,diff:"easy",mental:true,hint:"Multiply for independent events.",steps:["0.5Ã—0.4=0.2"],exp:"0.2."},
  ],
  statistics: [
    {text:"Mean of 2, 4, 6, 8, 10?",opts:["6","5","7","8"],ans:0,diff:"easy",mental:true,hint:"SumÃ·count. Sum=30, count=5.",steps:["30/5=6"],exp:"6."},
    {text:"Median of 1, 3, 5, 7, 9?",opts:["5","4","6","3"],ans:0,diff:"easy",mental:true,hint:"Middle value of sorted list.",steps:["5"],exp:"5."},
    {text:"Mode of 1, 2, 2, 3, 3, 3, 4?",opts:["3","2","4","1"],ans:0,diff:"easy",mental:true,hint:"Most frequent value.",steps:["3"],exp:"3."},
    {text:"Range of 4, 8, 15, 16, 23?",opts:["19","11","18","23"],ans:0,diff:"easy",mental:true,hint:"Max âˆ’ Min.",steps:["23âˆ’4=19"],exp:"19."},
    {text:"Mean of 10, 10, 10?",opts:["10","30","3","0"],ans:0,diff:"easy",mental:true,hint:"All same value.",steps:["10"],exp:"10."},
    {text:"Median of 2, 5, 8, 10?",opts:["6.5","5","8","7"],ans:0,diff:"easy",mental:true,hint:"Even count: average of middle two.",steps:["(5+8)/2=6.5"],exp:"6.5."},
    {text:"Which measure is most affected by outliers?",opts:["Mean","Median","Mode","Range"],ans:0,diff:"medium",mental:true,hint:"Extreme values change the average a lot.",steps:["Mean"],exp:"Mean."},
    {text:"Data: 5,5,5,5. Standard deviation = ?",opts:["0","5","1","4"],ans:0,diff:"easy",mental:true,hint:"No variation â†’ no spread.",steps:["0"],exp:"0."},
    {text:"Mean of 0, 0, 0, 100?",opts:["25","0","50","100"],ans:0,diff:"easy",mental:true,hint:"100Ã·4.",steps:["25"],exp:"25."},
    {text:"A dataset has one outlier. Which measure best represents the center?",opts:["Median","Mean","Mode","Range"],ans:0,diff:"medium",mental:true,hint:"Median is not affected by outliers.",steps:["Median"],exp:"Median."},
    {text:"Scores: 70,80,90. Mean?",opts:["80","70","85","90"],ans:0,diff:"easy",mental:true,hint:"Sum=240, count=3.",steps:["80"],exp:"80."},
    {text:"Mode of 1, 2, 3, 4, 5?",opts:["No mode","3","1","5"],ans:0,diff:"easy",mental:true,hint:"Each appears once.",steps:["No mode"],exp:"No mode."},
    {text:"Adding a 6th score of 0 to {4,6,8,10,12} changes the mean by?",opts:["âˆ’4","âˆ’6","âˆ’2","âˆ’8"],ans:0,diff:"medium",mental:true,hint:"Old mean=8, new sum=40, new mean=40/6â‰ˆ6.67.",steps:["Decreases by â‰ˆ4"],exp:"Decreases by about 4."},
    {text:"What does a histogram show?",opts:["Distribution of data","Individual values","Relationship between variables","Time series"],ans:0,diff:"easy",mental:true,hint:"Bars show frequency in ranges.",steps:["Distribution"],exp:"Distribution of data."},
    {text:"3 tests: 70,80,x. Mean must be 80. x = ?",opts:["90","85","80","100"],ans:0,diff:"easy",mental:true,hint:"Sum must be 240. 70+80+x=240.",steps:["90"],exp:"90."},
  ],
};

// Merge extra questions into QB
for (const topic of Object.keys(extra)) {
  if (QB[topic]) {
    QB[topic] = QB[topic].concat(extra[topic]);
  }
}

})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACHIEVEMENTS (20 total)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACHIEVEMENTS = [
  {id:'first',     icon:'âš¡', name:'First Strike',      desc:'Answer your first question',           check:s=>s.total>=1},
  {id:'streak3',   icon:'ðŸ”¥', name:'On Fire',           desc:'3-question streak',                    check:s=>s.streak>=3},
  {id:'streak5',   icon:'ðŸŒ‹', name:'Unstoppable',       desc:'5-question streak',                    check:s=>s.streak>=5},
  {id:'streak10',  icon:'ðŸ’¥', name:'Legendary Streak',  desc:'10-question streak!!',                 check:s=>s.streak>=10},
  {id:'ten',       icon:'ðŸŽ¯', name:'Sharp Shooter',     desc:'10 correct answers',                   check:s=>s.correct>=10},
  {id:'twenty',    icon:'ðŸ’ª', name:'Grinder',           desc:'25 correct answers',                   check:s=>s.correct>=25},
  {id:'fifty',     icon:'ðŸ”±', name:'Elite',             desc:'50 correct answers',                   check:s=>s.correct>=50},
  {id:'speed',     icon:'âš¡', name:'Speed Demon',       desc:'Correct in under 6 seconds',           check:s=>s.lastTime<6&&s.lastCorrect},
  {id:'allTopics', icon:'ðŸŒ', name:'Renaissance',       desc:'Attempt all 12 topics',                check:s=>Object.keys(s.tAttempt).length>=12},
  {id:'xp500',     icon:'ðŸ’Ž', name:'Diamond',           desc:'Earn 500 total XP',                    check:s=>s.xp>=500},
  {id:'xp1000',    icon:'ðŸ‘‘', name:'XP King',           desc:'Earn 1000 total XP',                   check:s=>s.xp>=1000},
  {id:'comp',      icon:'ðŸ†', name:'Challenge Ready', desc:'5 Challenge Round problems',           check:s=>(s.tCount.challenge||0)>=5},
  {id:'lv5',       icon:'ðŸš€', name:'Level 5',           desc:'Reach level 5',                        check:s=>s.level>=5},
  {id:'daily',     icon:'ðŸŒŸ', name:'Daily Challenger',  desc:'Complete 10 correct in one session',   check:s=>s.sessionCorrect>=10},
  {id:'nohint',    icon:'ðŸ§ ', name:'Brain Power',       desc:'10 correct without using a hint',      check:s=>s.noHintStreak>=10},
  {id:'comeback',  icon:'ðŸ”„', name:'Comeback Kid',      desc:'Get 3 correct after getting 3 wrong',  check:s=>s.comingBack>=3},
  {id:'perfect5',  icon:'âœ¨', name:'Perfect 5',         desc:'5 correct in a row, all under 10s',    check:s=>s.speedStreak>=5},
  {id:'mathcounts_mastery', icon:'ðŸ¥‡', name:'Challenge Master', desc:'80%+ accuracy in Challenge Round', check:s=>(s.tCount.challenge||0)>=5&&((s.tCorrect.challenge||0)/(s.tCount.challenge||1))>=0.8},
  {id:'goal_complete', icon:'ðŸŽ¯', name:'Goal Getter',   desc:'Complete your first goal',             check:s=>s.goalsCompleted>=1},
  {id:'week_streak',  icon:'ðŸ“…', name:'Week Warrior',   desc:'7-day study streak',                   check:s=>s.dayStreak>=7},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAILY TIPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TIPS = [
  "For competition math, always check: is there a shortcut? Top competitors solve 30 problems in 30 minutes.",
  "The quadratic formula always works â€” even when factoring fails. Memorize: x=(âˆ’bÂ±âˆš(bÂ²âˆ’4ac))/2a",
  "In system of equations problems, look for the easier method: substitution (if one variable is isolated) or elimination (if coefficients line up).",
  "Divisibility tricks: a number is divisible by 3 if its digits sum to a multiple of 3.",
  "For probability problems, drawing a tree diagram or listing outcomes systematically prevents mistakes.",
  "Pythagorean triples to memorize: 3-4-5, 5-12-13, 8-15-17, 7-24-25. They appear constantly in math problems!",
  "Vieta's formulas are a secret weapon: sum of roots = âˆ’b/a, product = c/a. No solving needed!",
  "For counting problems, ask yourself: does ORDER matter? Yes = permutation. No = combination.",
  "Practice doing problems WITHOUT a calculator â€” many competitions are calculator-free!",
  "When you get something wrong, don't just check the answer. Re-do the problem from scratch to build real understanding.",
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE & PERSISTENCE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'numiqube_v1';

function defaultState() {
  return {
    username: '',
    xp: 0, level: 1,
    correct: 0, wrong: 0, total: 0,
    streak: 0, bestStreak: 0,
    dayStreak: 0, lastStudyDate: '',
    sessionCorrect: 0, sessionXP: 0,
    lastDailyBonusDate: '',
    noHintStreak: 0, comingBack: 0, speedStreak: 0,
    goalsCompleted: 0,
    tAttempt: {}, tCount: {}, tCorrect: {},
    tAvgTime: {}, tTimes: {},
    earned: [],
    goals: [],
    history: [],
    wrongLog: [],
    activityLog: {},
    shopOwned: [],
    shopEquipped: {},
    shopSpent: 0,
    emailSignedUp: false,
    onboardingDone: false,
    duelWins: 0,
    duelLosses: 0,
    rankedLP: 0,
    rankedWins: 0,
    rankedLosses: 0,
    rankedWinStreak: 0,
    firstWinToday: false,
    lastWinDate: '',
    settings: { lightMode:false, sessionGoal:20, speedTimer:15, sound:true, confetti:true },
    // runtime only (not saved)
    currentTopic: 'quadratics',
    q: null, answered: false, qIdx: 0,
    streak: 0, lastTime: 999, lastCorrect: false, qStart: 0,
    hintUsed: false, speedInterval: null, paused: false,
    mode: 'normal', srMode: false,
    srQueue: [],
  };
}

let S = defaultState();

function loadState() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      const d = JSON.parse(saved);
      Object.assign(S, d);
      S.earned = new Set(S.earned || []);
      // re-init runtime
      S.q = null; S.answered = false; S.currentTopic = S.currentTopic || 'quadratics';
      S.streak = S.streak || 0; S.lastTime = 999; S.lastCorrect = false; S.qStart = 0;
      S.hintUsed = false; S.speedInterval = null; S.paused = false;
      S.mode = 'normal'; S.srMode = false; S.srQueue = [];
      S.sessionCorrect = 0; S.sessionXP = 0;
    } else {
      S.earned = new Set();
    }
  } catch(e) { S.earned = new Set(); }
}

function saveState() {
  try {
    const toSave = Object.assign({}, S);
    toSave.earned = [...S.earned];
    delete toSave.q; delete toSave.speedInterval; delete toSave.srQueue;
    localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    // Also save to Firebase if signed in
    saveStateToFirebase();
  } catch(e) {}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function init() {
  loadState();
  buildStars();
  // Always show home page â€” auth state listener handles the rest
  // (Don't auto-skip to study page anymore)
  Object.keys(QB).forEach(t => {
    if (!S.tCount[t]) S.tCount[t]=0;
    if (!S.tCorrect[t]) S.tCorrect[t]=0;
    if (!S.tTimes[t]) S.tTimes[t]=[];
  });
}

function buildStars() {
  const bg = document.getElementById('stars-bg');
  for (let i=0; i<80; i++) {
    const s = document.createElement('div');
    s.className = 'star';
    const size = Math.random()<0.7 ? 1 : Math.random()<0.7 ? 2 : 3;
    s.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*4}s;--delay:${Math.random()*4}s;--lo:${0.05+Math.random()*0.15};--hi:${0.4+Math.random()*0.5};`;
    bg.appendChild(s);
  }
}

function beginApp(returning=false) {
  const input = document.getElementById('username-input');
  if (!returning) {
    const name = input.value.trim();
    if (!name) { input.style.borderColor='var(--wrong)'; input.placeholder='Please enter your name!'; setTimeout(()=>{input.style.borderColor='';input.placeholder='Your name (e.g. Alex)';},1800); return; }
    S.username = name.slice(0,20);
  }
  document.getElementById('page-home').classList.remove('show');
  document.getElementById('nav').style.display = 'flex';
  updateDayStreak();
  restoreEquipped();
  isStudyPageActive = true;
  showPage('study');
  buildTopicTabs();
  startTimer();
  loadQ();
  refreshDashboard();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PAGE ROUTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const page = document.getElementById('page-'+name);
  if (page) page.classList.add('active');
  document.querySelectorAll('.nav-tab').forEach((t,i) => {
    const names = ['study','dashboard','progress','goals','friends','duels','settings'];
    t.classList.toggle('active', names[i] === name);
  });
  // Ranked/Casual are sub-pages of duels â€” highlight Duels tab
  if (name === 'ranked' || name === 'casual') {
    document.querySelectorAll('.nav-tab').forEach((t,i) => {
      t.classList.toggle('active', i === 5); // duels tab index
    });
  }
  isStudyPageActive = (name === 'study');
  if (name==='dashboard') refreshDashboard();
  if (name==='progress') refreshProgress();
  if (name==='goals') refreshGoals();
  if (name==='settings') refreshSettings();
  if (name==='friends') refreshFriends();
  if (name==='duels') { refreshDuelsPage(); refreshFriends(); }
  if (name==='ranked') refreshRankedPage();
  if (name==='study') {
    setTimeout(() => {
      if (_musicEnabled) {
        const track = S.mode === 'speed' ? 'speed' : 'study';
        startMusic(track);
      }
    }, 500);
  } else if (name === 'ranked' || name === 'casual' || name === 'duels') {
    // Keep whatever music is playing â€” duel pages don't need silence
  } else {
    stopAmbientMusic();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TIMER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let timerInterval = null;
let sessionSecs = 0;
let isStudyPageActive = false;

function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (S.paused) return;
    if (!isStudyPageActive) return;
    sessionSecs++;
    const m = String(Math.floor(sessionSecs/60)).padStart(2,'0');
    const s = String(sessionSecs%60).padStart(2,'0');
    document.getElementById('nav-timer').textContent = `${m}:${s}`;
  }, 1000);
}

function togglePause() {
  S.paused = !S.paused;
  const btn = document.getElementById('pause-btn');
  btn.textContent = S.paused ? 'â–¶ Resume' : 'â¸ Pause';
  btn.classList.toggle('active-tool', S.paused);
  const panelBtn = document.getElementById('panel-pause-btn');
  if(panelBtn){ panelBtn.textContent = S.paused ? 'â–¶ Resume' : 'â¸ Pause'; panelBtn.classList.toggle('active-tool', S.paused); }
  if (S.paused) {
    S._pausedAt = Date.now();
    if (S.speedInterval) { clearInterval(S.speedInterval); S.speedInterval = null; }
  } else {
    if (S._pausedAt) {
      const pausedDuration = Date.now() - S._pausedAt;
      S.qStart += pausedDuration;
      S._pausedAt = null;
    }
    if (S.mode === 'speed' && !S.answered) startSpeedTimer();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DAY STREAK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDayStreak() {
  const today = new Date().toDateString();
  const yest = new Date(Date.now()-86400000).toDateString();
  if (S.lastStudyDate === today) return;
  if (S.lastStudyDate === yest) S.dayStreak++;
  else if (S.lastStudyDate === '') S.dayStreak = 1;
  else S.dayStreak = 1;
  S.lastStudyDate = today;
  // Log activity
  const key = new Date().toISOString().slice(0,10);
  S.activityLog[key] = (S.activityLog[key]||0)+1;
  saveState();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOPIC TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TL = {
  counting:'ðŸŽ Counting Basics',
  earlyMath:'ðŸ”¢ Early Math',
  quadratics:'ðŸ“ Quadratics',
  systems:'ðŸ”— Systems',
  numberTheory:'ðŸ”¢ Number Theory',
  geometry:'ðŸ“ Geometry',
  probability:'ðŸŽ² Probability',
  algebra:'ðŸ“ˆ Algebra',
  logic:'ðŸ§© Logic',
  statistics:'ðŸ“Š Statistics',
  challenge:'ðŸ† Challenge Round',
  hardProblems:'ðŸ”¥ Extreme Math',
};
const TC = {counting:'#06d6a0',earlyMath:'#ffd166',quadratics:'#ff6b35',systems:'#118ab2',numberTheory:'#ffd166',geometry:'#06d6a0',probability:'#ef476f',algebra:'#c77dff',logic:'#ff9a3c',statistics:'#4cc9f0',challenge:'#f72585',hardProblems:'#ff6b35'};

const usedQ = {};
Object.keys(QB).forEach(t=>usedQ[t]=[]);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOPIC ICONS MAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TOPIC_ICONS = {
  counting:'ðŸŽ', earlyMath:'ðŸ”¢', quadratics:'ðŸ“', systems:'âš–ï¸',
  numberTheory:'ðŸ”¢', geometry:'ðŸ“', probability:'ðŸŽ²', algebra:'ðŸ”£',
  logic:'ðŸ§©', statistics:'ðŸ“Š', challenge:'ðŸ†', hardProblems:'ðŸ”¥'
};

// Selected topics â€” multi-topic support
let _selectedTopics = null; // null means all

function buildTopicTabs() {
  if (!_selectedTopics) _selectedTopics = new Set(Object.keys(QB));
  updateTopicPickerBtn();
}

function updateTopicPickerBtn() {
  const all = Object.keys(QB);
  const sel = _selectedTopics ? [..._selectedTopics] : all;
  const btn = document.getElementById('topic-pick-btn');
  if (sel.length === 1) {
    document.getElementById('topic-pick-icon').textContent = TOPIC_ICONS[sel[0]]||'ðŸ“š';
    document.getElementById('topic-pick-name').textContent = TL[sel[0]];
    S.currentTopic = sel[0];
  } else if (sel.length === all.length) {
    document.getElementById('topic-pick-icon').textContent = 'ðŸŒ';
    document.getElementById('topic-pick-name').textContent = 'All Topics';
  } else {
    document.getElementById('topic-pick-icon').textContent = 'ðŸ“š';
    document.getElementById('topic-pick-name').textContent = `${sel.length} Topics Mixed`;
  }
  const cnt = sel.reduce((a,t)=>a+(S.tCount[t]||0),0);
  const cor = sel.reduce((a,t)=>a+(S.tCorrect[t]||0),0);
  const acc = cnt>0 ? Math.round(cor/cnt*100)+'% accuracy' : 'Not started yet';
  document.getElementById('topic-pick-acc').textContent = acc;
}

function openTopicModal() {
  const all = Object.keys(QB);
  const sel = _selectedTopics || new Set(all);
  const grid = document.getElementById('topic-card-grid');
  grid.innerHTML = '';

  all.forEach(k => {
    const v = TL[k];
    const cnt = S.tCount[k]||0, cor = S.tCorrect[k]||0;
    const acc = cnt>0 ? Math.round(cor/cnt*100) : null;
    const icon = TOPIC_ICONS[k]||'ðŸ“š';
    const isSelected = sel.has(k);

    const card = document.createElement('div');
    card.className = 'topic-card-item'+(isSelected?' selected':'');
    card.dataset.topic = k;
    card.innerHTML = `
      <div class="tci-check">${isSelected?'âœ“':''}</div>
      <span class="tci-icon">${icon}</span>
      <span class="tci-name">${v}</span>
      <span class="tci-acc">${acc!==null?acc+'% acc':'Not tried yet'}</span>
      <div class="tci-bar"><div class="tci-bar-fill" style="width:${acc||0}%;background:${acc>=80?'var(--correct)':acc>=50?'var(--a2)':'var(--accent)'}"></div></div>
    `;
    card.onclick = () => toggleTopicCard(card, k);
    grid.appendChild(card);
  });

  updateSelectedCountLabel();
  openModal('topic-modal');
}

function toggleTopicCard(card, k) {
  const all = Object.keys(QB);
  if (!_selectedTopics) _selectedTopics = new Set(all);

  if (_selectedTopics.has(k)) {
    // Don't allow deselecting the last one
    if (_selectedTopics.size <= 1) { spawnXP('Pick at least 1!','var(--wrong)'); return; }
    _selectedTopics.delete(k);
    card.classList.remove('selected');
    card.querySelector('.tci-check').textContent = '';
  } else {
    _selectedTopics.add(k);
    card.classList.add('selected');
    card.querySelector('.tci-check').textContent = 'âœ“';
  }
  updateSelectedCountLabel();
  updateToggleAllBtn();
}

function updateSelectedCountLabel() {
  const all = Object.keys(QB);
  const sel = _selectedTopics ? _selectedTopics.size : all.length;
  document.getElementById('selected-count-label').textContent =
    sel === all.length ? `All ${all.length} selected` : `${sel} of ${all.length} selected`;
}

function updateToggleAllBtn() {
  const all = Object.keys(QB);
  const allSelected = _selectedTopics && _selectedTopics.size === all.length;
  const btn = document.getElementById('toggle-all-btn');
  btn.textContent = allSelected ? 'Deselect All' : 'Select All';
  btn.style.background = allSelected ? 'var(--accent)' : 'var(--card3)';
  btn.style.color = allSelected ? 'white' : 'var(--muted)';
}

function toggleAllTopics() {
  const all = Object.keys(QB);
  const allSelected = _selectedTopics && _selectedTopics.size === all.length;

  if (allSelected) {
    // Deselect all â€” keep first one so we always have at least one
    _selectedTopics = new Set([all[0]]);
  } else {
    _selectedTopics = new Set(all);
  }

  // Refresh the cards
  document.querySelectorAll('.topic-card-item').forEach(card => {
    const k = card.dataset.topic;
    const isSelected = _selectedTopics.has(k);
    card.classList.toggle('selected', isSelected);
    card.querySelector('.tci-check').textContent = isSelected ? 'âœ“' : '';
  });

  updateSelectedCountLabel();
  updateToggleAllBtn();
}

function confirmTopicSelection() {
  closeModal('topic-modal');
  updateTopicPickerBtn();
  loadQ();
}

function switchTopic(t) {
  _selectedTopics = new Set([t]);
  S.currentTopic = t;
  updateTopicPickerBtn();
  loadQ();
}

function shuffleTopic() {
  const topics = Object.keys(QB);
  const t = topics[Math.floor(Math.random()*topics.length)];
  switchTopic(t);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STUDY MODE vs TEST MODE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _isTestMode = false;
let _testResults = [];

function toggleStudyMode() {
  _isTestMode = !_isTestMode;
  const btn = document.getElementById('studymode-btn');
  const panelBtn = document.getElementById('panel-studymode-btn');
  const banner = document.getElementById('mode-banner');

  if (_isTestMode) {
    btn.textContent = 'ðŸ“ Test Mode';
    btn.classList.add('active-tool');
    if(panelBtn){ panelBtn.textContent='ðŸ“ Test Mode: On'; panelBtn.classList.add('active-tool'); }
    banner.classList.add('visible');
    _testResults = [];
    spawnXP('ðŸ“ Test Mode ON','var(--a4)');
  } else {
    btn.textContent = 'ðŸ“š Study Mode';
    btn.classList.remove('active-tool');
    if(panelBtn){ panelBtn.textContent='ðŸ“š Study Mode: Off'; panelBtn.classList.remove('active-tool'); }
    banner.classList.remove('visible');
    if (_testResults.length > 0) showTestSummary();
    _testResults = [];
  }
  loadQ();
}

function showTestSummary() {
  const total = _testResults.length;
  const correct = _testResults.filter(r=>r).length;
  const pct = Math.round(correct/total*100);
  const grade = pct>=90?'A+':pct>=80?'A':pct>=70?'B':pct>=60?'C':'Keep practicing';
  uiAlert(`${correct}/${total} correct â€” ${pct}%\n\nGrade: ${grade}\n\n${pct>=80?'ðŸŽ‰ Great work!':'Review the explanations for the ones you missed.'}`, 'ðŸ“', 'Test Results');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONCEPTS â€” per-topic explainer
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CONCEPTS = {
  counting: {
    title: 'ðŸŽ Counting Basics',
    body: `<p style="margin-bottom:12px;">Counting is the foundation of all math. Before anything else, you need to be comfortable with numbers and basic operations.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Addition</strong> â€” combining two groups. 3 + 4 = 7 means "3 things and 4 more things = 7 things total."
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Subtraction</strong> â€” taking away. 9 âˆ’ 5 = 4 means "start with 9, remove 5, you have 4 left."
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Sequences</strong> â€” a pattern of numbers. Count by 2s: 2, 4, 6, 8... Each number follows a rule.
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: Use your fingers, draw pictures, or use objects to count. There's no shame in that at any age.</p>`
  },
  earlyMath: {
    title: 'ðŸ”¢ Early Math',
    body: `<p style="margin-bottom:12px;">Early math is where arithmetic gets real. You're moving from counting to calculating.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Multiplication</strong> â€” repeated addition. 6 Ã— 4 = 24 means "six groups of four." Know your times tables up to 12!
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Division</strong> â€” splitting into equal groups. 20 Ã· 4 = 5 means "how many groups of 4 fit in 20?"
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--accent);">
  <strong>Fractions</strong> â€” parts of a whole. 3/4 means 3 out of 4 equal parts. Numerator (top) Ã· Denominator (bottom).
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: For percentages, remember that "percent" means "per hundred." So 40% = 40/100 = 0.4.</p>`
  },
  quadratics: {
    title: 'ðŸ“ Quadratics',
    body: `<p style="margin-bottom:12px;">A quadratic is any equation with an xÂ² term. They appear everywhere in physics, engineering, and competition math.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Standard form:</strong> axÂ² + bx + c = 0
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Factoring</strong> â€” find two numbers that multiply to c and add to b.<br>Example: xÂ² + 5x + 6 = (x+2)(x+3) because 2Ã—3=6 and 2+3=5.
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Quadratic Formula</strong> â€” works when factoring fails:<br>x = (âˆ’b Â± âˆš(bÂ²âˆ’4ac)) / 2a
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: Always check if the equation equals 0 before solving. And check your answers by plugging back in.</p>`
  },
  systems: {
    title: 'âš–ï¸ Systems of Equations',
    body: `<p style="margin-bottom:12px;">A system is two or more equations with the same variables. You need to find values that satisfy all of them at once.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Substitution</strong> â€” solve one equation for one variable, plug it into the other.<br>Best when one variable is already isolated.
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a4);">
  <strong>Elimination</strong> â€” add or subtract equations to cancel a variable.<br>Best when coefficients line up.
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: Always solve for both variables and check your answer in BOTH original equations.</p>`
  },
  numberTheory: {
    title: 'ðŸ”¢ Number Theory',
    body: `<p style="margin-bottom:12px;">Number theory is the study of integers and their properties. It's a huge part of competition math.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>GCD & LCM</strong> â€” Greatest Common Divisor and Least Common Multiple. GCD(12,8)=4. LCM(4,6)=12.
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Primes</strong> â€” numbers divisible only by 1 and themselves: 2, 3, 5, 7, 11, 13...
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Modular arithmetic</strong> â€” remainder after division. 17 mod 5 = 2 because 17 = 5Ã—3 + 2.
</div>
<p style="color:var(--muted);font-size:0.8rem;">Divisibility tricks: div by 3 if digits sum to multiple of 3. Div by 9 if digits sum to multiple of 9.</p>`
  },
  geometry: {
    title: 'ðŸ“ Geometry',
    body: `<p style="margin-bottom:12px;">Geometry is about shapes, sizes, and the relationships between them.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Key formulas:</strong><br>
  Circle: Area = Ï€rÂ², Circumference = 2Ï€r<br>
  Triangle: Area = Â½ Ã— base Ã— height<br>
  Rectangle: Area = l Ã— w, Perimeter = 2(l+w)
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Pythagorean theorem</strong> â€” for right triangles: aÂ² + bÂ² = cÂ²<br>
  Common triples: 3-4-5, 5-12-13, 8-15-17
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: Draw diagrams! Label what you know. Geometry problems become way easier when you can see them.</p>`
  },
  probability: {
    title: 'ðŸŽ² Probability',
    body: `<p style="margin-bottom:12px;">Probability measures how likely something is to happen, from 0 (impossible) to 1 (certain).</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Basic probability:</strong> P(event) = favorable outcomes Ã· total outcomes<br>
  P(rolling a 3 on a die) = 1/6
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Complementary:</strong> P(not A) = 1 âˆ’ P(A)<br>
  P(not rolling a 3) = 1 âˆ’ 1/6 = 5/6
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Counting methods:</strong> Combinations C(n,r) = n!/(r!(n-r)!), Permutations P(n,r) = n!/(n-r)!
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: When in doubt, list all outcomes. Tree diagrams and sample spaces prevent mistakes.</p>`
  },
  algebra: {
    title: 'ðŸ”£ Algebra',
    body: `<p style="margin-bottom:12px;">Algebra is about using variables (letters) to represent unknown numbers and finding their values.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Solving equations:</strong> Whatever you do to one side, do to the other.<br>
  2x + 5 = 13 â†’ 2x = 8 â†’ x = 4
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a4);">
  <strong>Functions:</strong> f(x) is a rule that turns x into an output.<br>
  f(x) = 2x + 1 â†’ f(3) = 7
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: Always simplify both sides before solving. And check your answer â€” plug it back in!</p>`
  },
  logic: {
    title: 'ðŸ§© Logic & Puzzles',
    body: `<p style="margin-bottom:12px;">Logic problems test your reasoning, not your formulas. They're about thinking clearly and systematically.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Pattern recognition</strong> â€” find the rule, apply it. What comes next in 1, 4, 9, 16...? (Perfect squares: 25)
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Deductive reasoning</strong> â€” use given facts to eliminate wrong answers. Work backwards from the conclusion.
</div>
<p style="color:var(--muted);font-size:0.8rem;">Tip: Read carefully. Logic problems often have one piece of info that unlocks everything else. Find it first.</p>`
  },
  statistics: {
    title: 'ðŸ“Š Statistics',
    body: `<p style="margin-bottom:12px;">Statistics is about collecting, analyzing, and interpreting data.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Mean</strong> â€” the average. Add all values, divide by count.<br>
  Mean of 2,4,6,8 = 20/4 = 5
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a3);">
  <strong>Median</strong> â€” the middle value when sorted. For 2,4,6,8,10 â†’ median = 6.
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Mode</strong> â€” the most frequent value. In 1,2,2,3,4 â†’ mode = 2.
</div>
<p style="color:var(--muted);font-size:0.8rem;">Range = max âˆ’ min. Outliers affect the mean a lot but barely affect the median.</p>`
  },
  challenge: {
    title: 'ðŸ† Challenge Round',
    body: `<p style="margin-bottom:12px;">Challenge Round problems are competition-level. These are the kinds of questions that appear on AMC, MATHCOUNTS, and similar contests.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a2);">
  <strong>Strategy:</strong> Always look for shortcuts. If brute force takes more than 2 minutes, there's a smarter way.
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Common patterns:</strong> Inclusion-exclusion, complementary counting, Pigeonhole principle, modular arithmetic cycles.
</div>
<p style="color:var(--muted);font-size:0.8rem;">These are hard. Getting 3 out of 5 right is great. Read every explanation carefully â€” that's where the real learning happens.</p>`
  },
  hardProblems: {
    title: 'ðŸ”¥ Extreme Math',
    body: `<p style="margin-bottom:12px;">These are the hardest problems on the app â€” designed to really push you.</p>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--wrong);">
  <strong>Topics covered:</strong> logarithms, function composition, modular arithmetic, combinatorics, geometric sequences, completing the square.
</div>
<div style="background:var(--card2);border-radius:10px;padding:12px;margin-bottom:10px;border-left:3px solid var(--a5);">
  <strong>Approach:</strong> Read the question twice. Identify what type of problem it is. Recall the relevant formula or technique. Work step by step.
</div>
<p style="color:var(--muted);font-size:0.8rem;">If you can handle these consistently, you're genuinely ready for advanced competitions. Be patient with yourself.</p>`
  }
};

function loadConcept() {
  const sel = _selectedTopics ? [..._selectedTopics] : Object.keys(QB);
  const topic = sel.length===1 ? sel[0] : (S.currentTopic||'quadratics');
  const c = CONCEPTS[topic] || CONCEPTS.quadratics;
  document.getElementById('concepts-content').innerHTML = `
    <h2 style="font-size:1.2rem;font-weight:900;margin-bottom:4px;">${c.title}</h2>
    <p style="font-size:0.75rem;color:var(--muted);margin-bottom:16px;">Quick concept review before you start</p>
    ${c.body}
    <button class="btn-primary" style="width:100%;margin-top:16px;font-size:0.9rem;" onclick="closeModal('concepts-modal')">Got it â€” let's study! â†’</button>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION REPORTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openReportModal() {
  if (!S.q) return;
  const preview = document.getElementById('report-q-preview');
  preview.textContent = S.q.text.slice(0,120)+(S.q.text.length>120?'...':'');
  document.getElementById('report-details').value = '';
  openModal('report-modal');
}

let _pendingEmail = '';

function submitEmail(source) {
  const inputId = source === 'home' ? 'home-email-input' : 'settings-email-input';
  const input = document.getElementById(inputId);
  const email = input.value.trim();

  if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
    input.style.borderColor = 'var(--wrong)';
    setTimeout(() => input.style.borderColor = '', 1500);
    return;
  }

  const btn = input.nextElementSibling;
  btn.textContent = 'Sending...';
  btn.disabled = true;

  fetch('https://formspree.io/f/mbdazzzp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({ email, type: 'newsletter_signup', source, username: S.username || 'unknown' })
  })
  .then(res => {
    if (res.ok) {
      _pendingEmail = email;
      // Hide email step, show name step
      document.getElementById(source + '-step-email').style.display = 'none';
      const nameStep = document.getElementById(source + '-step-name');
      nameStep.style.display = 'block';
      setTimeout(() => document.getElementById(source + '-first-name').focus(), 80);
    } else {
      btn.textContent = 'Failed â€” try again';
      btn.disabled = false;
    }
  })
  .catch(() => {
    btn.textContent = 'Failed â€” try again';
    btn.disabled = false;
  });
}

function submitName(source) {
  const firstName = document.getElementById(source + '-first-name').value.trim();
  const lastName = document.getElementById(source + '-last-name').value.trim();

  if (!firstName) {
    const inp = document.getElementById(source + '-first-name');
    inp.style.borderColor = 'var(--wrong)';
    inp.placeholder = 'Please enter your first name!';
    setTimeout(() => { inp.style.borderColor = ''; inp.placeholder = 'First name'; }, 1800);
    return;
  }

  const fullName = lastName ? `${firstName} ${lastName}` : firstName;

  // Update app display name
  S.username = fullName;
  const nameDisp = document.getElementById('current-name-display');
  if (nameDisp) nameDisp.textContent = 'Currently: ' + S.username;
  refreshDashboard();

  // Send name to Formspree
  fetch('https://formspree.io/f/mbdazzzp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({ email: _pendingEmail, type: 'name_update', first_name: firstName, last_name: lastName || '(not provided)', full_name: fullName, source })
  }).catch(() => {});

  _finishSignup(source, firstName);
}

function skipName(source) {
  _finishSignup(source, S.username || 'there');
}

function _finishSignup(source, firstName) {
  if (!S.emailSignedUp) {
    S.emailSignedUp = true;
    S.xp += 50;
    updateLevel();
    spawnXP(`+50 XP ðŸ“¬ Welcome, ${firstName}!`, '#4cc9f0');
  }
  saveState();
  document.getElementById(source + '-step-name').style.display = 'none';
  document.getElementById(source + '-email-success').style.display = 'block';
}


function submitReport() {
  const type = document.getElementById('report-type').value;
  const details = document.getElementById('report-details').value;
  const q = S.q;
  if (!q) return;

  const btn = document.querySelector('#report-modal .btn-primary');
  btn.textContent = 'Sending...';
  btn.disabled = true;

  fetch('https://formspree.io/f/mbdazzzp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
    body: JSON.stringify({
      issue_type: type,
      topic: S.currentTopic,
      question: q.text,
      correct_answer: q.opts ? q.opts[q.ans] : q.ans,
      details: details || 'None provided',
      source: 'Numiqube Report'
    })
  })
  .then(res => {
    if (res.ok) {
      closeModal('report-modal');
      spawnXP('Report sent! ðŸ™', 'var(--a3)');
    } else {
      btn.textContent = 'Failed â€” try again';
      btn.disabled = false;
    }
  })
  .catch(() => {
    btn.textContent = 'Failed â€” try again';
    btn.disabled = false;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GO HOME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goHome() {
  document.getElementById('page-home').classList.add('show');
  document.getElementById('nav').style.display = 'none';
  isStudyPageActive = false;
  showHomePage();
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PRINT WORKSHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openPrintModal() {
  // Populate topic select
  const sel = document.getElementById('print-topic-sel');
  sel.innerHTML = Object.entries(TL).map(([k,v])=>
    `<option value="${k}"${k===S.currentTopic?' selected':''}>${TOPIC_ICONS[k]||'ðŸ“š'} ${v}</option>`
  ).join('');
  openModal('print-modal');
}

function generateWorksheet() {
  const topic = document.getElementById('print-topic-sel').value;
  const count = parseInt(document.getElementById('print-count-sel').value);
  const diff = document.getElementById('print-diff-sel').value;
  const topicName = TL[topic];
  const icon = TOPIC_ICONS[topic] || 'ðŸ“š';

  // Build sections
  const diffs = diff === 'all' ? ['easy','medium','hard'] : [diff];
  let sections = [];
  let qNum = 1;
  let answerKey = [];

  diffs.forEach(d => {
    let pool = QB[topic].filter(q => q.diff === d);
    if (pool.length === 0) return;
    pool = [...pool].sort(() => Math.random() - 0.5).slice(0, Math.ceil(count / diffs.length));
    const label = d === 'easy' ? 'â­ Section A â€” Easy' : d === 'medium' ? 'â­â­ Section B â€” Medium' : 'â­â­â­ Section C â€” Hard';
    sections.push({ label, questions: pool });
    pool.forEach(q => {
      const ans = q.opts ? `${['A','B','C','D'][q.ans]}. ${q.opts[q.ans]}` : q.ans;
      answerKey.push({ num: qNum++, ans, exp: q.exp });
    });
  });

  if (sections.length === 0) { uiAlert('No questions match that difficulty for this topic.', 'ðŸ¤”', 'No Matches'); return; }

  const questionsHTML = sections.map(sec => `
    <div class="section-header">${sec.label}</div>
    ${sec.questions.map((q, i) => `
    <div class="q-block">
      <div class="q-num">Question ${answerKey.findIndex(a => a.num === (sections[0].questions.indexOf(q) !== -1 && sections[0].label === sec.label ? i+1 : -1)) + 1 || i+1}</div>
      <div class="q-text">${q.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
      ${q.opts
        ? `<div class="opts">${q.opts.map((o,oi)=>`<div class="opt">${['A','B','C','D'][oi]}. ${o}</div>`).join('')}</div>`
        : `<div style="margin-top:8px;">Answer: <span class="ans-line" style="width:200px"></span></div>`}
    </div>`).join('')}
  `).join('');

  // Recount properly
  let trueNum = 0;
  const properQHTML = sections.map(sec => `
    <div class="section-header">${sec.label}</div>
    ${sec.questions.map(q => {
      trueNum++;
      return `
      <div class="q-block">
        <div class="q-num">Question ${trueNum}</div>
        <div class="q-text">${q.text.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</div>
        ${q.opts
          ? `<div class="opts">${q.opts.map((o,oi)=>`<div class="opt">${['A','B','C','D'][oi]}. ${o}</div>`).join('')}</div>`
          : `<div style="margin-top:8px;">Answer: <span class="ans-line" style="width:200px"></span></div>`}
      </div>`;
    }).join('')}
  `).join('');

  const html = `<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Numiqube â€” ${topicName} Worksheet</title>
<style>
  *{box-sizing:border-box;}
  body{font-family:Arial,sans-serif;max-width:680px;margin:40px auto;padding:0 24px;color:#111;}
  .header-bar{display:flex;justify-content:space-between;align-items:flex-start;border-bottom:3px solid #111;padding-bottom:12px;margin-bottom:20px;}
  .header-left h1{font-size:1.5rem;margin:0 0 2px;}
  .header-left .sub{font-size:0.82rem;color:#555;}
  .name-line{display:flex;gap:24px;margin-top:8px;font-size:0.85rem;}
  .name-field{border-bottom:1px solid #999;min-width:160px;display:inline-block;height:18px;}
  .score-box{border:2px solid #111;padding:8px 18px;text-align:center;font-size:0.88rem;min-width:90px;}
  .score-box strong{display:block;font-size:1.4rem;margin-top:4px;}
  .section-header{background:#f0f0f0;border-left:4px solid #111;padding:6px 12px;font-size:0.82rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;margin:20px 0 12px;page-break-after:avoid;}
  .q-block{margin-bottom:20px;padding-bottom:14px;border-bottom:1px solid #e8e8e8;page-break-inside:avoid;}
  .q-num{font-size:0.72rem;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:4px;}
  .q-text{font-size:0.98rem;font-weight:600;margin-bottom:10px;line-height:1.55;}
  .opts{display:grid;grid-template-columns:1fr 1fr;gap:4px 24px;}
  .opt{font-size:0.88rem;padding:3px 0;}
  .ans-line{border-bottom:1px solid #ccc;display:inline-block;height:18px;margin-left:6px;}
  .answer-key{page-break-before:always;padding-top:20px;}
  .ak-header{border-bottom:3px solid #111;padding-bottom:10px;margin-bottom:16px;}
  .ak-header h2{font-size:1.2rem;margin:0;}
  .ak-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:8px;}
  .ak-item{background:#f8f8f8;border-radius:6px;padding:8px 10px;font-size:0.82rem;}
  .ak-item strong{color:#111;}
  .ak-exp{color:#555;font-size:0.75rem;margin-top:2px;}
  .footer{margin-top:30px;font-size:0.68rem;color:#bbb;text-align:center;border-top:1px solid #eee;padding-top:10px;}
  @media print{body{margin:16px;}.footer{position:fixed;bottom:0;left:0;right:0;}}
</style>
</head>
<body>

<div class="header-bar">
  <div class="header-left">
    <h1>${icon} ${topicName} Worksheet</h1>
    <div class="sub">Numiqube Â· ${diff === 'all' ? 'Mixed difficulties' : diff.charAt(0).toUpperCase()+diff.slice(1)} Â· ${trueNum || answerKey.length} questions</div>
    <div class="name-line">
      <span>Name: <span class="name-field"></span></span>
      <span>Date: <span class="name-field" style="min-width:100px"></span></span>
    </div>
  </div>
  <div class="score-box">Score<strong>___ / ${answerKey.length}</strong></div>
</div>

${properQHTML}

<div class="answer-key">
  <div class="ak-header">
    <h2>ðŸ“‹ Answer Key</h2>
    <p style="font-size:0.78rem;color:#555;margin:4px 0 0;">For teacher/parent use.</p>
  </div>
  <div class="ak-grid">
    ${answerKey.map(a=>`
    <div class="ak-item">
      <strong>Q${a.num}:</strong> ${a.ans.replace(/</g,'&lt;')}
      <div class="ak-exp">${a.exp.replace(/</g,'&lt;').slice(0,80)}</div>
    </div>`).join('')}
  </div>
</div>

<div class="footer">Generated by Numiqube Â· Free math practice for everyone Â· numiqube.com</div>
`;

  const win = window.open('','_blank');
  win.document.write(html);
  win.document.close();
  setTimeout(()=>win.print(), 400);
  closeModal('print-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XP SHOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CUSTOM DIALOG â€” replaces alert/confirm/prompt
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dialogResolve = null;

function showDialog({icon='ðŸ’¬', title, msg, type='alert', inputPlaceholder='', inputDefault='', confirmLabel='OK', cancelLabel='Cancel', dangerLabel=null}) {
  return new Promise(resolve => {
    _dialogResolve = resolve;
    document.getElementById('cd-icon').textContent = icon;
    document.getElementById('cd-title').textContent = title;
    document.getElementById('cd-msg').textContent = msg;
    const inp = document.getElementById('cd-input');
    const btns = document.getElementById('cd-btns');
    inp.style.display = 'none';
    btns.innerHTML = '';
    if (type === 'prompt') {
      inp.style.display = 'block';
      inp.value = inputDefault;
      inp.placeholder = inputPlaceholder;
      setTimeout(() => inp.focus(), 80);
      inp.onkeydown = e => { if(e.key==='Enter') dialogResolveWith(true); };
      btns.innerHTML = `<button class="cd-btn-secondary" onclick="dialogResolveWith(false)">${cancelLabel}</button>
        <button class="cd-btn-primary" onclick="dialogResolveWith(true)">${confirmLabel}</button>`;
    } else if (type === 'confirm') {
      btns.innerHTML = `<button class="cd-btn-secondary" onclick="dialogResolveWith(false)">${cancelLabel}</button>
        <button class="${dangerLabel ? 'cd-btn-danger' : 'cd-btn-primary'}" onclick="dialogResolveWith(true)">${dangerLabel || confirmLabel}</button>`;
    } else {
      btns.innerHTML = `<button class="cd-btn-primary" onclick="dialogResolveWith(true)" style="flex:none;padding:11px 32px;">${confirmLabel}</button>`;
    }
    document.getElementById('custom-dialog-overlay').classList.add('show');
  });
}

function dialogResolveWith(val) {
  document.getElementById('custom-dialog-overlay').classList.remove('show');
  if (_dialogResolve) {
    if (document.getElementById('cd-input').style.display !== 'none' && val) {
      _dialogResolve(document.getElementById('cd-input').value);
    } else {
      _dialogResolve(val);
    }
    _dialogResolve = null;
  }
}

// â”€â”€ Convenience wrappers â”€â”€
function uiAlert(msg, icon='ðŸ’¬', title='Notice') {
  return showDialog({icon, title, msg, type:'alert', confirmLabel:'Got it'});
}
function uiConfirm(msg, icon='âš ï¸', title='Are you sure?', dangerLabel=null) {
  return showDialog({icon, title, msg, type:'confirm', dangerLabel});
}
function uiPrompt(msg, defaultVal='', placeholder='', icon='âœï¸', title='Enter value') {
  return showDialog({icon, title, msg, type:'prompt', inputDefault:defaultVal, inputPlaceholder:placeholder});
}

const SHOP_ITEMS = [
  // â”€â”€ Themes â”€â”€
  {id:'theme_ocean',  type:'theme',  icon:'ðŸŒŠ', name:'Ocean Night',   cost:150, rarity:'common',    desc:'Deep blue vibes',      vars:{'--bg':'#05070f','--card':'#091428','--a4':'#0ea5e9','--accent':'#0ea5e9'}},
  {id:'theme_forest', type:'theme',  icon:'ðŸŒ¿', name:'Forest Mode',   cost:150, rarity:'common',    desc:'Calm green energy',    vars:{'--accent':'#22c55e','--a3':'#16a34a'}},
  {id:'theme_candy',  type:'theme',  icon:'ðŸ¬', name:'Candy Pop',     cost:200, rarity:'rare',      desc:'Pink & irresistible',  vars:{'--accent':'#f472b6','--a2':'#fb7185','--a5':'#a855f7'}},
  {id:'theme_gold',   type:'theme',  icon:'âœ¨', name:'Gold Rush',     cost:300, rarity:'epic',      desc:'Premium gold look',    vars:{'--accent':'#f59e0b','--a2':'#fbbf24','--a3':'#fcd34d'}},
  {id:'theme_void',   type:'theme',  icon:'ðŸŒ‘', name:'Deep Void',     cost:400, rarity:'epic',      desc:'Ultra dark, ultra cool',vars:{'--bg':'#000000','--bg2':'#050505','--card':'#0a0a0a','--card2':'#0f0f0f'}},
  {id:'theme_galaxy', type:'theme',  icon:'ðŸŒŒ', name:'Galaxy Brain',  cost:600, rarity:'legendary', desc:'You actually studied for this', vars:{'--bg':'#050012','--card':'#0d0a28','--accent':'#7c3aed','--a2':'#a78bfa','--a3':'#c4b5fd','--a5':'#f0abfc'}},
  // â”€â”€ Titles â”€â”€
  {id:'title_student',   type:'title', icon:'ðŸ“š', name:'"Student"',       cost:0,   rarity:'common',    desc:'The default â€” own it'},
  {id:'title_grinder',   type:'title', icon:'ðŸ’ª', name:'"The Grinder"',   cost:100,  rarity:'common',    desc:'For the dedicated'},
  {id:'title_curious',   type:'title', icon:'ðŸ”', name:'"The Curious"',   cost:100,  rarity:'common',    desc:'For explorers'},
  {id:'title_speedy',    type:'title', icon:'âš¡', name:'"Speed Demon"',   cost:150,  rarity:'rare',      desc:'Fast and accurate'},
  {id:'title_wizard',    type:'title', icon:'ðŸ§™', name:'"Math Wizard"',   cost:200,  rarity:'rare',      desc:'Earned by the best'},
  {id:'title_duelist',   type:'title', icon:'âš”ï¸', name:'"The Duelist"',   cost:250,  rarity:'epic',      desc:'5 duel wins required... or just buy it'},
  {id:'title_undefeated',type:'title', icon:'ðŸ›¡ï¸', name:'"Undefeated"',    cost:350,  rarity:'epic',      desc:'Intimidate your opponents'},
  {id:'title_legend',    type:'title', icon:'ðŸ‘‘', name:'"Legend"',        cost:500,  rarity:'legendary', desc:'For the true elite'},
  {id:'title_mathgod',   type:'title', icon:'ðŸ”±', name:'"Math God"',      cost:800,  rarity:'legendary', desc:'Unmistakable'},
  // â”€â”€ Avatars (free ones from onboarding are also here, cost 0) â”€â”€
  {id:'avatar_lion',   type:'avatar', icon:'ðŸ¦', name:'Lion',         cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_fox',    type:'avatar', icon:'ðŸ¦Š', name:'Fox',          cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_tiger',  type:'avatar', icon:'ðŸ¯', name:'Tiger',        cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_dolphin',type:'avatar', icon:'ðŸ¬', name:'Dolphin',      cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_unicorn',type:'avatar', icon:'ðŸ¦„', name:'Unicorn',      cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_dragon', type:'avatar', icon:'ðŸ‰', name:'Dragon',       cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_owl',    type:'avatar', icon:'ðŸ¦‰', name:'Owl',          cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_wolf',   type:'avatar', icon:'ðŸº', name:'Wolf',         cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_penguin',type:'avatar', icon:'ðŸ§', name:'Penguin',      cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_shark',  type:'avatar', icon:'ðŸ¦ˆ', name:'Shark',        cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_panda',  type:'avatar', icon:'ðŸ¼', name:'Panda',        cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_octopus',type:'avatar', icon:'ðŸ™', name:'Octopus',      cost:0,   rarity:'common',    desc:'Free starter avatar'},
  {id:'avatar_fire',   type:'avatar', icon:'ðŸ”¥', name:'Fire',         cost:75,  rarity:'common',    desc:'Ablaze with knowledge'},
  {id:'avatar_robot',  type:'avatar', icon:'ðŸ¤–', name:'Robot',        cost:75,  rarity:'common',    desc:'Calculating...'},
  {id:'avatar_star',   type:'avatar', icon:'â­', name:'Star',         cost:100, rarity:'rare',      desc:'Shine bright'},
  {id:'avatar_alien',  type:'avatar', icon:'ðŸ‘¾', name:'Alien',        cost:125, rarity:'rare',      desc:'From another dimension'},
  {id:'avatar_ninja',  type:'avatar', icon:'ðŸ¥·', name:'Ninja',        cost:150, rarity:'rare',      desc:'Swift and silent'},
  {id:'avatar_wizard2',type:'avatar', icon:'ðŸ§™', name:'Wizard',       cost:175, rarity:'rare',      desc:'Conjurer of equations'},
  {id:'avatar_cube',   type:'avatar', icon:'ðŸ§Š', name:'Ice Cube',     cost:200, rarity:'epic',      desc:'Official Numiqube avatar'},
  {id:'avatar_crown',  type:'avatar', icon:'ðŸ‘‘', name:'Crown',        cost:250, rarity:'epic',      desc:'Royalty only'},
  {id:'avatar_gem',    type:'avatar', icon:'ðŸ’Ž', name:'Diamond',      cost:350, rarity:'epic',      desc:'Rare and brilliant'},
  {id:'avatar_comet',  type:'avatar', icon:'â˜„ï¸',  name:'Comet',        cost:500, rarity:'legendary', desc:'Unstoppable force'},
  {id:'avatar_nova',   type:'avatar', icon:'ðŸŒŸ', name:'Supernova',    cost:750, rarity:'legendary', desc:'You earned this'},
];

function openShop() {
  // Auto-own all free items
  if (!S.shopOwned) S.shopOwned = [];
  SHOP_ITEMS.filter(i => i.cost === 0).forEach(i => {
    if (!S.shopOwned.includes(i.id)) S.shopOwned.push(i.id);
  });
  document.getElementById('shop-xp-display').textContent = S.xp+' XP';
  const grid = document.getElementById('shop-items-grid');
  grid.innerHTML = '';

  // Group by type
  const types = [['avatar','ðŸ™‚ Avatars'],['title','ðŸ“› Titles'],['theme','ðŸŽ¨ Themes']];
  types.forEach(([type, label]) => {
    const heading = document.createElement('div');
    heading.style.cssText='grid-column:1/-1;font-size:0.72rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:8px;';
    heading.textContent = label;
    grid.appendChild(heading);

    SHOP_ITEMS.filter(i=>i.type===type).forEach(item => {
      const owned = S.shopOwned && S.shopOwned.includes(item.id);
      const equipped = S.shopEquipped && S.shopEquipped[item.type]===item.id;
      const canAfford = S.xp >= item.cost;

      const rarity = item.rarity || 'common';
      const isFree = item.cost === 0;
      const card = document.createElement('div');
      card.className = 'shop-item'+(owned?' owned':'')+(equipped?' equipped':'')+((!owned&&!canAfford&&!isFree)?' locked':'');
      card.innerHTML = `
        <span class="shop-icon" style="position:relative;">${item.icon}</span>
        <span class="shop-name">${item.name}</span>
        <span class="rarity-badge ${rarity}">${rarity.charAt(0).toUpperCase()+rarity.slice(1)}</span>
        <span class="shop-cost">${owned?'Owned':isFree?'FREE':item.cost+' XP'}</span>
        <div class="shop-status" style="color:${equipped?'var(--a5)':owned?'var(--a3)':(canAfford||isFree)?'var(--muted)':'var(--wrong)'}">${equipped?'âœ“ Equipped':owned?'Tap to equip':(canAfford||isFree)?'Tap to equip/buy':'Need more XP'}</div>
      `;
      card.onclick = () => shopAction(item);
      grid.appendChild(card);
    });
  });

  openModal('shop-modal');
}

function shopAction(item) {
  if (!S.shopOwned) S.shopOwned = [];
  if (!S.shopEquipped) S.shopEquipped = {};

  const owned = S.shopOwned.includes(item.id);

  if (!owned) {
    if (item.cost > 0 && S.xp < item.cost) { spawnXP('Not enough XP!','var(--wrong)'); return; }
    S.xp -= item.cost;
    if (!S.shopSpent) S.shopSpent=0;
    S.shopSpent += item.cost;
    S.shopOwned.push(item.id);
    document.getElementById('shop-xp-display').textContent = S.xp+' XP';
    document.getElementById('nav-xp').textContent = S.xp+' XP';
    spawnXP(`ðŸŽ‰ ${item.icon} Unlocked!`,'#c77dff');
  }

  // Equip it
  if (S.shopEquipped[item.type]===item.id) {
    // Unequip
    delete S.shopEquipped[item.type];
    if (item.type==='theme') unequipTheme();
  } else {
    S.shopEquipped[item.type] = item.id;
    if (item.type==='theme') applyTheme(item);
    if (item.type==='avatar') document.getElementById('nav-streak').textContent = item.icon+(S.dayStreak||0);
  }

  saveState();
  openShop(); // refresh
}

function applyTheme(item) {
  const root = document.documentElement;
  if (item.vars) Object.entries(item.vars).forEach(([k,v])=>root.style.setProperty(k,v));
}

function unequipTheme() {
  // Reset to defaults
  const defaults = {'--bg':'#0f0e17','--bg2':'#13121f','--card':'#1a1830','--card2':'#201e38',
    '--accent':'#ff6b35','--a2':'#ffd166','--a3':'#06d6a0','--a4':'#118ab2','--a5':'#c77dff','--a6':'#f72585'};
  Object.entries(defaults).forEach(([k,v])=>document.documentElement.style.setProperty(k,v));
}

function restoreEquipped() {
  if (!S.shopEquipped) return;
  Object.entries(S.shopEquipped).forEach(([type, id]) => {
    const item = SHOP_ITEMS.find(i=>i.id===id);
    if (!item) return;
    if (type==='theme') applyTheme(item);
  });
  updateNavAvatar();
}

function updateNavAvatar() {
  const avatarId = S.shopEquipped && S.shopEquipped.avatar;
  const titleId  = S.shopEquipped && S.shopEquipped.title;
  const avatarItem = avatarId ? SHOP_ITEMS.find(i=>i.id===avatarId) : null;
  const titleItem  = titleId  ? SHOP_ITEMS.find(i=>i.id===titleId)  : null;
  const emoji = avatarItem ? avatarItem.icon : 'â­';
  const titleText = titleItem ? titleItem.name : '"Student"';
  const nameEl  = document.getElementById('nav-avatar-name');
  const titleEl = document.getElementById('nav-avatar-title');
  const emojiEl = document.getElementById('nav-avatar-emoji');
  if (emojiEl) emojiEl.textContent = emoji;
  if (nameEl)  nameEl.textContent  = (S.username||'Player').slice(0,14);
  if (titleEl) titleEl.textContent = titleText;
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SPACED REPETITION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleSR() {
  S.srMode = !S.srMode;
  document.getElementById('sr-btn').textContent = `ðŸ§  Spaced Rep: ${S.srMode?'ON':'Off'}`;
  document.getElementById('sr-btn').classList.toggle('active-tool', S.srMode);
  const pb = document.getElementById('panel-sr-btn');
  if(pb){ pb.textContent=`ðŸ§  Spaced Rep: ${S.srMode?'ON':'Off'}`; pb.classList.toggle('active-tool',S.srMode); }
  if (S.srMode) buildSRQueue();
}

function buildSRQueue() {
  // Put wrong questions back in queue
  S.srQueue = [...S.wrongLog].slice(-20);
}

function getNextQ() {
  if (S.srMode && S.srQueue.length > 0 && Math.random() < 0.4) {
    const item = S.srQueue.splice(0,1)[0];
    if (item) return item;
  }
  // Multi-topic support
  const activeTops = _selectedTopics ? [..._selectedTopics] : Object.keys(QB);
  // Pick a random topic from selection
  const topic = activeTops[Math.floor(Math.random()*activeTops.length)];
  S.currentTopic = topic;
  const pool = QB[topic], used = usedQ[topic];
  if (!used) usedQ[topic] = [];
  const avail = pool.map((_,i)=>i).filter(i=>!usedQ[topic].includes(i));
  if (avail.length===0) { usedQ[topic]=[]; return pool[Math.floor(Math.random()*pool.length)]; }
  const idx = avail[Math.floor(Math.random()*avail.length)];
  usedQ[topic].push(idx);
  return pool[idx];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATH RENDERING â€” converts ^, _, fractions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMath(str) {
  if (!str) return str;
  // Fractions: a/b surrounded by spaces or at start/end â†’ make fraction
  // Handle explicit fraction notation like Â½, Â¼ etc already in text
  str = String(str);

  // Superscripts: x^2 â†’ x<sup>2</sup>, handles multi-char like x^(n+1)
  str = str.replace(/\^(\([^)]+\))/g, (_, exp) => `<sup>${exp.replace(/[()]/g,'')}</sup>`);
  str = str.replace(/\^(-?\d+)/g, (_, exp) => `<sup>${exp}</sup>`);
  str = str.replace(/\^([a-zA-Z])/g, (_, exp) => `<sup>${exp}</sup>`);

  // Subscripts: x_1 â†’ x<sub>1</sub>
  str = str.replace(/_(\d+)/g, (_, sub) => `<sub>${sub}</sub>`);
  str = str.replace(/_([a-zA-Z])/g, (_, sub) => `<sub>${sub}</sub>`);

  // Simple inline fractions like (a/b) â†’ proper fraction display when surrounded by spaces
  // Pattern: number/number not inside a word context
  str = str.replace(/(\b\d+)\/(\d+\b)/g, (_, n, d) => 
    `<span class="inline-frac"><sup>${n}</sup>â„<sub>${d}</sub></span>`);

  // Square root: âˆš(expr) or âˆšn
  str = str.replace(/âˆš\(([^)]+)\)/g, (_, inner) => `<span class="sqrt-wrap">âˆš<span class="sqrt-inner">${inner}</span></span>`);

  // Â± â†’ proper symbol (already in some questions but make sure)
  str = str.replace(/\+\/-/g, 'Â±');

  // â†’ already fine
  // Ã— already fine
  // Ã· already fine

  return str;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANSWER SHUFFLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _shuffledOpts = [];
let _shuffledCorrectIdx = 0;

function shuffleAnswers(opts, correctIdx) {
  const indexed = opts.map((o, i) => ({text: o, isCorrect: i === correctIdx}));
  for (let i = indexed.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [indexed[i], indexed[j]] = [indexed[j], indexed[i]];
  }
  _shuffledOpts = indexed.map(o => o.text);
  _shuffledCorrectIdx = indexed.findIndex(o => o.isCorrect);
  return _shuffledOpts;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QUESTION LOADING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadQ() {
  if (S.paused) return;
  if (S.speedInterval) { clearInterval(S.speedInterval); S.speedInterval = null; }
  S.answered = false; S.hintUsed = false;
  S.q = getNextQ(); S.qIdx++; S.qStart = Date.now();
  document.getElementById('hint-text').style.display='none';
  document.getElementById('hint-btn').textContent='ðŸ’¡ Hint';
  document.getElementById('feedback-box').style.display='none';
  document.getElementById('next-btn').style.display='none';
  document.getElementById('review-section').style.display='none';

  const q = S.q;
  const dt = document.getElementById('diff-tag');
  dt.textContent = q.diff==='competition'?'ðŸ† Challenge':q.diff[0].toUpperCase()+q.diff.slice(1);
  dt.className = 'd-'+(q.diff==='competition'?'competition':q.diff);
  document.getElementById('topic-badge').textContent = TL[S.currentTopic];
  document.getElementById('q-counter').textContent = `Q ${S.qIdx}`;
  document.getElementById('question-text').innerHTML = renderMath(q.text.replace(/\n/g,'<br>'));
  document.getElementById('hint-text').innerHTML = renderMath(q.hint);

  // Progress bar
  const sg = S.settings.sessionGoal;
  const pct = Math.min(S.sessionCorrect/sg*100,100);
  document.getElementById('session-prog-fill').style.width = pct+'%';
  document.getElementById('session-prog-text').textContent = `Session Goal: ${S.sessionCorrect} / ${sg}`;
  document.getElementById('session-goal-badge').textContent = pct>=100?'ðŸ† Done! Seriously nice session.':pct>=50?'ðŸ’ª More than halfway there.':'Keep going, you got this.';

  // Daily progress
  const dpct = Math.min(S.sessionCorrect/10*100,100);
  document.getElementById('daily-compact-bar').style.width = dpct+'%';
  document.getElementById('daily-compact-count').textContent = (S.sessionCorrect>=10?'âœ…':S.sessionCorrect+'/10');
  document.getElementById('daily-compact-label').textContent = S.sessionCorrect>=10 ? 'âœ… Daily done!' : 'âš¡ Daily';

  const og = document.getElementById('options-grid');
  const fw = document.getElementById('free-wrap');
  const nw = document.getElementById('numpad-wrap');
  const sw = document.getElementById('sort-wrap');
  const mv = document.getElementById('multivar-wrap');
  og.innerHTML='';
  og.style.display='none';
  fw.style.display='none';
  nw.style.display='none';
  sw.style.display='none';
  mv.style.display='none';

  if (q.type==='free') {
    fw.style.display='block';
    document.getElementById('free-input').value='';
    document.getElementById('free-input').disabled=false;
    document.getElementById('submit-free').disabled=false;
    setTimeout(()=>document.getElementById('free-input').focus(),80);
  } else if (q.type==='numpad') {
    nw.style.display='block';
    document.getElementById('numpad-display').textContent='_';
    document.getElementById('numpad-display').style.borderColor='';
    document.getElementById('numpad-display').style.color='var(--text)';
    _numpadVal = '';
    // Re-enable all numpad buttons
    document.querySelectorAll('.numpad-btn').forEach(b=>b.disabled=false);
  } else if (q.type==='sort') {
    sw.style.display='block';
    document.querySelector('#sort-wrap .numpad-submit').disabled=false;
    buildSortList(q.sortItems.slice());
  } else if (q.type==='multivar') {
    mv.style.display='block';
    document.getElementById('submit-multivar').disabled=false;
    const fields = document.getElementById('multivar-fields');
    fields.innerHTML = q.vars.map((v,i) => `
      <div style="display:flex;align-items:center;gap:10px;">
        <label style="font-family:'Space Mono',monospace;font-size:0.95rem;font-weight:700;color:var(--accent);min-width:40px;">${v} =</label>
        <input class="free-input" id="mv-input-${i}" type="text" placeholder="Enter value" 
          style="flex:1;background:var(--card2);border:1.5px solid var(--border);color:var(--text);font-family:'Space Mono',monospace;font-size:1rem;padding:9px 13px;border-radius:10px;outline:none;"
          onkeydown="if(event.key==='Enter')submitMultiVar()"/>
      </div>`).join('');
    setTimeout(()=>document.getElementById('mv-input-0').focus(),80);
  } else {
    // Regular multiple choice â€” hard/competition = fewer choices if question specifies
    const shuffled = shuffleAnswers(q.opts, q.ans);
    const choiceCount = (q.diff==='competition'||q.diff==='hard') && q.opts.length<=2 ? q.opts.length : 4;
    og.style.display='grid';
    shuffled.slice(0,choiceCount).forEach((opt,i)=>{
      const b=document.createElement('button'); b.className='opt-btn';
      b.innerHTML=`<span class="opt-lbl">${['A','B','C','D'][i]}</span><span>${renderMath(opt)}</span>`;
      b.onclick=()=>checkAns(i); og.appendChild(b);
    });
  }

  // Speed mode
  const speedWrap = document.getElementById('speed-ring-wrap');
  if (S.mode==='speed') {
    speedWrap.style.display='block';
    startSpeedTimer();
  } else {
    speedWrap.style.display='none';
  }

  const card=document.getElementById('question-card');
  card.style.animation='none'; card.offsetHeight; card.style.animation='slideIn 0.3s ease';
}

function startSpeedTimer() {
  const limit = S.settings.speedTimer;
  let remaining = limit;
  const arc = document.getElementById('speed-arc');
  const num = document.getElementById('speed-num');
  const circum = 125.6;
  arc.style.stroke = 'var(--a2)';

  S.speedInterval = setInterval(() => {
    if (S.paused || S.answered) { clearInterval(S.speedInterval); return; }
    remaining--;
    num.textContent = remaining;
    const offset = circum * (1 - remaining/limit);
    arc.style.strokeDashoffset = offset;
    if (remaining <= 3) arc.style.stroke = 'var(--wrong)';
    if (remaining <= 0) {
      clearInterval(S.speedInterval);
      if (!S.answered) autoWrong();
    }
  },1000);
}

function autoWrong() {
  if (S.answered) return;
  S.answered = true;
  // Disable all input types gracefully
  document.querySelectorAll('.opt-btn').forEach((b,i) => {
    b.disabled = true;
    if (i === _shuffledCorrectIdx) b.classList.add('correct');
  });
  document.querySelectorAll('.numpad-btn').forEach(b => b.disabled = true);
  const fi = document.getElementById('free-input');
  if (fi) { fi.disabled = true; document.getElementById('submit-free').disabled = true; }
  const mvsub = document.getElementById('submit-multivar');
  if (mvsub) mvsub.disabled = true;
  document.querySelector('#sort-wrap .numpad-submit') && (document.querySelector('#sort-wrap .numpad-submit').disabled = true);
  showFeedback(false, S.q.exp, S.settings.speedTimer);
  updateScore(false);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANSWER CHECKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAns(sel) {
  if (S.answered || S.paused) return;
  S.answered = true;
  if (S.speedInterval) { clearInterval(S.speedInterval); S.speedInterval = null; }
  const elapsed = (Date.now()-S.qStart)/1000;
  S.lastTime = elapsed;
  // Use _shuffledCorrectIdx â€” the correct answer's position after shuffling
  S.lastCorrect = sel === _shuffledCorrectIdx;
  document.querySelectorAll('.opt-btn').forEach((b,i)=>{
    b.disabled=true;
    if(i===_shuffledCorrectIdx)b.classList.add('correct');
    else if(i===sel&&!S.lastCorrect)b.classList.add('wrong');
  });
  showFeedback(S.lastCorrect, S.q.exp, elapsed);
  updateScore(S.lastCorrect);
}

function submitFree() {
  if (S.answered || S.paused) return;
  S.answered=true;
  const elapsed=(Date.now()-S.qStart)/1000;
  S.lastTime=elapsed;
  const inp=document.getElementById('free-input').value.trim().toLowerCase();
  const acc=S.q.accepted.map(a=>a.toLowerCase());
  S.lastCorrect=acc.some(a=>inp===a||inp.replace(/\s/g,'')===a.replace(/\s/g,''));
  document.getElementById('free-input').disabled=true;
  document.getElementById('submit-free').disabled=true;
  showFeedback(S.lastCorrect,S.q.exp,elapsed);
  updateScore(S.lastCorrect);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NUMPAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _numpadVal = '';

function numpadPress(digit) {
  if (S.answered) return;
  if (_numpadVal.length >= 8) return;
  // Prevent double decimals or leading zeros
  if (digit === '.' && _numpadVal.includes('.')) return;
  if (digit === '.' && _numpadVal === '') { _numpadVal = '0'; }
  _numpadVal += digit;
  document.getElementById('numpad-display').textContent = _numpadVal;
}

function numpadNegate() {
  if (S.answered) return;
  if (_numpadVal.startsWith('-')) _numpadVal = _numpadVal.slice(1);
  else if (_numpadVal !== '' && _numpadVal !== '0') _numpadVal = '-' + _numpadVal;
  document.getElementById('numpad-display').textContent = _numpadVal || '_';
}

function numpadClear() {
  if (S.answered) return;
  _numpadVal = _numpadVal.slice(0,-1);
  document.getElementById('numpad-display').textContent = _numpadVal || '_';
}

function submitNumpad() {
  if (S.answered || S.paused || !_numpadVal || _numpadVal === '-') return;
  S.answered = true;
  if (S.speedInterval) { clearInterval(S.speedInterval); S.speedInterval = null; }
  const elapsed = (Date.now()-S.qStart)/1000;
  S.lastTime = elapsed;
  const acc = S.q.accepted.map(a => a.toString().toLowerCase().trim());
  const inp = _numpadVal.toLowerCase().trim();
  S.lastCorrect = acc.includes(inp);
  document.querySelectorAll('.numpad-btn').forEach(b=>b.disabled=true);
  const disp = document.getElementById('numpad-display');
  disp.style.borderColor = S.lastCorrect ? 'var(--correct)' : 'var(--wrong)';
  disp.style.color = S.lastCorrect ? 'var(--correct)' : 'var(--wrong)';
  showFeedback(S.lastCorrect, S.q.exp, elapsed);
  updateScore(S.lastCorrect);
}

function submitMultiVar() {
  if (S.answered || S.paused) return;
  const inputs = S.q.vars.map((v,i) => document.getElementById('mv-input-'+i));
  // Validate all filled
  let allFilled = true;
  inputs.forEach(inp => { if (!inp.value.trim()) { inp.style.borderColor='var(--wrong)'; allFilled=false; } else inp.style.borderColor=''; });
  if (!allFilled) {
    document.getElementById('multivar-hint').textContent = 'âš ï¸ Please fill in all fields before submitting.';
    document.getElementById('multivar-hint').style.color = 'var(--wrong)';
    setTimeout(() => {
      document.getElementById('multivar-hint').textContent = 'Enter each value separately. Use numbers only â€” no letters or symbols.';
      document.getElementById('multivar-hint').style.color = '';
    }, 2000);
    return;
  }
  S.answered = true;
  if (S.speedInterval) { clearInterval(S.speedInterval); S.speedInterval = null; }
  const elapsed = (Date.now()-S.qStart)/1000;
  S.lastTime = elapsed;
  const userVals = inputs.map(inp => inp.value.trim().toLowerCase());
  const correctVals = S.q.accepted.map(a => a.toString().toLowerCase().trim());
  S.lastCorrect = userVals.every((v,i) => v === correctVals[i]);
  document.getElementById('submit-multivar').disabled = true;
  inputs.forEach((inp,i) => {
    inp.disabled = true;
    inp.style.borderColor = userVals[i]===correctVals[i] ? 'var(--correct)' : 'var(--wrong)';
  });
  showFeedback(S.lastCorrect, S.q.exp, elapsed);
  updateScore(S.lastCorrect);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SORT / DRAG-TO-ORDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _dragSrcIdx = null;

function buildSortList(items) {
  // Shuffle the items so they don't start in order
  for (let i = items.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [items[i],items[j]] = [items[j],items[i]];
  }
  const list = document.getElementById('sort-list');
  list.innerHTML = '';
  items.forEach((item, idx) => {
    const el = document.createElement('div');
    el.className = 'sort-item';
    el.draggable = true;
    el.dataset.idx = idx;
    el.innerHTML = `<span class="sort-handle">â ¿</span><span>${renderMath(item)}</span>`;
    // Drag events
    el.addEventListener('dragstart', e => {
      _dragSrcIdx = idx;
      setTimeout(() => el.style.opacity = '0.4', 0);
    });
    el.addEventListener('dragend', () => {
      el.style.opacity = '1';
      document.querySelectorAll('.sort-item').forEach(i=>i.classList.remove('drag-over'));
    });
    el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('drag-over'); });
    el.addEventListener('dragleave', () => el.classList.remove('drag-over'));
    el.addEventListener('drop', e => {
      e.preventDefault();
      el.classList.remove('drag-over');
      const children = [...list.children];
      const srcEl = children[_dragSrcIdx];
      const tgtEl = children[idx];
      if (srcEl && tgtEl && srcEl !== tgtEl) {
        const srcNext = srcEl.nextSibling;
        const tgtNext = tgtEl.nextSibling;
        list.insertBefore(srcEl, tgtNext);
        list.insertBefore(tgtEl, srcNext);
      }
    });
    // Touch/tap: tap to select then tap destination to swap
    el.addEventListener('click', () => {
      if (S.answered) return;
      const selected = list.querySelector('.sort-item.selected');
      if (!selected || selected === el) {
        document.querySelectorAll('.sort-item').forEach(i=>i.classList.remove('selected'));
        el.classList.toggle('selected');
        if (el.classList.contains('selected')) el.style.borderColor = 'var(--accent)';
        else el.style.borderColor = '';
      } else {
        // Swap
        const children = [...list.children];
        const ai = children.indexOf(selected), bi = children.indexOf(el);
        const aNext = selected.nextSibling, bNext = el.nextSibling;
        list.insertBefore(selected, bNext);
        list.insertBefore(el, aNext);
        selected.classList.remove('selected');
        selected.style.borderColor = '';
      }
    });
    list.appendChild(el);
  });
}

function submitSort() {
  if (S.answered || S.paused) return;
  S.answered = true;
  const elapsed = (Date.now()-S.qStart)/1000;
  S.lastTime = elapsed;
  const list = document.getElementById('sort-list');
  const currentOrder = [...list.children].map(el => el.querySelector('span:last-child').textContent.trim());
  const correctOrder = S.q.sortAnswer;
  S.lastCorrect = currentOrder.join(',') === correctOrder.join(',');
  // Color the items
  [...list.children].forEach((el, i) => {
    el.style.borderColor = S.lastCorrect ? 'var(--correct)' : (el.querySelector('span:last-child').textContent.trim()===correctOrder[i]?'var(--correct)':'var(--wrong)');
    el.draggable = false;
  });
  document.querySelector('#sort-wrap .numpad-submit').disabled = true;
  showFeedback(S.lastCorrect, S.q.exp, elapsed);
  updateScore(S.lastCorrect);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HUMAN-SOUNDING FEEDBACK MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CORRECT_MSGS = [
  "Nailed it! ðŸŽ‰",
  "Yep, that's right!",
  "Let's go!! âœ…",
  "You got it.",
  "That's correct â€” nice work.",
  "Easy for you, huh? ðŸ˜",
  "Boom. âœ…",
  "On a roll! Keep going.",
  "That's the one. ðŸ™Œ",
  "Clean. Really clean.",
  "Didn't even hesitate. ðŸ”¥",
  "One step closer to calculus. ðŸ˜¤",
];
const WRONG_MSGS = [
  "Not quite â€” but now you know.",
  "Ah, close! Check the steps below.",
  "Nope, but don't stress it. Look at why.",
  "That one trips people up a lot. Read the breakdown.",
  "Wrong answer, right attitude for looking at it.",
  "Mistakes are literally how you get better. No cap.",
  "Ooh, not that one. Here's what happened:",
  "That's a common mix-up. Here's the fix:",
  "Even good students miss this. Read the steps.",
  "It happens. Look at the explanation and move on.",
];

function randMsg(arr) { return arr[Math.floor(Math.random()*arr.length)]; }

function showFeedback(correct, exp, elapsed) {
  const box=document.getElementById('feedback-box');
  box.style.display='block';
  box.className=correct?'fb-correct':'fb-wrong';
  const ts=elapsed<120?` <span style="color:var(--muted);font-size:0.75rem;">(${elapsed.toFixed(1)}s)</span>`:'';
  const headline = correct ? randMsg(CORRECT_MSGS) : randMsg(WRONG_MSGS);

  // Test mode: hide explanation until they're done, just show correct/wrong
  if (_isTestMode) {
    box.innerHTML = `<strong>${headline}</strong>${ts}
      <div style="margin-top:5px;font-size:0.75rem;color:var(--muted);">${correct?'Keep going!':'The explanation will be available when you exit test mode.'}</div>`;
    _testResults.push(correct);
    const t = _testResults.length;
    const c = _testResults.filter(r=>r).length;
    document.getElementById('test-score-live').textContent = `${c}/${t} correct`;
  } else {
    const stepsHTML = S.q.steps ? S.q.steps.map((s,i)=>`<div class="fb-step"><strong>Step ${i+1}</strong>${renderMath(s)}</div>`).join(''):'';
    box.innerHTML = `<strong>${headline}</strong>${ts}
      <div style="margin-top:6px;font-size:0.83rem;color:var(--muted);">${renderMath(exp)}</div>
      ${stepsHTML}`;
  }
  document.getElementById('next-btn').style.display='block';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORE UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateScore(correct) {
  S.total++; S.tCount[S.currentTopic]=(S.tCount[S.currentTopic]||0)+1;
  S.tAttempt[S.currentTopic]=true;
  _sessionQCount++;
  if (correct) _sessionQCorrect++;
  // Track time per topic
  if (!S.tTimes[S.currentTopic]) S.tTimes[S.currentTopic]=[];
  S.tTimes[S.currentTopic].push(S.lastTime);

  if (correct) {
    S.correct++; S.sessionCorrect++; S.streak++;
    S.tCorrect[S.currentTopic]=(S.tCorrect[S.currentTopic]||0)+1;
    if(S.streak>S.bestStreak)S.bestStreak=S.streak;
    if(!S.hintUsed)S.noHintStreak++;else S.noHintStreak=0;
    if(S.lastTime<10)S.speedStreak++;else S.speedStreak=0;
    // comeback tracking
    if(S.comingBack<0)S.comingBack++;
    else if(S.comingBack<0&&correct)S.comingBack++;

    const base={competition:30,hard:20,medium:15,easy:10}[S.q.diff]||10;
    const streakBonus=S.streak>=10?Math.floor(base):S.streak>=5?Math.floor(base*0.75):S.streak>=3?Math.floor(base*0.5):0;
    const speedBonus=S.lastTime<6?8:S.lastTime<10?4:0;
    const noHintBonus=!S.hintUsed?3:0;
    const gained=base+streakBonus+speedBonus+noHintBonus;
    S.xp+=gained; S.sessionXP+=gained;

    // Daily challenge bonus â€” only ONCE per calendar day
    const todayKey = new Date().toISOString().slice(0,10);
    if(S.sessionCorrect===10 && S.lastDailyBonusDate !== todayKey){
      S.lastDailyBonusDate = todayKey;
      S.xp+=100; S.sessionXP+=100;
      spawnXP('+100 XP ðŸŒŸ Daily Challenge!','#ffd166');
    }

    // Session goal reached â€” maybe show results card
    const sg = S.settings.sessionGoal || 20;
    if (_sessionQCount === sg) setTimeout(maybeShowResultsCard, 1200);

    spawnXP(`+${gained} XP${streakBonus>0?' ðŸ”¥':''}${speedBonus>0?' âš¡':''}${noHintBonus>0?' ðŸ§ ':''}`)
    updateLevel();

    // Update goals
    updateGoalProgress();
  } else {
    S.streak=0; S.wrong++; S.noHintStreak=0; S.speedStreak=0;
    if(S.comingBack>=0)S.comingBack=-3;else S.comingBack++;
    // Log wrong question for review
    S.wrongLog = [...S.wrongLog.slice(-49), {q:S.q, topic:S.currentTopic, date:new Date().toISOString()}];
  }

  // Activity log
  const key = new Date().toISOString().slice(0,10);
  S.activityLog[key] = (S.activityLog[key]||0)+1;

  // Update session history periodically
  if (S.total % 5 === 0) {
    S.history.unshift({date:new Date().toLocaleString(),topic:TL[S.currentTopic],correct:S.correct,total:S.total,xp:S.xp});
    S.history = S.history.slice(0,50);
  }

  // UI updates
  document.getElementById('score-display').textContent=`${S.correct}/${S.total}`;
  document.getElementById('nav-streak').textContent=`ðŸ”¥${S.dayStreak}`;
  document.getElementById('nav-xp').textContent=`${S.xp} XP`;
  document.getElementById('st-correct').textContent=S.correct;
  document.getElementById('st-wrong').textContent=S.wrong;
  document.getElementById('st-streak').textContent=S.bestStreak;
  document.getElementById('st-acc').textContent=S.total>0?Math.round(S.correct/S.total*100)+'%':'--%';
  const avgTimes=S.tTimes[S.currentTopic]||[];
  const avg=avgTimes.length>0?avgTimes.reduce((a,b)=>a+b,0)/avgTimes.length:0;
  document.getElementById('st-time').textContent=avg>0?avg.toFixed(1)+'s':'--s';
  document.getElementById('st-xp').textContent=S.sessionXP;

  // Question streak banner
  const banner = document.getElementById('q-streak-banner');
  const qsNum = document.getElementById('q-streak-num');
  const qsSub = document.getElementById('q-streak-sub');
  const navQS = document.getElementById('nav-qstreak');
  if (S.streak >= 2) {
    banner.classList.add('show');
    qsNum.textContent = S.streak;
    const milestones = {3:'Nice!',5:'Hot streak! ðŸ”¥',10:'Unstoppable!! ðŸ¤¯',20:'LEGENDARY ðŸ†'};
    const milestone = Object.keys(milestones).reverse().find(k => S.streak >= k);
    qsSub.textContent = milestone ? milestones[milestone] : 'in a row!';
    navQS.textContent = `âš¡${S.streak}`;
    navQS.style.display = 'inline';
  } else {
    banner.classList.remove('show');
    navQS.style.display = 'none';
  }

  // Sound
  if(S.settings.sound)playSound(correct);

  checkAchievements();
  updateWrongReview();
  saveState();
}

function updateLevel() {
  const oldLevel = S.level;
  const nl=Math.floor(S.xp/100)+1;
  if(nl>S.level){S.level=nl;spawnXP(`ðŸŽ‰ LEVEL ${S.level}!`,'#c77dff');}
  document.getElementById('nav-lvl').textContent=`LVL ${S.level}`;
  document.getElementById('xp-bar-fill')&&(document.getElementById('xp-bar-fill').style.width=Math.min((S.xp%100),100)+'%');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND (Web Audio API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SOUND ENGINE â€” Full procedural audio
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _audioCtx = null;
let _musicPlaying = false;
let _musicEnabled = true;

function getAudioCtx() {
  if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (_audioCtx.state === 'suspended') _audioCtx.resume();
  return _audioCtx;
}

// â”€â”€ Master gain node helper â”€â”€
function makeMaster(vol=0.3) {
  const ctx = getAudioCtx();
  const g = ctx.createGain();
  g.gain.setValueAtTime(vol, ctx.currentTime);
  g.connect(ctx.destination);
  return g;
}

// â”€â”€ Correct answer: bright ascending chime â”€â”€
function soundCorrect() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.25);
    const notes = [523.25, 659.25, 783.99, 1046.5]; // C5 E5 G5 C6
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const env = ctx.createGain();
      osc.connect(env); env.connect(master);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime);
      const t = ctx.currentTime + i * 0.09;
      env.gain.setValueAtTime(0, t);
      env.gain.linearRampToValueAtTime(0.5, t + 0.03);
      env.gain.exponentialRampToValueAtTime(0.001, t + 0.28);
      osc.start(t); osc.stop(t + 0.3);
    });
    // Sparkle layer â€” high harmonics
    const sparkle = ctx.createOscillator();
    const sg = ctx.createGain();
    sparkle.connect(sg); sg.connect(master);
    sparkle.type = 'sine';
    sparkle.frequency.setValueAtTime(2093, ctx.currentTime + 0.25);
    sg.gain.setValueAtTime(0.2, ctx.currentTime + 0.25);
    sg.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.55);
    sparkle.start(ctx.currentTime + 0.25); sparkle.stop(ctx.currentTime + 0.6);
  } catch(e) {}
}

// â”€â”€ Wrong answer: soft thud + descending tone â”€â”€
function soundWrong() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.2);
    // Low thud
    const buf = ctx.createBuffer(1, ctx.sampleRate * 0.15, ctx.sampleRate);
    const data = buf.getChannelData(0);
    for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.04));
    const src = ctx.createBufferSource();
    src.buffer = buf; src.connect(master); src.start();
    // Descending tone
    const osc = ctx.createOscillator();
    const env = ctx.createGain();
    osc.connect(env); env.connect(master);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(330, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(180, ctx.currentTime + 0.35);
    env.gain.setValueAtTime(0.3, ctx.currentTime);
    env.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.4);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.4);
  } catch(e) {}
}

// â”€â”€ XP / achievement fanfare â”€â”€
function soundAchievement() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.2);
    const melody = [523,659,784,659,1047]; // C E G E C octave
    const times  = [0, 0.12, 0.24, 0.36, 0.5];
    melody.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const env = ctx.createGain();
      osc.connect(env); env.connect(master);
      osc.type = i === 4 ? 'sine' : 'triangle';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + times[i]);
      const t = ctx.currentTime + times[i];
      env.gain.setValueAtTime(0, t);
      env.gain.linearRampToValueAtTime(0.4, t + 0.04);
      env.gain.exponentialRampToValueAtTime(0.001, t + 0.22);
      osc.start(t); osc.stop(t + 0.25);
    });
  } catch(e) {}
}

// â”€â”€ Level up: triumphant rising arpeggio â”€â”€
function soundLevelUp() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.22);
    const chord = [261.63, 329.63, 392, 523.25, 659.25, 783.99, 1046.5];
    chord.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const env = ctx.createGain();
      osc.connect(env); env.connect(master);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + i * 0.07);
      const t = ctx.currentTime + i * 0.07;
      env.gain.setValueAtTime(0, t);
      env.gain.linearRampToValueAtTime(0.35, t + 0.04);
      env.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
      osc.start(t); osc.stop(t + 0.55);
    });
  } catch(e) {}
}

// â”€â”€ Duel countdown beeps: tension builder â”€â”€
function soundCountdownBeep(n) {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.3);
    const freq = n === 0 ? 880 : 440; // GO! is higher
    const osc = ctx.createOscillator();
    const env = ctx.createGain();
    osc.connect(env); env.connect(master);
    osc.type = 'square';
    osc.frequency.setValueAtTime(freq, ctx.currentTime);
    if (n === 0) {
      // GO! â€” rapid ascending
      osc.frequency.linearRampToValueAtTime(1760, ctx.currentTime + 0.15);
    }
    env.gain.setValueAtTime(0.4, ctx.currentTime);
    env.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + (n === 0 ? 0.35 : 0.18));
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.4);
  } catch(e) {}
}

// â”€â”€ Duel win: victorious fanfare â”€â”€
function soundDuelWin() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.22);
    // Victory melody: G4 B4 D5 G5 D5 B4 G5 (triumphant)
    const notes  = [392, 493.88, 587.33, 783.99, 587.33, 493.88, 783.99];
    const beats  = [0, 0.15, 0.30, 0.48, 0.65, 0.80, 1.0];
    const durs   = [0.25, 0.25, 0.25, 0.35, 0.25, 0.25, 0.6];
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const env = ctx.createGain();
      osc.connect(env); env.connect(master);
      osc.type = 'sine';
      osc.frequency.setValueAtTime(freq, ctx.currentTime + beats[i]);
      const t = ctx.currentTime + beats[i];
      env.gain.setValueAtTime(0, t);
      env.gain.linearRampToValueAtTime(0.4, t + 0.03);
      env.gain.exponentialRampToValueAtTime(0.001, t + durs[i]);
      osc.start(t); osc.stop(t + durs[i] + 0.05);
    });
  } catch(e) {}
}

// â”€â”€ Duel lose: sad descending â”€â”€
function soundDuelLose() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.18);
    const notes = [523.25, 392, 329.63, 261.63];
    notes.forEach((freq, i) => {
      const osc = ctx.createOscillator();
      const env = ctx.createGain();
      osc.connect(env); env.connect(master);
      osc.type = 'sine';
      const t = ctx.currentTime + i * 0.18;
      osc.frequency.setValueAtTime(freq, t);
      env.gain.setValueAtTime(0.35, t);
      env.gain.exponentialRampToValueAtTime(0.001, t + 0.28);
      osc.start(t); osc.stop(t + 0.3);
    });
  } catch(e) {}
}

// â”€â”€ Duel score point: quick satisfying pop â”€â”€
function soundDuelPoint() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.2);
    const osc = ctx.createOscillator();
    const env = ctx.createGain();
    osc.connect(env); env.connect(master);
    osc.type = 'sine';
    osc.frequency.setValueAtTime(783.99, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(1046.5, ctx.currentTime + 0.08);
    env.gain.setValueAtTime(0.4, ctx.currentTime);
    env.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.2);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.22);
  } catch(e) {}
}

// â”€â”€ Streak milestone sound â”€â”€
function soundStreak() {
  if (!S.settings.sound) return;
  try {
    const ctx = getAudioCtx();
    const master = makeMaster(0.2);
    // Rising sparkle arpeggio
    const freqs = [523, 659, 784, 1047, 1319];
    freqs.forEach((f, i) => {
      const osc = ctx.createOscillator();
      const env = ctx.createGain();
      osc.connect(env); env.connect(master);
      osc.type = 'sine';
      const t = ctx.currentTime + i * 0.06;
      osc.frequency.setValueAtTime(f, t);
      env.gain.setValueAtTime(0.3, t);
      env.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
      osc.start(t); osc.stop(t + 0.22);
    });
  } catch(e) {}
}

// â”€â”€ Background ambient music: lo-fi study mode â”€â”€
let _ambientNodes = null;
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ðŸŽµ NUMIQUBE FULL SOUNDTRACK ENGINE
//  Three distinct tracks, all Web Audio API:
//  1. "Neon Library"   â€” study mode (lo-fi cosmic)
//  2. "Overclock"      â€” speed mode (faster, driven)
//  3. "Rival Signal"   â€” duel/arena (synthwave battle)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let _musicTrack = 'study'; // 'study' | 'speed' | 'duel'
let _musicNodes = null;    // { ctx, master, stopAll }
let _musicScheduler = null;
let _musicBeat = 0;

// â”€â”€ Reverb helper: creates a convolver with a synthesized room impulse â”€â”€
function makeReverb(ctx, decayTime = 1.5, wet = 0.25) {
  const convolver = ctx.createConvolver();
  const rate = ctx.sampleRate;
  const length = rate * decayTime;
  const impulse = ctx.createBuffer(2, length, rate);
  for (let c = 0; c < 2; c++) {
    const ch = impulse.getChannelData(c);
    for (let i = 0; i < length; i++) {
      ch[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2.5);
    }
  }
  convolver.buffer = impulse;
  const dryGain = ctx.createGain(); dryGain.gain.value = 1 - wet;
  const wetGain = ctx.createGain(); wetGain.gain.value = wet;
  const output = ctx.createGain();
  convolver.connect(wetGain); wetGain.connect(output);
  dryGain.connect(output);
  // Return a node-like object with connect method
  return { input: dryGain, dry: dryGain, wet: wetGain, convIn: convolver, output, connect(dest){ output.connect(dest); return dest; } };
}

// â”€â”€ Delay helper â”€â”€
function makeDelay(ctx, time = 0.375, feedback = 0.35, wet = 0.3) {
  const delay = ctx.createDelay(2.0);
  delay.delayTime.value = time;
  const fb = ctx.createGain(); fb.gain.value = feedback;
  const wetG = ctx.createGain(); wetG.gain.value = wet;
  const dryG = ctx.createGain(); dryG.gain.value = 1;
  const out = ctx.createGain();
  delay.connect(fb); fb.connect(delay);
  delay.connect(wetG); wetG.connect(out);
  dryG.connect(out);
  delay.connect(wetG);
  return { input: dryG, delayIn: delay, output: out, connect(dest){ out.connect(dest); } };
}

// â”€â”€ Compressor/limiter on master â”€â”€
function makeLimiter(ctx) {
  const comp = ctx.createDynamicsCompressor();
  comp.threshold.value = -6;
  comp.knee.value = 3;
  comp.ratio.value = 10;
  comp.attack.value = 0.003;
  comp.release.value = 0.1;
  comp.connect(ctx.destination);
  return comp;
}

// â”€â”€ Note frequency helpers â”€â”€
function noteHz(midi) { return 440 * Math.pow(2, (midi - 69) / 12); }
// C major pentatonic: C D E G A  (bright, happy, friendly!)
const CM_PEN = [0,2,4,7,9]; // semitone offsets from C
// Scale roots for tracks
const ROOT_STUDY = 60; // C4 (higher = brighter)
const ROOT_DUEL  = 55; // G3 (friendly energetic key)

function pentatonicNote(root, degree, octave=0) {
  const idx = ((degree % CM_PEN.length) + CM_PEN.length) % CM_PEN.length;
  return noteHz(root + CM_PEN[idx] + octave * 12);
}

// â”€â”€ Soft pad oscillator factory â”€â”€
function makePad(ctx, freq, type='sine', detuneCents=0, vol=0.08) {
  const osc = ctx.createOscillator();
  const g = ctx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  osc.detune.value = detuneCents;
  g.gain.value = vol;
  osc.connect(g);
  osc.start();
  return { osc, g, connect(dest){ g.connect(dest); } };
}

// â”€â”€ Pluck / bell tone (ADSR envelope, auto-stops) â”€â”€
function pluck(ctx, dest, freq, dur=0.8, vol=0.18, type='sine', attack=0.01, decay=0.15, sustain=0.4) {
  const osc = ctx.createOscillator();
  const env = ctx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  osc.connect(env); env.connect(dest);
  const t = ctx.currentTime;
  env.gain.setValueAtTime(0, t);
  env.gain.linearRampToValueAtTime(vol, t + attack);
  env.gain.linearRampToValueAtTime(vol * sustain, t + attack + decay);
  env.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  osc.start(t);
  osc.stop(t + dur + 0.05);
}

// â”€â”€ Sub bass note (sine, smooth) â”€â”€
function bassNote(ctx, dest, freq, dur=0.9, vol=0.22) {
  const osc = ctx.createOscillator();
  const env = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.value = freq;
  osc.connect(env); env.connect(dest);
  const t = ctx.currentTime;
  env.gain.setValueAtTime(0, t);
  env.gain.linearRampToValueAtTime(vol, t + 0.02);
  env.gain.setValueAtTime(vol * 0.7, t + dur * 0.6);
  env.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  osc.start(t);
  osc.stop(t + dur + 0.05);
}

// â”€â”€ Hi-hat (noise burst) â”€â”€
function hihat(ctx, dest, vol=0.06, dur=0.04) {
  const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.1), ctx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
  const src = ctx.createBufferSource();
  src.buffer = buf;
  const filt = ctx.createBiquadFilter();
  filt.type = 'highpass'; filt.frequency.value = 8000;
  const env = ctx.createGain();
  src.connect(filt); filt.connect(env); env.connect(dest);
  const t = ctx.currentTime;
  env.gain.setValueAtTime(vol, t);
  env.gain.exponentialRampToValueAtTime(0.0001, t + dur);
  src.start(t); src.stop(t + 0.12);
}

// â”€â”€ Kick drum (sine thud) â”€â”€
function kick(ctx, dest, vol=0.28) {
  const osc = ctx.createOscillator();
  const env = ctx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(150, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + 0.12);
  osc.connect(env); env.connect(dest);
  const t = ctx.currentTime;
  env.gain.setValueAtTime(vol, t);
  env.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
  osc.start(t); osc.stop(t + 0.2);
}

// â”€â”€ Snare (noise + tone) â”€â”€
function snare(ctx, dest, vol=0.14) {
  const noise = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.15), ctx.sampleRate);
  const nd = noise.getChannelData(0);
  for (let i = 0; i < nd.length; i++) nd[i] = Math.random() * 2 - 1;
  const ns = ctx.createBufferSource(); ns.buffer = noise;
  const nfilt = ctx.createBiquadFilter(); nfilt.type = 'bandpass'; nfilt.frequency.value = 2500; nfilt.Q.value = 0.5;
  const nenv = ctx.createGain();
  ns.connect(nfilt); nfilt.connect(nenv); nenv.connect(dest);
  const t = ctx.currentTime;
  nenv.gain.setValueAtTime(vol, t);
  nenv.gain.exponentialRampToValueAtTime(0.0001, t + 0.15);
  ns.start(t); ns.stop(t + 0.2);

  const osc = ctx.createOscillator(); const oenv = ctx.createGain();
  osc.type = 'triangle'; osc.frequency.value = 220;
  osc.connect(oenv); oenv.connect(dest);
  oenv.gain.setValueAtTime(vol * 0.5, t);
  oenv.gain.exponentialRampToValueAtTime(0.0001, t + 0.08);
  osc.start(t); osc.stop(t + 0.1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACK 1: "Cozy Corner" â€” Study Mode
//  Tempo: 76 BPM | Key: C major pentatonic
//  Vibe: warm, bright, friendly â€” like a cozy game menu
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startStudyTrack(ctx, master) {
  const BPM = 76;
  const BEAT = 60 / BPM;
  const BAR = BEAT * 4;

  // Gentle reverb, a little warmth
  const verb = makeReverb(ctx, 2.0, 0.3);
  verb.connect(master);
  const dly = makeDelay(ctx, BEAT * 0.75, 0.25, 0.2);
  dly.connect(verb.input);

  // â”€â”€ Pad layer: bright major chords â€” Cmaj â†’ Gmaj â†’ Amaj â†’ Fmaj â”€â”€
  // All intervals from major scale (2,4,7,9,12 = whole, major third, fifth, sixth, octave)
  const CHORDS = [
    [noteHz(ROOT_STUDY), noteHz(ROOT_STUDY+4), noteHz(ROOT_STUDY+7), noteHz(ROOT_STUDY+12)],   // Cmaj
    [noteHz(ROOT_STUDY-5), noteHz(ROOT_STUDY-1), noteHz(ROOT_STUDY+2), noteHz(ROOT_STUDY+7)],  // Gmaj
    [noteHz(ROOT_STUDY+9), noteHz(ROOT_STUDY+13), noteHz(ROOT_STUDY+16), noteHz(ROOT_STUDY+21)], // Amaj
    [noteHz(ROOT_STUDY+5), noteHz(ROOT_STUDY+9), noteHz(ROOT_STUDY+12), noteHz(ROOT_STUDY+17)], // Fmaj
  ];
  let chordIdx = 0;
  const padGain = ctx.createGain(); padGain.gain.value = 0.0;
  padGain.connect(verb.input);
  padGain.gain.linearRampToValueAtTime(0.07, ctx.currentTime + 3.5);

  // Use gentle sine + triangle â€” NO sawtooth or square
  const pads = CHORDS[0].map((f, i) => {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.value = f;
    osc.detune.value = (Math.random() - 0.5) * 8; // tiny detune for warmth
    g.gain.value = 0.28;
    osc.connect(g); g.connect(padGain);
    osc.start();
    return osc;
  });

  // Chord change every 2 bars â€” smooth glide
  let chordTimer;
  function scheduleChordChange() {
    if (!_musicNodes || !_musicNodes.playing) return;
    chordTimer = setTimeout(() => {
      chordIdx = (chordIdx + 1) % CHORDS.length;
      const newChord = CHORDS[chordIdx];
      pads.forEach((osc, i) => {
        if (newChord[i]) osc.frequency.linearRampToValueAtTime(newChord[i], ctx.currentTime + BAR * 0.4);
      });
      scheduleChordChange();
    }, BAR * 2 * 1000);
  }
  scheduleChordChange();

  // â”€â”€ Arp melody: playful bouncy bells, major pentatonic â”€â”€
  const arpGain = ctx.createGain(); arpGain.gain.value = 0.14;
  arpGain.connect(dly.input);
  arpGain.connect(verb.input);

  // A fun, skipping pattern â€” like a xylophone in a kids' game
  const ARP_PATTERN = [0, 1, 2, 4, 3, 2, 1, 0, 2, 4, 3, 1, 0, 2, 1, 3];
  const ARP_OCTAVES = [1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 2];
  let arpStep = 0;
  // Varied rhythm â€” gives it a dancing feel
  const arpIntervals = [BEAT*0.5, BEAT*0.25, BEAT*0.5, BEAT*0.5, BEAT*0.25, BEAT*0.75, BEAT*0.5, BEAT*0.25];

  function scheduleArp() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const degree = ARP_PATTERN[arpStep % ARP_PATTERN.length];
    const oct = ARP_OCTAVES[arpStep % ARP_OCTAVES.length];
    const freq = pentatonicNote(ROOT_STUDY, degree, oct);
    if (Math.random() > 0.1) {
      pluck(ctx, arpGain, freq, 0.55, 0.2, 'sine', 0.004, 0.07, 0.25);
    }
    arpStep++;
    const dur = arpIntervals[arpStep % arpIntervals.length];
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._arpTimeout = setTimeout(scheduleArp, dur * 1000);
    }
  }
  _musicNodes._arpTimeout = setTimeout(scheduleArp, BEAT * 1.5 * 1000);

  // â”€â”€ Soft bass: gentle, round, warm â€” not deep/heavy â”€â”€
  const bassGain = ctx.createGain(); bassGain.gain.value = 0.13;
  bassGain.connect(master);

  const BASS_PATTERN = [
    { deg:0, oct:0, dur:BAR }, { deg:0, oct:0, dur:BAR*0.5 }, { deg:2, oct:0, dur:BAR*0.5 },
    { deg:3, oct:0, dur:BAR }, { deg:4, oct:0, dur:BAR },
  ];
  let bassStep = 0;
  function scheduleBass() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const note = BASS_PATTERN[bassStep % BASS_PATTERN.length];
    // Play bass one octave lower, sine wave = round and warm
    bassNote(ctx, bassGain, pentatonicNote(ROOT_STUDY, note.deg, note.oct - 1), note.dur * 0.8, 0.15);
    bassStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._bassTimeout = setTimeout(scheduleBass, note.dur * 1000);
    }
  }
  setTimeout(scheduleBass, BEAT * 3 * 1000);

  // â”€â”€ Sparkle chimes: high, bright twinkling â”€â”€
  const shimGain = ctx.createGain(); shimGain.gain.value = 0.12;
  shimGain.connect(verb.input);
  function scheduleShimmer() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const freq = pentatonicNote(ROOT_STUDY, Math.floor(Math.random()*5), 2);
    pluck(ctx, shimGain, freq, 1.2, 0.18, 'sine', 0.005, 0.04, 0.15);
    const nextIn = (2000 + Math.random() * 4000);
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._shimTimeout = setTimeout(scheduleShimmer, nextIn);
    }
  }
  setTimeout(scheduleShimmer, 4000);

  return { pads, padGain, chordTimer };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACK 2: "Brain Sprint" â€” Speed Mode
//  Tempo: 110 BPM | Key: C major pentatonic
//  Vibe: upbeat, energetic, fun â€” like a mini-game!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startSpeedTrack(ctx, master) {
  const BPM = 110;
  const BEAT = 60 / BPM;
  const BAR = BEAT * 4;

  const verb = makeReverb(ctx, 1.0, 0.18);
  verb.connect(master);
  const dly = makeDelay(ctx, BEAT * 0.5, 0.22, 0.18);
  dly.connect(verb.input);

  // â”€â”€ Bright bouncy chords â€” major, happy â”€â”€
  const PULSE_CHORDS = [
    [noteHz(ROOT_STUDY), noteHz(ROOT_STUDY+4), noteHz(ROOT_STUDY+7), noteHz(ROOT_STUDY+12)],  // Cmaj
    [noteHz(ROOT_STUDY+5), noteHz(ROOT_STUDY+9), noteHz(ROOT_STUDY+12), noteHz(ROOT_STUDY+17)], // Fmaj
    [noteHz(ROOT_STUDY+7), noteHz(ROOT_STUDY+11), noteHz(ROOT_STUDY+14), noteHz(ROOT_STUDY+19)], // Gmaj
    [noteHz(ROOT_STUDY+9), noteHz(ROOT_STUDY+13), noteHz(ROOT_STUDY+16), noteHz(ROOT_STUDY+21)], // Amaj
  ];
  let pChordIdx = 0;
  const pulseGain = ctx.createGain(); pulseGain.gain.value = 0.06;
  pulseGain.connect(verb.input);

  // Triangle waves only â€” bright but not harsh
  const pulsePads = PULSE_CHORDS[0].map((f, i) => {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = 'triangle';
    osc.frequency.value = f;
    osc.detune.value = (i % 2 === 0 ? 5 : -5);
    g.gain.value = 0.25;
    osc.connect(g); g.connect(pulseGain);
    osc.start();
    return osc;
  });

  // Gentle LFO â€” just a light wobble, not aggressive
  const lfo = ctx.createOscillator();
  const lfoGain = ctx.createGain(); lfoGain.gain.value = 4;
  lfo.frequency.value = 3;
  lfo.connect(lfoGain);
  pulsePads.forEach(o => lfoGain.connect(o.detune));
  lfo.start();

  // Chord change every 2 bars
  let pChordTimer;
  function schedPulseChord() {
    if (!_musicNodes || !_musicNodes.playing) return;
    pChordIdx = (pChordIdx + 1) % PULSE_CHORDS.length;
    const nc = PULSE_CHORDS[pChordIdx];
    pulsePads.forEach((o, i) => { if (nc[i]) o.frequency.linearRampToValueAtTime(nc[i], ctx.currentTime + 0.15); });
    pChordTimer = setTimeout(schedPulseChord, BAR * 2 * 1000);
  }
  pChordTimer = setTimeout(schedPulseChord, BAR * 2 * 1000);

  // â”€â”€ Bright staccato melody: happy, quick, playful â”€â”€
  const arpG = ctx.createGain(); arpG.gain.value = 0.18;
  arpG.connect(dly.input);
  // Major pentatonic staircase pattern â€” very "game-y" and cheerful
  const FAST_ARP = [0,1,2,3,4,3,2,1, 2,3,4,3,2,1,0,2, 1,2,3,4,3,4,3,2];
  const FAST_OCT = [1,1,1,1,1,1,1,1, 1,1,2,1,1,1,1,1, 1,1,1,2,1,2,1,1];
  let farpStep = 0;
  function scheduleFastArp() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const freq = pentatonicNote(ROOT_STUDY, FAST_ARP[farpStep % FAST_ARP.length], FAST_OCT[farpStep % FAST_OCT.length]);
    // sine for bright clean tone â€” not square (which is harsh)
    pluck(ctx, arpG, freq, BEAT*0.35, 0.18, 'sine', 0.003, 0.05, 0.12);
    farpStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._farpTimeout = setTimeout(scheduleFastArp, BEAT * 0.25 * 1000);
    }
  }
  _musicNodes._farpTimeout = setTimeout(scheduleFastArp, BEAT * 1.5 * 1000);

  // â”€â”€ Light punchy drums â€” bouncy, not heavy â”€â”€
  const drumGain = ctx.createGain(); drumGain.gain.value = 0.7; // softer overall
  drumGain.connect(master);

  function scheduleDrums() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const t = _musicBeat;
    // Kick on 1 only (not every beat â€” less heavy)
    if (t % 4 === 0) kick(ctx, drumGain, 0.22);
    // Light snare on 2 and 4
    if (t % 4 === 1 || t % 4 === 3) snare(ctx, drumGain, 0.10);
    // Hi-hats on every 8th
    hihat(ctx, drumGain, 0.04, 0.025);
    _musicBeat++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._drumTimeout = setTimeout(scheduleDrums, BEAT * 0.5 * 1000);
    }
  }
  _musicNodes._drumTimeout = setTimeout(scheduleDrums, 600);

  // â”€â”€ Bass: light and bouncy â”€â”€
  const bassG = ctx.createGain(); bassG.gain.value = 0.14;
  bassG.connect(master);
  const SPEED_BASS = [0,0,2,0, 3,3,2,3, 4,4,2,4, 2,2,0,2];
  let sbStep = 0;
  function schedSpeedBass() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const deg = SPEED_BASS[sbStep % SPEED_BASS.length];
    bassNote(ctx, bassG, pentatonicNote(ROOT_STUDY, deg, 0), BEAT * 0.4, 0.17);
    sbStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._sbTimeout = setTimeout(schedSpeedBass, BEAT * 0.5 * 1000);
    }
  }
  _musicNodes._sbTimeout = setTimeout(schedSpeedBass, 800);

  return { pulsePads, lfo, pulseGain };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TRACK 3: "Math Battle!" â€” Duel Mode
//  Tempo: 118 BPM | Key: G major pentatonic
//  Vibe: exciting, competitive, fun â€” like a game show!
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startDuelTrack(ctx, master) {
  const BPM = 118;
  const BEAT = 60 / BPM;
  const BAR = BEAT * 4;

  const verb = makeReverb(ctx, 1.2, 0.2);
  verb.connect(master);
  const dly = makeDelay(ctx, BEAT * 0.375, 0.3, 0.22);
  dly.connect(verb.input);

  // â”€â”€ Bright energetic chords â€” all major, all happy â”€â”€
  // G major pentatonic: G A B D E
  const DUEL_CHORDS = [
    [noteHz(ROOT_DUEL), noteHz(ROOT_DUEL+4), noteHz(ROOT_DUEL+7), noteHz(ROOT_DUEL+12)],    // Gmaj
    [noteHz(ROOT_DUEL+5), noteHz(ROOT_DUEL+9), noteHz(ROOT_DUEL+12), noteHz(ROOT_DUEL+16)], // Cmaj
    [noteHz(ROOT_DUEL+7), noteHz(ROOT_DUEL+11), noteHz(ROOT_DUEL+14), noteHz(ROOT_DUEL+19)], // Dmaj
    [noteHz(ROOT_DUEL+9), noteHz(ROOT_DUEL+13), noteHz(ROOT_DUEL+16), noteHz(ROOT_DUEL+21)], // Emaj
  ];
  let dChordIdx = 0;

  const duelPadGain = ctx.createGain(); duelPadGain.gain.value = 0.0;
  duelPadGain.connect(verb.input);
  duelPadGain.gain.linearRampToValueAtTime(0.07, ctx.currentTime + 1.5);

  // Triangle waves for brightness without harshness
  const duelPads = DUEL_CHORDS[0].map((f, i) => {
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.type = 'triangle';
    osc.frequency.value = f;
    osc.detune.value = i % 2 === 0 ? 6 : -6;
    g.gain.value = 0.25;
    osc.connect(g); g.connect(duelPadGain);
    osc.start();
    return osc;
  });

  // Chord stab â€” bright punchy with positive energy
  function schedStabs() {
    if (!_musicNodes || !_musicNodes.playing) return;
    dChordIdx = (dChordIdx + 1) % DUEL_CHORDS.length;
    const nc = DUEL_CHORDS[dChordIdx];
    duelPads.forEach((o, i) => { if (nc[i]) o.frequency.setValueAtTime(nc[i], ctx.currentTime); });
    // Quick bright pop, not a dark slam
    duelPadGain.gain.cancelScheduledValues(ctx.currentTime);
    duelPadGain.gain.setValueAtTime(0.10, ctx.currentTime);
    duelPadGain.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + BEAT * 0.6);
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._stabTimeout = setTimeout(schedStabs, BAR * 1000);
    }
  }
  _musicNodes._stabTimeout = setTimeout(schedStabs, BAR * 1000);

  // â”€â”€ Lead melody: fast, catchy, upbeat game-show energy â”€â”€
  const leadGain = ctx.createGain(); leadGain.gain.value = 0.20;
  leadGain.connect(dly.input);
  const DUEL_MELODY = [
    {deg:0,oct:1,dur:BEAT*0.5}, {deg:2,oct:1,dur:BEAT*0.25}, {deg:4,oct:1,dur:BEAT*0.25},
    {deg:3,oct:1,dur:BEAT*0.5}, {deg:4,oct:1,dur:BEAT*0.5},
    {deg:2,oct:2,dur:BEAT*0.5}, {deg:4,oct:1,dur:BEAT*0.25}, {deg:3,oct:1,dur:BEAT*0.25},
    {deg:1,oct:1,dur:BEAT*0.5}, {deg:0,oct:1,dur:BEAT*0.25}, {deg:2,oct:1,dur:BEAT*0.25},
    {deg:4,oct:1,dur:BEAT*0.5}, {deg:3,oct:1,dur:BEAT*0.25}, {deg:2,oct:2,dur:BEAT*0.25},
    {deg:0,oct:2,dur:BEAT*0.75}, {deg:4,oct:1,dur:BEAT*0.25},
  ];
  let mStep = 0;
  function schedLead() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const note = DUEL_MELODY[mStep % DUEL_MELODY.length];
    const freq = pentatonicNote(ROOT_DUEL, note.deg, note.oct);
    // sine wave lead â€” bright and clean
    pluck(ctx, leadGain, freq, note.dur * 0.85, 0.22, 'sine', 0.004, 0.08, 0.35);
    mStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._leadTimeout = setTimeout(schedLead, note.dur * 1000);
    }
  }
  _musicNodes._leadTimeout = setTimeout(schedLead, BEAT * 3 * 1000);

  // â”€â”€ Counter-melody: bright chime response â”€â”€
  const ctGain = ctx.createGain(); ctGain.gain.value = 0.13;
  ctGain.connect(verb.input);
  const CT_MELODY = [
    {deg:4,oct:1,dur:BEAT},{deg:3,oct:1,dur:BEAT},{deg:2,oct:1,dur:BEAT*0.5},{deg:4,oct:1,dur:BEAT*0.5},
    {deg:0,oct:2,dur:BAR},{deg:4,oct:1,dur:BEAT},{deg:2,oct:1,dur:BEAT},{deg:0,oct:1,dur:BEAT*2},
  ];
  let ctStep = 0;
  function schedCounter() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const note = CT_MELODY[ctStep % CT_MELODY.length];
    pluck(ctx, ctGain, pentatonicNote(ROOT_DUEL, note.deg, note.oct), note.dur * 0.8, 0.14, 'sine', 0.008, 0.07, 0.25);
    ctStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._ctTimeout = setTimeout(schedCounter, note.dur * 1000);
    }
  }
  _musicNodes._ctTimeout = setTimeout(schedCounter, BEAT * 7 * 1000);

  // â”€â”€ Drums: fun and bouncy, not heavy â”€â”€
  const drumG = ctx.createGain(); drumG.gain.value = 0.75;
  drumG.connect(master);
  // More swing, less stomp â€” like a friendly game show rhythm
  const DRUM_PAT = ['K','.','H','.','S','.','H','H','K','.','H','.','S','.','H','.'];
  let dStep = 0;
  function schedDuelDrums() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const hit = DRUM_PAT[dStep % DRUM_PAT.length];
    if (hit === 'K') kick(ctx, drumG, 0.24);
    else if (hit === 'S') snare(ctx, drumG, 0.12);
    else if (hit === 'H') hihat(ctx, drumG, 0.055, 0.022);
    dStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._duelDrumTimeout = setTimeout(schedDuelDrums, BEAT * 0.25 * 1000);
    }
  }
  _musicNodes._duelDrumTimeout = setTimeout(schedDuelDrums, 400);

  // â”€â”€ Bouncy bass: root notes, bright register â”€â”€
  const bassG = ctx.createGain(); bassG.gain.value = 0.16;
  bassG.connect(master);
  const DUEL_BASS = [0,0,2,0, 3,3,2,3, 4,4,2,4, 2,0,2,4];
  let dbStep = 0;
  function schedDuelBass() {
    if (!_musicNodes || !_musicNodes.playing) return;
    const deg = DUEL_BASS[dbStep % DUEL_BASS.length];
    // Slightly higher register than before â€” less ominous
    bassNote(ctx, bassG, pentatonicNote(ROOT_DUEL, deg, 0), BEAT * 0.38, 0.18);
    dbStep++;
    if (_musicNodes && _musicNodes.playing) {
      _musicNodes._duelBassTimeout = setTimeout(schedDuelBass, BEAT * 0.5 * 1000);
    }
  }
  _musicNodes._duelBassTimeout = setTimeout(schedDuelBass, 700);

  return { duelPads, duelPadGain };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MASTER MUSIC CONTROLLER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startMusic(track = 'study') {
  if (!S.settings.sound || !_musicEnabled) return;
  if (_musicNodes && _musicNodes.track === track) return; // already playing this track
  stopMusic(false); // stop cleanly, then start new
  setTimeout(() => _startMusicInternal(track), _musicNodes ? 2200 : 0);
}

function _startMusicInternal(track) {
  try {
    const ctx = getAudioCtx();
    const limiter = makeLimiter(ctx);
    const master = ctx.createGain();
    master.gain.setValueAtTime(0, ctx.currentTime);
    master.gain.linearRampToValueAtTime(track === 'study' ? 0.55 : track === 'speed' ? 0.65 : 0.58, ctx.currentTime + 2.5);
    master.connect(limiter);

    _musicBeat = 0;
    _musicNodes = { ctx, master, limiter, playing: true, track };

    if (track === 'study') startStudyTrack(ctx, master);
    else if (track === 'speed') startSpeedTrack(ctx, master);
    else if (track === 'duel') startDuelTrack(ctx, master);

  } catch(e) { console.error('Music error:', e); }
}

function stopMusic(fade = true) {
  if (!_musicNodes) return;
  _musicNodes.playing = false;
  // Clear all scheduled timeouts
  const keys = ['_arpTimeout','_bassTimeout','_shimTimeout','_farpTimeout','_drumTimeout',
    '_sbTimeout','_stabTimeout','_leadTimeout','_ctTimeout','_duelDrumTimeout','_duelBassTimeout'];
  keys.forEach(k => { if (_musicNodes[k]) clearTimeout(_musicNodes[k]); });
  // Fade out master
  try {
    if (fade) {
      _musicNodes.master.gain.linearRampToValueAtTime(0, getAudioCtx().currentTime + 2);
    } else {
      _musicNodes.master.gain.setValueAtTime(0, getAudioCtx().currentTime);
    }
  } catch(e) {}
  const old = _musicNodes;
  _musicNodes = null;
}

// â”€â”€ Public wrappers (keep existing API working) â”€â”€
function startAmbientMusic() { startMusic('study'); }
function stopAmbientMusic()  { stopMusic(true); }

function startDuelMusic()    { startMusic('duel'); }
function stopDuelMusic()     { stopMusic(true); }

function startSpeedMusic()   { startMusic('speed'); }

function toggleMusic() {
  _musicEnabled = !_musicEnabled;
  const btn = document.getElementById('panel-music-btn');
  const tbBtn = document.getElementById('music-toolbar-btn');
  if (_musicEnabled) {
    if (btn) btn.innerHTML = 'ðŸŽµ Music: ON';
    if (tbBtn) { tbBtn.innerHTML = 'ðŸŽµ'; tbBtn.classList.remove('music-off'); }
    // Resume the right track based on context
    const currentPage = document.querySelector('.page.active');
    const pageId = currentPage ? currentPage.id : '';
    const duelArenaVisible = document.getElementById('duel-arena') && document.getElementById('duel-arena').classList.contains('show');
    if (duelArenaVisible) startMusic('duel');
    else if (S.mode === 'speed') startMusic('speed');
    else if (pageId === 'page-study') startMusic('study');
  } else {
    if (btn) btn.innerHTML = 'ðŸ”‡ Music: OFF';
    if (tbBtn) { tbBtn.innerHTML = 'ðŸ”‡'; tbBtn.classList.add('music-off'); }
    stopMusic(true);
  }
}

// Compatibility wrapper (old code calls playSound)
function playSound(correct) {
  if (correct) soundCorrect(); else soundWrong();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  XP POPUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnXP(txt, color='#06d6a0') {
  const el=document.createElement('div'); el.className='xp-pop';
  el.textContent=txt; el.style.color=color;
  el.style.left=(Math.random()*50+25)+'%'; el.style.top='80px';
  document.body.appendChild(el); setTimeout(()=>el.remove(),1400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACHIEVEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAchievements() {
  for (const a of ACHIEVEMENTS) {
    if (!S.earned.has(a.id) && a.check(S)) {
      S.earned.add(a.id);
      soundAchievement();
      document.getElementById('toast-name2').textContent=a.icon+' '+a.name;
      document.getElementById('toast-desc2').textContent=a.desc;
      const t=document.getElementById('ach-toast');
      t.classList.add('show');
      spawnXP('+50 XP ðŸ… Achievement!','#c77dff'); S.xp+=50; S.sessionXP+=50;
      if(S.settings.confetti)launchConfetti();
      setTimeout(()=>t.classList.remove('show'),3500);
      saveState();
    }
  }
}

function launchConfetti() {
  for (let i=0; i<30; i++) {
    const el=document.createElement('div');
    const colors=['#ff6b35','#ffd166','#06d6a0','#118ab2','#c77dff','#f72585'];
    el.style.cssText=`position:fixed;width:8px;height:8px;border-radius:2px;background:${colors[Math.floor(Math.random()*colors.length)]};left:${Math.random()*100}%;top:60px;z-index:999;pointer-events:none;animation:confettiFall ${0.8+Math.random()*1.2}s ease forwards;`;
    document.body.appendChild(el);
    setTimeout(()=>el.remove(),2500);
  }
}
// Add confetti keyframes dynamically
const confettiStyle=document.createElement('style');
confettiStyle.textContent='@keyframes confettiFall{0%{transform:translateY(0) rotate(0);opacity:1}100%{transform:translateY(80vh) rotate(720deg);opacity:0}}';
document.head.appendChild(confettiStyle);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showHint() {
  S.hintUsed=true;
  const ht=document.getElementById('hint-text'), btn=document.getElementById('hint-btn');
  if(ht.style.display==='none'||ht.style.display===''){ht.style.display='block';btn.textContent='ðŸ™ˆ Hide Hint';}
  else{ht.style.display='none';btn.textContent='ðŸ’¡ Hint';}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nextQ() { loadQ(); }
function skipQ() {
  if (S.answered) { loadQ(); return; }
  // Counts as wrong, then loads next
  S.answered = true;
  if (S.speedInterval) { clearInterval(S.speedInterval); S.speedInterval = null; }
  S.lastCorrect = false;
  S.lastTime = 0;
  updateScore(false);
  loadQ();
}

function toggleMode() {
  S.mode=S.mode==='normal'?'speed':'normal';
  document.getElementById('mode-btn').textContent=S.mode==='speed'?'âš¡ Speed Mode':'ðŸŽ¯ Normal Mode';
  document.getElementById('mode-btn').classList.toggle('active-tool',S.mode==='speed');
  const pb=document.getElementById('panel-mode-btn');
  if(pb){ pb.textContent=S.mode==='speed'?'âš¡ Speed Mode':'ðŸŽ¯ Normal Mode'; pb.classList.toggle('active-tool',S.mode==='speed'); }
  // Switch music track to match mode
  if (_musicEnabled) {
    if (S.mode === 'speed') startMusic('speed');
    else startMusic('study');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WRONG REVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateWrongReview() {
  if (S.wrongLog.length===0) return;
  const sec=document.getElementById('review-section'), list=document.getElementById('wrong-list');
  sec.style.display='block'; list.innerHTML='';
  const recent=S.wrongLog.slice(-5);
  recent.reverse().forEach(item=>{
    const d=document.createElement('div'); d.className='wrong-item';
    d.innerHTML=`<div class="wrong-q">${item.q.text.replace(/\n/g,' ').slice(0,80)}...</div>
      <div class="wrong-a">âœ… Correct answer: <span class="wrong-correct">${item.q.type==='free'?item.q.ans:item.q.opts[item.q.ans]}</span></div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:4px;">${item.q.hint}</div>`;
    list.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id) { document.getElementById(id).style.display='block'; }
function closeModal(id) { document.getElementById(id).style.display='none'; }
function openMorePanel() {
  document.getElementById('more-panel').classList.add('open');
  document.getElementById('more-panel-overlay').classList.add('open');
}
function closeMorePanel() {
  document.getElementById('more-panel').classList.remove('open');
  document.getElementById('more-panel-overlay').classList.remove('open');
}
function openProModal() { document.getElementById('pro-modal').classList.add('show'); }
function closeProModal() { document.getElementById('pro-modal').classList.remove('show'); }
function showComingSoon() {
  closeProModal();
  uiAlert('Payments are coming soon! Pro features are in development. Thank you for your interest!', 'ðŸ’³', 'Coming Soon');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshDashboard() {
  document.getElementById('dash-name').textContent = S.username||'Student';
  document.getElementById('dash-level-badge').textContent = `LVL ${S.level}`;
  const acc = S.total>0?Math.round(S.correct/S.total*100):0;
  document.getElementById('dash-subtitle').textContent = `Level ${S.level} Â· ${acc}% accuracy Â· ${S.dayStreak} day streak`;
  document.getElementById('daily-tip').textContent = TIPS[new Date().getDate()%TIPS.length];

  const grid=document.getElementById('dash-stats-grid');
  const stats=[
    {icon:'â­',num:S.xp,label:'Total XP',color:'#ffd166'},
    {icon:'âœ…',num:S.correct,label:'Correct',color:'#06d6a0'},
    {icon:'ðŸŽ¯',num:acc+'%',label:'Accuracy',color:'#c77dff'},
    {icon:'ðŸ”¥',num:S.dayStreak,label:'Day Streak',color:'#ff6b35'},
    {icon:'âš¡',num:S.bestStreak,label:'Best Streak',color:'#118ab2'},
    {icon:'ðŸ“š',num:S.total,label:'Total Solved',color:'#f72585'},
  ];
  grid.innerHTML=stats.map(s=>`<div class="dash-card"><span class="dc-icon">${s.icon}</span><div class="dc-num" style="color:${s.color}">${s.num}</div><div class="dc-label">${s.label}</div></div>`).join('');

  // Activity grid (last 28 days)
  const agrid=document.getElementById('activity-grid');
  agrid.innerHTML='';
  for(let i=27;i>=0;i--){
    const d=new Date(Date.now()-i*86400000).toISOString().slice(0,10);
    const count=S.activityLog[d]||0;
    const cls=count===0?'act-0':count<5?'act-1':count<10?'act-2':count<20?'act-3':'act-4';
    const cell=document.createElement('div'); cell.className=`act-cell ${cls}`;
    cell.title=`${d}: ${count} questions`;
    // Show count directly on the cell â€” visible without hover
    if(count>0) cell.textContent = count>99?'99+':count;
    agrid.appendChild(cell);
  }

  // Week row
  const week=document.getElementById('week-row');
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const today=new Date().getDay();
  week.innerHTML='';
  for(let i=6;i>=0;i--){
    const d=new Date(Date.now()-i*86400000);
    const key=d.toISOString().slice(0,10);
    const isToday=i===0;
    const hasDone=(S.activityLog[key]||0)>0;
    const dot=document.createElement('div');
    dot.className='day-dot '+(isToday?'day-today':hasDone?'day-done':'day-missed');
    dot.textContent=days[d.getDay()];
    week.appendChild(dot);
  }
  const streakMessages = [
    `ðŸ”¥ ${S.dayStreak} days in a row. Don't stop now.`,
    `ðŸ”¥ ${S.dayStreak}-day streak. You're actually doing it.`,
    `ðŸ”¥ ${S.dayStreak} days straight. Respect.`,
  ];
  document.getElementById('streak-msg').textContent = S.dayStreak>0
    ? streakMessages[S.dayStreak % streakMessages.length]
    : "Open the app today to start your streak. It's worth it.";

  // Goals preview
  const dg=document.getElementById('dash-goals');
  dg.innerHTML='';
  const active=S.goals.filter(g=>!g.done).slice(0,3);
  if(active.length===0){dg.innerHTML='<p style="color:var(--muted);font-size:0.8rem;">No active goals. <button onclick="showPage(\'goals\')" style="background:none;border:none;color:var(--accent);cursor:pointer;font-family:Nunito,sans-serif;font-weight:700;">Set one now â†’</button></p>';}
  active.forEach(g=>{
    const pct=Math.min(getGoalProgress(g)/g.target*100,100).toFixed(0);
    const div=document.createElement('div'); div.className='goal-card';
    div.innerHTML=`<div class="goal-header"><div class="goal-title">${g.title}</div><div class="goal-pct">${pct}%</div></div>
      <div class="goal-bar-wrap"><div class="goal-bar-fill" style="width:${pct}%;background:${TC[g.type]||'var(--accent)'}"></div></div>
      <div class="goal-sub">${getGoalProgress(g)} / ${g.target} ${g.type}</div>`;
    dg.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROGRESS PAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function progressTab(el,id) {
  ['prog-accuracy','prog-history','prog-review','prog-ach'].forEach(i=>document.getElementById(i).style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.tab-pill').forEach(b=>b.classList.remove('active'));
  el.classList.add('active');
  if(id==='prog-accuracy')buildAccuracyBars();
  if(id==='prog-history')buildHistory();
  if(id==='prog-review')buildWrongReview();
  if(id==='prog-ach')buildAchGrid();
}

function refreshProgress() { buildAccuracyBars(); }

function buildAccuracyBars() {
  const bars=document.getElementById('topic-acc-bars');
  bars.innerHTML='';
  for(const[k,v]of Object.entries(TL)){
    const att=S.tCount[k]||0,cor=S.tCorrect[k]||0;
    const pct=att>0?Math.round(cor/att*100):0;
    const row=document.createElement('div'); row.className='topic-bar-row';
    row.innerHTML=`<div class="tb-label">${v}</div>
      <div class="tb-bar-wrap"><div class="tb-bar-fill" style="width:${pct}%;background:${TC[k]}"></div></div>
      <div class="tb-pct">${att>0?pct+'%':'--'}</div>`;
    bars.appendChild(row);
  }

  const speed=document.getElementById('speed-analysis');
  speed.innerHTML='';
  for(const[k,v]of Object.entries(TL)){
    const times=S.tTimes[k]||[];
    const avg=times.length>0?(times.reduce((a,b)=>a+b,0)/times.length).toFixed(1):'--';
    const div=document.createElement('div'); div.style.cssText='display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border);font-size:0.8rem;';
    div.innerHTML=`<span>${v}</span><span style="font-family:Space Mono,monospace;color:var(--a2);">${avg==='--'?'Not attempted':avg+'s avg'}</span>`;
    speed.appendChild(div);
  }
}

function buildHistory() {
  const list=document.getElementById('history-list'); list.innerHTML='';
  if(S.history.length===0){list.innerHTML='<p style="color:var(--muted);font-size:0.8rem;">No session history yet. Keep studying!</p>';return;}
  S.history.slice(0,20).forEach(h=>{
    const item=document.createElement('div'); item.className='hist-item';
    const acc=h.total>0?Math.round(h.correct/h.total*100):0;
    item.innerHTML=`<div><div style="font-weight:700;font-size:0.82rem;">${h.topic}</div><div style="color:var(--muted);font-size:0.7rem;">${h.date}</div></div>
      <div class="hist-correct">${h.correct}/${h.total} (${acc}%)</div>
      <div style="color:var(--a5);font-size:0.72rem;font-family:Space Mono,monospace;">+${h.xp||0} XP</div>`;
    list.appendChild(item);
  });
}

function buildWrongReview() {
  const list=document.getElementById('prog-wrong-list'); list.innerHTML='';
  if(S.wrongLog.length===0){list.innerHTML='<p style="color:var(--muted);">No wrong answers logged yet! ðŸŽ‰</p>';return;}
  [...S.wrongLog].reverse().slice(0,20).forEach(item=>{
    const d=document.createElement('div'); d.className='wrong-item';
    d.innerHTML=`<div class="wrong-q">${item.q.text.replace(/\n/g,' ')}</div>
      <div class="wrong-a">âœ… Answer: <span class="wrong-correct">${item.q.type==='free'?item.q.ans:item.q.opts[item.q.ans]}</span></div>
      <div style="font-size:0.72rem;color:var(--muted);margin-top:4px;">ðŸ’¡ ${item.q.hint}</div>
      <div style="font-size:0.72rem;margin-top:4px;color:var(--a3);">${(item.q.steps||[]).slice(0,2).join(' â†’ ')}</div>`;
    d.onclick=()=>d.querySelector('.wrong-a').style.display='block';
    list.appendChild(d);
  });
}

function buildAchGrid() {
  const grid=document.getElementById('ach-grid'); grid.innerHTML='';
  document.getElementById('ach-count').textContent=[...S.earned].length;
  document.getElementById('ach-total').textContent=ACHIEVEMENTS.length;
  ACHIEVEMENTS.forEach(a=>{
    const earned=S.earned.has(a.id);
    const c=document.createElement('div'); c.className='ach-card'+(earned?' earned':'');
    c.innerHTML=`<div class="ach-icon" style="${earned?'':'filter:grayscale(1) opacity(0.3)'}">${a.icon}</div><div class="ach-name">${a.name}</div><div class="ach-desc">${a.desc}</div>`;
    grid.appendChild(c);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getGoalProgress(g) {
  switch(g.type){
    case 'questions': return S.total;
    case 'correct': return S.correct;
    case 'xp': return S.xp;
    case 'streak': return S.dayStreak;
    case 'topic': {
      let best=0;
      for(const k of Object.keys(S.tCount)){
        const att=S.tCount[k]||0,cor=S.tCorrect[k]||0;
        if(att>=5)best=Math.max(best,Math.round(cor/att*100));
      }
      return best;
    }
    default: return 0;
  }
}

function updateGoalProgress() {
  let changed=false;
  S.goals.forEach(g=>{
    if(g.done)return;
    const prog=getGoalProgress(g);
    if(prog>=g.target){
      g.done=true; S.goalsCompleted++;
      spawnXP('+200 XP ðŸŽ¯ Goal Complete!','#ffd166');
      S.xp+=200; changed=true;
      checkAchievements();
    }
  });
  if(changed)saveState();
}

function addGoal() {
  const title=document.getElementById('goal-title-in').value.trim();
  const type=document.getElementById('goal-type-in').value;
  const target=parseInt(document.getElementById('goal-target-in').value);
  if(!title||!target||target<1){uiAlert('Please fill in all fields!','âš ï¸','Missing Info');return;}
  S.goals.push({id:Date.now(),title,type,target,done:false,created:new Date().toISOString()});
  document.getElementById('goal-title-in').value='';
  document.getElementById('goal-target-in').value='';
  saveState(); refreshGoals();
}

function refreshGoals() {
  const active=document.getElementById('goals-list'), done=document.getElementById('goals-done');
  active.innerHTML=''; done.innerHTML='';
  const activeg=S.goals.filter(g=>!g.done), doneg=S.goals.filter(g=>g.done);
  if(activeg.length===0)active.innerHTML='<p style="color:var(--muted);font-size:0.8rem;">No active goals. Add one above!</p>';
  activeg.forEach(g=>{
    const pct=Math.min(Math.round(getGoalProgress(g)/g.target*100),100);
    const div=document.createElement('div'); div.className='goal-item';
    div.innerHTML=`<button class="goal-del" onclick="deleteGoal(${g.id})">âœ•</button>
      <div class="goal-item-header"><div class="goal-item-title">${g.title}</div><span class="goal-badge gb-active">Active</span></div>
      <div class="goal-bar-wrap"><div class="goal-bar-fill" style="width:${pct}%;background:var(--accent)"></div></div>
      <div class="goal-sub">${getGoalProgress(g)} / ${g.target} Â· ${g.type} Â· ${pct}% complete</div>`;
    active.appendChild(div);
  });
  if(doneg.length===0)done.innerHTML='<p style="color:var(--muted);font-size:0.8rem;">Complete a goal to see it here!</p>';
  doneg.forEach(g=>{
    const div=document.createElement('div'); div.className='goal-item';
    div.innerHTML=`<div class="goal-item-header"><div class="goal-item-title">âœ… ${g.title}</div><span class="goal-badge gb-done">Done!</span></div>
      <div class="goal-sub">${g.type} Â· Completed</div>`;
    done.appendChild(div);
  });
}

function deleteGoal(id) {
  S.goals=S.goals.filter(g=>g.id!==id);
  saveState(); refreshGoals();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEADERBOARD (simulated)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLeaderboard() {
  const fakeUsers=[
    {name:'Aria K.',     xp:2840, icon:'ðŸ¦'},
    {name:'Marcus T.',   xp:2310, icon:'ðŸ¦Š'},
    {name:'Priya S.',    xp:1980, icon:'ðŸ¯'},
    {name:'Ethan R.',    xp:1640, icon:'ðŸ¬'},
    {name:'Sofia M.',    xp:1420, icon:'ðŸ¦„'},
    {name:'James L.',    xp:1100, icon:'ðŸ‰'},
    {name:'Nadia B.',    xp:890,  icon:'ðŸ¦‹'},
    {name:'Tyler H.',    xp:650,  icon:'ðŸ¦…'},
  ];
  const all=[...fakeUsers,{name:S.username||'You',xp:S.xp,icon:'â­',isMe:true}];
  all.sort((a,b)=>b.xp-a.xp);
  const list=document.getElementById('lb-list'); list.innerHTML='';
  all.forEach((u,i)=>{
    const row=document.createElement('div');
    row.className='lb-row'+(u.isMe?' lb-me':'');
    const rankCls=i===0?'gold':i===1?'silver':i===2?'bronze':'';
    const rankIcon=i===0?'ðŸ¥‡':i===1?'ðŸ¥ˆ':i===2?'ðŸ¥‰':i+1;
    row.innerHTML=`<div class="lb-rank ${rankCls}">${rankIcon}</div>
      <div class="lb-avatar" style="background:${['#ff6b35','#ffd166','#06d6a0','#118ab2','#c77dff','#f72585'][i%6]}22;">${u.icon}</div>
      <div class="lb-name">${u.name}${u.isMe?' (You)':''}</div>
      <div class="lb-xp">${u.xp} XP</div>`;
    list.appendChild(row);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function refreshSettings() {
  const s=S.settings;
  document.getElementById('light-toggle').className='toggle'+(s.lightMode?' on':'');
  document.getElementById('sound-toggle').className='toggle'+(s.sound?' on':'');
  document.getElementById('confetti-toggle').className='toggle'+(s.confetti?' on':'');
  document.getElementById('goal-select').value=s.sessionGoal;
  document.getElementById('speed-timer-select').value=s.speedTimer;
  document.getElementById('current-name-display').textContent='Currently: '+S.username;
}

function toggleLight() {
  S.settings.lightMode=!S.settings.lightMode;
  document.body.classList.toggle('light-mode',S.settings.lightMode);
  document.getElementById('theme-btn').textContent=S.settings.lightMode?'ðŸŒ™':'â˜€ï¸';
  document.getElementById('light-toggle').className='toggle'+(S.settings.lightMode?' on':'');
  saveState();
}

function toggleSetting(key) {
  S.settings[key]=!S.settings[key];
  document.getElementById(key+'-toggle').className='toggle'+(S.settings[key]?' on':'');
  saveState();
}

function updateSessionGoal() {
  S.settings.sessionGoal=parseInt(document.getElementById('goal-select').value);
  saveState();
}

function saveSettings() {
  S.settings.speedTimer=parseInt(document.getElementById('speed-timer-select').value);
  saveState();
}

async function changeName() {
  const n = await uiPrompt('Enter your new display name:', S.username, 'New name...', 'âœï¸', 'Change Name');
  if (n === null) return; // cancelled
  const trimmed = n.trim().slice(0,20);
  if (!trimmed) { uiAlert('Name cannot be empty!', 'âš ï¸', 'Invalid Name'); return; }
  S.username = trimmed;
  document.getElementById('current-name-display').textContent = 'Currently: ' + S.username;
  refreshDashboard();
  saveState();
}

function exportData() {
  const data=JSON.stringify({username:S.username,xp:S.xp,correct:S.correct,total:S.total,level:S.level,achievements:[...S.earned],exportDate:new Date().toISOString()},null,2);
  const a=document.createElement('a');
  a.href='data:application/json,'+encodeURIComponent(data);
  a.download='numiqube_progress.json'; a.click();
}

async function resetData() {
  if(await uiConfirm('Really delete ALL progress? This cannot be undone!', 'ðŸ—‘ï¸', 'Reset All Data', 'Yes, delete everything')){
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KEYBOARD SHORTCUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('keydown',e=>{
  if(document.getElementById('page-study').style.display==='none'&&!document.getElementById('page-study').classList.contains('active'))return;
  if(document.activeElement===document.getElementById('free-input'))return;
  if(e.target.tagName==='INPUT'||e.target.tagName==='SELECT'||e.target.tagName==='TEXTAREA')return;
  const map={'1':0,'2':1,'3':2,'4':3,'a':0,'b':1,'c':2,'d':3};
  if(map[e.key.toLowerCase()]!==undefined&&!S.answered){
    const btns=document.querySelectorAll('.opt-btn');
    if(btns[map[e.key.toLowerCase()]])btns[map[e.key.toLowerCase()]].click();
  }
  if((e.key==='Enter'||e.key===' ')&&S.answered){e.preventDefault();const nb=document.getElementById('next-btn');if(nb.style.display!=='none')nb.click();}
  if(e.key.toLowerCase()==='h')showHint();
  if(e.key.toLowerCase()==='r')shuffleTopic();
  if(e.key==='Escape'){document.querySelectorAll('.modal-overlay').forEach(m=>m.style.display='none');}
});

// Close modals on outside click
document.querySelectorAll('.modal-overlay').forEach(m=>{
  m.addEventListener('click',e=>{if(e.target===m)m.style.display='none';});
});
document.getElementById('pro-modal').addEventListener('click',e=>{
  if(e.target===document.getElementById('pro-modal'))closeProModal();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FRIENDS & LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _lbTab = 'xp';
let _friendsData = [];
let _pendingRequests = [];

function generateFriendCode(uid) {
  // Derive a STABLE, UNIQUE code from the Firebase UID
  // This means the same user always gets the same code
  const words = ['MATH','CALC','QUAD','GEOM','PROB','ALGE','STAT','NUMQ','TRIG','CUBE'];
  // Hash the UID into a consistent index
  let hash = 0;
  for (let i = 0; i < uid.length; i++) {
    hash = ((hash << 5) - hash) + uid.charCodeAt(i);
    hash |= 0; // Convert to 32bit int
  }
  const absHash = Math.abs(hash);
  const w = words[absHash % words.length];
  // Use last 4 digits derived from UID for the number part
  const n = 1000 + (absHash % 9000);
  return `${w}-${n}`;
}

async function ensureFriendCode() {
  if (!currentUser) return;
  const ref = db.collection('users').doc(currentUser.uid);
  const doc = await ref.get();
  // Always regenerate from UID to fix old random codes
  const code = generateFriendCode(currentUser.uid);
  if (!doc.exists || !doc.data().friendCode || doc.data().friendCode !== code) {
    // Only set fields that DON'T already exist â€” never overwrite friends/pendingIn
    const updates = { friendCode: code, username: S.username, xp: S.xp, dayStreak: S.dayStreak, weeklyXP: S.sessionXP || 0, photoURL: currentUser.photoURL || '' };
    if (!doc.exists) {
      updates.friends = [];
      updates.pendingIn = [];
      updates.pendingOut = [];
    }
    await ref.set(updates, { merge: true });
  }
  return code;
}

async function refreshFriends() {
  if (!currentUser) {
    document.getElementById('friends-guest-msg').style.display = 'block';
    document.getElementById('friends-content').style.display = 'none';
    return;
  }
  document.getElementById('friends-guest-msg').style.display = 'none';
  document.getElementById('friends-content').style.display = 'block';

  // Ensure user has a friend code
  const code = await ensureFriendCode();
  document.getElementById('my-friend-code').textContent = code || '...';

  // Sync latest stats to Firebase
  await db.collection('users').doc(currentUser.uid).set({
    username: S.username, xp: S.xp, dayStreak: S.dayStreak,
    photoURL: currentUser.photoURL || '', updatedAt: Date.now(), lastSeen: Date.now()
  }, { merge: true });

  // Load user doc
  const myDoc = await db.collection('users').doc(currentUser.uid).get();
  const myData = myDoc.data() || {};
  const friendIds = myData.friends || [];
  const pendingIn = myData.pendingIn || [];

  // Pending requests
  _pendingRequests = [];
  for (const uid of pendingIn) {
    const d = await db.collection('users').doc(uid).get();
    if (d.exists) _pendingRequests.push({ uid, ...d.data() });
  }
  renderFriendRequests();

  // Friends list + leaderboard data
  _friendsData = [];
  for (const uid of friendIds) {
    const d = await db.collection('users').doc(uid).get();
    if (d.exists) _friendsData.push({ uid, ...d.data() });
  }
  // Add self to leaderboard
  _friendsData.push({ uid: currentUser.uid, username: S.username, xp: S.xp, dayStreak: S.dayStreak, weeklyXP: S.sessionXP || 0, photoURL: currentUser.photoURL || '', isMe: true });

  renderFriendsList(friendIds);
  renderLeaderboard();
}

function renderFriendRequests() {
  const list = document.getElementById('friend-requests-list');
  const title = document.getElementById('requests-title');
  const badge = document.getElementById('req-badge');
  const badgeInline = document.getElementById('req-badge-inline');

  if (_pendingRequests.length === 0) {
    title.style.display = 'none';
    list.innerHTML = '';
    badge.style.display = 'none';
    return;
  }
  title.style.display = 'block';
  badge.style.display = 'inline';
  if (badgeInline) { badgeInline.style.display = 'inline'; badgeInline.textContent = _pendingRequests.length; }
  badge.textContent = _pendingRequests.length;

  list.innerHTML = _pendingRequests.map(u => `
    <div class="friend-item">
      <div class="friend-avatar">${u.photoURL ? `<img src="${u.photoURL}"/>` : 'ðŸ‘¤'}</div>
      <div style="flex:1;">
        <div class="friend-name">${u.username || 'Unknown'}</div>
        <div class="friend-sub">${u.xp || 0} XP Â· ${u.dayStreak || 0} day streak</div>
      </div>
      <button class="friend-action-btn accept" onclick="acceptFriend('${u.uid}')">âœ“ Accept</button>
      <button class="friend-action-btn decline" onclick="declineFriend('${u.uid}')">âœ•</button>
    </div>`).join('');
}

function renderFriendsList(friendIds) {
  const list = document.getElementById('friends-list');
  if (_friendsData.filter(f => !f.isMe).length === 0) {
    list.innerHTML = '<p style="color:var(--muted);font-size:0.82rem;">No friends yet. Share your friend code!</p>';
    return;
  }
  list.innerHTML = _friendsData.filter(f => !f.isMe).map(u => {
    const isOnline = (Date.now() - (u.lastSeen || 0)) < 120000; // online if seen in last 2 min
    return `
    <div class="friend-item">
      <div class="friend-avatar">${u.photoURL ? `<img src="${u.photoURL}"/>` : 'ðŸ‘¤'}</div>
      <div style="flex:1;">
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="friend-name">${u.username || 'Unknown'}</div>
          <div class="online-dot ${isOnline ? 'online' : ''}" title="${isOnline ? 'Online' : 'Offline'}"></div>
        </div>
        <div class="friend-sub">${u.xp || 0} XP Â· ${u.dayStreak || 0} day streak</div>
      </div>
      <button class="duel-btn challenge" onclick="sendDuelChallenge('${u.uid}', '${(u.username||'Unknown').replace(/'/g,'')}')" title="Challenge to a duel!">âš”ï¸ Duel</button>
      <button class="friend-action-btn remove" style="margin-left:4px;" onclick="removeFriend('${u.uid}')">Remove</button>
    </div>`;
  }).join('');
}

function renderLeaderboard() {
  const list = document.getElementById('leaderboard-list');
  if (_friendsData.length <= 1) {
    list.innerHTML = `<div class="lb-empty">Add friends to see the leaderboard!<br><span style="font-size:0.72rem;">Share your friend code above to get started.</span></div>`;
    return;
  }
  const sorted = [..._friendsData].sort((a,b) => {
    if (_lbTab === 'xp') return (b.xp||0) - (a.xp||0);
    if (_lbTab === 'weekly') return (b.weeklyXP||0) - (a.weeklyXP||0);
    if (_lbTab === 'streak') return (b.dayStreak||0) - (a.dayStreak||0);
    return 0;
  });
  const rankIcons = ['ðŸ¥‡','ðŸ¥ˆ','ðŸ¥‰'];
  list.innerHTML = sorted.map((u,i) => {
    const val = _lbTab==='xp' ? `${u.xp||0} XP` : _lbTab==='weekly' ? `${u.weeklyXP||0} XP` : `${u.dayStreak||0} days`;
    const rankClass = i===0?'gold':i===1?'silver':i===2?'bronze':'';
    return `<div class="lb-row${u.isMe?' me':''}">
      <div class="lb-rank ${rankClass}">${i<3?rankIcons[i]:i+1}</div>
      <div class="friend-avatar" style="width:32px;height:32px;font-size:1rem;">${u.photoURL?`<img src="${u.photoURL}" style="width:32px;height:32px;border-radius:50%"/>` :'ðŸ‘¤'}</div>
      <div class="lb-info">
        <div class="lb-name">${u.username||'Unknown'}${u.isMe?' (you)':''}</div>
      </div>
      <div class="lb-value">${val}</div>
    </div>`;
  }).join('');
}

function switchLbTab(tab) {
  _lbTab = tab;
  document.querySelectorAll('.lb-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('lb-tab-'+tab).classList.add('active');
  renderLeaderboard();
}

async function sendFriendRequest() {
  if (!currentUser) return;
  const query = document.getElementById('friend-search-input').value.trim();
  const result = document.getElementById('friend-search-result');
  if (!query) return;
  result.textContent = 'Searching...';
  result.style.color = 'var(--muted)';

  try {
    // Search by friend code or username
    let snap = await db.collection('users').where('friendCode','==',query.toUpperCase()).get();
    if (snap.empty) snap = await db.collection('users').where('username','==',query).get();

    if (snap.empty) { result.textContent = 'âŒ No user found with that code or username.'; result.style.color='var(--wrong)'; return; }

    const targetDoc = snap.docs[0];
    const targetUid = targetDoc.id;

    if (targetUid === currentUser.uid) { result.textContent = 'ðŸ˜… That\'s you!'; return; }

    const myDoc = await db.collection('users').doc(currentUser.uid).get();
    const myData = myDoc.data() || {};
    if ((myData.friends||[]).includes(targetUid)) { result.textContent = 'âœ… Already friends!'; result.style.color='var(--a3)'; return; }
    if ((myData.pendingOut||[]).includes(targetUid)) { result.textContent = 'â³ Request already sent!'; return; }

    // Send request
    await db.collection('users').doc(targetUid).update({ pendingIn: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
    await db.collection('users').doc(currentUser.uid).update({ pendingOut: firebase.firestore.FieldValue.arrayUnion(targetUid) });

    result.textContent = `âœ… Friend request sent to ${targetDoc.data().username||'them'}!`;
    result.style.color = 'var(--a3)';
    document.getElementById('friend-search-input').value = '';
  } catch(e) {
    result.textContent = 'âŒ Something went wrong. Try again.';
    result.style.color = 'var(--wrong)';
    console.error(e);
  }
}

async function acceptFriend(uid) {
  if (!currentUser) return;
  await db.collection('users').doc(currentUser.uid).update({
    friends: firebase.firestore.FieldValue.arrayUnion(uid),
    pendingIn: firebase.firestore.FieldValue.arrayRemove(uid)
  });
  await db.collection('users').doc(uid).update({
    friends: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
    pendingOut: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
  });
  refreshFriends();
}

async function declineFriend(uid) {
  if (!currentUser) return;
  await db.collection('users').doc(currentUser.uid).update({ pendingIn: firebase.firestore.FieldValue.arrayRemove(uid) });
  await db.collection('users').doc(uid).update({ pendingOut: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
  refreshFriends();
}

async function removeFriend(uid) {
  if (!currentUser) return; if (!await uiConfirm('Remove this friend?', 'ðŸ‘¥', 'Remove Friend', 'Remove')) return;
  await db.collection('users').doc(currentUser.uid).update({ friends: firebase.firestore.FieldValue.arrayRemove(uid) });
  await db.collection('users').doc(uid).update({ friends: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
  refreshFriends();
}

async function copyFriendCode() {
  const code = document.getElementById('my-friend-code').textContent;
  try {
    await navigator.clipboard.writeText(code);
    showToast('ðŸ“‹ Friend code copied!');
  } catch(e) {
    showToast('Code: ' + code);
  }
}


let _sessionQCount = 0;
let _sessionQCorrect = 0;

function maybeShowResultsCard() {
  if (_sessionQCount < 5) return;
  const acc = Math.round(_sessionQCorrect / _sessionQCount * 100);
  if (acc < 80) return;

  // Guard: make sure the results card is actually in the DOM
  const overlay = document.getElementById('results-card-overlay');
  if (!overlay) return;

  const topic = TL[S.currentTopic] || 'Math';
  const grade = acc>=97?'S':acc>=93?'A+':acc>=90?'A':acc>=87?'Aâˆ’':acc>=83?'B+':'B';
  const gradeColor = acc>=90?'#06d6a0':acc>=80?'#ffd166':'#4cc9f0';

  // Fill card with null checks on every element
  const set = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
  set('rc-username', S.username || 'Student');
  set('rc-topic', topic);
  set('rc-pct', acc + '%');
  set('rc-xp', '+' + S.sessionXP);
  set('rc-correct', _sessionQCorrect + '/' + _sessionQCount);
  set('rc-streak', S.bestStreak);

  const gradeEl = document.getElementById('rc-grade');
  if (gradeEl) {
    gradeEl.textContent = grade;
    gradeEl.style.background = gradeColor + '22';
    gradeEl.style.color = gradeColor;
  }

  const avatarEl = document.getElementById('rc-avatar');
  if (avatarEl) {
    if (currentUser && currentUser.photoURL) {
      avatarEl.innerHTML = `<img src="${currentUser.photoURL}" alt=""/>`;
    } else {
      avatarEl.innerHTML = (S.shopEquipped && S.shopEquipped.avatar) || 'â­';
    }
  }

  overlay.classList.add('show');
}

function closeResultsCard() {
  document.getElementById('results-card-overlay').classList.remove('show');
  // Reset counters for next session
  _sessionQCount = 0;
  _sessionQCorrect = 0;
}

function shareResultsCard() {
  const card = document.getElementById('results-card');
  card.style.outline = '3px solid var(--accent)';
  setTimeout(() => card.style.outline = '', 1200);
  const isWin = navigator.platform.indexOf('Win') > -1;
  const shortcut = isWin ? 'Win + Shift + S' : 'Cmd + Shift + 4';
  showToast(`ðŸ“¸ Take a screenshot! (${shortcut})`);
}

function showToast(msg, duration=3000) {
  let toast = document.getElementById('global-toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'global-toast';
    toast.style.cssText = `position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);
      background:var(--card);border:1px solid var(--border);color:var(--text);
      font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;
      padding:10px 20px;border-radius:99px;box-shadow:0 8px 24px rgba(0,0,0,0.4);
      z-index:9999;opacity:0;transition:all 0.3s;white-space:nowrap;pointer-events:none;`;
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.style.opacity = '1';
  toast.style.transform = 'translateX(-50%) translateY(0)';
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(20px)';
  }, duration);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  âš”ï¸ DUEL SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _duelId = null;
let _isRankedDuel = false;
let _duelListener = null;
let _duelOpponentUid = null;
let _duelOpponentName = 'Opponent';
let _duelMyScore = 0;
let _duelTheirScore = 0;
let _duelAnswered = false;
let _duelQuestions = [];
let _duelQIdx = 0;
let _duelIncomingId = null;
let _duelIncomingTimer = null;
let _duelTopics = [];
const DUEL_WIN_SCORE = 15;

// â”€â”€ Pick a shared question pool for the duel (mental math only) â”€â”€
function buildDuelQuestions(topics) {
  let pool = [];
  topics.forEach(t => {
    const qs = QB[t] || [];
    // Only use questions tagged mental:true for duels
    const mental = qs.filter(q => q.mental === true);
    const src = mental.length >= 10 ? mental : qs.filter(q => q.type !== 'sort' && q.type !== 'multivar');
    const shuffled = [...src].sort(() => Math.random() - 0.5).slice(0, 30);
    pool = pool.concat(shuffled.map(q => ({...q, _topic: t})));
  });
  // Shuffle combined pool
  return pool.sort(() => Math.random() - 0.5);
}

// â”€â”€ Send a duel challenge â”€â”€
async function sendDuelChallenge(opponentUid, opponentName) {
  if (!currentUser) { showToast('Sign in to duel!'); return; }

  // Pick a random topic from shared topics
  const topics = Object.keys(QB);
  const topic = topics[Math.floor(Math.random() * topics.length)];

  const duelRef = db.collection('duels').doc();
  _duelId = duelRef.id;
  _duelOpponentUid = opponentUid;
  _duelOpponentName = opponentName;
  _duelTopics = [topic];

  await duelRef.set({
    challengerUid: currentUser.uid,
    challengerName: S.username || 'Someone',
    opponentUid,
    opponentName,
    topic,
    status: 'pending',      // pending â†’ accepted â†’ active â†’ finished
    challengerScore: 0,
    opponentScore: 0,
    createdAt: Date.now(),
    expiresAt: Date.now() + 30000,  // 30s to accept
  });

  showToast(`âš”ï¸ Duel challenge sent to ${opponentName}! Waiting...`);

  // Listen for acceptance or expiry
  _duelListener = duelRef.onSnapshot(snap => {
    const d = snap.data();
    if (!d) return;
    if (d.status === 'accepted') {
      showToast('âœ… Challenge accepted! Get ready...');
      startDuelArena(duelRef.id, d, true);
    } else if (d.status === 'declined') {
      showToast(`âŒ ${opponentName} declined the duel.`);
      cleanupDuelListener();
    } else if (Date.now() > d.expiresAt && d.status === 'pending') {
      showToast(`â° ${opponentName} didn't respond in time.`);
      duelRef.update({ status: 'expired' });
      cleanupDuelListener();
    }
  });
}

// â”€â”€ Listen for incoming duels â”€â”€
function listenForIncomingDuels() {
  if (!currentUser) return;
  db.collection('duels')
    .where('opponentUid', '==', currentUser.uid)
    .where('status', '==', 'pending')
    .onSnapshot(snap => {
      snap.docChanges().forEach(change => {
        if (change.type === 'added') {
          const d = change.doc.data();
          if (Date.now() < d.expiresAt) {
            showIncomingDuel(change.doc.id, d);
          }
        }
      });
    });
}

// â”€â”€ Show incoming duel notification â”€â”€
function showIncomingDuel(duelId, data) {
  _duelIncomingId = duelId;
  _duelOpponentUid = data.challengerUid;
  _duelOpponentName = data.challengerName;
  _duelTopics = [data.topic];

  document.getElementById('di-challenger-name').textContent = data.challengerName;
  document.getElementById('di-topic-info').textContent = `Topic: ${TL[data.topic] || data.topic}`;
  document.getElementById('duel-incoming').classList.add('show');

  // Countdown timer display
  let remaining = Math.ceil((data.expiresAt - Date.now()) / 1000);
  document.getElementById('di-timer-text').textContent = `Expires in ${remaining}s`;
  clearInterval(_duelIncomingTimer);
  _duelIncomingTimer = setInterval(() => {
    remaining--;
    const el = document.getElementById('di-timer-text');
    if (el) el.textContent = `Expires in ${remaining}s`;
    if (remaining <= 0) {
      clearInterval(_duelIncomingTimer);
      document.getElementById('duel-incoming').classList.remove('show');
    }
  }, 1000);
}

// â”€â”€ Accept the incoming duel â”€â”€
async function acceptDuel() {
  if (!_duelIncomingId) return;
  clearInterval(_duelIncomingTimer);
  document.getElementById('duel-incoming').classList.remove('show');

  const duelRef = db.collection('duels').doc(_duelIncomingId);
  _duelId = _duelIncomingId;
  await duelRef.update({ status: 'accepted' });

  // Listen to duel state
  const snap = await duelRef.get();
  startDuelArena(_duelIncomingId, snap.data(), false);
}

// â”€â”€ Decline the incoming duel â”€â”€
async function declineDuel() {
  clearInterval(_duelIncomingTimer);
  document.getElementById('duel-incoming').classList.remove('show');
  if (_duelIncomingId) {
    await db.collection('duels').doc(_duelIncomingId).update({ status: 'declined' });
    _duelIncomingId = null;
  }
}

// â”€â”€ Start the duel arena â”€â”€
function startDuelArena(duelId, data, isChallenger) {
  cleanupDuelListener();
  _duelId = duelId;
  _duelMyScore = 0;
  _duelTheirScore = 0;
  _duelQIdx = 0;
  _duelAnswered = false;
  _duelTopics = [data.topic];

  // Build question pool â€” same seed based on duelId so both players get same questions
  _duelQuestions = buildDuelQuestions(_duelTopics);

  // Set UI names
  document.getElementById('da-my-name').textContent = S.username || 'You';
  document.getElementById('da-their-name').textContent = isChallenger ? data.opponentName : data.challengerName;
  document.getElementById('da-topic-badge').textContent = TL[data.topic] || data.topic;
  updateDuelScoreboard();

  // Show pre-duel intro â†’ countdown â†’ arena
  showPreDuelIntro(data, isChallenger, _isRankedDuel || false, () => {
    document.getElementById('duel-arena').classList.add('show');
    // ðŸŽµ Start duel battle music
    if (_musicEnabled) startMusic('duel');
    loadDuelQuestion();

    // Listen for opponent's score updates
    _duelListener = db.collection('duels').doc(duelId).onSnapshot(snap => {
      const d = snap.data();
      if (!d) return;
      const theirScore = isChallenger ? (d.opponentScore || 0) : (d.challengerScore || 0);
      if (theirScore !== _duelTheirScore) {
        _duelTheirScore = theirScore;
        updateDuelScoreboard();
        // Opponent scored â€” flash their score
        const el = document.getElementById('da-their-score');
        if (el) { el.style.transform='scale(1.4)'; setTimeout(()=>el.style.transform='',300); }
      }
      // Check if game over
      if (d.status === 'finished') {
        endDuel(d, isChallenger);
      } else if (d.status === 'cancelled') {
        cleanupDuelListener();
        endDuelCancelled();
      } else if (d.status === 'finished' && d.opponentForfeited && d.winnerId === currentUser.uid) {
        // Opponent forfeited â€” we win
        endDuel(d, isChallenger);
      }
    });
  });
}

// â”€â”€ Pre-duel intro screen â”€â”€
function showPreDuelIntro(duelData, isChallenger, isRanked, cb) {
  const myAvatar = (S.shopEquipped && S.shopEquipped.avatar)
    ? (SHOP_ITEMS.find(i => i.id === S.shopEquipped.avatar) || {icon:'â­'}).icon
    : 'â­';
  const myTitle = (S.shopEquipped && S.shopEquipped.title)
    ? (SHOP_ITEMS.find(i => i.id === S.shopEquipped.title) || {name:'"Student"'}).name
    : '"Student"';
  const oppName = isChallenger ? duelData.opponentName : duelData.challengerName;

  // Populate
  document.getElementById('pdi-my-avatar').textContent = myAvatar;
  document.getElementById('pdi-my-name').textContent = S.username || 'You';
  document.getElementById('pdi-my-title').textContent = myTitle;
  document.getElementById('pdi-their-avatar').textContent = duelData.opponentAvatar || 'ðŸŽ¯';
  document.getElementById('pdi-their-name').textContent = oppName;
  document.getElementById('pdi-their-title').textContent = duelData.opponentTitle || '"Challenger"';
  document.getElementById('pdi-my-record').textContent = `${S.duelWins||0}W Â· ${S.duelLosses||0}L`;
  document.getElementById('pdi-their-record').textContent = `${duelData.opponentWins||0}W Â· ${duelData.opponentLosses||0}L`;
  document.getElementById('pdi-topic-name').textContent = TL[duelData.topic] || duelData.topic;
  document.getElementById('pdi-rounds-info').textContent = 'First to 15 correct wins Â· Best of 1';
  const badge = document.getElementById('pdi-mode-badge');
  badge.className = 'pdi-ranked-badge ' + (isRanked ? 'ranked' : 'unranked');
  badge.innerHTML = isRanked ? 'ðŸ† Ranked Match' : 'ðŸŽ® Casual Match';

  document.getElementById('preduel-intro').classList.add('show');

  // Dramatic tension â€” show for 2.8s then transition to countdown
  setTimeout(() => {
    document.getElementById('preduel-intro').classList.remove('show');
    setTimeout(() => showDuelCountdown(cb), 200);
  }, 2800);
}

// â”€â”€ Countdown animation â”€â”€
function showDuelCountdown(cb) {
  const overlay = document.getElementById('duel-countdown');
  const num = document.getElementById('dc-num');
  overlay.classList.add('show');
  let count = 3;
  num.textContent = count;
  soundCountdownBeep(count);
  const iv = setInterval(() => {
    count--;
    if (count <= 0) {
      clearInterval(iv);
      num.textContent = 'GO!';
      soundCountdownBeep(0);
      setTimeout(() => { overlay.classList.remove('show'); cb(); }, 600);
    } else {
      num.style.animation = 'none'; num.offsetHeight; num.style.animation = 'dcPop 0.4s cubic-bezier(0.34,1.56,0.64,1)';
      num.textContent = count;
      soundCountdownBeep(count);
    }
  }, 800);
}

// â”€â”€ Load next duel question â”€â”€
function loadDuelQuestion() {
  if (_duelQIdx >= _duelQuestions.length) {
    // Ran out â€” reshuffle
    _duelQuestions = buildDuelQuestions(_duelTopics);
    _duelQIdx = 0;
  }
  const q = _duelQuestions[_duelQIdx++];
  _duelAnswered = false;

  const diffColors = {easy:'rgba(6,214,160,0.18)',medium:'rgba(255,209,102,0.18)',hard:'rgba(239,71,111,0.18)',competition:'rgba(17,138,178,0.18)'};
  const diffText = {easy:'Easy',medium:'Medium',hard:'Hard',competition:'ðŸ† Challenge'};
  const dtag = document.getElementById('da-diff-tag');
  dtag.textContent = diffText[q.diff] || q.diff;
  dtag.style.background = diffColors[q.diff] || diffColors.medium;

  document.getElementById('da-question-text').innerHTML = renderMath(q.text);
  document.getElementById('da-feedback').style.display = 'none';

  const grid = document.getElementById('da-options-grid');
  grid.innerHTML = '';

  if (q.opts) {
    const shuffled = shuffleAnswers(q.opts, q.ans);
    shuffled.forEach((opt, i) => {
      const b = document.createElement('button');
      b.className = 'opt-btn';
      b.innerHTML = `<span class="opt-lbl">${['A','B','C','D'][i]}</span><span>${renderMath(opt)}</span>`;
      b.onclick = () => checkDuelAnswer(i, q);
      grid.appendChild(b);
    });
  }
}

// â”€â”€ Check duel answer â”€â”€
async function checkDuelAnswer(sel, q) {
  if (_duelAnswered) return;
  _duelAnswered = true;

  const correct = sel === _shuffledCorrectIdx;

  // Color the buttons
  document.querySelectorAll('#da-options-grid .opt-btn').forEach((b, i) => {
    b.disabled = true;
    if (i === _shuffledCorrectIdx) b.classList.add('correct');
    else if (i === sel && !correct) b.classList.add('wrong');
  });

  // Feedback
  const fb = document.getElementById('da-feedback');
  fb.style.display = 'block';
  fb.style.background = correct ? 'rgba(6,214,160,0.12)' : 'rgba(239,71,111,0.1)';
  fb.style.border = `1px solid ${correct ? 'var(--a3)' : 'var(--wrong)'}`;
  fb.textContent = correct ? 'âœ… Correct! Next question loading...' : `âŒ Wrong. Answer: ${q.opts ? q.opts[q.ans] : q.ans}`;

  if (correct) {
    _duelMyScore++;
    updateDuelScoreboard();
    soundDuelPoint();
    // Flash my score
    const el = document.getElementById('da-my-score');
    if (el) { el.style.transform='scale(1.4)'; setTimeout(()=>el.style.transform='',300); }

    // Push my score to Firebase
    const duelRef = db.collection('duels').doc(_duelId);
    const snap = await duelRef.get();
    const d = snap.data();
    const myField = d.challengerUid === currentUser.uid ? 'challengerScore' : 'opponentScore';
    await duelRef.update({ [myField]: _duelMyScore });

    // Check win condition
    if (_duelMyScore >= DUEL_WIN_SCORE) {
      await duelRef.update({ status: 'finished', winnerId: currentUser.uid });
      return;
    }
  }

  // Load next question after short delay
  setTimeout(loadDuelQuestion, correct ? 900 : 1400);
}

// â”€â”€ Update duel scoreboard UI â”€â”€
function updateDuelScoreboard() {
  const myEl = document.getElementById('da-my-score');
  const theirEl = document.getElementById('da-their-score');
  const barMe = document.getElementById('da-bar-me');
  const barThem = document.getElementById('da-bar-them');
  if (myEl) myEl.textContent = _duelMyScore;
  if (theirEl) theirEl.textContent = _duelTheirScore;
  if (barMe) barMe.style.width = Math.min((_duelMyScore / DUEL_WIN_SCORE) * 50, 50) + '%';
  if (barThem) barThem.style.width = Math.min((_duelTheirScore / DUEL_WIN_SCORE) * 50, 50) + '%';
}

// â”€â”€ End duel â”€â”€
function endDuel(data, isChallenger) {
  cleanupDuelListener();
  document.getElementById('duel-arena').classList.remove('show');

  const iWon = data.winnerId === currentUser.uid;
  const myScore = isChallenger ? data.challengerScore : data.opponentScore;
  const theirScore = isChallenger ? data.opponentScore : data.challengerScore;
  const opponentName = isChallenger ? data.opponentName : data.challengerName;

  // Track W/L
  if (iWon) { S.duelWins = (S.duelWins||0) + 1; }
  else { S.duelLosses = (S.duelLosses||0) + 1; }
  // XP reward
  const xpReward = iWon ? 150 : 50;
  S.xp += xpReward; S.sessionXP += xpReward;
  spawnXP(`+${xpReward} XP âš”ï¸ ${iWon ? 'Duel Win!' : 'Good fight!'}`, iWon ? '#ffd166' : '#a7a9be');
  // LP reward for ranked
  if (_isRankedDuel) {
    updateRankedLP(iWon, S.rankedWinStreak || 0);
  }
  saveState();

  // Show result screen
  document.getElementById('dr-crown').textContent = iWon ? 'ðŸ†' : 'ðŸ˜¤';
  document.getElementById('dr-outcome').textContent = iWon ? 'You Win! ðŸŽ‰' : 'You Lost!';
  document.getElementById('dr-sub').textContent = iWon
    ? `You destroyed ${opponentName}!`
    : `${opponentName} was faster this time. Rematch?`;
  document.getElementById('dr-my-score').textContent = myScore || _duelMyScore;
  document.getElementById('dr-my-name').textContent = S.username || 'You';
  document.getElementById('dr-their-score').textContent = theirScore || _duelTheirScore;
  document.getElementById('dr-their-name').textContent = opponentName;
  document.getElementById('dr-xp-reward').textContent = `+${xpReward} XP ${iWon ? 'ðŸ† Victory bonus!' : 'â€” keep practicing!'}`;

  const myBox = document.getElementById('dr-my-box');
  const theirBox = document.getElementById('dr-their-box');
  if (iWon) { myBox.classList.add('winner'); theirBox.classList.add('loser'); }
  else { myBox.classList.add('loser'); theirBox.classList.add('winner'); }

  if (iWon) soundDuelWin(); else soundDuelLose();
  if (S.settings.confetti && iWon) launchConfetti();
  document.getElementById('duel-result').classList.add('show');
  // ðŸŽµ Stop duel music, fade back to study track after result screen
  stopMusic(true);
  setTimeout(() => { if (_musicEnabled) startMusic('study'); }, 3000);
}

function closeDuelResult() {
  document.getElementById('duel-result').classList.remove('show');
  document.getElementById('dr-my-box').classList.remove('winner','loser');
  document.getElementById('dr-their-box').classList.remove('winner','loser');
}

async function quitDuel() {
  if (!await uiConfirm("Quit the duel? You'll lose this match.", 'âš”ï¸', 'Quit Duel?', 'Yes, forfeit')) return;
  cleanupDuelListener();
  document.getElementById('duel-arena').classList.remove('show');
  if (_duelId && currentUser) {
    const duelRef = db.collection('duels').doc(_duelId);
    // Mark this player as forfeited â€” use a timestamp so double-forfeit detection works
    const myField = await (async () => {
      try {
        const snap = await duelRef.get();
        const d = snap.data();
        return d.challengerUid === currentUser.uid ? 'challengerForfeited' : 'opponentForfeited';
      } catch(e) { return 'challengerForfeited'; }
    })();
    try {
      const snap = await duelRef.get();
      const d = snap.data();
      const otherField = myField === 'challengerForfeited' ? 'opponentForfeited' : 'challengerForfeited';
      if (d[otherField]) {
        // Both forfeited â€” cancel match
        await duelRef.update({ status: 'cancelled', [myField]: Date.now() });
        showToast('âš¡ Match cancelled â€” both players forfeited.');
        endDuelCancelled();
      } else {
        // I forfeited â€” opponent wins
        await duelRef.update({
          status: 'finished',
          winnerId: _duelOpponentUid,
          [myField]: Date.now()
        });
        showToast('You forfeited. Opponent wins.');
      }
    } catch(e) { console.error('Forfeit error:', e); }
  }
  showToast('Duel ended.');
}

function endDuelCancelled() {
  document.getElementById('duel-arena').classList.remove('show');
  // ðŸŽµ Stop duel music
  stopMusic(true);
  setTimeout(() => { if (_musicEnabled) startMusic('study'); }, 2500);
  // Show a neutral result screen
  document.getElementById('dr-crown').textContent = 'âš¡';
  document.getElementById('dr-outcome').textContent = 'Match Cancelled';
  document.getElementById('dr-sub').textContent = 'Both players forfeited. No result recorded.';
  document.getElementById('dr-my-score').textContent = _duelMyScore;
  document.getElementById('dr-my-name').textContent = S.username || 'You';
  document.getElementById('dr-their-score').textContent = _duelTheirScore;
  document.getElementById('dr-their-name').textContent = _duelOpponentName;
  document.getElementById('dr-xp-reward').textContent = 'No XP â€” match was cancelled';
  document.getElementById('dr-my-box').classList.remove('winner','loser');
  document.getElementById('dr-their-box').classList.remove('winner','loser');
  document.getElementById('duel-result').classList.add('show');
}

function cleanupDuelListener() {
  if (_duelListener) { _duelListener(); _duelListener = null; }
}

// Start listening for incoming duels when user signs in
// (called from auth state change handler)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RANKED MATCHMAKING SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _mmListener = null;
let _mmTimer = null;
let _mmElapsed = 0;
let _mmExpanded = false;
let _mmMode = 'ranked'; // 'ranked' or 'casual'
let _mmTopics = [];
let _mmDocId = null;

async function startMatchmaking(mode) {
  if (!currentUser) {
    uiAlert('Sign in with Google to use matchmaking!', 'ðŸ”', 'Sign In Required');
    return;
  }
  if (!currentUser.emailVerified) {
    uiAlert('Please verify your email address to use matchmaking. Check your inbox for a verification link.', 'ðŸ“§', 'Verify Email First');
    return;
  }

  _mmMode = mode;
  _mmElapsed = 0;
  _mmExpanded = false;
  _mmTopics = _selectedTopics ? [..._selectedTopics] : Object.keys(QB);

  // Show matchmaking UI
  const badge = document.getElementById('mm-type-badge');
  badge.className = 'mm-type-badge ' + (mode === 'ranked' ? 'ranked' : 'unranked');
  badge.innerHTML = mode === 'ranked' ? 'ðŸ† Ranked' : 'ðŸŽ® Casual';
  document.getElementById('mm-title').textContent = 'Finding an Opponent...';
  document.getElementById('mm-status').textContent = mode === 'ranked'
    ? 'Searching for players in your rank range...'
    : 'Searching for anyone online...';
  document.getElementById('mm-expand-msg').style.display = 'none';
  document.getElementById('mm-timer').textContent = '0:00';

  // Topic chips
  const chips = document.getElementById('mm-topic-chips');
  chips.innerHTML = _mmTopics.slice(0,6).map(t =>
    `<div class="mm-topic-chip selected">${TL[t] || t}</div>`
  ).join('') + (_mmTopics.length > 6 ? `<div class="mm-topic-chip">+${_mmTopics.length-6} more</div>` : '');

  document.getElementById('matchmaking-overlay').classList.add('show');

  // Post to Firestore queue
  const myAvatar = (S.shopEquipped && S.shopEquipped.avatar)
    ? (SHOP_ITEMS.find(i => i.id === S.shopEquipped.avatar) || {icon:'â­'}).icon
    : 'â­';
  const myTitle = (S.shopEquipped && S.shopEquipped.title)
    ? (SHOP_ITEMS.find(i => i.id === S.shopEquipped.title) || {name:'"Student"'}).name
    : '"Student"';

  const queueRef = db.collection('matchmaking_queue').doc(currentUser.uid);
  await queueRef.set({
    uid: currentUser.uid,
    name: S.username || 'Player',
    avatar: myAvatar,
    title: myTitle,
    xp: S.xp || 0,
    level: S.level || 1,
    duelWins: S.duelWins || 0,
    duelLosses: S.duelLosses || 0,
    rankedLP: S.rankedLP || 0,
    mode,
    topics: _mmTopics,
    status: 'searching',
    timestamp: Date.now(),
    expanded: false,
  });
  _mmDocId = currentUser.uid;

  // Listen to our own doc for a match
  _mmListener = queueRef.onSnapshot(async snap => {
    const d = snap.data();
    if (!d) return;
    if (d.status === 'matched' && d.matchedDuelId) {
      clearInterval(_mmTimer);
      clearTimeout(_mmExpandTimeout);
      document.getElementById('matchmaking-overlay').classList.remove('show');
      _mmListener && _mmListener();
      _mmListener = null;

      // Get duel data and start
      const duelSnap = await db.collection('duels').doc(d.matchedDuelId).get();
      _isRankedDuel = mode === 'ranked';
      startDuelArena(d.matchedDuelId, duelSnap.data(), d.isChallenger);
      // Clean up queue entry
      queueRef.delete().catch(()=>{});
    }
  });

  // Count-up timer
  let _mmElapsedSecs = 0;
  _mmTimer = setInterval(() => {
    _mmElapsedSecs++;
    _mmElapsed++;
    const mins = Math.floor(_mmElapsedSecs/60);
    const secs = _mmElapsedSecs % 60;
    const timerEl = document.getElementById('mm-timer');
    if (timerEl) timerEl.textContent = `${mins}:${secs.toString().padStart(2,'0')}`;
    if (timerEl) timerEl.style.color = _mmElapsedSecs > 90 ? 'var(--wrong)' : 'var(--a3)';

    if (_mmElapsedSecs >= 120) {
      clearInterval(_mmTimer);
      cancelMatchmaking(true); // timeout after 2 minutes
    }
  }, 1000);

  // At 20s, show expand option (ranked only)
  let _mmExpandTimeout;
  if (mode === 'ranked') {
    _mmExpandTimeout = setTimeout(() => {
      if (document.getElementById('matchmaking-overlay').classList.contains('show')) {
        document.getElementById('mm-expand-msg').style.display = 'block';
        document.getElementById('mm-status').textContent = 'Still looking... try expanding your search?';
      }
    }, 20000);
  }
}

async function expandMatchmaking() {
  if (!_mmDocId) return;
  _mmExpanded = true;
  document.getElementById('mm-expand-msg').style.display = 'none';
  document.getElementById('mm-status').textContent = 'Expanded to all ranks â€” finding a match...';
  await db.collection('matchmaking_queue').doc(_mmDocId).update({ expanded: true });
}

async function cancelMatchmaking(timeout=false) {
  clearInterval(_mmTimer);
  if (_mmListener) { _mmListener(); _mmListener = null; }
  if (_mmDocId) {
    await db.collection('matchmaking_queue').doc(_mmDocId).delete().catch(()=>{});
    _mmDocId = null;
  }
  document.getElementById('matchmaking-overlay').classList.remove('show');
  if (timeout) {
    showToast('No opponent found. Please try again!', 4000);
  }
}

// â”€â”€ Matchmaking engine: Cloud Function would be ideal but here's a client-side
//    best-effort approach â€” listen for queue changes and attempt to pair â”€â”€
function listenForMatchmaking() {
  if (!currentUser) return;
  // Listen for other people queuing â€” try to pair with them
  db.collection('matchmaking_queue')
    .where('status', '==', 'searching')
    .onSnapshot(snap => {
      if (!_mmDocId) return; // Not in queue ourselves
      snap.docs.forEach(async doc => {
        if (doc.id === currentUser.uid) return; // skip self
        const other = doc.data();
        // Check mode compatibility
        if (other.mode !== _mmMode && !_mmExpanded && !other.expanded) return;
        // Try to create a match (only one side does this â€” use UID comparison to prevent race)
        if (currentUser.uid < doc.id) {
          await attemptPairing(doc.id, other);
        }
      });
    });
}

async function attemptPairing(opponentUid, opponentData) {
  if (!_mmDocId) return;
  // Use a Firestore transaction to claim both queue spots
  const myRef = db.collection('matchmaking_queue').doc(currentUser.uid);
  const theirRef = db.collection('matchmaking_queue').doc(opponentUid);

  try {
    await db.runTransaction(async tx => {
      const mySnap = await tx.get(myRef);
      const theirSnap = await tx.get(theirRef);
      if (!mySnap.exists || !theirSnap.exists) throw new Error('already matched');
      if (mySnap.data().status !== 'searching' || theirSnap.data().status !== 'searching') throw new Error('already matched');

      // Pick shared topic
      const myTopics = mySnap.data().topics || [];
      const theirTopics = theirSnap.data().topics || [];
      const shared = myTopics.filter(t => theirTopics.includes(t));
      const topic = shared.length > 0
        ? shared[Math.floor(Math.random() * shared.length)]
        : myTopics[Math.floor(Math.random() * myTopics.length)];

      // Create duel document
      const duelRef = db.collection('duels').doc();
      tx.set(duelRef, {
        challengerUid: currentUser.uid,
        challengerName: S.username || 'Player',
        challengerAvatar: mySnap.data().avatar || 'â­',
        challengerTitle: mySnap.data().title || '"Student"',
        opponentUid,
        opponentName: opponentData.name || 'Player',
        opponentAvatar: opponentData.avatar || 'ðŸŽ¯',
        opponentTitle: opponentData.title || '"Challenger"',
        opponentWins: opponentData.duelWins || 0,
        opponentLosses: opponentData.duelLosses || 0,
        topic,
        status: 'accepted',
        isRanked: _mmMode === 'ranked',
        challengerScore: 0,
        opponentScore: 0,
        createdAt: Date.now(),
      });

      // Mark both as matched
      tx.update(myRef, { status:'matched', matchedDuelId:duelRef.id, isChallenger:true });
      tx.update(theirRef, { status:'matched', matchedDuelId:duelRef.id, isChallenger:false });
    });
  } catch(e) {
    // Already matched or transaction failed â€” that's OK
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RANK SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RANKS = [
  { id:'apprentice', name:'Apprentice', icon:'ðŸ“–', color:'var(--rank-apprentice)', cls:'rank-apprentice', minLP:0, divisions:4 },
  { id:'scholar',    name:'Scholar',    icon:'ðŸ”', color:'var(--rank-scholar)',    cls:'rank-scholar',    minLP:400, divisions:4 },
  { id:'thinker',    name:'Thinker',    icon:'ðŸ’¡', color:'var(--rank-thinker)',    cls:'rank-thinker',    minLP:800, divisions:4 },
  { id:'analyst',    name:'Analyst',    icon:'ðŸ“Š', color:'var(--rank-analyst)',    cls:'rank-analyst',    minLP:1200, divisions:4 },
  { id:'sage',       name:'Sage',       icon:'ðŸ”®', color:'var(--rank-sage)',       cls:'rank-sage',       minLP:1600, divisions:4 },
  { id:'genius',     name:'Genius',     icon:'ðŸ§ ', color:'var(--rank-genius)',     cls:'rank-genius',     minLP:2000, divisions:4 },
  { id:'mastermind', name:'Mastermind', icon:'ðŸ‘‘', color:'var(--rank-mastermind)', cls:'rank-mastermind', minLP:2400, divisions:0 },
];
const LP_PER_DIVISION = 100;
const DIVISIONS = ['IV','III','II','I'];

function getTotalLP() { return S.rankedLP || 0; }

function getRankFromLP(lp) {
  for (let i = RANKS.length - 1; i >= 0; i--) {
    if (lp >= RANKS[i].minLP) return RANKS[i];
  }
  return RANKS[0];
}

function getDivisionFromLP(lp) {
  const rank = getRankFromLP(lp);
  if (rank.id === 'mastermind') return '';
  const lpInRank = lp - rank.minLP;
  const divIdx = Math.min(Math.floor(lpInRank / LP_PER_DIVISION), 3);
  return DIVISIONS[divIdx];
}

function getRankDisplayName(lp) {
  const rank = getRankFromLP(lp);
  if (rank.id === 'mastermind') return `${rank.icon} Mastermind`;
  const div = getDivisionFromLP(lp);
  return `${rank.icon} ${rank.name} ${div}`;
}

function getRankClass(lp) {
  return getRankFromLP(lp).cls;
}

function getLPInDivision(lp) {
  const rank = getRankFromLP(lp);
  if (rank.id === 'mastermind') return lp - rank.minLP;
  const lpInRank = lp - rank.minLP;
  return lpInRank % LP_PER_DIVISION;
}

function updateRankedLP(won, winStreak) {
  if (!S.rankedLP) S.rankedLP = 0;
  if (!S.rankedWins) S.rankedWins = 0;
  if (!S.rankedLosses) S.rankedLosses = 0;
  if (!S.rankedWinStreak) S.rankedWinStreak = 0;
  if (!S.firstWinToday) S.firstWinToday = false;
  
  const today = new Date().toISOString().slice(0,10);
  
  if (won) {
    S.rankedWins++;
    S.rankedWinStreak = (S.rankedWinStreak || 0) + 1;
    let lpGain = 20 + Math.floor(Math.random() * 11); // 20-30 LP
    if (S.rankedWinStreak >= 3) lpGain = Math.floor(lpGain * 1.2); // streak bonus
    if (!S.firstWinToday || S.lastWinDate !== today) {
      lpGain += 35; // first win of day bonus
      S.firstWinToday = true;
      S.lastWinDate = today;
    }
    S.rankedLP = Math.max(0, S.rankedLP + lpGain);
    spawnXP(`+${lpGain} LP ðŸ† Rank Up!`, 'var(--rank-sage)');
  } else {
    S.rankedLosses++;
    S.rankedWinStreak = 0;
    const lpLoss = 15;
    S.rankedLP = Math.max(0, S.rankedLP - lpLoss);
    spawnXP(`âˆ’${lpLoss} LP`, 'var(--wrong)');
  }
  saveState();
}

function buildRankTiersDisplay() {
  const el = document.getElementById('rank-tiers-display');
  if (!el) return;
  const myLP = getTotalLP();
  const myRank = getRankFromLP(myLP);
  el.innerHTML = RANKS.map(r => {
    const isCurrent = r.id === myRank.id;
    const divText = r.id === 'mastermind' ? 'Top tier â€” no divisions' : 'Divisions IV â†’ I';
    return `<div class="rank-tier-card${isCurrent?' current':''}">
      <span class="rank-tier-icon">${r.icon}</span>
      <span class="rank-tier-name" style="color:${r.color}">${r.name}</span>
      <span class="rank-tier-sub">${divText}</span>
      ${isCurrent ? `<div class="rank-lp-bar-wrap"><div class="rank-lp-bar" style="width:${getLPInDivision(myLP)}%;background:${r.color}"></div></div>` : ''}
    </div>`;
  }).join('');
}

function refreshRankedPage() {
  const lp = getTotalLP();
  const rankName = getRankDisplayName(lp);
  const rankCls = getRankClass(lp);
  const badge = document.getElementById('my-rank-badge');
  if (badge) {
    badge.textContent = rankName;
    badge.className = `rank-badge ${rankCls}`;
  }
  const lpEl = document.getElementById('my-lp');
  if (lpEl) lpEl.textContent = `${lp} LP`;
  
  const rank = getRankFromLP(lp);
  const lpNext = document.getElementById('my-lp-next');
  if (lpNext) {
    if (rank.id === 'mastermind') {
      lpNext.textContent = 'ðŸ‘‘ Maximum rank achieved';
    } else {
      const lpInDiv = getLPInDivision(lp);
      lpNext.textContent = `${LP_PER_DIVISION - lpInDiv} LP to next division`;
    }
  }
  
  const bar = document.getElementById('lp-progress-bar');
  if (bar) {
    bar.style.width = (getLPInDivision(lp)) + '%';
    bar.style.background = rank.color;
  }
  
  buildRankTiersDisplay();
  buildRankedLeaderboard();
}

async function buildRankedLeaderboard() {
  const container = document.getElementById('ranked-leaderboard-list');
  if (!container) return;
  container.innerHTML = '<div style="text-align:center;padding:16px;color:var(--muted);font-size:0.8rem;">Loading top 35...</div>';
  
  try {
    const snap = await db.collection('users')
      .orderBy('rankedLP', 'desc')
      .limit(35)
      .get();
    
    const docs = snap.docs;
    const myLP = getTotalLP();
    
    if (docs.length === 0) {
      // No ranked data yet â€” show placeholder with current user
      const myRankName = getRankDisplayName(myLP);
      const myRankCls = getRankClass(myLP);
      container.innerHTML = `
        <div class="ranked-lb-row me">
          <div class="ranked-lb-pos">1</div>
          <div class="ranked-lb-avatar">${(S.shopEquipped&&S.shopEquipped.avatar)?'â­':'â­'}</div>
          <div class="ranked-lb-info">
            <div class="ranked-lb-name">${S.username||'You'} (You)</div>
            <div class="ranked-lb-rank"><span class="rank-badge ${myRankCls}" style="font-size:0.62rem;padding:2px 8px;">${myRankName}</span></div>
          </div>
          <div class="ranked-lb-lp">${myLP} LP</div>
        </div>
        <div style="text-align:center;padding:12px;color:var(--muted);font-size:0.78rem;">Be the first to climb the leaderboard!</div>`;
      return;
    }
    
    let myShown = false;
    container.innerHTML = docs.map((doc, i) => {
      const u = doc.data();
      const isMe = currentUser && doc.id === currentUser.uid;
      if (isMe) myShown = true;
      const uLP = u.rankedLP || 0;
      const rankName = getRankDisplayName(uLP);
      const rankCls = getRankClass(uLP);
      const posIcon = i===0?'ðŸ¥‡':i===1?'ðŸ¥ˆ':i===2?'ðŸ¥‰':`#${i+1}`;
      return `<div class="ranked-lb-row${isMe?' me':''}">
        <div class="ranked-lb-pos">${posIcon}</div>
        <div class="ranked-lb-avatar">${u.photoURL ? `<img src="${u.photoURL}" style="width:28px;height:28px;border-radius:50%;"/>` : 'ðŸ‘¤'}</div>
        <div class="ranked-lb-info">
          <div class="ranked-lb-name">${u.username||'Unknown'}${isMe?' (You)':''}</div>
          <div class="ranked-lb-rank"><span class="rank-badge ${rankCls}" style="font-size:0.62rem;padding:2px 8px;">${rankName}</span></div>
        </div>
        <div class="ranked-lb-lp">${uLP} LP</div>
      </div>`;
    }).join('');
    
    // If current user isn't in top 35, show their position at bottom
    if (!myShown && currentUser) {
      container.innerHTML += `<div style="text-align:center;padding:8px;color:var(--muted);font-size:0.72rem;">â€” â€” â€”</div>
      <div class="ranked-lb-row me">
        <div class="ranked-lb-pos" style="color:var(--muted);">?</div>
        <div class="ranked-lb-avatar">â­</div>
        <div class="ranked-lb-info">
          <div class="ranked-lb-name">${S.username||'You'} (You)</div>
          <div class="ranked-lb-rank"><span class="rank-badge ${getRankClass(myLP)}" style="font-size:0.62rem;padding:2px 8px;">${getRankDisplayName(myLP)}</span></div>
        </div>
        <div class="ranked-lb-lp">${myLP} LP</div>
      </div>`;
    }
  } catch(e) {
    console.error('Ranked leaderboard error:', e);
    container.innerHTML = '<div style="text-align:center;padding:12px;color:var(--muted);font-size:0.8rem;">Leaderboard unavailable â€” check your connection.</div>';
  }
}

function refreshDuelsPage() {
  const wins = S.duelWins || 0;
  const losses = S.duelLosses || 0;
  const total = wins + losses;
  const winrate = total > 0 ? Math.round(wins / total * 100) : 0;
  const wEl = document.getElementById('duels-wins');
  const lEl = document.getElementById('duels-losses');
  const wrEl = document.getElementById('duels-winrate');
  if (wEl) wEl.textContent = wins;
  if (lEl) lEl.textContent = losses;
  if (wrEl) wrEl.textContent = winrate + '%';
  
  // Load friends for challenge list
  const list = document.getElementById('duels-friends-list');
  if (!currentUser) {
    if (document.getElementById('duels-guest-msg')) document.getElementById('duels-guest-msg').style.display='block';
    if (list) list.style.display = 'none';
    return;
  }
  if (document.getElementById('duels-guest-msg')) document.getElementById('duels-guest-msg').style.display='none';
  if (!list) return;
  
  if (_friendsData.filter(f=>!f.isMe).length === 0) {
    list.innerHTML = '<p style="color:var(--muted);font-size:0.82rem;">Add friends to challenge them! Head to the ðŸ‘¥ Friends tab.</p>';
    return;
  }
  
  list.innerHTML = _friendsData.filter(f=>!f.isMe).map(u => {
    const isOnline = (Date.now() - (u.lastSeen || 0)) < 120000;
    return `<div class="friend-item">
      <div class="friend-avatar">${u.photoURL ? `<img src="${u.photoURL}"/>` : 'ðŸ‘¤'}</div>
      <div style="flex:1;">
        <div style="display:flex;align-items:center;gap:6px;">
          <div class="friend-name">${u.username||'Unknown'}</div>
          <div class="online-dot ${isOnline?'online':''}" title="${isOnline?'Online':'Offline'}"></div>
        </div>
        <div class="friend-sub">${u.xp||0} XP Â· ${u.dayStreak||0} day streak</div>
      </div>
      <button class="duel-btn challenge" onclick="sendDuelChallenge('${u.uid}','${(u.username||'Unknown').replace(/'/g,'')}')">âš”ï¸ Challenge</button>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
init();
// Only apply local settings if not signed in (Firebase will override for signed-in users)
// This is a temporary apply that Firebase's onAuthStateChanged will correct if needed
if(S.settings&&S.settings.lightMode){document.body.classList.add('light-mode');document.getElementById('theme-btn').textContent='ðŸŒ™';}
// Fallback: if Firebase auth doesn't respond in 3s, show home anyway
setTimeout(() => {
  if(document.getElementById('loader') && !document.getElementById('loader').classList.contains('hidden')) {
    document.getElementById('loader').classList.add('hidden');
    document.getElementById('page-home').classList.add('show');
  }
}, 3000);
</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DUEL SYSTEM HTML
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- Incoming duel notification -->
<div id="duel-incoming">
  <div class="di-title">âš”ï¸ Duel Challenge!</div>
  <div class="di-challenger" id="di-challenger-name">Someone</div>
  <div class="di-sub" id="di-topic-info">wants to duel you!</div>
  <div class="di-btns">
    <button class="di-accept" onclick="acceptDuel()">âš”ï¸ Accept!</button>
    <button class="di-decline" onclick="declineDuel()">Not now</button>
  </div>
  <div class="di-timer" id="di-timer-text">Expires in 30s</div>
</div>

<!-- Countdown overlay -->
<div id="duel-countdown">
  <div class="dc-num" id="dc-num">3</div>
  <div class="dc-sub">GET READY TO DUEL</div>
</div>

<!-- Duel arena -->
<div id="duel-arena">
  <div class="da-header">
    <button class="da-quit" onclick="quitDuel()">âœ• Quit</button>
    <div class="da-title">âš”ï¸ DUEL IN PROGRESS</div>
    <div style="font-family:'Space Mono',monospace;font-size:0.72rem;color:var(--muted);" id="da-first-to">First to 15 correct wins</div>
  </div>
  <div class="da-scoreboard">
    <div class="da-player">
      <div class="da-player-name" id="da-my-name">You</div>
      <div class="da-player-score me" id="da-my-score">0</div>
    </div>
    <div class="da-vs">VS</div>
    <div class="da-player">
      <div class="da-player-name" id="da-their-name">Opponent</div>
      <div class="da-player-score them" id="da-their-score">0</div>
    </div>
  </div>
  <div class="da-progress">
    <div class="da-progress-me" id="da-bar-me" style="width:0%"></div>
    <div class="da-progress-them" id="da-bar-them" style="width:0%"></div>
    <div class="da-progress-mid"></div>
  </div>
  <div class="da-question-area">
    <div class="da-topic-badge" id="da-topic-badge">Quadratics</div>
    <div id="da-question-card" style="background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px;margin-bottom:12px;">
      <div id="da-diff-tag" style="font-size:0.7rem;font-weight:700;padding:3px 9px;border-radius:99px;display:inline-block;margin-bottom:10px;"></div>
      <div id="da-question-text" style="font-size:1rem;line-height:1.7;margin-bottom:16px;"></div>
      <div id="da-options-grid" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;"></div>
    </div>
    <div id="da-feedback" style="display:none;padding:12px 14px;border-radius:12px;font-size:0.83rem;margin-bottom:10px;"></div>
    <div class="da-finish-15">ðŸ First to answer <strong>15 correct</strong> wins</div>
  </div>
</div>

<!-- Duel result screen -->
<div id="duel-result">
  <div class="dr-card">
    <span class="dr-crown" id="dr-crown">ðŸ†</span>
    <div class="dr-outcome" id="dr-outcome">You Win!</div>
    <div class="dr-sub" id="dr-sub">Amazing duel!</div>
    <div class="dr-scores">
      <div class="dr-score-box" id="dr-my-box">
        <div class="dr-score-num" id="dr-my-score">0</div>
        <div class="dr-score-name" id="dr-my-name">You</div>
      </div>
      <div class="dr-score-box" id="dr-their-box">
        <div class="dr-score-num" id="dr-their-score">0</div>
        <div class="dr-score-name" id="dr-their-name">Opponent</div>
      </div>
    </div>
    <div class="dr-xp-reward" id="dr-xp-reward">+150 XP for dueling!</div>
    <button class="btn-primary" style="width:100%;font-size:0.9rem;" onclick="closeDuelResult()">Back to Numiqube</button>
  </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CUSTOM DIALOG (replaces alert/confirm/prompt)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="custom-dialog-overlay">
  <div id="custom-dialog">
    <span class="cd-icon" id="cd-icon">âš ï¸</span>
    <div class="cd-title" id="cd-title">Title</div>
    <div class="cd-msg" id="cd-msg">Message</div>
    <input class="cd-input" id="cd-input" type="text" style="display:none;" placeholder=""/>
    <div class="cd-btns" id="cd-btns"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PRE-DUEL INTRO SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="preduel-intro">
  <div class="pdi-bg"></div>
  <div class="pdi-inner">
    <div class="pdi-title">âš”ï¸ GET READY TO DUEL</div>
    <div id="pdi-mode-badge" class="pdi-ranked-badge ranked">ðŸ† Ranked Match</div>
    <div class="pdi-players">
      <div class="pdi-player">
        <div class="pdi-avatar me" id="pdi-my-avatar">â­</div>
        <div class="pdi-player-name" id="pdi-my-name">You</div>
        <div class="pdi-player-title" id="pdi-my-title">Student</div>
        <div class="pdi-player-record" id="pdi-my-record">0W Â· 0L</div>
      </div>
      <div class="pdi-vs">
        <div class="pdi-vs-text">VS</div>
      </div>
      <div class="pdi-player them">
        <div class="pdi-avatar them" id="pdi-their-avatar">ðŸŽ¯</div>
        <div class="pdi-player-name" id="pdi-their-name">Opponent</div>
        <div class="pdi-player-title" id="pdi-their-title">Challenger</div>
        <div class="pdi-player-record" id="pdi-their-record">0W Â· 0L</div>
      </div>
    </div>
    <div class="pdi-topic-info">
      <div class="pdi-topic-label">Topic</div>
      <div class="pdi-topic-name" id="pdi-topic-name">Quadratics</div>
      <div class="pdi-topic-rounds" id="pdi-rounds-info">First to 15 correct wins</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RANKED MATCHMAKING QUEUE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="matchmaking-overlay">
  <div id="matchmaking-card">
    <div class="mm-radar">ðŸ”</div>
    <div class="mm-type-badge ranked" id="mm-type-badge">ðŸ† Ranked</div>
    <div class="mm-title" id="mm-title">Finding an Opponent...</div>
    <div class="mm-status" id="mm-status">Looking for players in your rank range</div>
    <div class="mm-timer" id="mm-timer">0:45</div>
    <div class="mm-expand-msg" id="mm-expand-msg">
      ðŸŒ No players found in your rank range. <strong>Expanding to all ranks?</strong>
      <br><button onclick="expandMatchmaking()" style="margin-top:8px;background:linear-gradient(135deg,var(--accent),#ff9a3c);border:none;color:white;font-family:'Nunito',sans-serif;font-size:0.82rem;font-weight:800;padding:7px 18px;border-radius:99px;cursor:pointer;">Yes, expand!</button>
    </div>
    <p style="font-size:0.72rem;color:var(--muted);margin-bottom:12px;" id="mm-topic-label">Your selected topics:</p>
    <div class="mm-topic-row" id="mm-topic-chips"></div>
    <button class="mm-cancel-btn" onclick="cancelMatchmaking()">Cancel</button>
  </div>
</div>

</body>
</html>
